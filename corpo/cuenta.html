<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Chat Pro</title>
    
    <!-- LIBRERIAS & FUENTES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1'
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS DE TEMA */
        :root {
            --bg: #050505; --card: #121212; --text: #e5e5e5; --text-mute: #737373;
            --brand: #ef4444; --brand-glow: rgba(239, 68, 68, 0.3); --border: #27272a; --input-bg: #18181b;
            --own-msg: #ef4444; --other-msg: #27272a;
            --pkg-color: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* NAV GLOBAL */
        #global-nav { height: 56px; background: #000000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 50; }
        .g-logo { color: #fff; font-weight: 900; text-decoration: none; font-size: 1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .g-links { display: flex; align-items: center; gap: 20px; }
        .g-link { color: #71717a; text-decoration: none; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: color 0.2s; }
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }

        /* APP HEADER */
        header { height: 60px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; z-index: 40; }
        .app-logo { font-size: 1rem; font-weight: 800; color: var(--text); display: flex; gap: 8px; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }

        /* TABS */
        .sections-bar { background: var(--bg); border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 8px; gap: 8px; flex-shrink: 0; }
        .section-tab { background: transparent; border: 1px solid transparent; border-radius: 12px; color: var(--text-mute); padding: 12px; font-size: 0.75rem; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .section-tab:hover { background: var(--card); }
        .section-tab.active { background: var(--card); border-color: var(--border); color: var(--brand); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section-tab[data-tab="paquetes"].active { color: var(--pkg-color); }

        /* CHAT AREA */
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.02) 0%, transparent 100%); }
        #messages::-webkit-scrollbar { width: 5px; }
        #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .message-row { display: flex; flex-direction: column; max-width: 85%; position: relative; animation: slideUp 0.25s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-row.mine { align-self: flex-end; align-items: flex-end; }
        .message-row.theirs { align-self: flex-start; align-items: flex-start; }
        
        .sender-name { font-size: 0.65rem; color: var(--text-mute); margin-bottom: 2px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .bubble-container { display: flex; align-items: flex-end; gap: 8px; }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: var(--text-mute); flex-shrink: 0; }

        .bubble { padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; font-weight: 500; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: transform 0.1s; cursor: pointer; }
        .bubble:active { transform: scale(0.98); }
        .message-row.theirs .bubble { background: var(--other-msg); color: var(--text); border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .message-row.mine .bubble { background: var(--own-msg); color: white; border-bottom-right-radius: 4px; }
        .msg-meta { font-size: 0.6rem; margin-top: 4px; opacity: 0.6; font-weight: 700; }

        /* FOOTER & INPUT */
        footer { background: var(--card); padding: 12px 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        
        #replyBanner { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg); border-radius: 12px 12px 0 0; margin-bottom: -4px; border: 1px solid var(--border); border-bottom: none; font-size: 0.8rem; color: var(--text-mute); display: none; }
        #replyBanner.active { display: flex; }

        .input-container { display: flex; align-items: center; gap: 10px; width: 100%; }
        .chat-input-wrapper { flex-grow: 1; display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border); border-radius: 20px; height: 44px; }
        #messageInput { width: 100%; background: transparent; border: none; color: var(--text); padding: 0 16px; font-size: 0.95rem; }
        
        #sendButton { background: var(--brand); color: white; width: 44px; height: 44px; border-radius: 12px; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        #sendButton:disabled { opacity: 0.4; cursor: not-allowed; background: var(--border); }

        #pkgButton { background: var(--pkg-color); color: white; border: none; border-radius: 12px; width: 100%; height: 50px; font-weight: 800; display: none; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; }
        .full-btn { width: 100%; padding: 14px; background: var(--brand); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 10px; text-transform: uppercase; }
        .full-input { width: 100%; padding: 14px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; }
    </style>
</head>

<body>

    <!-- NAV GLOBAL -->
    <nav id="global-nav">
        <a href="/" class="g-logo"><i class="ph-bold ph-circles-three-plus text-lg text-brand-500"></i> God's Plan</a>
        <div class="g-links">
            <a href="/corpo/index.html" class="g-link">HUB</a>
            <a href="/corpo/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="#" class="g-link active">CHAT</a>
            <a href="/blqa/finanzas.html" class="g-link">FINANZAS</a>
        </div>
    </nav>

    <!-- HEADER APP -->
    <header>
        <div class="app-logo"><i class="ph-fill ph-buildings text-brand-500"></i> Corpodatos Chat</div>
        <div class="header-actions">
            <button onclick="window.app.logout()" title="Cerrar"><i class="ph-bold ph-sign-out"></i></button>
        </div>
    </header>

    <!-- CANALES -->
    <div class="sections-bar">
        <button class="section-tab active" onclick="window.app.switchChannel('blints')"><i class="ph-bold ph-lightning"></i> Blints</button>
        <button class="section-tab" onclick="window.app.switchChannel('chat')"><i class="ph-bold ph-chat-circle-text"></i> Chat</button>
        <button class="section-tab" data-tab="paquetes" onclick="window.app.switchChannel('paquetes')"><i class="ph-bold ph-package"></i> Apoyo</button>
    </div>

    <!-- AREA MENSAJES -->
    <main id="messages"></main>

    <!-- FOOTER -->
    <footer>
        <div id="replyBanner">
            <div class="flex flex-col overflow-hidden">
                <span class="text-[10px] font-bold text-brand-500 uppercase">Respondiendo a:</span>
                <span id="replyTargetText" class="truncate text-xs opacity-80">...</span>
            </div>
            <button onclick="window.app.cancelReply()" class="p-2"><i class="ph-bold ph-x"></i></button>
        </div>

        <div class="input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje..." autocomplete="off">
            </div>
            <button id="sendButton" disabled><i class="ph-fill ph-paper-plane-right"></i></button>
            <button id="pkgButton" onclick="window.app.openPkgModal()"><i class="ph-bold ph-package"></i> SOLICITAR APOYO</button>
        </div>
    </footer>

    <!-- MODAL APOYO -->
    <div class="modal" id="pkgModal">
        <div class="modal-card">
            <h3 class="text-amber-500 font-black mb-4 uppercase tracking-wider text-xl">Solicitud de Apoyo</h3>
            <label class="block text-left text-[10px] font-bold text-zinc-500 mb-1 uppercase">Fecha Requerida</label>
            <input type="date" id="pkgDate" class="full-input">
            <label class="block text-left text-[10px] font-bold text-zinc-500 mb-1 uppercase">Motivo del Apoyo</label>
            <input type="text" id="pkgReason" class="full-input" placeholder="Ej. Material pesado">
            <button class="full-btn !bg-amber-500" onclick="window.app.sendPkgRequest()">Enviar Solicitud</button>
            <button class="full-btn bg-zinc-800 !text-zinc-400" onclick="document.getElementById('pkgModal').classList.remove('active')">Cancelar</button>
        </div>
    </div>

    <!-- FIREBASE MODULAR -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ✅ [FIX] Importamos setPersistence y browserLocalPersistence
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN OFICIAL
        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // ✅ ACTIVAR PERSISTENCIA LOCAL (Fix para móviles)
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        // RUTA ESTRICTA SEGÚN REGLA 1
        const CHAT_PATH = '/artifacts/godsplan/public/data/chat_pro';

        window.app = {
            user: null, currentChannel: 'blints', replyTo: null, unsub: null,

            async init() {
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        this.user = u;
                        this.loadMessages();
                    } else {
                        // Redirigir al portal si no hay auth
                        window.location.href = '/';
                    }
                });

                const input = document.getElementById('messageInput');
                input.addEventListener('input', e => document.getElementById('sendButton').disabled = !e.target.value.trim());
                input.addEventListener('keydown', e => { if(e.key==='Enter') this.sendMessage(); });
                document.getElementById('sendButton').onclick = () => this.sendMessage();
                document.getElementById('pkgDate').valueAsDate = new Date();
            },

            switchChannel(c) {
                this.currentChannel = c;
                this.cancelReply();
                document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
                const tabs = document.querySelectorAll('.section-tab');
                if(c==='blints') tabs[0].classList.add('active');
                if(c==='chat') tabs[1].classList.add('active');
                if(c==='paquetes') tabs[2].classList.add('active');

                const isPkg = c === 'paquetes';
                document.querySelector('.chat-input-wrapper').style.display = isPkg ? 'none' : 'flex';
                document.getElementById('sendButton').style.display = isPkg ? 'none' : 'flex';
                document.getElementById('pkgButton').style.display = isPkg ? 'flex' : 'none';
                
                this.loadMessages();
            },

            loadMessages() {
                if(this.unsub) this.unsub();
                const box = document.getElementById('messages');
                box.innerHTML = '<div class="text-center p-10 text-zinc-600 text-xs font-bold animate-pulse">ESTABLECIENDO CONEXIÓN...</div>';
                
                // Consulta simple por canal (Regla 2: SinOrderBy complejo)
                const q = query(collection(db, CHAT_PATH), where('channel', '==', this.currentChannel));

                this.unsub = onSnapshot(q, (snapshot) => {
                    const wasAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
                    box.innerHTML = '';
                    
                    let messages = [];
                    snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                    
                    // Ordenar en memoria (Regla 2)
                    messages.sort((a, b) => {
                        const tA = a.at?.toMillis ? a.at.toMillis() : 0;
                        const tB = b.at?.toMillis ? b.at.toMillis() : 0;
                        return tA - tB;
                    });

                    if(messages.length === 0) {
                        box.innerHTML = '<div class="text-center p-10 text-zinc-800 text-[10px] font-black uppercase tracking-widest">Sin registros en el canal</div>';
                    } else {
                        messages.forEach(m => box.appendChild(this.renderMessage(m)));
                    }
                    
                    if(wasAtBottom) box.scrollTop = box.scrollHeight;
                });
            },

            renderMessage(m) {
                const mine = this.user && m.uid === this.user.uid;
                const time = m.at ? new Date(m.at.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                let name = m.name || "Agente";
                if (name.includes('@')) name = name.split('@')[0];

                const div = document.createElement('div');
                div.className = `message-row ${mine?'mine':'theirs'} mb-2`;
                
                let content = `<div class="sender-name ${mine?'text-right pr-2':'pl-10'}">${name.toUpperCase()}</div><div class="bubble-container">`;
                if(!mine) content += `<div class="avatar">${name.substring(0,1).toUpperCase()}</div>`;
                
                const isPkg = m.type === 'package_request';
                let bubbleHtml = isPkg ? `
                    <div class="flex items-center gap-2 text-amber-500 font-bold mb-1"><i class="ph-bold ph-package"></i> APOYO</div>
                    <div class="text-sm">Fecha: <strong>${m.targetDate}</strong></div>
                    <div class="text-[10px] opacity-70 mt-1 uppercase font-mono">${m.reason}</div>
                ` : m.text;

                if(m.replyTo && !isPkg) {
                    bubbleHtml = `<div class="mb-1 opacity-50 border-l-2 border-white/20 pl-2 text-[10px] italic">RE: ${m.replyTo.text}</div>` + bubbleHtml;
                }
                
                content += `<div class="bubble" onclick="window.app.handleReply('${m.id}', '${isPkg ? 'Solicitud Apoyo' : m.text}')">
                                ${bubbleHtml}
                                <div class="msg-meta text-right">${time}</div>
                            </div></div>`;
                div.innerHTML = content;
                return div;
            },

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const txt = input.value.trim();
                if(!txt || !this.user) return;
                
                const payload = {
                    text: txt, type: 'text', at: serverTimestamp(),
                    uid: this.user.uid, 
                    name: this.user.displayName || this.user.email,
                    channel: this.currentChannel
                };

                if(this.replyTo) {
                    payload.replyTo = { id: this.replyTo.id, text: this.replyTo.text };
                    this.cancelReply();
                }

                input.value = '';
                await addDoc(collection(db, CHAT_PATH), payload);
            },

            handleReply(id, text) {
                this.replyTo = { id, text };
                const banner = document.getElementById('replyBanner');
                banner.classList.add('active');
                document.getElementById('replyTargetText').textContent = text;
            },

            cancelReply() {
                this.replyTo = null;
                document.getElementById('replyBanner').classList.remove('active');
            },

            openPkgModal() { document.getElementById('pkgModal').classList.add('active'); },

            async sendPkgRequest() {
                const date = document.getElementById('pkgDate').value;
                const reason = document.getElementById('pkgReason').value;
                if(!date || !this.user) return;
                
                await addDoc(collection(db, CHAT_PATH), {
                    type: 'package_request', targetDate: date, reason: reason,
                    at: serverTimestamp(), uid: this.user.uid, 
                    name: this.user.displayName || this.user.email, channel: 'paquetes'
                });
                document.getElementById('pkgModal').classList.remove('active');
            },

            logout() { signOut(auth).then(() => window.location.href = '/'); }
        };

        window.app.init();
    </script>
</body>
</html>
