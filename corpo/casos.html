<!DOCTYPE html>
<html lang="es" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Ticket System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: {
                        brand: '#E70000',
                        dark: '#050505',
                        status: {
                            unassigned: '#ef4444', 
                            pending: '#eab308',      
                            resolved: '#22c55e'      
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; background-color: #09090b; color: #e4e4e7; }
        
        /* Scrollbar Global */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }
        
        /* Scrollbar interna para logs (Más fina) */
        .log-scroll::-webkit-scrollbar { width: 4px; }
        .log-scroll::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 2px; }
        .dark .log-scroll::-webkit-scrollbar-thumb { background: #27272a; }
        .log-scroll:hover::-webkit-scrollbar-thumb { background: #a1a1aa; }
        
        .glass-nav { backdrop-filter: blur(12px); border-bottom: 1px solid; }
        .dark .glass-nav { background: rgba(9, 9, 11, 0.85); border-color: rgba(255,255,255,0.05); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); border-color: rgba(0,0,0,0.05); }

        .action-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn:active { transform: scale(0.95); }
        
        /* Animaciones de estado */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .badge-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Estilos para pestañas del modal (God's Plan) */
        .tab-active { border-bottom-color: #E70000; color: #E70000; background-color: rgba(231, 0, 0, 0.05); }
        .tab-inactive { border-bottom-color: transparent; color: #9ca3af; }
        .dark .tab-inactive { color: #52525b; }

        /* NAV GLOBAL STYLES */
        #global-nav { height: 56px; background: #000000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 50; }
        .g-logo { color: #fff; font-weight: 900; text-decoration: none; font-size: 1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .g-links { display: flex; align-items: center; gap: 20px; }
        .g-link { color: #71717a; text-decoration: none; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: color 0.2s; }
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
    </style>
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden font-sans">

    <div id="toast-container" class="fixed bottom-6 right-6 z-[300] flex flex-col gap-2 pointer-events-none"></div>

    <!-- NAV GLOBAL -->
    <nav id="global-nav">
        <a href="/" class="g-logo"><i class="ph-bold ph-circles-three-plus text-lg text-brand"></i> God's Plan</a>
        <div class="g-links">
            <a href="/corpo/index.html" class="g-link">HUB</a>
            <a href="/corpo/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/corpo/chat.html" class="g-link">CHAT</a>
            <!-- MOVIDO A BLQA -->
            <a href="/blqa/finanzas.html" class="g-link">FINANZAS (BIO)</a>
            <a href="/corpo/cuenta.html" class="g-link">CUENTA</a>
        </div>
    </nav>

    <!-- === APP VIEW === -->
    <div id="app-view" class="flex flex-col flex-grow opacity-0 transition-opacity duration-500 relative z-10">
        <!-- HEADER INTERNO -->
        <header class="h-16 glass-nav sticky top-14 z-40 flex items-center justify-between px-4 lg:px-8 shadow-sm dark:shadow-none transition-colors">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3 font-black tracking-tighter text-lg group">
                    <div class="w-8 h-8 bg-brand rounded flex items-center justify-center shadow-lg shadow-brand/20 group-hover:scale-105 transition-transform">
                        <i class="ph-bold ph-strategy text-white"></i>
                    </div>
                    <span class="text-white tracking-tight">CASOS</span>
                </div>
                <!-- Estadísticas rápidas -->
                <div class="hidden lg:flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider text-gray-500">
                    <div class="px-2 py-1 rounded bg-red-900/20 text-red-400">
                        <span id="stat-unassigned">0</span> Libres
                    </div>
                    <div class="px-2 py-1 rounded bg-yellow-900/20 text-yellow-400">
                        <span id="stat-pending">0</span> En Proceso
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="window.app.toggleTheme()" class="w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center text-gray-300 hover:bg-zinc-700 transition-colors">
                    <i id="theme-icon" class="ph-bold ph-moon"></i>
                </button>
                <button onclick="window.app.toggleImportModal()" class="action-btn bg-white text-black hover:bg-brand hover:text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-2 shadow-lg transition-colors">
                    <i class="ph-bold ph-plus"></i> <span class="hidden sm:inline">Nuevo Caso</span>
                </button>
                <div id="user-pill" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-zinc-900 rounded-lg border border-zinc-800 group relative cursor-pointer">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span id="username-display" class="text-xs font-bold text-zinc-300">...</span>
                </div>
            </div>
        </header>

        <!-- CONTROLS & FILTERS -->
        <div class="sticky top-28 z-30 bg-[#09090b]/95 backdrop-blur-sm border-b border-zinc-800 py-3 px-4 lg:px-8 shadow-sm">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                
                <!-- Main State Filters -->
                <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto no-scrollbar pb-1 md:pb-0">
                    <button id="filter-unassigned" onclick="window.app.setFilter('unassigned')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div> Sin Asignar
                    </button>
                    <button id="filter-mine" onclick="window.app.setFilter('mine')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-yellow-500"></div> Mis Pendientes
                    </button>
                    <button id="filter-resolved" onclick="window.app.setFilter('resolved')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div> Resueltos
                    </button>
                    <div class="h-4 w-px bg-zinc-700 mx-1"></div>
                    <button id="filter-all" onclick="window.app.setFilter('all')" class="action-btn px-3 py-1.5 rounded-full text-xs font-bold uppercase border text-gray-500">Todos</button>
                </div>

                <!-- Search -->
                <div class="relative w-full md:w-80 group">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand transition-colors"></i>
                    <input type="text" id="search-input" onkeyup="window.app.handleSearch(this.value)" class="block w-full pl-9 pr-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand transition-all" placeholder="Buscar cliente, teléfono...">
                </div>
            </div>
        </div>

        <!-- MAIN GRID -->
        <main class="flex-grow p-4 lg:p-6 w-full max-w-7xl mx-auto">
            <div id="cases-grid" class="grid grid-cols-1 gap-4">
                <!-- Loader -->
                <div class="col-span-1 flex flex-col items-center justify-center h-64 text-zinc-600">
                    <i class="ph-duotone ph-spinner-gap text-4xl animate-spin mb-3 text-brand"></i>
                    <span class="text-xs font-mono uppercase tracking-widest">Sincronizando Casos...</span>
                </div>
            </div>
        </main>
    </div>

    <!-- NEW HYBRID MODAL -->
    <div id="import-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-all duration-200 opacity-0 font-sans">
        <div class="bg-zinc-900 border border-zinc-700 w-full max-w-xl rounded-2xl shadow-2xl transform scale-95 transition-all duration-200 flex flex-col overflow-hidden" id="import-modal-content">
            <!-- Header -->
            <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
                <h3 class="font-black text-lg text-white flex items-center gap-2"><i class="ph-fill ph-plus-circle text-brand"></i> NUEVO CASO</h3>
                <button onclick="window.app.toggleImportModal()" class="text-gray-400 hover:text-red-500 p-2 rounded-lg transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-zinc-800">
                <button onclick="window.app.setTab('auto')" id="tab-auto" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active">Automático (Pegar)</button>
                <button onclick="window.app.setTab('manual')" id="tab-manual" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive">Manual</button>
            </div>

            <div class="p-6 relative">
                <!-- VISTA AUTOMÁTICA -->
                <div id="view-auto" class="transition-all duration-300">
                    <div class="mb-4 text-xs text-zinc-400 flex items-start gap-2">
                        <i class="ph-bold ph-magic-wand text-brand mt-0.5"></i>
                        Pega el texto crudo (ej: WhatsApp, Email). El sistema extraerá teléfonos y nombres.
                    </div>
                    <textarea id="raw-input" class="w-full h-40 bg-black border border-zinc-700 rounded-xl p-4 text-sm font-mono text-zinc-300 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand/50 resize-none mb-6 placeholder:text-zinc-700" placeholder="Ej: Cliente Juan Perez 5512345678 problema con pantalla..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.app.processInput('smartwatch')" class="p-3 rounded-xl border border-zinc-800 hover:border-sky-500 bg-zinc-950 hover:bg-sky-900/10 transition-all text-left group">
                            <span class="text-sky-500 font-black text-xs flex items-center gap-2 mb-1"><i class="ph-fill ph-watch"></i> SMARTWATCH</span>
                            <span class="text-[10px] text-gray-400">Procesar como soporte SW</span>
                        </button>
                        <button onclick="window.app.processInput('general')" class="p-3 rounded-xl border border-zinc-800 hover:border-yellow-500 bg-zinc-950 hover:bg-yellow-900/10 transition-all text-left group">
                            <span class="text-yellow-500 font-black text-xs flex items-center gap-2 mb-1"><i class="ph-fill ph-globe"></i> GENERAL</span>
                            <span class="text-[10px] text-gray-400">Procesar como ventas/dudas</span>
                        </button>
                    </div>
                </div>

                <!-- VISTA MANUAL -->
                <div id="view-manual" class="hidden transition-all duration-300 flex flex-col gap-4">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-zinc-500 mb-1 block">Nombre del Cliente</label>
                        <input type="text" id="man-name" class="w-full bg-black border border-zinc-800 rounded-lg p-2.5 text-sm font-bold text-white focus:outline-none focus:border-brand uppercase" placeholder="Ej: JUAN PEREZ">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-zinc-500 mb-1 block">Tel. Contacto</label>
                            <input type="text" id="man-contact" class="w-full bg-black border border-zinc-800 rounded-lg p-2.5 text-sm font-mono text-white focus:outline-none focus:border-brand" placeholder="Llamar a...">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-zinc-500 mb-1 block">Tel. Afectado (Opcional)</label>
                            <input type="text" id="man-affected" class="w-full bg-black border border-zinc-800 rounded-lg p-2.5 text-sm font-mono text-white focus:outline-none focus:border-brand" placeholder="Línea con falla...">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] uppercase font-bold text-zinc-500 mb-1 block">Tipo de Caso</label>
                        <select id="man-type" class="w-full bg-black border border-zinc-800 rounded-lg p-2.5 text-sm text-white focus:outline-none focus:border-brand">
                            <option value="smartwatch">Smartwatch</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase font-bold text-zinc-500 mb-1 block">Descripción del Problema</label>
                        <textarea id="man-desc" rows="3" class="w-full bg-black border border-zinc-800 rounded-lg p-2.5 text-sm text-zinc-300 focus:outline-none focus:border-brand resize-none" placeholder="Detalles del caso..."></textarea>
                    </div>

                    <button onclick="window.app.saveManual()" class="w-full py-3 bg-brand hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-brand/20 transition-all uppercase text-sm mt-2">
                        Crear Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE ENTORNO UNIFICADA (GODSPLAN BLQA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // RUTA DE TICKETS COMPARTIDOS (CorpoDatos Shared Space)
        const TICKETS_PATH = 'artifacts/godsplan/public/data/tickets';

        let currentUser = null;
        let casesData = [];
        let currentFilter = 'unassigned';
        let searchTerm = '';
        let unsubscribeRealtime = null;

        // --- UI UTILS ---
        const toast = (msg, type = 'success') => {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-500 text-white' : (type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white');
            el.className = `${colors} px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 text-sm font-bold animate-toastIn pointer-events-auto`;
            el.innerHTML = `<i class="ph-bold ${type === 'success' ? 'ph-check' : (type === 'error' ? 'ph-warning' : 'ph-info')}"></i> ${msg}`;
            c.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300) }, 3000);
        };

        const timeAgo = (date) => {
            if (!date) return 'Hace un momento';
            const seconds = Math.floor((new Date() - date.toDate()) / 1000);
            if (seconds < 60) return 'Hace unos seg';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} h`;
            return `${Math.floor(hours / 24)} d`;
        };

        const formatDateTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        // --- AUTH & DATA ---
        onAuthStateChanged(auth, (user) => {
            const appView = document.getElementById('app-view');
            
            if (user) {
                currentUser = user;
                document.getElementById('username-display').textContent = (user.displayName || user.email?.split('@')[0] || 'AGENTE').toUpperCase();
                
                appView.classList.remove('hidden');
                setTimeout(() => appView.style.opacity = '1', 50);

                initRealtime();
            } else {
                // Si no hay sesión, volver al portal principal
                window.location.href = '/';
            }
        });

        function initRealtime() {
            const q = collection(db, TICKETS_PATH);
            unsubscribeRealtime = onSnapshot(q, (snap) => {
                casesData = [];
                snap.forEach(d => casesData.push({ id: d.id, ...d.data() }));
                
                // Actualizar contadores
                const unassignedCount = casesData.filter(c => c.status === 'unassigned').length;
                const pendingCount = casesData.filter(c => c.status === 'pending').length;
                document.getElementById('stat-unassigned').textContent = unassignedCount;
                document.getElementById('stat-pending').textContent = pendingCount;
                
                // Ordenar: Pendientes urgentes primero
                casesData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            }, (error) => {
                console.error("Error fetching tickets:", error);
                if(error.code === 'permission-denied') {
                    toast('Sin permisos de acceso', 'error');
                }
            });
        }

        // --- APP LOGIC ---
        window.app = {
            logout: async () => {
                try {
                    await signOut(auth);
                    window.location.href = '/';
                } catch(e) { console.error(e); }
            },

            toggleTheme: () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-icon').className = isDark ? 'ph-bold ph-sun' : 'ph-bold ph-moon';
            },

            toggleImportModal: () => {
                const m = document.getElementById('import-modal');
                const c = document.getElementById('import-modal-content');
                if (m.classList.contains('hidden')) {
                    m.classList.remove('hidden');
                    setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); }, 10);
                    window.app.setTab('auto');
                } else {
                    m.classList.add('opacity-0'); c.classList.add('scale-95');
                    setTimeout(() => m.classList.add('hidden'), 200);
                }
            },

            setTab: (tabName) => {
                const btnAuto = document.getElementById('tab-auto');
                const btnMan = document.getElementById('tab-manual');
                const viewAuto = document.getElementById('view-auto');
                const viewMan = document.getElementById('view-manual');

                if (tabName === 'auto') {
                    btnAuto.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active";
                    btnMan.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive";
                    viewAuto.classList.remove('hidden');
                    viewMan.classList.add('hidden');
                    document.getElementById('raw-input').focus();
                } else {
                    btnAuto.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive";
                    btnMan.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active";
                    viewAuto.classList.add('hidden');
                    viewMan.classList.remove('hidden');
                    document.getElementById('man-name').focus();
                }
            },

            setFilter: (f) => {
                currentFilter = f;
                render();
            },

            handleSearch: (val) => {
                searchTerm = val.toLowerCase();
                render();
            },

            // AUTOMATIC IMPORT
            processInput: async (type) => {
                const text = document.getElementById('raw-input').value;
                if(!text.trim()) return toast('El campo está vacío', 'error');
                
                const chunks = text.split(/(?:plis|\n{2,})/i).map(c => c.trim()).filter(c => c.length > 5);
                let added = 0;
                
                for (const chunk of chunks) {
                    const phones = chunk.match(/\b\d{10}\b/g) || [];
                    let name = chunk.split(phones[0] || '')[0].replace(/[:.-]/g, ' ').trim().substring(0, 30);
                    if(!name || name.length < 3) name = "Cliente Desconocido";

                    await addDoc(collection(db, TICKETS_PATH), {
                        type,
                        rawText: chunk,
                        clientName: name.toUpperCase(),
                        contactPhone: phones[0] || '',
                        phones,
                        description: chunk,
                        status: 'unassigned',
                        assignedTo: null,
                        comments: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    added++;
                }
                
                toast(`${added} Tickets Creados`);
                document.getElementById('raw-input').value = '';
                window.app.toggleImportModal();
            },

            // MANUAL IMPORT
            saveManual: async () => {
                const name = document.getElementById('man-name').value.trim();
                const contact = document.getElementById('man-contact').value.trim();
                const affected = document.getElementById('man-affected').value.trim();
                const type = document.getElementById('man-type').value;
                const desc = document.getElementById('man-desc').value.trim();

                if (!name) return toast('El nombre es obligatorio', 'error');
                if (!contact && !affected) return toast('Ingresa al menos un teléfono', 'error');
                if (!desc) return toast('La descripción es obligatoria', 'error');

                try {
                    await addDoc(collection(db, TICKETS_PATH), {
                        type,
                        rawText: 'Creado manualmente',
                        clientName: name.toUpperCase(),
                        contactPhone: contact,
                        affectedPhone: affected,
                        phones: [contact, affected].filter(p => p),
                        description: desc,
                        status: 'unassigned',
                        assignedTo: null,
                        comments: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    
                    toast('Ticket creado con éxito');
                    
                    document.getElementById('man-name').value = '';
                    document.getElementById('man-contact').value = '';
                    document.getElementById('man-affected').value = '';
                    document.getElementById('man-desc').value = '';
                    
                    window.app.toggleImportModal();
                } catch (e) {
                    console.error(e);
                    toast('Error al guardar', 'error');
                }
            },

            // CASE ACTIONS
            claim: async (id) => {
                if(!currentUser) return;
                try {
                    await updateDoc(doc(db, TICKETS_PATH, id), {
                        status: 'pending',
                        assignedTo: { uid: currentUser.uid, name: currentUser.displayName || currentUser.email || 'Agente' },
                        updatedAt: serverTimestamp(),
                        comments: arrayUnion({ type: 'system', text: 'tomó el caso', author: currentUser.displayName || currentUser.email || 'Agente', time: Date.now() })
                    });
                    toast('Caso asignado a ti');
                } catch(e) { toast('Error al asignar', 'error'); }
            },

            release: async (id) => {
                if(!confirm("¿Soltar este caso?")) return;
                await updateDoc(doc(db, TICKETS_PATH, id), {
                    status: 'unassigned',
                    assignedTo: null,
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: 'liberó el caso', author: currentUser.displayName || currentUser.email, time: Date.now() })
                });
                toast('Caso liberado');
            },

            resolve: async (id, reason) => {
                const text = reason === 'solved' ? 'marcó como resuelto' : 'cerró el caso (sin respuesta)';
                const confirmMsg = reason === 'solved' ? "¿Marcar caso como RESUELTO?" : "¿Cerrar caso por FALTA DE RESPUESTA?";
                
                if(!confirm(confirmMsg)) return;
                
                await updateDoc(doc(db, TICKETS_PATH, id), {
                    status: 'resolved',
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: text, author: currentUser.displayName || currentUser.email, time: Date.now() })
                });
                toast(reason === 'solved' ? 'Caso Resuelto' : 'Caso Cerrado', 'success');
            },

            reopen: async (id) => {
                if(!confirm("¿Reabrir caso?")) return;
                await updateDoc(doc(db, TICKETS_PATH, id), {
                    status: 'pending',
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: 'reabrió el caso', author: currentUser.displayName || currentUser.email, time: Date.now() })
                });
                toast('Caso Reabierto');
            },

            addComment: async (id, inputId) => {
                const input = document.getElementById(inputId);
                const txt = input.value.trim();
                if(!txt) return;
                
                await updateDoc(doc(db, TICKETS_PATH, id), {
                    comments: arrayUnion({ type: 'user', text: txt, author: currentUser.displayName?.split(' ')[0] || currentUser.email?.split('@')[0] || 'Yo', time: Date.now() })
                });
                input.value = '';
            },

            toggleSuccessInput: (id) => {
                const el = document.getElementById(`success-input-${id}`);
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) document.getElementById(`comment-success-${id}`).focus();
            },

            logInteraction: async (id, type) => {
                let commentText = '';
                
                if (type === 'success') {
                    const input = document.getElementById(`comment-success-${id}`);
                    commentText = input.value.trim();
                    if (!commentText) return toast('Debes agregar un comentario para registro exitoso', 'error');
                    document.getElementById(`success-input-${id}`).classList.add('hidden');
                    input.value = '';
                }

                const logData = {
                    type: 'interaction',
                    subtype: type, 
                    text: commentText, 
                    author: currentUser.displayName || currentUser.email || 'Agente',
                    time: Date.now()
                };

                await updateDoc(doc(db, TICKETS_PATH, id), {
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion(logData)
                });
                
                toast('Interacción registrada');
            },

            delete: async (id) => {
                if(!confirm("¿Eliminar permanentemente?")) return;
                await deleteDoc(doc(db, TICKETS_PATH, id));
                toast('Eliminado');
            }
        };

        // --- RENDER ---
        function render() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '';

            // Update Filter Buttons Style
            const filters = ['unassigned', 'mine', 'resolved', 'all'];
            filters.forEach(f => {
                const btn = document.getElementById(`filter-${f}`);
                if (btn) {
                    if (currentFilter === f) {
                        btn.classList.add('bg-zinc-900', 'dark:bg-white', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.remove('bg-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('bg-zinc-900', 'dark:bg-white', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.add('bg-transparent', 'text-gray-500', 'hover:text-white');
                    }
                }
            });

            // Filter Data logic
            let list = casesData;

            if (currentFilter === 'unassigned') {
                list = list.filter(c => c.status === 'unassigned');
            } else if (currentFilter === 'mine') {
                list = list.filter(c => c.status === 'pending' && c.assignedTo?.uid === currentUser?.uid);
            } else if (currentFilter === 'resolved') {
                list = list.filter(c => c.status === 'resolved');
            }

            if (searchTerm) {
                list = list.filter(c => JSON.stringify(c).toLowerCase().includes(searchTerm));
            }

            if (list.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-1 flex flex-col items-center justify-center h-64 opacity-50">
                        <i class="ph-duotone ph-magnifying-glass text-4xl mb-2"></i>
                        <span class="text-sm font-bold uppercase">No hay tickets en esta vista</span>
                    </div>`;
                return;
            }

            list.forEach(c => {
                const isMine = c.assignedTo?.uid === currentUser?.uid;
                
                let statusColor = 'gray';
                let statusLabel = 'DESCONOCIDO';
                let borderColor = 'border-zinc-800';
                
                if (c.status === 'unassigned') {
                    statusColor = 'red'; statusLabel = 'SIN ASIGNAR';
                    borderColor = 'border-red-900/30 bg-red-950/5';
                } else if (c.status === 'pending') {
                    statusColor = 'yellow'; statusLabel = isMine ? 'MIS PENDIENTES' : `PENDIENTE (${c.assignedTo?.name})`;
                    borderColor = isMine ? 'border-yellow-900/30 bg-yellow-950/5 ring-1 ring-yellow-400/20' : 'border-zinc-800 opacity-90';
                } else if (c.status === 'resolved') {
                    statusColor = 'green'; statusLabel = 'RESUELTO';
                    borderColor = 'border-green-900/30 bg-green-950/5 opacity-75';
                }

                const attempts = c.comments?.filter(co => co.type === 'interaction' && co.subtype === 'failed').length || 0;

                const card = document.createElement('div');
                card.className = `group relative rounded-2xl border ${borderColor} p-5 flex flex-col md:flex-row gap-6 transition-all hover:shadow-lg dark:hover:shadow-none bg-[#0f0f11]`;

                const typeIcon = c.type === 'smartwatch' ? 'ph-watch' : 'ph-globe';
                const typeColor = c.type === 'smartwatch' ? 'text-sky-500' : 'text-orange-500';

                let phonesDisplay = c.contactPhone || 'Sin teléfono';
                if (c.affectedPhone && c.affectedPhone !== c.contactPhone) {
                    phonesDisplay += ` <span class="opacity-50 mx-1">|</span> <i class="ph-bold ph-warning-circle text-orange-500"></i> ${c.affectedPhone}`;
                }

                const recentComments = c.comments?.slice().reverse().slice(0, 20).map(co => {
                    const time = formatDateTime(co.time);
                    
                    if (co.type === 'system') {
                        return `<div class="text-[10px] text-zinc-500 italic mb-1 pl-1 border-l-2 border-zinc-800">
                            <span class="font-bold">${co.author}</span> ${co.text} <span class="opacity-50 text-[9px]">${time}</span>
                        </div>`;
                    }
                    
                    if (co.type === 'interaction') {
                        let icon = 'ph-info';
                        let color = 'text-gray-500';
                        let text = 'Interacción';
                        
                        if (co.subtype === 'failed') { icon = 'ph-x-circle'; color = 'text-red-500'; text = 'No Contesta'; }
                        else if (co.subtype === 'success') { icon = 'ph-check-circle'; color = 'text-green-500'; text = 'Contacto Exitoso'; }

                        return `<div class="text-[11px] mb-2 bg-zinc-900 p-2 rounded border border-dashed border-zinc-800">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ph-fill ${icon} ${color}"></i>
                                <span class="font-bold text-zinc-300 uppercase text-[10px]">${text}</span>
                                <span class="ml-auto text-[9px] font-mono text-zinc-500">${time}</span>
                            </div>
                            ${co.text ? `<div class="text-zinc-400 pl-6 border-l-2 border-green-500/20">${co.text}</div>` : ''}
                        </div>`;
                    }

                    return `<div class="text-[11px] text-zinc-300 mb-1 bg-zinc-800/50 p-2 rounded-lg border border-zinc-700/50">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="font-bold text-zinc-200">${co.author}</span>
                            <span class="text-[9px] text-zinc-500 font-mono">${time}</span>
                        </div>
                        ${co.text}
                    </div>`;
                }).join('') || '<div class="text-[10px] text-zinc-600 italic">Sin actividad reciente</div>';

                let mainAction = '';
                if (c.status === 'unassigned') {
                    mainAction = `<button onclick="window.app.claim('${c.id}')" class="w-full py-2 bg-white text-black font-bold text-xs uppercase rounded-lg hover:bg-brand hover:text-white transition-colors">TOMAR CASO</button>`;
                } else if (c.status === 'pending') {
                    if (isMine) {
                        mainAction = `
                            <!-- Interaction Controls for Owner -->
                            <div class="mb-3 p-2 bg-zinc-900 rounded-lg border border-dashed border-zinc-700">
                                <p class="text-[9px] font-bold text-zinc-500 uppercase mb-2 tracking-wider">Registrar Interacción</p>
                                <div class="flex gap-2 mb-2">
                                    <button onclick="window.app.logInteraction('${c.id}', 'failed')" class="flex-1 py-2 bg-black border border-zinc-800 rounded text-[10px] font-bold text-red-500 hover:border-red-500 transition-colors" title="No contestó"><i class="ph-bold ph-phone-slash"></i> NO CONTESTA</button>
                                    <button onclick="window.app.toggleSuccessInput('${c.id}')" class="flex-1 py-2 bg-black border border-zinc-800 rounded text-[10px] font-bold text-green-500 hover:border-green-500 transition-colors" title="Contacto Exitoso"><i class="ph-bold ph-check"></i> EXITOSO</button>
                                </div>
                                <div id="success-input-${c.id}" class="hidden animate-fadeIn">
                                    <input type="text" id="comment-success-${c.id}" placeholder="¿Qué acordaron?" class="w-full text-xs bg-black border border-green-500/30 rounded px-2 py-1 mb-2 focus:outline-none focus:border-green-500 text-white">
                                    <button onclick="window.app.logInteraction('${c.id}', 'success')" class="w-full py-1 bg-green-500 text-white text-[10px] font-bold rounded uppercase hover:bg-green-600">Guardar Éxito</button>
                                </div>
                            </div>

                            <!-- Closing Controls -->
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="window.app.resolve('${c.id}', 'solved')" class="col-span-2 md:col-span-1 py-2 bg-green-500 text-white font-bold text-xs uppercase rounded-lg hover:bg-green-600 shadow-lg shadow-green-500/20">RESUELTO</button>
                                <button onclick="window.app.resolve('${c.id}', 'unresponsive')" class="col-span-2 md:col-span-1 py-2 bg-zinc-800 text-zinc-400 font-bold text-xs uppercase rounded-lg hover:bg-zinc-700">CERRAR (NO CONTESTA)</button>
                                <button onclick="window.app.release('${c.id}')" class="col-span-2 py-1.5 border border-dashed border-zinc-700 text-[10px] text-zinc-500 hover:text-red-500 rounded-lg" title="Soltar caso">Liberar Caso</button>
                            </div>
                        `;
                    } else {
                        mainAction = `<button onclick="window.app.claim('${c.id}')" class="w-full py-2 border border-brand/50 text-brand font-bold text-xs uppercase rounded-lg hover:bg-brand hover:text-white transition-colors">TOMAR CASO (DE ${c.assignedTo?.name?.split(' ')[0]})</button>`;
                    }
                } else if (c.status === 'resolved') {
                    mainAction = `<button onclick="window.app.reopen('${c.id}')" class="w-full py-2 border border-zinc-700 text-zinc-400 font-bold text-xs uppercase rounded-lg hover:bg-zinc-800">REABRIR CASO</button>`;
                }

                card.innerHTML = `
                    <div class="flex-grow min-w-0 flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-${statusColor}-500 bg-${statusColor}-900/20 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider ${c.status === 'unassigned' ? 'badge-pulse' : ''}">${statusLabel}</span>
                                ${attempts > 0 ? `<span class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px] font-bold" title="Intentos fallidos"><i class="ph-bold ph-phone-slash"></i> ${attempts}</span>` : ''}
                                <span class="text-[10px] font-mono text-zinc-500">${timeAgo(c.updatedAt || c.createdAt)}</span>
                            </div>
                            <i class="${typeIcon} ${typeColor} text-lg opacity-50"></i>
                        </div>
                        
                        <div>
                            <h3 class="font-black text-xl text-white leading-tight truncate tracking-tight mb-1">${c.clientName}</h3>
                            <p class="text-xs font-mono text-zinc-500 select-all">${phonesDisplay}</p>
                        </div>

                        <div class="text-sm text-zinc-400 leading-relaxed line-clamp-3 hover:line-clamp-none transition-all cursor-help bg-black/20 p-3 rounded-lg border border-zinc-800/50">
                            ${c.description}
                        </div>
                    </div>

                    <div class="flex-grow md:max-w-xs min-w-0 md:border-l border-zinc-800 md:pl-6 flex flex-col gap-3 justify-between">
                        <div class="flex flex-col gap-1">
                            <div class="text-[10px] font-bold text-zinc-600 uppercase tracking-wider mb-1">Actividad Reciente</div>
                            <div class="max-h-40 overflow-y-auto pr-1 log-scroll flex flex-col-reverse">
                                ${recentComments}
                            </div>
                        </div>

                        <div class="space-y-3 pt-3 border-t border-zinc-800">
                            ${c.status !== 'resolved' ? `
                            <div class="relative">
                                <input type="text" id="input-${c.id}" placeholder="Nota rápida..." 
                                    class="w-full bg-black border border-zinc-800 rounded-lg px-3 py-2 text-xs text-white focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all"
                                    onkeypress="if(event.key==='Enter') window.app.addComment('${c.id}', 'input-${c.id}')">
                                <button onclick="window.app.addComment('${c.id}', 'input-${c.id}')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand"><i class="ph-bold ph-paper-plane-right"></i></button>
                            </div>
                            ` : ''}
                            
                            ${mainAction}
                            
                            <div class="flex justify-end pt-1">
                                <button onclick="window.app.delete('${c.id}')" class="text-[10px] text-zinc-600 hover:text-red-500 uppercase font-bold flex items-center gap-1 transition-colors"><i class="ph-bold ph-trash"></i> Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>
