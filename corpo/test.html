<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>God's Plan | Finanzas</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="./favicon.ico?v=2" type="image/x-icon">
    <link rel="icon" href="./favicon.ico?v=2" type="image/x-icon">

    <!-- FUENTE -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        card: '#111111',
                        brand: '#dc2626',
                        'text-mute': '#737373',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-red': 'pulseRed 2s infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        pulseRed: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.5' } }
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE MODULAR -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, updateProfile, setPersistence, browserLocalPersistence,
            getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc, where
        };
    </script>

    <style>
        /* ESTILOS BASE */
        :root { --sab: env(safe-area-inset-bottom); --sat: env(safe-area-inset-top); }
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; min-height: 100dvh; }
        input, select, textarea { font-size: 16px !important; outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* UTILIDADES VISUALES */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-highlight { background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.08); }
        .glass-nav { background: rgba(5, 5, 5, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); padding-bottom: max(10px, var(--sab)); height: calc(70px + var(--sab)); }

        .input-modern { background: #09090b; border: 1px solid #27272a; color: white; border-radius: 16px; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); font-size: 16px !important; }
        .input-modern:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); outline: none; background: #18181b; }
        
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border-color: #ef4444; }
        
        #toast-container { position: fixed; top: calc(80px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; animation: fadeIn 0.3s forwards; pointer-events: auto; }
        
        /* Modal Styles */
        #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; align-items: flex-end; justify-content: center; }
        #modalOverlay.is-open { opacity: 1; pointer-events: auto; }
        #modalSheet { background: #121212; width: 100%; max-height: 85dvh; border-top-left-radius: 32px; border-top-right-radius: 32px; border-top: 1px solid #27272a; padding: 20px 24px; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: calc(40px + var(--sab)); }
        #modalOverlay.is-open #modalSheet { transform: translateY(0); }
        @media (min-width: 768px) {
            #modalOverlay { align-items: center; padding: 20px; }
            #modalSheet { width: 100%; max-width: 360px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-height: 85vh; padding: 20px; transform: scale(0.95); opacity: 0; transition: all 0.2s ease-out; }
            #modalOverlay.is-open #modalSheet { transform: scale(1); opacity: 1; }
        }

        .nav-link-desk { color: #71717a; padding: 6px 16px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; transition: all 0.2s; cursor: pointer; }
        .nav-link-desk:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-link-desk.active { color: white; background: #27272a; }

        /* AUTH STYLES */
        .modal-auth { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-auth.active { display: flex; }
        .auth-switch { position: relative; display: flex; background: rgba(30,30,30,0.5); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .auth-switch button { flex: 1; padding: 8px; font-size: 0.75rem; font-weight: 700; z-index: 1; color: #71717a; transition: 0.3s; }
        .auth-switch button.active { color: white; }
        .auth-switch-glider { position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: calc(50% - 4px); background: #27272a; border-radius: 8px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.1); }
        .auth-mode-register .auth-switch-glider { transform: translateX(100%); }

        /* Screen Transitions */
        section { animation: fadeIn 0.4s ease-out; }
    </style>
</head>

<body class="bg-[#050505] text-[#e5e5e5] font-sans pb-28 pt-20 text-sm font-normal">

    <!-- HEADER FIJO -->
    <nav class="fixed top-0 left-0 w-full z-[100] border-b border-white/5 bg-[rgba(0,0,0,0.9)] backdrop-blur-md h-20 flex items-center shadow-lg transition-all duration-300">
        <div class="w-full max-w-7xl mx-auto px-4 md:px-6 flex justify-between items-center h-full">
            <a href="/corpo/index.html" class="flex items-center gap-3 group">
                <div class="relative w-9 h-9 flex items-center justify-center">
                    <div class="absolute inset-0 bg-brand rounded-full blur opacity-20 group-hover:opacity-40 transition-opacity"></div>
                    <i class="ph-fill ph-planet text-3xl text-brand relative z-10"></i>
                </div>
                <div class="flex flex-col justify-center">
                    <span class="font-bold tracking-widest text-lg text-white leading-none">GOD'S PLAN</span>
                    <span class="text-[0.6rem] text-zinc-400 font-mono tracking-widest uppercase hidden sm:block">System v4.1</span>
                </div>
            </a>

            <!-- Navegación Central (Desktop) -->
            <div class="hidden md:flex items-center bg-white/5 rounded-full p-1 border border-white/5">
                <a href="/corpo/adherencia.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">ADHERENCIA</a>
                <a href="/corpo/finanzas.html" class="px-4 py-1.5 rounded-full bg-brand text-white text-xs font-bold tracking-wide shadow-lg shadow-brand/20 transition-all">FINANZAS</a>
                <a href="/corpo/chat.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CHAT</a>
                <a href="/corpo/casos.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CASOS</a>
                <a href="/corpo/cuenta.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CUENTA</a>
            </div>

            <!-- User Badge -->
            <div id="user-badge" class="hidden items-center gap-2 animate-fade-in pl-4 border-l border-white/10 ml-2">
                <div class="hidden lg:flex flex-col text-right mr-2">
                    <span id="user-name" class="text-xs font-bold text-white uppercase tracking-wider max-w-[100px] truncate">Usuario</span>
                    <span id="user-role" class="text-[9px] font-mono text-emerald-500 tracking-wide">SYSTEM ACCESS</span>
                </div>
                <button onclick="window.app.logout()" class="w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-zinc-400 hover:bg-red-500/10 hover:border-red-500/50 hover:text-red-500 transition-all group" title="Cerrar Sesión">
                    <i class="ph-bold ph-power text-lg group-hover:scale-110 transition-transform"></i>
                </button>
            </div>
            
            <button class="md:hidden w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-zinc-400 hover:bg-white/10 hover:text-white transition-colors" onclick="window.app.openNavModal()">
                 <i class="ph-bold ph-list text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth overflow-x-hidden md:px-6">
        <input type="file" id="importFile" accept=".json" class="hidden">
        
        <div class="w-full max-w-lg md:max-w-6xl mx-auto h-full pt-4 md:pt-8">
            
            <!-- SUB-NAVEGACIÓN INTERNA (DESKTOP) -->
            <div class="hidden md:flex justify-center mb-8 fade-in">
                <div class="bg-zinc-900/80 border border-white/10 p-1.5 rounded-full flex items-center gap-1 shadow-lg backdrop-blur-sm">
                    <button onclick="app.switchView('balance')" class="nav-link-desk active px-5" data-view="balance">Billetera</button>
                    <button onclick="app.switchView('loans')" class="nav-link-desk px-5" data-view="loans">Préstamos</button>
                    <button onclick="app.switchView('future')" class="nav-link-desk px-5" data-view="future">Futuro</button>
                    <button onclick="app.switchView('plan')" class="nav-link-desk px-5" data-view="plan">Planificación</button>
                </div>
            </div>

            <!-- VISTA 1: BILLETERA (HOME) -->
            <section id="view-balance" class="p-4 sm:p-0 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-12 md:gap-8 items-start">
                    <div class="md:col-span-5 lg:col-span-4 md:sticky md:top-24">
                        <div class="flex justify-between items-end mb-4 px-1">
                            <div onclick="app.openModal('config')" class="cursor-pointer group py-2">
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1 group-hover:text-red-500 transition-colors">
                                    CICLO ACTUAL <i class="ph-bold ph-gear inline align-middle ml-1"></i>
                                </p>
                                <h2 class="text-base font-bold text-white flex items-center gap-2" id="periodDates">Cargando...</h2>
                            </div>
                            <div id="daysLeftBadge" class="text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(239,68,68,0.1)]">
                                -- Días
                            </div>
                        </div>

                        <div id="mainCard" class="glass rounded-[2rem] p-6 relative overflow-hidden group mb-6 transition-all active:scale-[0.98] md:hover:scale-[1.01] shadow-2xl shadow-black/50">
                            <div id="mainCardBg" class="absolute -top-10 -right-10 w-32 h-32 bg-red-600/20 rounded-full blur-3xl transition-colors duration-500"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <button id="extraMenuTrigger" onclick="app.toggleExtrasMenu()" class="flex items-center gap-2 group text-left focus:outline-none">
                                        <span id="labelDailyState" class="text-xs font-bold text-zinc-400 uppercase tracking-widest transition-colors group-hover:text-white">Disponible Hoy</span>
                                        <i id="extraMenuIcon" class="ph-bold ph-caret-down text-zinc-500 group-hover:text-white transition-transform duration-300"></i>
                                    </button>
                                </div>
                                <div class="text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black text-white tracking-tighter mb-2 break-all relative leading-none transition-colors" id="dailyFreeContainer">
                                    <span id="dailyFree">---</span>
                                </div>
                                <div class="flex items-center gap-3 mb-6 font-mono text-xs">
                                    <div class="text-zinc-500">Límite: <span id="valDailyLimit" class="text-zinc-300 font-bold">---</span></div>
                                    <div class="w-1 h-1 bg-zinc-700 rounded-full"></div>
                                    <div class="text-zinc-500">Gastado: <span id="valTodaySpent" class="text-red-400 font-bold">---</span></div>
                                </div>

                                <div id="extraMenu" class="hidden border-t border-white/10 pt-4 mb-4 animate-fade-in">
                                    <div class="mb-4">
                                        <button onclick="app.openModal('adjustment')" class="w-full bg-zinc-800/50 hover:bg-zinc-800 text-zinc-300 text-xs font-bold py-3 rounded-xl border border-white/5 transition-all flex items-center justify-center gap-2 active:scale-95 group/adj">
                                            <i class="ph-bold ph-scales text-zinc-500 group-hover/adj:text-white transition-colors"></i> AJUSTAR SALDO REAL
                                        </button>
                                    </div>
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest flex items-center gap-2"><i class="ph-fill ph-magic-wand"></i> Simulador & Extras</div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] font-bold text-zinc-500 uppercase">Simular</span>
                                            <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                                                <input type="checkbox" name="toggle" id="simToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-zinc-600 transition-all duration-300" onclick="app.toggleSimulation()">
                                                <label for="simToggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-zinc-800 cursor-pointer"></label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mb-4">
                                        <div>
                                            <label class="text-[9px] text-zinc-600 font-bold uppercase block mb-1">Monto Extra</label>
                                            <div class="flex items-center bg-black/30 rounded-xl px-3 border border-white/5 focus-within:border-emerald-500/50 transition-colors">
                                                <span class="text-emerald-500 font-bold mr-1">$</span>
                                                <input type="number" id="manualExtraPay" inputmode="decimal" class="bg-transparent w-full py-2.5 text-sm font-bold text-white focus:outline-none placeholder-zinc-700 font-mono text-right" placeholder="0" onblur="app.saveExtraPayValue(this.value)">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-zinc-600 font-bold uppercase block mb-1">Fecha Cobro</label>
                                            <input type="date" id="extraPayDateInput" onchange="app.saveExtraPayDate(this.value)" class="bg-black/30 w-full py-2.5 px-2 rounded-xl text-xs font-bold text-white border border-white/5 focus:outline-none focus:border-emerald-500/50 text-center cursor-pointer">
                                            <div class="text-[9px] text-zinc-500 text-right mt-1" id="daysToTuesday">-- días</div>
                                        </div>
                                    </div>
                                    <button id="btnImportExtras" onclick="app.importExtraMoney()" class="w-full bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 text-xs font-bold py-3 rounded-xl border border-emerald-500/20 transition-all flex items-center justify-center gap-2 active:scale-95">
                                        <i class="ph-bold ph-download-simple"></i> IMPORTAR AL SALDO
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                                    <div><span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Restante Total</span><span class="text-lg font-bold text-zinc-200" id="totalFree">---</span></div>
                                    <div class="text-right"><span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Gastado</span><span class="text-lg font-bold text-red-400" id="cycleSpent">---</span></div>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 h-1.5 bg-zinc-800 w-full">
                                <div id="periodProgress" class="h-full bg-gradient-to-r from-red-600 to-orange-600 shadow-[0_0_10px_rgba(239,68,68,0.5)] w-0 transition-all duration-1000 ease-out"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-1 gap-3 mb-6">
                            <button onclick="app.openModal('extra')" class="glass-highlight h-14 rounded-2xl text-emerald-500 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 md:hover:scale-105 hover:bg-emerald-500/10 border-transparent hover:border-emerald-500/30">
                                <i class="ph-bold ph-arrow-down-left text-lg"></i> INGRESO
                            </button>
                            <button onclick="app.openModal('expense')" class="glass-highlight h-14 rounded-2xl text-white font-bold text-xs flex items-center justify-center gap-2 transition-all hover:scale-105 hover:bg-red-600 hover:border-red-500 bg-red-600/10 border-red-600/30">
                                <i class="ph-bold ph-minus text-lg"></i> GASTO
                            </button>
                        </div>
                    </div>

                    <div class="md:col-span-7 lg:col-span-8">
                        <div class="mt-2 md:mt-0">
                            <div class="mb-4 px-1 md:p-3 md:rounded-xl">
                                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-3 md:mb-1">Actividad y Filtros</h3>
                                <div class="flex items-center gap-2">
                                    <div class="relative flex-1">
                                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 text-sm"></i>
                                        <input type="text" id="searchTx" placeholder="Buscar concepto o monto..." onkeyup="app.filterTransactions()" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl py-2 pl-9 pr-3 text-sm text-white focus:outline-none focus:border-zinc-600 placeholder-zinc-700 transition-colors">
                                    </div>
                                </div>
                            </div>

                            <div id="dateFilterDisplay" class="hidden mx-1 md:mx-0 p-3 mb-4 bg-red-600/10 border border-red-500/20 rounded-xl text-xs font-bold text-red-400 justify-between items-center animate-fade-in">
                                <span id="dateFilterLabel"></span>
                                <button onclick="app.clearDateFilter()" class="text-red-300 hover:text-white transition-colors flex items-center gap-1 uppercase tracking-wider">
                                    <i class="ph-bold ph-x text-sm"></i> Limpiar Filtro
                                </button>
                            </div>

                            <div id="transactionsList" class="space-y-3 min-h-[100px] pb-24 md:pb-0">
                                <div class="text-center py-10 text-zinc-600 animate-pulse">Sincronizando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISTA 2: PRÉSTAMOS (LOANS) -->
            <section id="view-loans" class="hidden p-4 sm:p-0 fade-in pb-24">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulario Nuevo Préstamo -->
                    <div>
                        <div class="glass p-6 rounded-[2rem] border border-emerald-500/20 shadow-lg shadow-emerald-900/10">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20">
                                    <i class="ph-bold ph-hand-coins text-emerald-500 text-xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-white">Nuevo Préstamo</h2>
                                    <p class="text-xs text-zinc-500">Registrar dinero entrante (Deuda)</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Fuente / Acreedor</label>
                                    <input type="text" id="loanSource" class="input-modern w-full p-4 h-12 text-sm placeholder-zinc-700" placeholder="Ej: Papá, Banco, Amigo...">
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto</label>
                                        <input type="number" id="loanAmount" inputmode="decimal" class="input-modern w-full p-4 h-12 text-sm font-bold text-emerald-400 placeholder-zinc-700" placeholder="$0">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Fecha Vencimiento</label>
                                        <input type="date" id="loanDeadline" class="input-modern w-full p-4 h-12 text-sm text-center cursor-pointer">
                                    </div>
                                </div>

                                <button onclick="app.saveLoan()" class="w-full bg-white hover:bg-zinc-200 text-black font-black py-4 rounded-xl mt-2 transition-all active:scale-95 shadow-lg flex items-center justify-center gap-2">
                                    <i class="ph-bold ph-floppy-disk"></i> GUARDAR PRÉSTAMO
                                </button>
                                
                                <p class="text-[10px] text-zinc-500 text-center leading-relaxed px-4">
                                    <i class="ph-fill ph-info text-emerald-500"></i> Al guardar, el dinero se sumará <b>inmediatamente</b> a tu Billetera y la deuda se registrará para el futuro.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Préstamos Activos -->
                    <div>
                         <div class="mb-4 flex items-center justify-between px-2">
                            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Préstamos Activos</h3>
                            <span class="text-xs font-bold text-white bg-zinc-800 px-2 py-1 rounded-lg border border-zinc-700" id="totalLoansAmount">$0.00</span>
                        </div>
                        <div id="loansList" class="space-y-3">
                            <div class="text-center py-10 text-zinc-700 text-xs italic">Sincronizando lista...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISTA 3: FUTURO (FUTURE) -->
            <section id="view-future" class="hidden p-4 sm:p-0 fade-in pb-24">
                <div class="max-w-2xl mx-auto">
                    <!-- Selector de Mes -->
                    <div class="glass rounded-full p-2 flex items-center justify-between mb-8 border border-zinc-800/50">
                        <button onclick="app.changeFutureMonth(-1)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-zinc-400 transition-colors">
                            <i class="ph-bold ph-caret-left text-lg"></i>
                        </button>
                        <div class="text-center">
                            <h2 id="futureDateLabel" class="text-lg font-bold text-white capitalize">---</h2>
                            <p class="text-[10px] text-zinc-500 font-mono tracking-widest uppercase">Calculadora de Liquidez</p>
                        </div>
                        <button onclick="app.changeFutureMonth(1)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-zinc-400 transition-colors">
                            <i class="ph-bold ph-caret-right text-lg"></i>
                        </button>
                    </div>

                    <!-- Tablero de Cálculo -->
                    <div class="glass rounded-[2rem] p-6 mb-8 relative overflow-hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div class="space-y-2">
                                <div>
                                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Ingreso Estimado</label>
                                    <div class="flex items-center bg-zinc-900 rounded-2xl px-4 border border-zinc-800 focus-within:border-emerald-500/50 transition-colors">
                                        <span class="text-emerald-500 font-bold mr-2 text-lg">+</span>
                                        <input type="number" id="futureIncomeInput" inputmode="decimal" class="bg-transparent w-full py-4 text-xl font-bold text-emerald-500 focus:outline-none placeholder-zinc-700 font-mono" placeholder="0" onkeyup="app.renderFuture()">
                                    </div>
                                </div>
                                <div class="bg-zinc-900/50 rounded-xl px-4 py-3 border border-zinc-800 flex justify-between items-center">
                                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-wide">Gastos Fijos</span>
                                    <span id="futureFixedSum" class="text-base font-bold text-zinc-300 font-mono">-$0.00</span>
                                </div>
                                <div class="bg-red-500/5 rounded-xl px-4 py-3 border border-red-500/10 flex justify-between items-center">
                                    <span class="text-xs font-bold text-red-400 uppercase tracking-wide">Deudas Mes</span>
                                    <span id="futureDebtSum" class="text-base font-bold text-red-400 font-mono">-$0.00</span>
                                </div>
                            </div>

                            <div class="text-center md:text-right border-t md:border-t-0 md:border-l border-white/5 pt-6 md:pt-0 md:pl-6">
                                <span class="text-[10px] text-zinc-500 uppercase tracking-widest font-bold block mb-2">Dinero Libre</span>
                                <div id="futureResult" class="text-5xl font-black text-white tracking-tighter transition-all duration-300">
                                    $0.00
                                </div>
                                <p class="text-[10px] text-zinc-600 mt-2 italic">Ingreso - Fijos - Deudas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Vencimientos -->
                    <div>
                        <div class="flex items-center gap-2 mb-4 px-2">
                             <i class="ph-fill ph-calendar-x text-zinc-500"></i>
                             <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Vencimientos del Mes</h3>
                        </div>
                        <div id="futureLoansList" class="space-y-2">
                             <!-- JS Renders here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISTA 4: PLANIFICACIÓN (PLAN) -->
            <section id="view-plan" class="hidden p-4 sm:p-0 fade-in max-w-2xl mx-auto pb-24">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-black text-white">Planificación</h2>
                        <p class="text-zinc-500 text-xs mt-1">Tus gastos fijos mensuales recurrentes.</p>
                    </div>
                    <div class="text-right">
                         <span class="block text-[10px] text-zinc-500 uppercase font-bold">Total Mensual</span>
                         <span id="planTotalFixed" class="text-xl font-bold text-white font-mono">$0.00</span>
                    </div>
                </div>
                
                <div id="planFixedList" class="space-y-3 mb-8">
                    <!-- Lista Renderizada por JS -->
                    <div class="text-center py-8 text-zinc-700 italic text-xs">Cargando lista...</div>
                </div>

                <button onclick="app.openModal('fixed')" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-bold py-4 rounded-2xl border border-zinc-700 border-dashed transition-all flex items-center justify-center gap-2 active:scale-95 group">
                    <div class="w-6 h-6 rounded-full bg-zinc-600 flex items-center justify-center group-hover:bg-white group-hover:text-black transition-colors">
                        <i class="ph-bold ph-plus"></i>
                    </div>
                    AGREGAR GASTO FIJO
                </button>
            </section>

        </div>
    </main>

    <!-- FAB (MÓVIL) -->
    <div id="fabContainer" class="md:hidden fixed bottom-[calc(85px+var(--sab))] left-1/2 -translate-x-1/2 z-40 transition-transform duration-300">
        <button onclick="app.openModal('expense')" class="w-14 h-14 bg-gradient-to-b from-red-600 to-red-700 rounded-full flex items-center justify-center text-white shadow-[0_8px_30px_rgba(220,38,38,0.4)] border-[4px] border-[#050505] active:scale-90 transition-transform duration-200 group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <i class="ph-bold ph-plus text-2xl group-hover:rotate-90 transition-transform duration-300 relative z-10"></i>
        </button>
    </div>

    <!-- NAV INFERIOR - MÓVIL (4 SECCIONES) -->
    <div class="md:hidden glass-nav fixed bottom-0 w-full grid grid-cols-4 z-50">
        <button class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('balance', this)">
            <div class="relative p-1"><i class="ph-fill ph-wallet text-xl group-[.active]:text-red-500 transition-colors duration-300"></i></div>
            <span class="text-[9px] font-bold group-[.active]:text-red-500 transition-colors">Billetera</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('loans', this)">
            <div class="relative p-1"><i class="ph-fill ph-hand-coins text-xl group-[.active]:text-red-500 transition-colors duration-300"></i></div>
            <span class="text-[9px] font-bold group-[.active]:text-red-500 transition-colors">Préstamos</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('future', this)">
            <div class="relative p-1"><i class="ph-fill ph-chart-line-up text-xl group-[.active]:text-red-500 transition-colors duration-300"></i></div>
            <span class="text-[9px] font-bold group-[.active]:text-red-500 transition-colors">Futuro</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('plan', this)">
            <div class="relative p-1"><i class="ph-fill ph-gear text-xl group-[.active]:text-red-500 transition-colors duration-300"></i></div>
            <span class="text-[9px] font-bold group-[.active]:text-red-500 transition-colors">Plan</span>
        </button>
    </div>

    <!-- MODAL DE NAVEGACIÓN MÓVIL -->
    <div class="modal fixed inset-0 w-screen h-screen z-[1000] hidden bg-black/80 backdrop-blur-sm" id="navModal" onclick="window.app.closeModalById('navModal')">
        <div class="absolute bottom-0 left-0 w-full bg-card rounded-t-2xl p-6 border-t border-white/5 animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <span class="font-bold text-lg text-white">Navegación</span>
                 <button onclick="window.app.closeModalById('navModal')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 text-zinc-400 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="grid gap-3">
                <a href="/corpo/index.html" class="p-3.5 rounded-xl bg-zinc-900/50 border border-white/5 hover:bg-white/5 text-zinc-400 hover:text-white font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-fill ph-check-circle text-lg"></i> ADHERENCIA
                </a>
                <a href="#" class="p-3.5 rounded-xl bg-brand/10 text-brand border border-brand/20 font-extrabold flex items-center gap-3 text-sm tracking-wide">
                    <i class="ph-bold ph-currency-dollar text-lg"></i> FINANZAS
                </a>
                <a href="/corpo/chat.html" class="p-3.5 rounded-xl bg-zinc-900/50 border border-white/5 hover:bg-white/5 text-zinc-400 hover:text-white font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-bold ph-chat-circle-dots text-lg"></i> CHAT
                </a>
                <a href="/corpo/casos.html" class="p-3.5 rounded-xl bg-zinc-900/50 border border-white/5 hover:bg-white/5 text-zinc-400 hover:text-white font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-bold ph-briefcase text-lg"></i> CASOS
                </a>
                <a href="/corpo/cuenta.html" class="p-3.5 rounded-xl bg-zinc-900/50 border border-white/5 hover:bg-white/5 text-zinc-400 hover:text-white font-bold flex items-center gap-3 transition-colors text-sm tracking-wide">
                    <i class="ph-bold ph-user-circle text-lg"></i> CUENTA
                </a>
            </div>
        </div>
    </div>

    <!-- MODAL PRINCIPAL FINANZAS -->
    <div id="modalOverlay" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet">
            <div class="md:hidden w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0"></div>
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#121212] z-10 pb-2 border-b border-transparent">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo</h3>
                <button onclick="app.closeModal()" class="w-10 h-10 rounded-full bg-zinc-900 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 transition-colors active:scale-90"><i class="ph-bold ph-x text-lg"></i></button>
            </div>

            <!-- Formularios de Transacción (Expense, Extra, Adjustment) -->
            <div id="formTransaction" class="hidden pb-4">
                <div class="relative mb-8 md:mb-2">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+60px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none">$</span>
                    <input type="number" id="txAmount" inputmode="decimal" class="bg-transparent text-center text-5xl md:text-3xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800 h-16 md:h-10" placeholder="0">
                </div>
                <div class="mb-6 md:mb-1" id="categorySelectionContainer">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-2 md:mb-1 block">Categoría</label>
                    <div id="categoryChips" class="flex flex-wrap gap-2.5 md:gap-1.5 no-scrollbar overflow-x-auto pb-2"></div>
                </div>
                <div class="mb-4 md:mb-2">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Fecha</label>
                    <input type="date" id="txDate" class="input-modern w-full p-4 text-center h-14 md:h-9 md:text-sm font-bold cursor-pointer">
                </div>
                <input type="text" id="txDesc" class="input-modern w-full p-4 mb-6 md:mb-3 text-center placeholder-zinc-600 h-14 md:h-9 md:text-sm" placeholder="Nota opcional...">
                <button id="btnSaveTx" onclick="app.saveTransaction()" class="w-full bg-white text-black py-4 md:py-0 rounded-2xl font-black text-lg hover:bg-zinc-200 transition-colors active:scale-95 shadow-lg shadow-white/10 h-16 md:h-10 md:text-sm">GUARDAR</button>
                <button id="btnDeleteTx" onclick="app.deleteTxConfirm()" class="w-full mt-4 text-red-500 py-3 font-bold text-xs hidden opacity-70 hover:opacity-100">ELIMINAR TRANSACCIÓN</button>
            </div>

            <!-- Formulario Gasto Fijo -->
            <div id="formFixed" class="hidden space-y-4 md:space-y-2 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Nombre del Gasto</label><input type="text" id="fixName" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm" placeholder="Ej: Renta, Netflix, Internet..."></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto Mensual</label><input type="number" id="fixAmount" inputmode="decimal" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm" placeholder="$0.00"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Día Pago</label><input type="number" id="fixDay" inputmode="numeric" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm text-center" placeholder="1-31"></div>
                </div>
                <button onclick="app.saveFixed()" class="w-full bg-white text-black py-4 md:py-0 rounded-2xl font-black mt-4 h-16 md:h-10 md:text-sm hover:bg-zinc-200">GUARDAR GASTO FIJO</button>
                <button id="btnDeleteFix" onclick="app.deleteFixedConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR DE LISTA</button>
            </div>

            <!-- Formulario Configuración -->
            <div id="formConfig" class="hidden space-y-4 pb-4">
                <p class="text-zinc-400 text-xs text-center mb-4">Define cómo y cuándo recibes tus ingresos.</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.setCycleMode('biweekly')" id="btnCycleBi" class="border border-zinc-700 p-4 rounded-2xl text-center transition-colors w-full h-32 md:h-20 flex flex-col items-center justify-center active:scale-95">
                        <i class="ph-bold ph-calendar-check text-3xl text-emerald-500 mb-2"></i>
                        <div class="font-bold text-sm text-white">Quincenal</div>
                        <div class="text-[10px] text-zinc-500 mt-1">2 Pagos al mes</div>
                    </button>
                    <button onclick="app.setCycleMode('monthly')" id="btnCycleMo" class="border border-zinc-700 p-4 rounded-2xl text-center transition-colors w-full h-32 md:h-20 flex flex-col items-center justify-center active:scale-95">
                        <i class="ph-bold ph-calendar text-3xl text-blue-500 mb-2"></i>
                        <div class="font-bold text-sm text-white">Mensual</div>
                        <div class="text-[10px] text-zinc-500 mt-1">Pago único (Día 1)</div>
                    </button>
                </div>
                <div id="customStartDayDiv" class="hidden mt-6">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block" id="lblStartDay">Día de Inicio</label>
                    <input type="number" id="configStartDay" class="input-modern w-full p-4 mt-1 text-center" placeholder="Día del mes (ej: 1, 5, 15)" value="1" min="1" max="28">
                    <p class="text-[10px] text-zinc-600 mt-2 text-center">Si eliges 10, tus cortes serán 10 y 25.</p>
                </div>
                <div class="mt-6 flex items-center justify-between bg-zinc-900/50 p-4 rounded-xl border border-zinc-800">
                    <div>
                        <div class="text-sm font-bold text-white">Módulo Adherencia</div>
                        <div class="text-xs text-zinc-500">Mostrar panel de horas extras</div>
                    </div>
                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggleAdh" id="adhToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-zinc-700 transition-all duration-300" onclick="app.toggleAdherenceModule()"/>
                        <label for="adhToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-zinc-800 cursor-pointer"></label>
                    </div>
                </div>
                <button onclick="app.saveCycleConfig()" class="w-full bg-white text-black py-4 md:py-0 rounded-2xl font-black mt-6 h-16 md:h-10 md:text-sm hover:bg-zinc-200">APLICAR CONFIGURACIÓN</button>
            </div>
        </div>
    </div>

    <!-- MODAL AUTH -->
    <div class="modal-auth" id="authModal">
        <div class="rounded-3xl p-6 bg-[#121212] border border-zinc-800 max-w-sm w-full mx-4 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-red-600 blur-md opacity-50"></div>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-red-500/20">
                    <i class="ph-fill ph-planet text-red-500 text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-1">GOD'S PLAN</h2>
                <p class="text-[10px] text-zinc-500 uppercase tracking-widest font-mono">Portal de Acceso</p>
            </div>
            <div class="auth-switch" id="auth-switch-container">
                <div class="auth-switch-glider"></div>
                <button onclick="app.toggleAuthMode('login')" id="tab-login" class="active">INGRESAR</button>
                <button onclick="app.toggleAuthMode('register')" id="tab-register">REGISTRARSE</button>
            </div>
            <form onsubmit="event.preventDefault(); app.handleAuthSubmit();" class="space-y-3">
                <div id="field-name" class="hidden"><input type="text" id="input-name" class="input-modern w-full p-3 pl-4 text-sm" placeholder="Tu Nombre"></div>
                <input type="text" id="input-id" class="input-modern w-full p-3 pl-4 text-sm" placeholder="ID o Email" required>
                <input type="password" id="input-pass" class="input-modern w-full p-3 pl-4 text-sm" placeholder="Contraseña" required>
                <div id="error-msg" class="hidden p-2.5 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-[10px] font-bold text-center flex items-center justify-center gap-2">
                    <i class="ph-fill ph-warning-circle"></i> <span id="error-txt">Error</span>
                </div>
                <button type="submit" id="btn-submit" class="w-full bg-white hover:bg-zinc-200 text-black py-3 rounded-xl font-black text-xs uppercase tracking-wider transition-colors flex items-center justify-center gap-2 group mt-2">
                    <span id="btn-text">INICIAR SESIÓN</span>
                    <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </form>
            <div class="relative my-4 text-center">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-zinc-800"></div></div>
                <span class="relative bg-[#121212] px-2 text-[9px] text-zinc-600 font-bold uppercase">O accede con</span>
            </div>
            <button onclick="app.loginGoogle()" class="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 text-xs">
                <i class="ph-bold ph-google-logo text-lg text-white"></i>
                <span>Google Account</span>
            </button>
        </div>
    </div>

    <!-- DIALOGO CONFIRMACION -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[2200] hidden flex items-center justify-center opacity-0 transition-opacity p-5">
        <div class="rounded-3xl p-6 bg-[#121212] border border-zinc-800 transform scale-95 transition-transform duration-200 w-full max-w-xs" id="confirmBox">
            <h4 id="confirmTitle" class="text-lg font-bold text-white mb-2">Confirmar</h4>
            <p id="confirmMessage" class="text-zinc-400 text-sm mb-8 leading-relaxed">¿Estás seguro?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="text-zinc-400 text-xs font-bold px-4 py-3 rounded-xl hover:bg-zinc-800 transition-colors uppercase tracking-wider flex-1 bg-zinc-900">Cancelar</button>
                <button id="confirmAction" class="bg-red-600 text-white text-xs font-bold px-4 py-3 rounded-xl hover:bg-red-700 transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20 flex-1">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, updateProfile, setPersistence, browserLocalPersistence, where } = window.firebaseImports;
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-finance';
        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7"
        };

        let fbApp, auth, db;
        try { 
            fbApp = initializeApp(firebaseConfig); 
            auth = getAuth(fbApp); 
            setPersistence(auth, browserLocalPersistence).catch(console.error);
            db = getFirestore(fbApp); 
        } catch(e) { console.error("Error initializing Firebase:", e); }

        const UI = {
            toast(msg, type='info') {
                const con = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'toast';
                const icons = { success: 'ph-check-circle text-emerald-400', error: 'ph-warning-circle text-red-400', info: 'ph-info text-blue-400' };
                el.innerHTML = `<i class="ph-fill ${icons[type]||icons.info} text-xl"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                con.appendChild(el); setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 3000);
            },
            fmtMoney(n) { return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n||0); },
            confirm(title, msg) {
                return new Promise(resolve => {
                    const d = document.getElementById('confirmDialog'); const box = document.getElementById('confirmBox');
                    document.getElementById('confirmTitle').textContent=title; document.getElementById('confirmMessage').textContent=msg;
                    const cleanup = (res) => { d.classList.add('opacity-0'); box.classList.remove('scale-100'); setTimeout(()=>{d.classList.add('hidden');},200); document.getElementById('confirmAction').onclick=null; document.getElementById('confirmCancel').onclick=null; resolve(res); };
                    document.getElementById('confirmAction').onclick=()=>cleanup(true); document.getElementById('confirmCancel').onclick=()=>cleanup(false);
                    d.classList.remove('hidden'); requestAnimationFrame(()=>{d.classList.remove('opacity-0'); box.classList.add('scale-100');});
                });
            }
        };

        const DefaultCategories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' },
            { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
            { id: 'Ocio', icon: 'ph-popcorn', color: 'text-purple-400' },
            { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' },
            { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Super', icon: 'ph-basket', color: 'text-emerald-400' },
            { id: 'Ajuste', icon: 'ph-scales', color: 'text-zinc-300' },
            { id: 'Préstamo', icon: 'ph-hand-coins', color: 'text-emerald-500' },
            { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
        ];

        const MX_HOLIDAYS = [
            '2024-01-01', '2024-02-05', '2024-03-18', '2024-05-01', '2024-09-16', '2024-10-01', '2024-11-18', '2024-12-25',
            '2025-01-01', '2025-02-03', '2025-03-17', '2025-05-01', '2025-09-16', '2025-11-17', '2025-12-25', '2026-01-01'
        ];

        window.app = {
            user: null,
            isRegistering: false,
            data: { income: 0, incomeQ2: 0, fixed: [], cycle: 'biweekly', startDay: 1, enableAdherence: true, extraPayAmount: 0 },
            logs: [],
            loans: [],
            currentPeriod: null,
            searchQuery: '',
            filterDate: null,
            currentWalletBalance: 0,
            isSimulating: false,
            currentFutureDate: new Date(), 
            
            init() {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        this.user = u; this.updateUserUI();
                        document.getElementById('authModal').classList.remove('active');
                        this.setupListeners();
                        document.getElementById('importFile').addEventListener('change', (e) => this.handleImport(e));
                        
                        // Default future date to next month for utility
                        const nextMonth = new Date();
                        nextMonth.setMonth(nextMonth.getMonth() + 1);
                        this.currentFutureDate = nextMonth;
                        
                    } else {
                         document.getElementById('authModal').classList.add('active');
                    }
                });
            },

            toggleAuthMode(mode) {
                this.isRegistering = (mode === 'register');
                const container = document.getElementById('auth-switch-container');
                const btnText = document.getElementById('btn-text');
                const nameField = document.getElementById('field-name');
                const errorMsg = document.getElementById('error-msg');
                
                document.getElementById('tab-login').classList.toggle('active', !this.isRegistering);
                document.getElementById('tab-register').classList.toggle('active', this.isRegistering);
                container.classList.toggle('auth-mode-register', this.isRegistering);
                errorMsg.classList.add('hidden');

                if(this.isRegistering) {
                    btnText.textContent = "CREAR CUENTA";
                    nameField.classList.remove('hidden');
                } else {
                    btnText.textContent = "INICIAR SESIÓN";
                    nameField.classList.add('hidden');
                }
            },

            async handleAuthSubmit() {
                const btn = document.getElementById('btn-submit');
                const errMsg = document.getElementById('error-msg');
                const errTxt = document.getElementById('error-txt');
                
                let id = document.getElementById('input-id').value.trim();
                const pass = document.getElementById('input-pass').value;
                const name = document.getElementById('input-name').value.trim();

                if (!id || !pass) return this.showAuthError("Completa todos los campos");
                if (this.isRegistering && !name) return this.showAuthError("El nombre es obligatorio");
                if (!id.includes('@')) id = `${id}@godsplan.site`;

                btn.disabled = true;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> PROCESANDO...';
                errMsg.classList.add('hidden');

                try {
                    if (this.isRegistering) {
                        const userCredential = await createUserWithEmailAndPassword(auth, id, pass);
                        await updateProfile(userCredential.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, id, pass);
                    }
                } catch (error) {
                    this.showAuthError(error.message);
                    btn.disabled = false;
                    btn.innerHTML = `<span id="btn-text">${this.isRegistering ? 'CREAR CUENTA' : 'INICIAR SESIÓN'}</span> <i class="ph-bold ph-arrow-right"></i>`;
                }
            },

            async loginGoogle() {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (error) { this.showAuthError("Error con Google."); }
            },

            showAuthError(msg) {
                const errMsg = document.getElementById('error-msg');
                const errTxt = document.getElementById('error-txt');
                errTxt.textContent = msg;
                errMsg.classList.remove('hidden');
            },

            logout() { if(confirm("¿Salir?")) signOut(auth).then(() => window.location.reload()); },

            updateUserUI() {
                const badge = document.getElementById('user-badge');
                if (this.user) {
                      badge.classList.remove('hidden'); badge.classList.add('flex');
                      document.getElementById('user-name').textContent = this.user.displayName || this.user.email.split('@')[0];
                } else {
                    badge.classList.add('hidden'); badge.classList.remove('flex');
                }
            },

            setupListeners() {
                const uid = this.user.uid;
                const userRef = doc(db, 'users', uid, 'finance', 'data');
                const logsRef = collection(db, 'users', uid, 'finance', 'data', 'transactions');
                const loansRef = collection(db, 'users', uid, 'finance', 'data', 'loans');
                
                onSnapshot(userRef, (snap) => {
                    if(snap.exists()) {
                        this.data = { income: 0, incomeQ2: 0, fixed: [], cycle: 'biweekly', startDay: 1, enableAdherence: true, extraPayAmount: 0, ...snap.data() };
                        
                        const adhToggle = document.getElementById('adhToggle');
                        if (adhToggle) adhToggle.checked = this.data.enableAdherence !== false;
                        
                        const extraPayInput = document.getElementById('manualExtraPay');
                        if (extraPayInput) extraPayInput.value = this.data.extraPayAmount > 0 ? this.data.extraPayAmount : '';

                        this.renderPlan(); // Nuevo render para la pestaña Planificación
                        this.calcPeriod();
                        this.updateExtraUI();
                        
                        // Set default future income to user's base income if not set manually yet
                        if (!document.getElementById('futureIncomeInput').value && this.data.income) {
                             document.getElementById('futureIncomeInput').value = this.data.income;
                        }

                    } else setDoc(userRef, { income: 0, fixed: [] });
                });
                
                const q = query(logsRef, orderBy('date', 'desc'), limit(150));
                onSnapshot(q, (snap) => {
                    this.logs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                    this.calcBalance();
                    this.renderTransactions();
                });

                // Escuchar Préstamos Activos
                const qLoans = query(loansRef);
                onSnapshot(qLoans, (snap) => {
                    const allLoans = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    // Filtrar y ordenar en memoria para evitar índices compuestos
                    this.loans = allLoans
                        .filter(l => l.status === 'active')
                        .sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                    this.renderLoans();
                    this.renderFuture(); // Actualizar vista futuro si cambian los préstamos
                });
            },

            renderLoans() {
                const list = document.getElementById('loansList');
                const totalLabel = document.getElementById('totalLoansAmount');
                list.innerHTML = '';
                
                let total = 0;
                if (this.loans.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-zinc-700 text-xs italic">No hay préstamos activos.</div>';
                } else {
                    this.loans.forEach(loan => {
                        total += parseFloat(loan.amount);
                        const deadline = new Date(loan.deadline + 'T12:00:00');
                        const now = new Date();
                        const diffTime = deadline - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        let daysText = diffDays > 0 ? `Vence en ${diffDays} días` : (diffDays === 0 ? 'Vence Hoy' : `Vencido hace ${Math.abs(diffDays)} días`);
                        let daysColor = diffDays < 3 ? 'text-red-400' : 'text-zinc-500';

                        list.innerHTML += `
                        <div class="flex items-center justify-between p-4 bg-zinc-900/50 border border-zinc-800 rounded-2xl">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center text-zinc-400">
                                    <i class="ph-bold ph-user"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-zinc-200">${loan.source}</div>
                                    <div class="text-[10px] ${daysColor} font-bold uppercase tracking-wider">${daysText}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white text-sm">${UI.fmtMoney(loan.amount)}</div>
                                <div class="text-[10px] text-zinc-600">${new Date(loan.deadline).toLocaleDateString('es-MX', {day:'numeric', month:'short'})}</div>
                            </div>
                        </div>`;
                    });
                }
                totalLabel.textContent = UI.fmtMoney(total);
            },

            // --- FUTURE MODULE LOGIC START ---
            changeFutureMonth(delta) {
                const newDate = new Date(this.currentFutureDate);
                newDate.setMonth(newDate.getMonth() + delta);
                this.currentFutureDate = newDate;
                this.renderFuture();
            },

            renderFuture() {
                const month = this.currentFutureDate.getMonth();
                const year = this.currentFutureDate.getFullYear();
                
                // 1. Update Label
                const dateLabel = this.currentFutureDate.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
                document.getElementById('futureDateLabel').textContent = dateLabel;

                // 2. Filter Loans for this specific month/year
                const loansInMonth = this.loans.filter(l => {
                    const d = new Date(l.deadline + 'T12:00:00');
                    return d.getMonth() === month && d.getFullYear() === year;
                });

                // 3. Calc Sum of Debts
                const totalDebt = loansInMonth.reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
                document.getElementById('futureDebtSum').textContent = `-${UI.fmtMoney(totalDebt)}`;

                // 4. Calc Sum of Fixed Expenses (From Plan)
                const totalFixed = (this.data.fixed || []).reduce((acc, curr) => acc + parseFloat(curr.amount || 0), 0);
                document.getElementById('futureFixedSum').textContent = `-${UI.fmtMoney(totalFixed)}`;

                // 5. Get Projected Income
                const projectedIncome = parseFloat(document.getElementById('futureIncomeInput').value) || 0;

                // 6. Calc Result (Free Money)
                const freeMoney = projectedIncome - totalFixed - totalDebt;
                const resultEl = document.getElementById('futureResult');
                resultEl.textContent = UI.fmtMoney(freeMoney);
                
                if(freeMoney < 0) {
                      resultEl.className = 'text-5xl font-black text-red-500 tracking-tighter transition-all duration-300';
                } else {
                      resultEl.className = 'text-5xl font-black text-emerald-500 tracking-tighter transition-all duration-300';
                }

                // 7. Render Detail List
                const listEl = document.getElementById('futureLoansList');
                listEl.innerHTML = '';
                
                if (loansInMonth.length === 0) {
                    listEl.innerHTML = `<div class="p-4 rounded-xl border border-dashed border-zinc-800 text-center text-zinc-600 text-xs">Sin deudas registradas para ${dateLabel}.</div>`;
                } else {
                    loansInMonth.sort((a,b) => new Date(a.deadline) - new Date(b.deadline)).forEach(loan => {
                        const day = new Date(loan.deadline + 'T12:00:00').getDate();
                        listEl.innerHTML += `
                            <div class="flex items-center justify-between p-3 bg-zinc-900 border border-zinc-800 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-red-500/10 flex items-center justify-center text-red-500 font-bold text-xs border border-red-500/20">
                                        ${day}
                                    </div>
                                    <span class="text-sm font-bold text-zinc-300">${loan.source}</span>
                                </div>
                                <span class="text-sm font-mono text-red-400 font-bold">-${UI.fmtMoney(loan.amount)}</span>
                            </div>
                        `;
                    });
                }
            },
            // --- FUTURE MODULE LOGIC END ---

            async saveLoan() {
                const source = document.getElementById('loanSource').value.trim();
                const amount = parseFloat(document.getElementById('loanAmount').value);
                const deadline = document.getElementById('loanDeadline').value;

                if (!source) return UI.toast('Ingresa la fuente del préstamo', 'error');
                if (isNaN(amount) || amount <= 0) return UI.toast('Ingresa un monto válido', 'error');
                if (!deadline) return UI.toast('Ingresa la fecha de pago', 'error');

                const batch = writeBatch(db);
                
                // 1. Crear referencia para la transacción en billetera
                const txRef = doc(collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions'));
                const now = new Date();
                
                batch.set(txRef, {
                    amount: amount,
                    category: 'Préstamo',
                    desc: `Préstamo de ${source}`,
                    type: 'income',
                    date: now.toISOString()
                });

                // 2. Crear referencia para el registro de deuda en base de datos aparte
                const loanRef = doc(collection(db, 'users', this.user.uid, 'finance', 'data', 'loans'));
                batch.set(loanRef, {
                    source: source,
                    amount: amount,
                    deadline: deadline,
                    createdAt: now.toISOString(),
                    status: 'active',
                    relatedTxId: txRef.id
                });

                try {
                    await batch.commit();
                    UI.toast('Préstamo registrado correctamente', 'success');
                    
                    // Limpiar formulario solamente (NO cambiar de vista para ver la lista actualizarse)
                    document.getElementById('loanSource').value = '';
                    document.getElementById('loanAmount').value = '';
                    document.getElementById('loanDeadline').value = '';
                    
                } catch (e) {
                    console.error(e);
                    UI.toast('Error al guardar préstamo', 'error');
                }
            },

            toggleExtrasMenu() {
                const menu = document.getElementById('extraMenu');
                const icon = document.getElementById('extraMenuIcon');
                menu.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            },

            updateExtraUI() {
                const triggerBtn = document.getElementById('extraMenuTrigger');
                const menu = document.getElementById('extraMenu');
                const icon = document.getElementById('extraMenuIcon');
                if (this.data.enableAdherence === false) {
                    triggerBtn.classList.add('pointer-events-none');
                    icon.classList.add('hidden');
                    menu.classList.add('hidden');
                } else {
                    triggerBtn.classList.remove('pointer-events-none');
                    icon.classList.remove('hidden');
                }
                this.pendingExtraPay = this.data.extraPayAmount || 0;
                this.resolvePayDate();
            },

            resolvePayDate() {
                const input = document.getElementById('extraPayDateInput');
                const badge = document.getElementById('daysToTuesday');
                if (this.data.nextExtraPayDate) {
                    const savedDate = new Date(this.data.nextExtraPayDate + 'T12:00:00');
                    const now = new Date();
                    const daysDiff = Math.ceil((savedDate - now) / (1000 * 60 * 60 * 24));
                    input.value = this.data.nextExtraPayDate;
                    badge.textContent = daysDiff === 0 ? '¡Es Hoy!' : (daysDiff < 0 ? 'Pasado' : `Faltan ${daysDiff} días`);
                } else {
                    input.value = new Date().toISOString().split('T')[0];
                    badge.textContent = `Sin fecha`;
                }
            },

            async saveExtraPayDate(val) { await updateDoc(doc(db,'users',this.user.uid,'finance','data'), { nextExtraPayDate: val }); this.resolvePayDate(); },
            async saveExtraPayValue(val) { const amount = parseFloat(val) || 0; await updateDoc(doc(db,'users',this.user.uid,'finance','data'), { extraPayAmount: amount }); this.calcBalance(); },
            toggleAdherenceModule() { const isEnabled = document.getElementById('adhToggle').checked; updateDoc(doc(db,'users',this.user.uid,'finance','data'), { enableAdherence: isEnabled }); },
            toggleSimulation() { this.isSimulating = document.getElementById('simToggle').checked; this.calcBalance(); },
            
            async importExtraMoney() {
                const amount = this.data.extraPayAmount || 0;
                if (amount <= 0) return UI.toast('Monto debe ser mayor a 0', 'error');
                if (await UI.confirm('Importar Dinero', `¿Registrar ingreso de ${UI.fmtMoney(amount)}?`)) {
                    await addDoc(collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions'), {
                        amount: amount, desc: `Cobro Extra`, category: 'Otro', type: 'income', date: new Date().toISOString()
                    });
                    UI.toast('Dinero sumado a billetera', 'success');
                }
            },

            getNextBusinessDay(date) {
                let d = new Date(date);
                for(let i=0; i<14; i++) {
                    const day = d.getDay();
                    const dateStr = d.toISOString().split('T')[0];
                    if (day === 0) { d.setDate(d.getDate() + 1); continue; }
                    if (day === 6) { d.setDate(d.getDate() + 2); continue; }
                    if (MX_HOLIDAYS.includes(dateStr)) { d.setDate(d.getDate() + 1); continue; }
                    return d;
                }
                return d;
            },

            getCycleParams(dateInput) {
                const d = new Date(dateInput);
                const day = d.getDate();
                const m = d.getMonth();
                const y = d.getFullYear();
                const startDay = this.data.startDay || 1;
                let start, end;
                let isQ2 = false;
                
                if (this.data.cycle === 'monthly') {
                    if (day >= startDay) { start = new Date(y, m, startDay); end = new Date(y, m + 1, startDay - 1); } 
                    else { start = new Date(y, m - 1, startDay); end = new Date(y, m, startDay - 1); }
                } else {
                    const midDay = startDay + 15;
                    if (day >= startDay && day < midDay) { start = new Date(y, m, startDay); end = new Date(y, m, midDay - 1); } 
                    else {
                        if (day >= midDay) { start = new Date(y, m, midDay); end = new Date(y, m + 1, startDay - 1); } 
                        else { start = new Date(y, m - 1, midDay); end = new Date(y, m, startDay - 1); }
                        isQ2 = true;
                    }
                }
                start = this.getNextBusinessDay(start);
                end = this.getNextBusinessDay(end);
                start.setHours(0,0,0,0);
                end.setHours(23,59,59,999);
                return { start, end, isQ2 };
            },

            calcPeriod() {
                const now = new Date();
                const cycle = this.getCycleParams(now);
                const totalMs = cycle.end - cycle.start;
                const elapsed = now - cycle.start;
                const progress = Math.min(100, Math.max(0, (elapsed / totalMs) * 100));
                const daysLeft = Math.ceil((cycle.end - now) / (86400000));
                this.currentPeriod = { start: cycle.start, end: cycle.end, daysLeft: Math.max(1, daysLeft), progress };
                document.getElementById('periodDates').innerHTML = `<span class="text-zinc-400 text-sm font-normal">${cycle.start.getDate()} ${cycle.start.toLocaleString('es',{month:'short'})}</span> <i class="ph-bold ph-arrow-right text-zinc-600 text-xs"></i> <span class="text-white text-sm">${cycle.end.getDate()} ${cycle.end.toLocaleString('es',{month:'short'})}</span>`;
                document.getElementById('daysLeftBadge').textContent = `Faltan ${this.currentPeriod.daysLeft} días`;
                document.getElementById('periodProgress').style.width = `${progress}%`;
                this.calcBalance();
            },

            calcBalance() {
                if(!this.currentPeriod) return;
                const { start: pStart, end: pEnd } = this.currentPeriod;
                const periodLogs = this.logs.filter(l => { const d = new Date(l.date); return d >= pStart && d <= pEnd; });
                const todayStr = new Date().toDateString();
                const todaySpent = periodLogs.filter(l => l.type === 'expense' && l.category !== 'Ajuste' && new Date(l.date).toDateString() === todayStr).reduce((a, b) => a + b.amount, 0);
                let totalSpentInCycle = 0; let extraInc = 0;
                periodLogs.forEach(l => { if(l.type === 'income') extraInc += l.amount; else totalSpentInCycle += l.amount; });
                if (this.isSimulating) { extraInc += (this.data.extraPayAmount || 0); }
                let fixedReserve = 0;
                const fixedStatus = [];
                (this.data.fixed || []).forEach(f => {
                    const amount = parseFloat(f.amount) || 0;
                    const day = parseInt(f.day); let triggers = false;
                    const d1 = new Date(pStart.getFullYear(), pStart.getMonth(), day);
                    const d2 = new Date(pStart.getFullYear(), pStart.getMonth() + 1, day);
                    if ((d1 >= pStart && d1 <= pEnd) || (d2 >= pStart && d2 <= pEnd)) triggers = true;
                    if (triggers) {
                        const isPaid = periodLogs.some(l => (l.meta_related_fixed && l.meta_related_fixed === f.name) || (l.type === 'expense' && (l.desc || '').toLowerCase().includes(f.name.toLowerCase()) && l.amount > 0));
                        fixedStatus.push({ name: f.name, paid: isPaid });
                        if (!isPaid) fixedReserve += amount;
                    } else {
                        fixedStatus.push({ name: f.name, paid: 'n/a' });
                    }
                });
                
                // NO UPDATE FIXED UI HERE (Only for Home view logic if needed, but we removed visual list from Home)

                let baseInc = parseFloat(this.data.income) || 0;
                if (this.data.cycle === 'biweekly') {
                    const pStartDay = this.currentPeriod.start.getDate();
                    const triggerQ2 = (this.data.startDay || 1) + 14;
                    if (pStartDay >= triggerQ2) { baseInc = parseFloat(this.data.incomeQ2) || baseInc; }
                }
                
                const liquidIncome = (baseInc + extraInc);
                const remainingTotal = liquidIncome - fixedReserve - totalSpentInCycle;
                
                const daysLeft = this.currentPeriod.daysLeft;
                const virtualAvailableStartOfDay = remainingTotal + todaySpent;
                const dailyLimit = virtualAvailableStartOfDay / daysLeft;
                const balanceToday = dailyLimit - todaySpent;
                
                this.currentWalletBalance = remainingTotal;
                
                // UI UPDATE
                const dailyEl = document.getElementById('dailyFree');
                const labelState = document.getElementById('labelDailyState');
                const cardBg = document.getElementById('mainCardBg');
                const mainCard = document.getElementById('mainCard');
                mainCard.style.border = ''; mainCard.style.boxShadow = '';
                dailyEl.textContent = UI.fmtMoney(balanceToday);
                
                if (this.isSimulating) {
                    cardBg.className = 'absolute -top-10 -right-10 w-32 h-32 rounded-full blur-3xl transition-colors duration-500 bg-emerald-500/40 animate-pulse';
                    labelState.textContent = 'SIMULACIÓN ACTIVA';
                    labelState.className = 'text-xs font-bold text-emerald-400 uppercase tracking-widest transition-colors';
                    dailyEl.className = 'text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black tracking-tighter mb-2 break-all relative leading-none transition-colors text-emerald-400 font-black';
                    mainCard.style.border = '1px solid rgba(16, 185, 129, 0.3)';
                    mainCard.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(16, 185, 129, 0.1)';
                } else if (balanceToday < 0) {
                    cardBg.className = 'absolute -top-10 -right-10 w-32 h-32 bg-red-600/50 rounded-full blur-3xl transition-colors duration-500 animate-pulse-red';
                    labelState.textContent = 'EXCEDIDO HOY';
                    labelState.className = 'text-xs font-black text-red-500 uppercase tracking-widest';
                    dailyEl.className = 'text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black tracking-tighter mb-2 break-all relative leading-none transition-colors text-red-500 animate-pulse font-black';
                } else {
                    cardBg.className = 'absolute -top-10 -right-10 w-32 h-32 bg-red-600/20 rounded-full blur-3xl transition-colors duration-500';
                    labelState.textContent = 'DISPONIBLE HOY';
                    labelState.className = 'text-xs font-bold text-zinc-400 uppercase tracking-widest transition-colors group-hover:text-white';
                    dailyEl.className = 'text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black tracking-tighter mb-2 break-all relative leading-none transition-colors text-white font-black';
                }
                
                document.getElementById('valDailyLimit').textContent = UI.fmtMoney(dailyLimit);
                document.getElementById('valTodaySpent').textContent = UI.fmtMoney(todaySpent);
                document.getElementById('totalFree').textContent = UI.fmtMoney(remainingTotal);
                document.getElementById('totalFree').className = remainingTotal < 0 ? 'text-lg font-bold text-red-500' : 'text-lg font-bold text-zinc-200';
                document.getElementById('cycleSpent').textContent = `-${UI.fmtMoney(totalSpentInCycle)}`;
                
                this.renderTransactions();
            },

            setFilterDate(dateString) {
                if (!dateString) return;
                this.filterDate = dateString;
                this.renderTransactions();
                const displayEl = document.getElementById('dateFilterDisplay');
                const labelEl = document.getElementById('dateFilterLabel');
                const [y, m, d] = dateString.split('-').map(Number);
                const dateObj = new Date(y, m-1, d);
                labelEl.textContent = `Filtro Activo: ${dateObj.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}`;
                displayEl.classList.remove('hidden'); displayEl.classList.add('flex');
            },

            clearDateFilter() {
                this.filterDate = null;
                document.getElementById('dateFilterDisplay').classList.remove('flex');
                document.getElementById('dateFilterDisplay').classList.add('hidden');
                this.renderTransactions();
                UI.toast('Filtro de fecha eliminado', 'info');
            },

            groupTransactionsByDate(logs) {
                const groups = {};
                logs.forEach(log => {
                    const date = new Date(log.date);
                    const sortKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    if (!groups[sortKey]) { groups[sortKey] = { txs: [], income: 0, expense: 0, date: date }; }
                    groups[sortKey].txs.push(log);
                    if (log.type === 'income') groups[sortKey].income += log.amount;
                    else groups[sortKey].expense += log.amount;
                });
                return groups;
            },

            renderTransactions() {
                const list = document.getElementById('transactionsList'); list.innerHTML = '';
                let visibleLogs = this.logs;
                if(this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    visibleLogs = visibleLogs.filter(l => (l.desc||'').toLowerCase().includes(q) || (l.category||'').toLowerCase().includes(q) || l.amount.toString().includes(q));
                }
                if(this.filterDate) {
                    visibleLogs = visibleLogs.filter(l => {
                        const txDate = new Date(l.date);
                        const [y, m, d] = this.filterDate.split('-').map(Number);
                        return txDate.getFullYear() === y && txDate.getMonth() === m-1 && txDate.getDate() === d;
                    });
                }
                if(!visibleLogs.length) {
                    list.innerHTML = `<div class="text-center py-6 text-zinc-600 text-xs italic">No hay movimientos${this.filterDate || this.searchQuery ? ' para estos filtros.' : '.'}</div>`;
                    return;
                }
                const cats = DefaultCategories;
                const groupedLogs = this.groupTransactionsByDate(visibleLogs);
                const sortedDates = Object.keys(groupedLogs).sort((a, b) => b.localeCompare(a));
                sortedDates.forEach(dateKey => {
                    const group = groupedLogs[dateKey];
                    const dayName = group.date.toLocaleDateString('es-MX', { weekday: 'long' });
                    const formattedDate = group.date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
                    list.innerHTML += `
                        <div class="daily-summary-header flex justify-between items-end px-2 mt-6 mb-2 pb-2 border-b border-white/5">
                            <div class="flex flex-col">
                                <h3 class="text-base font-bold text-zinc-200 capitalize">${dayName}</h3>
                                <p class="text-[11px] text-zinc-500 font-medium">${formattedDate}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-3">
                                     ${group.income > 0 ? `<span class="text-xs font-bold text-emerald-500 font-mono bg-emerald-500/10 px-2 py-1 rounded-md">+${UI.fmtMoney(group.income)}</span>` : ''}
                                    <span class="text-sm font-bold text-red-400 font-mono bg-red-500/10 px-2 py-1 rounded-md">-${UI.fmtMoney(group.expense)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    list.innerHTML += `
                    <div class="space-y-1">
                        ${group.txs.map(l => {
                            const isInc = l.type === 'income';
                            const cat = cats.find(c=>c.id === l.category) || {icon:'ph-question',color:'text-gray-500'};
                            const icon = isInc ? 'ph-arrow-down-left' : cat.icon;
                            const color = isInc ? 'text-emerald-500' : cat.color;
                            const isFixedLink = l.meta_related_fixed ? '<i class="ph-bold ph-link text-zinc-600 ml-1" title="Vinculado a Gasto Fijo"></i>' : '';
                            const time = new Date(l.date).toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
                            return `
                            <div onclick="app.openModal('${isInc?'extra':'expense'}','${l.id}')" class="flex justify-between items-center p-3 rounded-xl hover:bg-zinc-900/50 transition-colors cursor-pointer border border-transparent hover:border-zinc-800 group active:scale-[0.99] active:bg-zinc-900 md:bg-zinc-900/20">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform md:bg-black"><i class="ph-fill ${icon} ${color} text-xl"></i></div>
                                    <div class="min-w-0">
                                        <h4 class="font-bold text-zinc-300 text-sm truncate flex items-center">${l.desc || l.category || 'Movimiento'} ${isFixedLink}</h4>
                                        <p class="text-xs text-zinc-500">${time}</p>
                                    </div>
                                </div>
                                <span class="font-bold text-base ${isInc?'text-emerald-500':'text-zinc-300'} whitespace-nowrap">${isInc?'+':'-'}${UI.fmtMoney(l.amount)}</span>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    `;
                });
            },

            renderPlan() {
                const el = document.getElementById('planFixedList');
                const totalEl = document.getElementById('planTotalFixed');
                if(!el) return;
                
                el.innerHTML='';
                const fixedList = (this.data.fixed || []).sort((a,b)=>a.day-b.day);
                let total = 0;

                fixedList.forEach((f,i) => {
                    total += parseFloat(f.amount || 0);
                    el.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-zinc-900/50 border border-zinc-800 rounded-2xl mb-2 active:scale-[0.99] transition-transform hover:border-zinc-700 cursor-pointer group" onclick="app.openModal('fixed', ${i})">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center font-bold text-sm text-zinc-400 group-hover:bg-zinc-700 transition-colors">${f.day}</div>
                            <div class="min-w-0">
                                <div class="font-bold text-sm text-zinc-200 truncate group-hover:text-white">${f.name}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-sm font-bold text-white font-mono">${UI.fmtMoney(f.amount)}</div>
                            <i class="ph-bold ph-pencil-simple text-zinc-600 group-hover:text-zinc-400"></i>
                        </div>
                    </div>`;
                });

                if(fixedList.length === 0) { 
                    el.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-zinc-600 border-2 border-dashed border-zinc-800 rounded-2xl">
                        <i class="ph-bold ph-list-plus text-4xl mb-2 text-zinc-700"></i>
                        <span class="text-xs italic">Añade tus gastos fijos aquí<br>(Renta, Luz, Suscripciones)</span>
                    </div>`; 
                }
                
                totalEl.textContent = UI.fmtMoney(total);
                
                // Actualizar también la vista de Futuro si está visible
                if(!document.getElementById('view-future').classList.contains('hidden')) {
                    this.renderFuture();
                }
            },

            openModal(type, id=null) {
                this.modalType = type; this.editId = id;
                document.querySelectorAll('#modalSheet > div[id^="form"]').forEach(d => d.classList.add('hidden'));
                document.getElementById('modalOverlay').classList.add('is-open');
                const title = document.getElementById('modalTitle');
                document.getElementById('categorySelectionContainer').classList.remove('hidden');
                
                if(type === 'expense' || type === 'extra' || type === 'adjustment') {
                    document.getElementById('formTransaction').classList.remove('hidden');
                    if (type === 'expense') title.textContent = 'Registrar Gasto';
                    else if (type === 'extra') title.textContent = 'Ingreso Extra';
                    else if (type === 'adjustment') {
                        title.textContent = 'Ajuste de Saldo';
                        document.getElementById('categorySelectionContainer').classList.add('hidden');
                    }
                    const chips = document.getElementById('categoryChips');
                    chips.innerHTML = DefaultCategories.map(c => `
                        <div onclick="app.selCat(this)" class="chip bg-zinc-900 px-5 py-3 rounded-full text-xs font-bold text-zinc-400 cursor-pointer border border-zinc-800 hover:border-zinc-600 flex items-center gap-2 transition-all">
                            <i class="ph-fill ${c.icon} ${c.color} text-lg"></i>
                            <span>${c.id}</span>
                        </div>
                    `).join('');
                    const log = id ? this.logs.find(l=>l.id===id) : null;
                    document.getElementById('txAmount').value = log ? log.amount : '';
                    document.getElementById('txDesc').value = log ? log.desc : '';
                    let dateVal = new Date().toISOString().split('T')[0];
                    if (log) {
                         const d = new Date(log.date);
                         dateVal = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                    }
                    document.getElementById('txDate').value = dateVal;
                    document.getElementById('btnDeleteTx').classList.toggle('hidden', !log);
                    if (type === 'adjustment') {
                        document.getElementById('txAmount').placeholder = "Saldo Real Actual";
                        document.getElementById('txDesc').placeholder = "Motivo del ajuste (opcional)";
                    } else {
                        document.getElementById('txAmount').placeholder = "0";
                        document.getElementById('txDesc').placeholder = "Nota opcional...";
                    }
                    if(log) { setTimeout(()=> { Array.from(chips.children).find(c => c.querySelector('span')?.textContent.trim() === log.category)?.classList.add('active'); }, 50); } 
                    else if (type === 'expense') { setTimeout(()=> { chips.children[0]?.classList.add('active') }, 50); }
                }
                else if (type === 'fixed') {
                    document.getElementById('formFixed').classList.remove('hidden'); title.textContent = 'Gasto Fijo';
                    const f = id !== null ? this.data.fixed[id] : {};
                    document.getElementById('fixName').value = f.name||''; document.getElementById('fixAmount').value=f.amount||''; document.getElementById('fixDay').value=f.day||'';
                    document.getElementById('btnDeleteFix').classList.toggle('hidden', id===null);
                }
                else if (type === 'config') {
                    document.getElementById('formConfig').classList.remove('hidden'); title.textContent = 'Configuración Ciclo';
                    const currentMode = this.data.cycle || 'biweekly';
                    this.setCycleMode(currentMode);
                    document.getElementById('configStartDay').value = this.data.startDay || 1;
                }
            },

            closeModal() { document.getElementById('modalOverlay').classList.remove('is-open'); },
            selCat(el) { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); },
            
            async saveTransaction() {
                const amtVal = parseFloat(document.getElementById('txAmount').value);
                const desc = document.getElementById('txDesc').value;
                const catEl = document.querySelector('.chip.active');
                let cat = catEl ? catEl.innerText.trim() : 'Otro';
                const dateVal = document.getElementById('txDate').value;
                if(isNaN(amtVal)) return UI.toast('Ingresa un monto válido','error');
                if(!dateVal) return UI.toast('Fecha requerida','error');
                const [y, m, d] = dateVal.split('-').map(Number);
                const now = new Date();
                const finalDate = new Date(y, m-1, d, now.getHours(), now.getMinutes());
                const payload = { desc, date: finalDate.toISOString() };
                if (this.modalType === 'adjustment') {
                    const diff = amtVal - this.currentWalletBalance;
                    if (Math.abs(diff) < 0.01) return UI.toast('El saldo ya cuadra con el sistema', 'success');
                    payload.amount = Math.abs(diff);
                    payload.type = diff > 0 ? 'income' : 'expense';
                    payload.category = 'Ajuste';
                    payload.desc = desc || 'Ajuste Manual de Saldo';
                } else {
                    payload.amount = amtVal;
                    payload.category = cat;
                    payload.type = this.modalType === 'extra' ? 'income' : 'expense';
                }
                const ref = collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions');
                if(this.editId) await updateDoc(doc(ref, this.editId), payload);
                else await addDoc(ref, payload);
                UI.toast(this.modalType === 'adjustment' ? 'Saldo Ajustado' : 'Guardado', 'success');
                this.closeModal();
            },

            async saveFixed() {
                const arr = [...(this.data.fixed||[])];
                const item = { name: document.getElementById('fixName').value, amount: parseFloat(document.getElementById('fixAmount').value), day: parseInt(document.getElementById('fixDay').value) };
                if(!item.name || isNaN(item.amount) || isNaN(item.day)) return UI.toast("Completa todos los campos", "error");
                
                if(this.editId!==null) arr[this.editId]=item; else arr.push(item);
                await updateDoc(doc(db,'users',this.user.uid,'finance','data'),{fixed:arr});
                this.closeModal(); UI.toast('Gasto Fijo Actualizado','success');
            },

            async saveConfig() {
                const inpInc = document.getElementById('inpIncome');
                const inpIncQ2 = document.getElementById('inpIncomeQ2');
                if (!inpInc) return; 

                const inc = parseFloat(inpInc.value);
                const incQ2 = parseFloat(inpIncQ2 ? inpIncQ2.value : 0);
                await updateDoc(doc(db,'users',this.user.uid,'finance','data'),{income:inc, incomeQ2: incQ2});
                UI.toast('Ingresos actualizados','success');
            },

            setCycleMode(mode) {
                this.tempCycle = mode;
                document.getElementById('btnCycleBi').className = `border p-4 rounded-2xl text-center transition-colors w-full h-32 md:h-20 flex flex-col items-center justify-center active:scale-95 ${mode==='biweekly' ? 'border-emerald-500 bg-emerald-500/10' : 'border-zinc-700'}`;
                document.getElementById('btnCycleMo').className = `border p-4 rounded-2xl text-center transition-colors w-full h-32 md:h-20 flex flex-col items-center justify-center active:scale-95 ${mode==='monthly' ? 'border-blue-500 bg-blue-500/10' : 'border-zinc-700'}`;
                const div = document.getElementById('customStartDayDiv');
                div.classList.remove('hidden');
                const lbl = document.getElementById('lblStartDay');
                if(mode === 'biweekly') {
                    lbl.textContent = 'Día Inicio 1er Periodo';
                    div.querySelector('p').textContent = 'El segundo periodo iniciará 15 días después.';
                } else {
                    lbl.textContent = 'Día de Corte / Inicio Mes';
                    div.querySelector('p').textContent = 'Tu mes financiero iniciará en este día.';
                }
            },

            async saveCycleConfig() {
                const mode = this.tempCycle || this.data.cycle || 'biweekly';
                const startDay = parseInt(document.getElementById('configStartDay').value) || 1;
                await updateDoc(doc(db,'users',this.user.uid,'finance','data'),{cycle: mode, startDay: startDay});
                UI.toast('Ciclo actualizado','success'); this.closeModal();
            },

            async deleteTxConfirm() { if(await UI.confirm('Borrar','¿Eliminar esta transacción?')) { await deleteDoc(doc(db,'users',this.user.uid,'finance','data','transactions',this.editId)); this.closeModal(); } },
            async deleteFixedConfirm() { if(await UI.confirm('Borrar','¿Eliminar gasto fijo?')) { const arr=this.data.fixed.filter((_,i)=>i!==this.editId); await updateDoc(doc(db,'users',this.user.uid,'finance','data'),{fixed:arr}); this.closeModal(); } },
            
            async resetData() {
                 if(await UI.confirm('RESETEO TOTAL','¿Estás seguro? Se borrará TODO.')) {
                     const uid = this.user.uid; const batch = writeBatch(db);
                     batch.set(doc(db,'users',uid,'finance','data'), {income:0,fixed:[], categories:[]});
                     const q = await getDocs(collection(db,'users',uid,'finance','data','transactions'));
                     q.forEach(d => batch.delete(d.ref));
                     await batch.commit(); window.location.reload();
                 }
            },

            switchView(v, btnRef) {
                // Ocultar todas las secciones
                document.querySelectorAll('section[id^="view-"]').forEach(s => s.classList.add('hidden'));
                
                // Mostrar la seleccionada
                const target = document.getElementById('view-'+v);
                if(target) target.classList.remove('hidden');
                
                // Actualizar estado de botones navegación móvil
                document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                if(btnRef) btnRef.classList.add('active');
                
                // Actualizar estado botones navegación desktop
                document.querySelectorAll('.nav-link-desk').forEach(b => {
                    b.classList.toggle('active', b.dataset.view === v);
                });
                
                // Ajustar el FAB
                document.getElementById('fabContainer').classList.toggle('scale-0', v !== 'balance');
                
                // Specific View Loaders
                if(v === 'future') this.renderFuture();
            },

            filterTransactions() {
                this.searchQuery = document.getElementById('searchTx').value;
                this.renderTransactions();
            },

            async exportData() {
                UI.toast('Preparando exportación...', 'info');
                try {
                    const q = query(collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions'), orderBy('date', 'desc'));
                    const snap = await getDocs(q);
                    const allTxs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const data = {
                        financials: this.data,
                        transactions: allTxs,
                        timestamp: new Date().toISOString()
                    };
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    const fileName = "gods_plan_backup_" + new Date().toISOString().split('T')[0] + ".json";
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", fileName);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    UI.toast('Backup descargado', 'success');
                } catch(e) { console.error(e); UI.toast('Error exportando datos', 'error'); }
            },

            triggerImport() { document.getElementById('importFile').click(); },
            async handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (!json.financials || !json.transactions) throw new Error("Formato inválido: Falta estructura base");
                        const msg = `Se restaurarán:\n• Configuración financiera\n• ${json.transactions.length} transacciones\n\nLos datos actuales serán sobrescritos/fusionados. ¿Continuar?`;
                        if (await UI.confirm('Restaurar Backup', msg)) { await this.restoreBackup(json); }
                    } catch (err) { UI.toast('Error: ' + err.message, 'error'); console.error(err); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            },

            async restoreBackup(data) {
                UI.toast('Restaurando datos...', 'info');
                try {
                    const uid = this.user.uid;
                    const batch = writeBatch(db);
                    const userRef = doc(db, 'users', uid, 'finance', 'data');
                    batch.set(userRef, data.financials, {merge: true});
                    await batch.commit();
                    const txs = data.transactions;
                    const BATCH_SIZE = 450;
                    let restoredCount = 0;
                    for (let i = 0; i < txs.length; i += BATCH_SIZE) {
                        const chunk = txs.slice(i, i + BATCH_SIZE);
                        const chunkBatch = writeBatch(db);
                        chunk.forEach(tx => {
                            const txRef = tx.id ? doc(db, 'users', uid, 'finance', 'data', 'transactions', tx.id) : doc(collection(db, 'users', uid, 'finance', 'data', 'transactions'));
                            const { id, ...txData } = tx; 
                            chunkBatch.set(txRef, txData); 
                        });
                        await chunkBatch.commit();
                        restoredCount += chunk.length;
                    }
                    UI.toast(`Restaurado con éxito (${restoredCount} txs)`, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } catch(e) { console.error(e); UI.toast('Error crítico restaurando datos', 'error'); }
            },
            
            openNavModal() {
                 const m = document.getElementById('navModal');
                 if(m) {
                     m.classList.remove('hidden');
                     m.classList.add('flex');
                 }
            },
            
            closeModalById(id) {
                const m = document.getElementById(id);
                if(m) {
                    m.classList.remove('flex');
                    m.classList.add('hidden');
                }
            }
        };
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
