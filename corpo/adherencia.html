<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Adherencia</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="./favicon.ico?v=2" type="image/x-icon">
    <link rel="icon" href="./favicon.ico?v=2" type="image/x-icon">

    <!-- FUENTE UNIFICADA: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS & CONFIGURACIÓN DE TEMA -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Activamos dark mode por clase/atributo
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        'text-mute': 'var(--text-mute)',
                        brand: 'var(--brand)',
                        money: 'var(--money)',
                        alert: 'var(--alert)',
                        warn: 'var(--warn)',
                        border: 'var(--border)',
                        'input-bg': 'var(--input-bg)',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where,
            setPersistence, browserLocalPersistence
        };
    </script>

    <style>
        /* --- DEFINICIÓN DE VARIABLES DE TEMA --- */
        
        /* TEMA BLUE (DEFAULT) - CORREGIDO A DARK SLATE PARA LEGIBILIDAD */
        :root {
            --bg: #0f172a;        /* Slate 900 - Fondo Azul Oscuro */
            --card: #1e293b;      /* Slate 800 - Tarjetas un poco más claras */
            --text: #f1f5f9;      /* Slate 100 - Texto Blanco Suave */
            --text-mute: #94a3b8; /* Slate 400 - Texto secundario */
            --brand: #3b82f6;     /* Blue 500 - Marca Azul Vibrante */
            --money: #34d399;     /* Emerald 400 */
            --alert: #f87171;     /* Red 400 */
            --warn: #fbbf24;      /* Amber 400 */
            --border: #334155;    /* Slate 700 - Bordes sutiles */
            --input-bg: #020617;  /* Slate 950 - Inputs muy oscuros */
            --header-bg: rgba(15, 23, 42, 0.85); /* Header semitransparente */
        }

        /* TEMA SANGRE (RED/BLACK) - MANTENIDO IGUAL */
        [data-theme="red"] {
            --bg: #000000;
            --card: #111111;
            --text: #e5e5e5;
            --text-mute: #737373;
            --brand: #dc2626; 
            --money: #16a34a;
            --alert: #b91c1c;
            --warn: #d97706;
            --border: #262626;
            --input-bg: #0a0a0a;
            --header-bg: rgba(0, 0, 0, 0.9);
        }

        /* RESET & UTILIDADES ESPECÍFICAS */
        * { -webkit-tap-highlight-color: transparent; outline: none; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* Ocultar scrollbar en navegación */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--brand); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* ESTADOS ACTIVOS COMPLEJOS */
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
        
        /* Botones de control de tiempo activos */
        .btn-ctrl.active-bath { background: var(--card); color: var(--brand) !important; border-color: var(--brand) !important; box-shadow: inset 0 0 0 1px var(--brand); }
        .btn-ctrl.active-food { background: var(--card); color: var(--warn) !important; border-color: var(--warn) !important; box-shadow: inset 0 0 0 1px var(--warn); }
        .btn-ctrl.active-pause { background: #431407; color: #fb923c !important; border-color: #fb923c !important; box-shadow: inset 0 0 0 1px #f97316; }
        
        /* Ajuste específico para tema azul en pausa */
        :root .btn-ctrl.active-pause { background: #451a03; }

        .side-clock.active { opacity: 1; transform: scale(1.05); background: transparent; }
        .side-clock.danger .side-val { color: var(--alert) !important; }
        
        /* Tabs del modal (Estilo Segmentado Moderno) */
        .tab { @apply text-text-mute rounded-md transition-all; }
        .tab.active { @apply bg-white/10 text-white shadow-sm ring-1 ring-white/10 font-bold; }
        
        /* Ajuste para inputs en modo oscuro para que sean legibles */
        input, select, textarea { color: var(--text) !important; }
    </style>
</head>

<body class="bg-bg text-text font-sans pb-24 pt-20 text-sm font-normal selection:bg-brand selection:text-white">

    <!-- HEADER FIJO -->
    <nav class="fixed top-0 left-0 w-full z-[100] border-b border-white/5 bg-[var(--header-bg)] backdrop-blur-md h-20 flex items-center shadow-lg transition-all duration-300">
        <div class="w-full max-w-7xl mx-auto px-4 md:px-6 flex justify-between items-center h-full">
            <!-- Logo (ICONO + TEXTO AGRUPADOS EN EL LINK) -->
            <a href="/corpo/index.html" class="flex items-center gap-3 group">
                <div class="relative w-9 h-9 flex items-center justify-center">
                    <div class="absolute inset-0 bg-brand rounded-full blur opacity-20 group-hover:opacity-40 transition-opacity"></div>
                    <i class="ph-fill ph-planet text-3xl text-brand relative z-10"></i>
                </div>
                <div class="flex flex-col justify-center">
                    <span class="font-bold tracking-widest text-lg text-white leading-none">GOD'S PLAN</span>
                    <span class="text-[0.6rem] text-zinc-400 font-mono tracking-widest uppercase hidden sm:block">System v2.5</span>
                </div>
            </a>

            <!-- Navegación Central -->
            <div class="hidden md:flex items-center bg-white/5 rounded-full p-1 border border-white/5">
                <a href="#" class="px-4 py-1.5 rounded-full bg-brand text-white text-xs font-bold tracking-wide shadow-lg shadow-brand/20 transition-all">ADHERENCIA</a>
                <a href="/corpo/finanzas.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">FINANZAS</a>
                <a href="/corpo/chat.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CHAT</a>
                <a href="/corpo/casos.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CASOS</a>
                <a href="/corpo/cuenta.html" class="px-4 py-1.5 rounded-full text-zinc-400 hover:text-white hover:bg-white/5 text-xs font-bold tracking-wide transition-all">CUENTA</a>
            </div>

            <!-- User Badge -->
            <div id="user-badge" class="hidden items-center gap-2 animate-fade-in pl-4 border-l border-white/10 ml-2">
                <div class="hidden lg:flex flex-col text-right mr-2">
                    <span id="user-name" class="text-xs font-bold text-white uppercase tracking-wider max-w-[100px] truncate">Usuario</span>
                    <span id="user-role" class="text-[9px] font-mono text-emerald-500 tracking-wide">SYSTEM ACCESS</span>
                </div>

                <!-- BOTÓN AZUL Y SANGRE (TOGGLE THEME) -->
                <button onclick="window.app.toggleTheme()" class="w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-zinc-400 hover:bg-white/10 hover:text-brand transition-all group" title="Cambiar Tema (Azul/Sangre)">
                    <i id="themeIcon" class="ph-fill ph-drop-half-bottom text-lg transition-transform duration-500 rotate-0"></i>
                </button>

                <button onclick="window.app.logout()" class="w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-zinc-400 hover:bg-red-500/10 hover:border-red-500/50 hover:text-red-500 transition-all group" title="Cerrar Sesión">
                    <i class="ph-bold ph-power text-lg group-hover:scale-110 transition-transform"></i>
                </button>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="md:hidden w-9 h-9 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-zinc-400" onclick="window.app.openConfigModal()">
                 <i class="ph-bold ph-list text-lg"></i>
            </button>
        </div>
    </nav>

    <!-- HEADER APP -->
    <header class="bg-card border-b border-border py-2.5 px-4 sticky top-20 z-40 flex justify-between items-center shadow-sm flex-wrap gap-2.5 transition-all">
        <div class="text-[1.1rem] font-extrabold flex items-center gap-2 text-text uppercase">
            <i class="ph-fill ph-check-circle text-brand"></i> <span class="hidden sm:inline">Panel de Control</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap justify-end flex-1 md:flex-none">
            <!-- RELOJ REAL CDMX -->
            <div id="realWorldClock" class="flex flex-col items-end mr-1 px-2 py-0.5 border-r border-border/50 min-w-[70px]">
                <div class="text-[0.6rem] text-text-mute font-black tracking-wider leading-none mb-0.5 flex items-center gap-1 justify-end">
                      <span id="syncDot" class="w-1.5 h-1.5 rounded-full bg-red-500 inline-block"></span> CDMX
                </div>
                <div class="text-[0.9rem] font-mono font-bold text-text leading-none tabular-nums text-right" id="realClockTime">--:--:--</div>
            </div>

            <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text" onclick="window.app.syncData()" title="Sincronizar"><i class="ph-bold ph-arrows-clockwise"></i></button>
            <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg hover:text-text" onclick="window.app.openConfigModal()" title="Menú"><i class="ph-bold ph-gear"></i></button>
            
            <div class="flex items-center gap-1 bg-bg px-2 py-1 rounded-full border border-border">
                <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(-1)"><i class="ph-bold ph-caret-left"></i></button>
                <span class="text-[0.85rem] font-extrabold uppercase text-text min-w-[75px] text-center" id="monthLabel">--</span>
                <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:text-text" onclick="window.app.changeMonth(1)"><i class="ph-bold ph-caret-right"></i></button>
                <button class="bg-transparent border-none text-brand cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center hover:scale-110 transition-transform" onclick="window.app.goToday()"><i class="ph-bold ph-calendar-check"></i></button>
            </div>
        </div>
    </header>

    <div class="w-full max-w-[900px] mx-auto p-4 overflow-x-hidden">
        <div id="auth-status" class="text-center text-[0.85rem] text-text-mute mx-auto mb-5 py-2.5 px-4 w-fit bg-card border border-border rounded-full hidden items-center justify-center gap-2.5 shadow-sm">Conectando...</div>

        <!-- RELOJ -->
        <div class="bg-card rounded-2xl border border-border py-5 px-2.5 text-center mb-5 shadow-sm relative overflow-hidden">
            <div id="mainLoader" class="absolute inset-0 bg-card/90 flex items-center justify-center z-10 rounded-2xl hidden">
                <div class="spinner"></div>
            </div>

            <!-- Timer Grid -->
            <div class="grid grid-cols-[1fr_1.2fr_1fr] items-center gap-1.5 mb-5" id="timersDisplay" style="display:none;">
                <!-- Baño -->
                <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockBathContainer" onclick="window.app.openTimerEdit('bathroom')" type="button">
                    <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-toilet"></i> Baño <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                    </div>
                    <div class="font-mono font-bold text-base text-text tabular-nums" id="dispBath">00:00</div>
                    <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limBath">15</span>m</div>
                    <div id="remBath" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                </button>
                
                <!-- Reloj Principal -->
                <div class="flex flex-col items-center">
                    <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-1.5" id="clockStatus">TURNO ACTIVO</div>
                    <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text tabular-nums leading-none" id="clockDisplay">00:00</div>
                    
                    <div id="shiftStartTime" class="text-[0.7rem] text-text-mute font-bold mt-1.5 uppercase tracking-wide opacity-80" style="display:none;">
                        ENTRADA: --:--
                    </div>

                    <div id="networkTimeBadge" class="text-[0.65rem] text-money font-bold mt-1.5 opacity-0 transition-opacity duration-500">
                        <i class="ph-bold ph-globe"></i> Local
                    </div>
                </div>

                <!-- Comida -->
                <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-100 hover:scale-105 transition-all cursor-pointer" id="clockFoodContainer" onclick="window.app.openTimerEdit('food')" type="button">
                    <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-hamburger"></i> Comida <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                    </div>
                    <div class="font-mono font-bold text-base text-text tabular-nums" id="dispFood">00:00</div>
                    <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limFood">45</span>m</div>
                    <div id="remFood" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                </button>
            </div>

            <!-- Offline Display -->
            <div id="offlineDisplay" style="display:block;">
                <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-2.5">FUERA DE TURNO</div>
                <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text-mute tabular-nums leading-none mb-5">--:--:--</div>
            </div>

            <!-- Botones de Acción -->
            <div class="grid grid-cols-2 gap-2.5 mt-4" id="actionButtons"></div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Semanal -->
            <div class="bg-card border border-border rounded-xl p-4">
                <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                    <div class="flex items-center gap-2">
                        <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(-1)"><i class="ph-bold ph-caret-left"></i></button>
                        <span class="text-[0.9rem] font-extrabold text-text">Semana <span id="weekNum">--</span></span>
                        <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0 hover:text-white" onclick="window.app.changeWeek(1)"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <span id="weekBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                </div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="weekTarget" class="text-text">0:00</strong></div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="weekWorked">0:00</strong></div>
                <div class="flex justify-between items-center mt-2.5 pt-1.5 border-t border-dashed border-border text-[0.9rem]">
                    <span class="text-text-mute">Pago Extra</span><strong class="text-money" id="weekPay">$0</strong>
                </div>
            </div>

            <!-- Quincenal -->
            <div class="bg-card border border-border rounded-xl p-4">
                <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                    <span class="text-[0.9rem] font-extrabold text-text">Quincena <span id="qName">--</span></span>
                    <span id="qBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-900/30 text-emerald-400">0h</span>
                </div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="qTarget" class="text-text">0:00</strong></div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="qWorked">0:00</strong></div>
                <div class="flex justify-between items-center mt-2.5 text-[0.9rem]"><span class="text-alert">Faltas</span><strong class="text-alert" id="qFails">0</strong></div>
            </div>
        </div>

        <!-- LISTA HISTORIAL -->
        <div class="bg-card border border-border rounded-2xl overflow-hidden shadow-sm mb-6">
            <div class="px-5 py-4 bg-bg/50 font-extrabold text-text-mute text-[0.75rem] border-b border-border flex justify-between items-center tracking-wide">
                <span id="logListTitle">HISTORIAL</span>
                <button onclick="window.app.openModal()" class="border-none bg-transparent text-brand font-extrabold cursor-pointer hover:underline">+ MANUAL</button>
            </div>
            <div id="logList"></div>
        </div>
    </div>

    <!-- MODALES -->
    
    <!-- MENU CONFIGURACION -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="configModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[400px] max-h-[90vh] overflow-hidden flex flex-col border border-border shadow-2xl relative">
            <!-- Modal Header -->
            <div class="p-4 border-b border-border flex justify-between items-center bg-bg/50 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-planet text-xl text-brand"></i>
                    <span class="font-bold text-text text-sm tracking-wide">CONFIGURACIÓN</span>
                </div>
                <button onclick="window.app.closeModalById('configModal')" class="text-text-mute hover:text-text transition-colors">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-5 overflow-y-auto flex-1">
                <div class="flex p-1 bg-input-bg rounded-xl mb-6 border border-border/50">
                    <div class="tab active flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tSettings')">Ajustes</div>
                    <div class="tab flex-1 text-center py-2 text-[0.75rem] font-bold cursor-pointer hover:text-text" onclick="window.app.switchTab('tData')">Datos</div>
                </div>

                <div id="tAccount" class="tab-content hidden"></div>
                <div id="tDesign" class="tab-content hidden"></div>

                <!-- TAB AJUSTES -->
                <div id="tSettings" class="tab-content active block animate-fade-in">
                    <div class="mb-6">
                        <p class="text-[0.65rem] font-black text-brand mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-clock"></i> Límites de Tiempo (Min)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Baño</label>
                                <input type="number" id="cfgBath" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Comida</label>
                                <input type="number" id="cfgFood" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-[0.65rem] font-black text-money mb-3 uppercase tracking-wider flex items-center gap-1"><i class="ph-bold ph-currency-dollar"></i> Configuración de Pagos</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Tarifa Base</label>
                                <input type="number" id="cfgRate1" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                            <div class="bg-input-bg p-3 rounded-xl border border-border">
                                <label class="block text-text-mute text-[0.65rem] font-bold mb-1 uppercase">Tarifa Extra</label>
                                <input type="number" id="cfgRate2" class="bg-transparent w-full font-bold text-lg text-text focus:outline-none placeholder-zinc-700">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB DATOS -->
                <div id="tData" class="tab-content hidden animate-fade-in">
                    <div class="space-y-3">
                        <!-- BOTON IMPORTAR EXCEL -->
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.openImportModal()">
                            <div class="w-10 h-10 rounded-lg bg-emerald-900/30 text-emerald-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-bold ph-file-csv text-xl"></i>
                            </div>
                            <div>
                                <div class="text-sm text-text">Importar Excel</div>
                                <div class="text-[0.65rem] text-text-mute">Cargar datos masivos</div>
                            </div>
                        </button>
                        <!-- BOTON IMPORTAR BACKUP JSON -->
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="window.app.exportBackup()">
                             <div class="w-10 h-10 rounded-lg bg-blue-900/30 text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-bold ph-download-simple text-xl"></i>
                            </div>
                            <div>
                                <div class="text-sm text-text">Descargar Backup</div>
                                <div class="text-[0.65rem] text-text-mute">Guardar copia de seguridad</div>
                            </div>
                        </button>
                    </div>
                        <!-- BOTON IMPORTAR BACKUP JSON -->
                        <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-border bg-input-bg hover:bg-bg transition-colors flex items-center gap-3 text-left group" onclick="document.getElementById('importJsonInput').click()">
                            <div class="w-10 h-10 rounded-lg bg-violet-900/30 text-violet-400 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-bold ph-upload-simple text-xl"></i>
                            </div>
                            <div>
                                <div class="text-sm text-text">Importar Backup (JSON)</div>
                                <div class="text-[0.65rem] text-text-mute">Restaurar desde archivo</div>
                            </div>
                        </button>
                        <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="window.app.importJson(this)">
                    <div class="border-t border-border my-6"></div>
                    
                    <button class="w-full p-4 rounded-xl font-bold cursor-pointer border border-red-900 bg-red-900/10 text-red-500 hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2" onclick="window.app.resetData()">
                        <i class="ph-bold ph-trash"></i> Reiniciar Aplicación
                    </button>
                </div>
            </div>

            <!-- Modal Footer -->
             <div class="p-4 border-t border-border bg-card">
                <button class="w-full bg-brand text-white p-3.5 rounded-xl font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors shadow-lg shadow-brand/20" onclick="window.app.saveConfig()">
                    GUARDAR CAMBIOS
                </button>
            </div>
        </div>
    </div>

    <!-- LOG MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="logModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Registro Manual</h3>
            
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Fecha</label>
            <input type="date" id="inpDate" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5 [color-scheme:dark]">
            
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Tipo</label>
            <select id="inpType" onchange="window.app.toggleTimeInputs()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5">
                <option value="Laboral">Laboral</option>
                <option value="Descanso">Descanso</option>
                <option value="Falta">Falta</option>
                <option value="Vacaciones">Vacaciones</option>
            </select>

            <div id="timeInputs">
                <div class="grid grid-cols-2 gap-2.5 mb-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Entrada</label><input type="time" id="inpIn" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Salida</label><input type="time" id="inpOut" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text [color-scheme:dark]"></div>
                </div>
                <div class="bg-bg/50 p-2.5 rounded-lg mb-2.5 border border-border">
                    <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Minutos Reales:</label>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Baño</label><input type="number" id="inpBathTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Comida</label><input type="number" id="inpFoodTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Pausa</label><input type="number" id="inpPauseTime" value="0" oninput="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-1.5 rounded text-sm text-text"></div>
                    </div>
                </div>
                <p class="text-right text-text-mute text-sm">Neto Calculado: <strong id="calcHoursDisplay" class="text-text">0:00</strong></p>
            </div>

            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors mt-4" onclick="window.app.saveLog()">Guardar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer mb-2.5 text-alert border border-alert bg-transparent hidden hover:bg-alert/10" id="btnDelete" onclick="window.app.deleteLog()">Eliminar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('logModal')">Cancelar</button>
        </div>
    </div>

    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="clockOutModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <h3 class="text-text font-bold text-lg mb-4">¿Terminar Turno?</h3>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-alert text-white mt-4 mb-2.5 hover:bg-red-600 transition-colors" onclick="window.app.finishShiftReal()">TERMINAR</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.cancelClockOut()">Cancelar</button>
        </div>
    </div>

    <!-- EDITAR TIEMPO MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="timerEditModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Ajustar Tiempo</h3>
            <p class="text-sm mb-2.5 text-text-mute">
                Ingresa el tiempo acumulado para <strong id="timerEditTitle" class="text-text">--</strong>.
                <br><span class="text-xs">(Formatos aceptados: "15", "3.5" o "3:14")</span>
            </p>
            <input type="text" id="inpTimerEdit" placeholder="Ej. 3:14" class="text-lg text-center bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text">
            <div class="flex gap-2.5 mt-4">
                <button class="flex-1 bg-brand text-white p-3 rounded-lg font-extrabold cursor-pointer border-none hover:bg-blue-600 transition-colors" onclick="window.app.saveTimerEdit()">Actualizar</button>
                <button class="flex-1 bg-transparent border border-border text-text-mute p-3 rounded-lg font-extrabold cursor-pointer hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('timerEditModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- UTILS MODALS -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="msgModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <i id="msgIcon" class="text-[2.5rem] mb-2.5 block"></i>
            <p id="msgText" class="font-bold mb-5 text-text"></p>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.closeModalById('msgModal')">OK</button>
        </div>
    </div>
    <div class="modal fixed inset-0 w-screen h-screen bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="importModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Importar Excel</h3>
            <textarea id="importTextArea" rows="6" class="font-mono text-xs w-full bg-input-bg border border-border p-2.5 rounded-lg text-text mb-4 placeholder-zinc-700" placeholder="Pegar CSV aquí..."></textarea>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white hover:bg-blue-600 transition-colors" onclick="window.app.processImport()">Procesar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute hover:text-text hover:bg-white/5" onclick="window.app.closeModalById('importModal')">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where,
            setPersistence, browserLocalPersistence
        };

        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db;
        function showGlobalError(m) { const x = document.getElementById('msgModal'); if (x) { document.getElementById('msgText').textContent = m; document.getElementById('msgIcon').className = 'ph-fill ph-warning-circle text-alert'; x.classList.remove('hidden'); x.classList.add('flex'); } else alert(m); }
        window.onerror = function (m) { if (!String(m).includes('popup')) showGlobalError(m); };

        try { 
            const fbApp = initializeApp(firebaseConfig); 
            auth = getAuth(fbApp); 
            setPersistence(auth, browserLocalPersistence).catch(console.error);
            db = getFirestore(fbApp); 
        } catch (e) { setTimeout(() => showGlobalError(e.message), 1000); }

        window.app = {
            data: { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null },
            userId: null, offline: false, editingId: null, date: new Date(), timer: null, processing: false, authMode: 'login',
            currentTheme: 'light', editingTimerType: null, timeOffset: 0, lastSync: 0, isSyncing: false, nextSyncAllowed: 0,

            init() {
                this.updateRealClockUI();
                setInterval(() => this.updateRealClockUI(), 1000);

                document.getElementById('auth-status').classList.remove('hidden');
                document.getElementById('auth-status').classList.add('flex');
                
                // Cargar tema guardado o default a 'red' (Sangre)
                const savedTheme = localStorage.getItem('gp_theme') || 'red';
                this.setTheme(savedTheme);
                
                if (!auth) return this.goOffline();

                onAuthStateChanged(auth, async u => {
                    if (u) { 
                        this.userId = u.uid; 
                        this.offline = false; 
                        this.renderAuth(u); 
                        await this.load(); 
                    } else {
                         if (!window.location.pathname.endsWith('index.html')) {
                             // console.log("Redirigiendo...");
                         }
                        this.goOffline();
                    }
                    this.loadLocal(); 
                });
            },

            updateRealClockUI() {
                const now = new Date();
                const clockEl = document.getElementById('realClockTime');
                if (clockEl) {
                    try {
                        const horaCDMX = new Intl.DateTimeFormat('es-MX', {
                            timeZone: 'America/Mexico_City',
                            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                        }).format(now);
                        clockEl.textContent = horaCDMX;
                    } catch (e) {
                        clockEl.textContent = now.toLocaleTimeString();
                    }
                }
            },

            getNow() { return Date.now() + this.timeOffset; },

            getCDMXDate(ms) {
                 return new Date(ms).toLocaleDateString('en-CA', { timeZone: 'America/Mexico_City' });
            },

            getCDMXTime(ms) {
                return new Date(ms).toLocaleTimeString('es-MX', { 
                    timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', hour12: false 
                }).slice(0, 5);
            },

            setTheme(t) {
                this.currentTheme = t;
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('gp_theme', t);
                
                const icon = document.getElementById('themeIcon');
                if (icon) {
                    if (t === 'light') {
                        // Blue Theme (Ahora es Dark Blue) - Icono Gota Media
                        icon.className = 'ph-fill ph-drop-half-bottom text-lg transition-transform duration-500 rotate-0';
                    } else {
                        // Sangre Theme - Icono Fuego/Gota
                        icon.className = 'ph-fill ph-fire text-lg transition-transform duration-500 rotate-0'; 
                    }
                }
            },

            toggleTheme() {
                const newTheme = this.currentTheme === 'light' ? 'red' : 'light';
                this.setTheme(newTheme);
            },

            goOffline() { this.offline = true; document.getElementById('auth-status').innerHTML = `<i class="ph-bold ph-wifi-slash"></i> Offline`; this.loadLocal(); },
            
            renderAuth(u) {
                const isRealUser = u && !u.isAnonymous;
                let t = u ? (u.isAnonymous ? "ANÓNIMO" : (u.displayName || "Usuario")) : "DESCONECTADO";
                if (isRealUser && u.email && u.email.includes('@godsplan.site')) t = u.email.split('@')[0];
                document.getElementById('auth-status').innerHTML = `<i class="ph-fill ph-user-circle"></i> ${t}`;
                
                const badge = document.getElementById('user-badge');
                const nameLabel = document.getElementById('user-name');
                if (isRealUser) {
                    badge.classList.remove('hidden'); badge.classList.add('flex');
                    if (nameLabel) nameLabel.textContent = t;
                } else {
                    badge.classList.add('hidden'); badge.classList.remove('flex');
                }
            },

            loadLocal() { const d = localStorage.getItem('godsPlanData'); if (d) { try { this.data = JSON.parse(d); this.render(); this.uiClock(); } catch (e) { } } },
            
            async load() {
                if (this.offline || !this.userId) return;
                try {
                    const docRef = doc(db, "users", this.userId, "attendance", "sync_state");
                    const snap = await getDoc(docRef);
                    if (snap.exists()) { 
                        this.data = snap.data(); 
                        this.data.logs = this.data.logs || []; 
                        this.data.config = this.data.config || { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 };
                    } else if (auth.currentUser.isAnonymous) { 
                        const l = localStorage.getItem('godsPlanData'); 
                        if (l) { this.data = JSON.parse(l); this.save(); } 
                    }
                    this.render(); this.uiClock();
                } catch (e) { console.error(e); }
            },
            
            async save() {
                localStorage.setItem('godsPlanData', JSON.stringify(this.data));
                if (!this.offline && this.userId) {
                    const docRef = doc(db, "users", this.userId, "attendance", "sync_state");
                    await setDoc(docRef, this.data);
                }
            },
            
            syncData() { this.load(); this.showSuccess("Sincronizado"); this.syncNetworkTime(true); },
            async syncNetworkTime(force = false) { this.isSyncing = false; },
            
            uiClock() {
                const s = this.data.activeShift;
                const area = document.getElementById('actionButtons');
                const off = document.getElementById('offlineDisplay');
                const on = document.getElementById('timersDisplay');
                const config = this.data.config || {}; 
                const bl = config.bathAllow || 15;
                const fl = config.foodAllow || 45;

                const btnBase = "btn-ctrl h-[55px] rounded-lg font-extrabold text-[0.85rem] cursor-pointer flex flex-col items-center justify-center gap-0.5 uppercase transition-all relative overflow-hidden active:scale-95";
                const btnStart = `${btnBase} col-span-2 text-lg h-[70px] text-white bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 border-none`;
                const btnStop = `${btnBase} col-span-2 text-white bg-gradient-to-br from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 border-none`;
                
                // ACTUALIZACIÓN DE BORDES SOLICITADA
                const btnBath = `${btnBase} bg-card text-text-mute border-2 border-blue-500/40 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-500/10`;
                const btnFood = `${btnBase} bg-card text-text-mute border-2 border-amber-500/40 hover:border-amber-500 hover:text-amber-500 hover:bg-amber-500/10`;
                const btnPause = `${btnBase} col-span-2 bg-card text-text-mute border-2 border-orange-600/40 hover:border-orange-500 hover:text-orange-500 hover:bg-orange-500/10`;

                const startEl = document.getElementById('shiftStartTime');

                if (!s) {
                    off.style.display = 'block'; on.style.display = 'none';
                    area.innerHTML = `<button class="${btnStart}" onclick="window.app.clockIn()"><i class="ph-bold ph-play"></i> INICIAR JORNADA</button>`;
                    if (this.timer) clearInterval(this.timer);
                    document.getElementById('clockStatus').textContent = "FUERA DE TURNO";
                    document.getElementById('clockStatus').classList.remove('animate-pulse-custom');
                    document.getElementById('clockStatus').classList.remove('text-warn');
                    if(startEl) startEl.style.display = 'none';
                } else {
                    if (!s.breaks) { s.breaks = { bathroom: 0, food: 0, pause: 0 }; this.save(); }
                    if (s.breaks.pause === undefined) s.breaks.pause = 0;

                    off.style.display = 'none'; on.style.display = 'grid';
                    document.getElementById('limBath').textContent = bl;
                    document.getElementById('limFood').textContent = fl;
                    const bathEl = document.getElementById('clockBathContainer');
                    const foodEl = document.getElementById('clockFoodContainer');
                    
                    if(startEl && s.start) {
                        startEl.textContent = `ENTRADA: ${this.getCDMXTime(s.start)}`;
                        startEl.style.display = 'block';
                    }

                    area.innerHTML = `
                        <button class="${btnBath} ${s.breakType === 'bathroom' ? 'active-bath' : ''}" onclick="window.app.toggleBreak('bathroom')"><i class="ph-bold ph-toilet"></i> BAÑO</button>
                        <button class="${btnFood} ${s.breakType === 'food' ? 'active-food' : ''}" onclick="window.app.toggleBreak('food')"><i class="ph-bold ph-hamburger"></i> COMIDA</button>
                        <button class="${btnPause} ${s.breakType === 'pause' ? 'active-pause' : ''}" onclick="window.app.toggleBreak('pause')"><i class="ph-bold ph-pause-circle"></i> ${s.breakType === 'pause' ? 'REANUDAR' : 'PAUSAR / DESCONEXIÓN'}</button>
                        <button class="${btnStop}" onclick="window.app.confirmClockOut()"><i class="ph-bold ph-stop"></i> TERMINAR JORNADA</button>
                    `;

                    if (this.timer) clearInterval(this.timer);
                    this.timer = setInterval(() => {
                        const now = this.getNow();
                        
                        let totalPauseAccumulated = (s.breaks.pause || 0) * 60000;
                        let currentPauseDuration = 0;

                        if (s.breakType === 'pause') {
                            document.getElementById('clockStatus').textContent = "PAUSADO";
                            document.getElementById('clockStatus').classList.add('animate-pulse-custom');
                            document.getElementById('clockStatus').classList.add('text-warn');
                            
                            currentPauseDuration = now - s.breakStart;
                        } else {
                            document.getElementById('clockStatus').textContent = "TURNO ACTIVO";
                            document.getElementById('clockStatus').classList.remove('animate-pulse-custom');
                            document.getElementById('clockStatus').classList.remove('text-warn');
                        }

                        let displayTime = (now - s.start) - totalPauseAccumulated - currentPauseDuration;
                        document.getElementById('clockDisplay').textContent = this.msToTime(displayTime);

                        let b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                        if (s.breakStart) {
                            const d = (now - s.breakStart) / 60000;
                            if (s.breakType === 'bathroom') b += d; else if (s.breakType === 'food') f += d;
                        }
                        
                        document.getElementById('dispBath').textContent = this.fmtBreak(b);
                        if (s.breakType === 'bathroom') bathEl.classList.add('active'); else bathEl.classList.remove('active');
                        if (b > bl) bathEl.classList.add('danger'); else bathEl.classList.remove('danger');

                        const bathRem = (config.bathAllow || 15) - b;
                        const elRemBath = document.getElementById('remBath');
                        if (elRemBath) {
                            elRemBath.textContent = bathRem >= 0 ? `Restan: ${this.fmtBreak(bathRem)}` : `Exceso: ${this.fmtBreak(Math.abs(bathRem))}`;
                            elRemBath.className = bathRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }

                        document.getElementById('dispFood').textContent = this.fmtBreak(f);
                        if (s.breakType === 'food') foodEl.classList.add('active'); else foodEl.classList.remove('active');
                        if (f > fl) foodEl.classList.add('danger'); else foodEl.classList.remove('danger');

                        const foodRem = (config.foodAllow || 45) - f;
                        const elRemFood = document.getElementById('remFood');
                        if (elRemFood) {
                            elRemFood.textContent = foodRem >= 0 ? `Restan: ${this.fmtBreak(foodRem)}` : `Exceso: ${this.fmtBreak(Math.abs(foodRem))}`;
                            elRemFood.className = foodRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }
                    }, 1000);
                }
            },
            
            openTimerEdit(type) {
                if (!this.data.activeShift) return;
                this.editingTimerType = type;
                let currentTotal = this.data.activeShift.breaks[type] || 0;
                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === type) {
                    currentTotal += (this.getNow() - this.data.activeShift.breakStart) / 60000;
                }
                document.getElementById('timerEditTitle').textContent = type === 'bathroom' ? 'Baño' : 'Comida';
                const m = Math.floor(currentTotal);
                const s = Math.floor((currentTotal % 1) * 60);
                document.getElementById('inpTimerEdit').value = `${m}:${s.toString().padStart(2, '0')}`; 
                const modal = document.getElementById('timerEditModal');
                if(modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                setTimeout(() => document.getElementById('inpTimerEdit').focus(), 100);
            },

            saveTimerEdit() {
                if (!this.editingTimerType || !this.data.activeShift) return;
                const valStr = document.getElementById('inpTimerEdit').value.trim();
                let newVal = 0;
                if (valStr.includes(':')) {
                    const parts = valStr.split(':');
                    newVal = (parseInt(parts[0]) || 0) + ((parseInt(parts[1]) || 0) / 60);
                } else newVal = parseFloat(valStr);
                
                if (isNaN(newVal) || newVal < 0) return this.showMessage("Tiempo inválido");

                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === this.editingTimerType) {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                    this.data.activeShift.breakStart = this.getNow();
                } else {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                }
                this.save(); this.uiClock();
                document.getElementById('timerEditModal').classList.remove('flex');
                document.getElementById('timerEditModal').classList.add('hidden');
            },

            clockIn() {
                if (auth.currentUser?.isAnonymous) {
                    this.showMessage("Inicia sesión primero.");
                    this.redirectToAuth();
                    return;
                }
                if (this.processing) return; this.processing = true;
                this.stopBreak();
                this.data.activeShift = { start: this.getNow(), breaks: { bathroom: 0, food: 0, pause: 0 }, breakStart: null, breakType: null };
                this.save(); this.uiClock(); this.processing = false;
            },
            toggleBreak(type) {
                const s = this.data.activeShift; if (!s) return;
                if (s.breakStart) {
                    const prev = s.breakType;
                    this.stopBreak();
                    if (prev !== type) setTimeout(() => this.startBreak(type), 50);
                } else this.startBreak(type);
            },
            startBreak(t) { 
                this.data.activeShift.breakStart = this.getNow(); 
                this.data.activeShift.breakType = t; 
                this.save(); this.uiClock(); 
            },
            stopBreak() {
                const s = this.data.activeShift;
                if (s && s.breakStart) {
                    if (s.breakType) {
                        if (s.breaks[s.breakType] === undefined) s.breaks[s.breakType] = 0;
                        s.breaks[s.breakType] += (this.getNow() - s.breakStart) / 60000;
                    }
                    s.breakStart = null; s.breakType = null;
                    this.save(); this.uiClock();
                }
            },
            confirmClockOut() {
                if (this.data.activeShift.breakStart) this.stopBreak();
                if (this.data.activeShift) {
                    const m = document.getElementById('clockOutModal');
                    m.classList.remove('hidden');
                    m.classList.add('flex');
                }
            },
            finishShiftReal() {
                const s = this.data.activeShift;
                if (!s) return;
                if (s.breakStart) this.stopBreak(); 
                if (!s.breaks) s.breaks = { bathroom: 0, food: 0, pause: 0 };
                
                const end = this.getNow();
                const totalWallTime = (end - s.start) / 60000;
                const pauseTime = s.breaks.pause || 0;
                const gross = totalWallTime - pauseTime;
                
                const b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                const config = this.data.config || {}; 
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                const logDate = this.getCDMXDate(s.start);
                const logIn = this.getCDMXTime(s.start);
                const logOut = this.getCDMXTime(end);

                this.data.logs.push({
                    id: this.getNow(), 
                    date: logDate, 
                    type: 'Laboral',
                    in: logIn, 
                    out: logOut, 
                    hours: gross, 
                    disconnection: disc,
                    details: { bath: b, food: f, pause: pauseTime }
                });
                this.data.activeShift = null;
                this.save(); this.render(); this.uiClock();
                document.getElementById('clockOutModal').classList.remove('flex');
                document.getElementById('clockOutModal').classList.add('hidden');
            },
            cancelClockOut() { 
                document.getElementById('clockOutModal').classList.remove('flex'); 
                document.getElementById('clockOutModal').classList.add('hidden'); 
            },

            render() {
                const d = this.date, m = d.getMonth(), y = d.getFullYear();
                document.getElementById('monthLabel').textContent = `${["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"][m]} ${y}`;
                const wn = this.getWeek(d);
                document.getElementById('weekNum').textContent = wn;

                const wLogs = this.data.logs.filter(l => this.getWeek(new Date(l.date + 'T00:00')) === wn && new Date(l.date).getFullYear() === y);
                const wRes = this.calcStats(wLogs);
                document.getElementById('weekTarget').textContent = this.fmt(wRes.target);
                document.getElementById('weekWorked').textContent = this.fmt(wRes.worked);
                this.setBadge('weekBalance', wRes.bal);
                const config = this.data.config || {}; 
                let pay = 0, he = Math.floor(wRes.bal / 60);
                if (wRes.bal > 0) pay = (he <= 12) ? he * (config.rate1 || 50) : (12 * (config.rate1 || 50)) + ((he - 12) * (config.rate1 || 50));
                document.getElementById('weekPay').textContent = `$${Math.round(pay)}`;

                const isQ1 = d.getDate() <= 15;
                document.getElementById('qName').textContent = isQ1 ? 'Q1' : 'Q2';
                const qLogs = this.data.logs.filter(l => { const x = new Date(l.date + 'T00:00'); return x.getMonth() === m && (isQ1 ? x.getDate() <= 15 : x.getDate() > 15); });
                const qRes = this.calcStats(qLogs);
                document.getElementById('qTarget').textContent = this.fmt(qRes.target);
                document.getElementById('qWorked').textContent = this.fmt(qRes.worked);
                this.setBadge('qBalance', qRes.bal);
                document.getElementById('qFails').textContent = qRes.fails;

                const list = document.getElementById('logList'); list.innerHTML = '';
                const mLogs = this.data.logs.filter(l => new Date(l.date + 'T00:00').getMonth() === m).sort((a, b) => new Date(b.date) - new Date(a.date));
                mLogs.forEach(l => {
                    const x = new Date(l.date + 'T00:00');
                    const net = (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0;
                    const bal = net - ((l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0);
                    let chips = '';
                    if (l.details) {
                        const pillClass = "px-1.5 py-0.5 rounded flex items-center gap-1 font-semibold text-[0.7rem] border border-border bg-bg/50 text-text-mute";
                        const excessClass = "bg-red-900/40 text-red-300 border-red-900";

                        if (l.details.bath > 0) chips += `<span class="${pillClass} ${l.details.bath > (config.bathAllow || 15) ? excessClass : ''}"><i class="ph-bold ph-toilet"></i> ${Math.round(l.details.bath)}m</span>`;
                        if (l.details.food > 0) chips += `<span class="${pillClass} ${l.details.food > (config.foodAllow || 45) ? excessClass : ''}"><i class="ph-bold ph-hamburger"></i> ${Math.round(l.details.food)}m</span>`;
                        if (l.details.pause > 0) chips += `<span class="${pillClass} text-warn border-warn"><i class="ph-bold ph-pause-circle"></i> ${Math.round(l.details.pause)}m</span>`;
                    }
                    const hourText = (l.type === 'Laboral' || (l.type === 'Descanso' && l.hours > 0)) ? `${l.in ? l.in + '-' + l.out + ' • ' : ''}<b>${this.fmt(net)}</b>` : '';

                    let tagClass = "px-2.5 py-1 rounded-md text-[0.7rem] font-extrabold uppercase inline-flex items-center justify-center leading-none tracking-wide ";
                    if(l.type === 'Laboral') tagClass += "bg-blue-900/30 text-blue-200";
                    else if(l.type === 'Descanso') tagClass += "bg-slate-800 text-slate-300 border border-white/5";
                    else if(l.type === 'Falta') tagClass += "bg-red-900/30 text-red-200";
                    else if(l.type === 'Vacaciones') tagClass += "bg-amber-900/30 text-amber-200";

                    const balClass = bal >= 0 ? "bg-emerald-900/30 text-emerald-300" : "bg-red-900/30 text-red-300";

                    const html = `
                    <div class="bg-card border border-border rounded-lg text-center py-1.5 flex flex-col items-center justify-center">
                        <div class="text-base font-extrabold text-text leading-none mb-0.5">${x.getDate()}</div>
                        <div class="text-[0.65rem] uppercase text-text-mute font-bold">${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][x.getDay()]}</div>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="flex items-center text-[0.85rem] font-semibold text-text"><span class="${tagClass}">${l.type}</span></div>
                        ${hourText ? `<div class="text-[0.8rem] text-text-mute flex gap-2 items-center font-medium">${hourText}</div>` : ''}
                        <div class="flex gap-1.5 flex-wrap text-[0.7rem]">${chips}</div>
                    </div>
                    <div class="text-center font-extrabold text-[0.8rem] px-2 py-1 rounded-md justify-self-end min-w-[60px] ${balClass}">${bal > 0 ? '+' : ''}${this.fmt(bal)}</div>`;
                    const div = document.createElement('div'); 
                    div.className = 'p-4 border-b border-border grid grid-cols-[45px_1fr_auto] gap-4 items-center hover:bg-white/5 transition-colors cursor-pointer last:border-b-0'; 
                    div.onclick = () => window.app.openModal(l.id); 
                    div.innerHTML = html;
                    list.appendChild(div);
                });
            },

            calcStats(logs) { let t = 0, w = 0, f = 0; logs.forEach(l => { t += (l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0; w += (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0; if (l.type === 'Falta') f++; }); return { target: t, worked: w, bal: w - t, fails: f }; },
            fmt(m) { const a = Math.abs(m); return `${m < 0 ? '-' : ''}${Math.floor(a / 60)}:${Math.floor(a % 60).toString().padStart(2, '0')}`; },
            fmtBreak(m) { return `${Math.floor(m).toString().padStart(2, '0')}:${Math.floor((m % 1) * 60).toString().padStart(2, '0')}`; },
            msToTime(ms) { const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60); return `${h}:${(m % 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; },
            getWeek(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - y) / 86400000) + 1) / 7); },
            setBadge(id, v) { 
                const e = document.getElementById(id); 
                e.textContent = (v > 0 ? '+' : '') + this.fmt(v); 
                e.className = `px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] ${v >= 0 ? 'bg-emerald-900/30 text-emerald-300' : 'bg-red-900/30 text-red-300'}`; 
            },
            changeMonth(n) { this.date.setMonth(this.date.getMonth() + n); this.date.setDate(1); this.render(); },
            changeWeek(n) { this.date.setDate(this.date.getDate() + (n * 7)); this.render(); },
            goToday() { this.date = new Date(); this.render(); },

            openConfigModal() { 
                const m = document.getElementById('configModal');
                m.classList.remove('hidden'); m.classList.add('flex');
                document.getElementById('cfgBath').value = this.data.config.bathAllow || 15; document.getElementById('cfgFood').value = this.data.config.foodAllow || 45; document.getElementById('cfgRate1').value = this.data.config.rate1; document.getElementById('cfgRate2').value = this.data.config.rate2; 
                this.switchTab('tSettings'); 
            },
            saveConfig() { this.data.config.bathAllow = parseFloat(document.getElementById('cfgBath').value) || 15; this.data.config.foodAllow = parseFloat(document.getElementById('cfgFood').value) || 45; this.data.config.rate1 = parseFloat(document.getElementById('cfgRate1').value) || 50; this.data.config.rate2 = parseFloat(document.getElementById('cfgRate2').value) || 75; this.save(); this.closeModalById('configModal'); },
            switchTab(id) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active', 'block')); document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); event.target.classList.add('active'); document.getElementById(id).classList.add('active', 'block'); document.getElementById(id).classList.remove('hidden'); },
            
            redirectToAuth() { window.location.href = "index.html"; },
            openAuthModal(m) { this.redirectToAuth(); },
            processAuth() { this.redirectToAuth(); },
            loginWithGoogle() { this.redirectToAuth(); },
            
            logout() { signOut(auth).then(() => window.location.href = "index.html"); }, 
            
            resetData() { if (confirm("¿Borrar todo?")) { this.data = { logs: [], config: this.data.config, activeShift: null }; this.save(); location.reload(); } },

            openModal(id = null) {
                this.editingId = id; 
                const m = document.getElementById('logModal');
                m.classList.remove('hidden');
                m.classList.add('flex');

                const now = new Date().toISOString().split('T')[0];
                document.getElementById('inpDate').value = now; document.getElementById('inpType').value = 'Laboral';
                document.getElementById('inpIn').value = ''; document.getElementById('inpOut').value = '';
                document.getElementById('inpBathTime').value = 0; document.getElementById('inpFoodTime').value = 0;
                document.getElementById('inpPauseTime').value = 0;

                const btnDel = document.getElementById('btnDelete');
                if (id) {
                    btnDel.classList.remove('hidden');
                    const l = this.data.logs.find(x => x.id === id);
                    document.getElementById('inpDate').value = l.date; document.getElementById('inpType').value = l.type;
                    document.getElementById('inpIn').value = l.in; document.getElementById('inpOut').value = l.out;
                    if (l.details) { 
                        document.getElementById('inpBathTime').value = Math.round(l.details.bath); 
                        document.getElementById('inpFoodTime').value = Math.round(l.details.food); 
                        document.getElementById('inpPauseTime').value = l.details.pause ? Math.round(l.details.pause) : 0;
                    }
                } else {
                    btnDel.classList.add('hidden');
                }
                this.toggleTimeInputs();
            },
            toggleTimeInputs() { 
                const type = document.getElementById('inpType').value;
                document.getElementById('timeInputs').style.display = (type === 'Falta' || type === 'Vacaciones') ? 'none' : 'block'; 
            },
            calcPreview() { 
                const i = document.getElementById('inpIn').value, o = document.getElementById('inpOut').value;
                const b = parseFloat(document.getElementById('inpBathTime').value) || 0;
                const f = parseFloat(document.getElementById('inpFoodTime').value) || 0; 
                const p = parseFloat(document.getElementById('inpPauseTime').value) || 0; 

                const g = this.calcHours(i, o);
                const config = this.data.config || {};
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                document.getElementById('calcHoursDisplay').textContent = g === -1 ? 'Error' : this.fmt(g - p - disc);
            },
            saveLog() {
                const d = document.getElementById('inpDate').value, t = document.getElementById('inpType').value, i = document.getElementById('inpIn').value, o = document.getElementById('inpOut').value;
                const b = parseFloat(document.getElementById('inpBathTime').value) || 0, f = parseFloat(document.getElementById('inpFoodTime').value) || 0;
                const p = parseFloat(document.getElementById('inpPauseTime').value) || 0;

                if (!d) return this.showMessage("Fecha requerida");
                let h = 0, disc = 0; 
                
                if (t === 'Laboral') {
                    if (!i || !o) return this.showMessage("Laboral requiere entrada y salida");
                    h = this.calcHours(i, o) - p; 
                    if (h <= 0) return this.showMessage("Horario inválido o pausa excede turno"); 
                } else if (t === 'Descanso') {
                    if (i && o) {
                        h = this.calcHours(i, o) - p;
                        if (h < 0) return this.showMessage("Horario inválido");
                    } else {
                        h = 0;
                    }
                }

                if (t === 'Laboral' || (t === 'Descanso' && h > 0)) {
                        const config = this.data.config || {};
                        disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                }

                const log = { id: this.editingId || this.getNow(), date: d, type: t, in: i || '', out: o || '', hours: h, disconnection: disc, details: { bath: b, food: f, pause: p } };
                if (this.editingId) this.data.logs[this.data.logs.findIndex(x => x.id === this.editingId)] = log; else this.data.logs.push(log);
                this.save(); this.render(); 
                this.closeModalById('logModal');
            },
            deleteLog() { if (confirm("¿Eliminar?")) { this.data.logs = this.data.logs.filter(x => x.id !== this.editingId); this.save(); this.render(); this.closeModalById('logModal'); } },
            
            closeModalById(id) {
                const m = document.getElementById(id);
                if(m) {
                    m.classList.remove('flex');
                    m.classList.add('hidden');
                }
            },

            showMessage(m) { 
                document.getElementById('msgText').textContent = m; 
                document.getElementById('msgIcon').className = 'ph-fill ph-warning-circle text-alert'; 
                const mod = document.getElementById('msgModal');
                mod.classList.remove('hidden');
                mod.classList.add('flex');
            },
            showSuccess(m) { 
                document.getElementById('msgText').textContent = m; 
                document.getElementById('msgIcon').className = 'ph-fill ph-check-circle text-money'; 
                const mod = document.getElementById('msgModal');
                mod.classList.remove('hidden');
                mod.classList.add('flex');
            },
            closeMessageModal() { 
                this.closeModalById('msgModal');
            },

            openImportModal() { 
                const m = document.getElementById('importModal');
                m.classList.remove('hidden');
                m.classList.add('flex');
            },
            processImport() { const t = document.getElementById('importTextArea').value; if (!t) return; const l = t.split('\n'); let c = 0; l.forEach(x => { const p = x.split(/[\t,]+/); if (p.length >= 4) { this.data.logs.push({ id: Date.now() + c, date: p[0], type: p[1], in: p[2], out: p[3], hours: this.calcHours(p[2], p[3]), disconnection: 0 }); c++; } }); this.save(); this.closeModalById('importModal'); this.showSuccess(c + " importados"); },
            
            // NUEVA FUNCIÓN DE IMPORTAR JSON
            importJson(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json.logs)) {
                            // Merge logs based on ID to avoid duplicates
                            let count = 0;
                            json.logs.forEach(l => {
                                if (!this.data.logs.find(x => x.id === l.id)) {
                                    this.data.logs.push(l);
                                    count++;
                                }
                            });
                            // Update config if exists
                            if(json.config) this.data.config = { ...this.data.config, ...json.config };
                            
                            this.save();
                            this.render();
                            this.showSuccess(count > 0 ? `${count} registros recuperados` : "Datos actualizados (Sin nuevos registros)");
                        } else {
                            this.showMessage("Archivo inválido");
                        }
                    } catch (err) {
                        this.showMessage("Error al leer JSON");
                    }
                    input.value = ''; // Reset
                };
                reader.readAsText(file);
            },

            exportBackup() { const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.data)); a.download = 'backup.json'; a.click(); },

            calcHours(i, o) { if (!i || !o) return 0; const [h1, m1] = i.split(':'), [h2, m2] = o.split(':'); const d = ((h2 * 60 + +m2) - (h1 * 60 + +m1)); return d < 0 ? -1 : d; },
            toggleLoader(s) { 
                const l = document.getElementById('mainLoader');
                if(s) l.classList.remove('hidden'); else l.classList.add('hidden');
            }
        };
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>

</html>
