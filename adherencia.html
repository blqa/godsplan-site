<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Adherencia</title>
    <!-- FUENTE UNIFICADA: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS & CONFIGURACI√ìN DE TEMA -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        'text-mute': 'var(--text-mute)',
                        brand: 'var(--brand)',
                        money: 'var(--money)',
                        alert: 'var(--alert)',
                        warn: 'var(--warn)',
                        border: 'var(--border)',
                        'input-bg': 'var(--input-bg)',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where
        };
    </script>

    <style>
        /* --- DEFINICI√ìN DE VARIABLES DE TEMA --- */
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-mute: #64748b;
            --brand: #2563eb;
            --money: #059669;
            --alert: #dc2626;
            --warn: #f59e0b;
            --border: #e2e8f0;
            --input-bg: #f8fafc;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-mute: #94a3b8;
            --brand: #3b82f6;
            --money: #10b981;
            --alert: #ef4444;
            --warn: #f59e0b;
            --border: #334155;
            --input-bg: #0f172a;
        }

        [data-theme="red"] {
            --bg: #000000;
            --card: #111111;
            --text: #e5e5e5;
            --text-mute: #737373;
            --brand: #dc2626;
            --money: #16a34a;
            --alert: #b91c1c;
            --warn: #d97706;
            --border: #262626;
            --input-bg: #0a0a0a;
        }

        /* RESET & UTILIDADES ESPEC√çFICAS */
        * { -webkit-tap-highlight-color: transparent; outline: none; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* Ocultar scrollbar en navegaci√≥n */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--brand); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }

        /* ESTADOS ACTIVOS COMPLEJOS */
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
        
        /* Botones de control de tiempo activos */
        .btn-ctrl.active-bath { background: var(--bg); color: var(--brand) !important; border-color: var(--brand) !important; box-shadow: inset 0 0 0 1px var(--brand); }
        .btn-ctrl.active-food { background: var(--bg); color: var(--warn) !important; border-color: var(--warn) !important; box-shadow: inset 0 0 0 1px var(--warn); }
        .btn-ctrl.active-pause { background: #fff7ed; color: #f97316 !important; border-color: #f97316 !important; box-shadow: inset 0 0 0 1px #f97316; }
        
        [data-theme="dark"] .btn-ctrl.active-pause, [data-theme="red"] .btn-ctrl.active-pause { background: #431407; color: #fb923c !important; border-color: #fb923c !important; }
        
        .side-clock.active { opacity: 1; transform: scale(1.05); background: transparent; }
        .side-clock.danger .side-val { color: var(--alert) !important; }
        
        /* Tabs del modal */
        .tab.active { color: var(--brand); border-bottom-color: var(--brand); }
        
        /* Theme buttons */
        .theme-btn.active { border-color: var(--brand); color: var(--brand); background: var(--card); box-shadow: 0 0 0 2px var(--brand); }
        
        /* Inputs Color Picker */
        input[type="color"] { -webkit-appearance: none; padding: 0; border: none; border-radius: 4px; height: 30px; width: 40px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
    </style>
</head>

<body class="bg-bg text-text font-sans pb-24 text-sm font-normal selection:bg-brand selection:text-white">

    <!-- NAV GLOBAL -->
    <nav id="global-nav" class="sticky top-0 z-[100] h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 shadow-md">
        <a href="/" class="text-white font-black text-base tracking-wide flex items-center gap-2 no-underline hover:text-red-500 transition-colors">
            <i class="ph-bold ph-circles-three-plus text-lg text-red-500"></i> God's Plan
        </a>
        <div class="flex items-center gap-5 overflow-x-auto no-scrollbar pr-2.5">
            <a href="/adherencia.html" class="g-link active text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap hover:text-white transition-colors">ADHERENCIA</a>
            <a href="/chat.html" class="g-link text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap hover:text-white transition-colors">CHAT</a>
            <a href="/finanzas" class="g-link text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap hover:text-white transition-colors">FINANZAS</a>
            <a href="/cuenta.html" class="g-link text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap hover:text-white transition-colors">CUENTA</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)] ml-1 shrink-0"></div>
        </div>
    </nav>

    <!-- HEADER APP -->
    <header class="bg-card border-b border-border py-2.5 px-4 sticky top-14 z-50 flex justify-between items-center shadow-sm flex-wrap gap-2.5">
        <div class="text-[1.1rem] font-extrabold flex items-center gap-2 text-text uppercase">
            <i class="ph-fill ph-check-circle text-brand"></i> <span>Adherencia</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap justify-end flex-1 md:flex-none">
            <!-- NUEVO: RELOJ REAL CDMX (Mejorado para m√≥vil) -->
            <div id="realWorldClock" class="flex flex-col items-end mr-1 px-2 py-0.5 border-r border-border/50 min-w-[70px]">
                <div class="text-[0.6rem] text-text-mute font-black tracking-wider leading-none mb-0.5 flex items-center gap-1 justify-end">
                     <span id="syncDot" class="w-1.5 h-1.5 rounded-full bg-red-500 inline-block"></span> CDMX
                </div>
                <div class="text-[0.9rem] font-mono font-bold text-text leading-none tabular-nums text-right" id="realClockTime">--:--:--</div>
            </div>

            <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg" onclick="window.app.openExtensionModal()" title="Instalar Extensi√≥n"><i class="ph-bold ph-puzzle-piece"></i></button>
            <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg" onclick="window.app.syncData()" title="Sincronizar"><i class="ph-bold ph-arrows-clockwise"></i></button>
            <button class="bg-transparent border border-border text-text-mute text-base p-1.5 rounded-lg flex items-center justify-center hover:bg-bg" onclick="window.app.openConfigModal()" title="Men√∫"><i class="ph-bold ph-list"></i></button>
            
            <div class="flex items-center gap-1 bg-bg px-2 py-1 rounded-full border border-border">
                <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center" onclick="window.app.changeMonth(-1)"><i class="ph-bold ph-caret-left"></i></button>
                <span class="text-[0.85rem] font-extrabold uppercase text-text min-w-[75px] text-center" id="monthLabel">--</span>
                <button class="bg-transparent border-none text-text-mute cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center" onclick="window.app.changeMonth(1)"><i class="ph-bold ph-caret-right"></i></button>
                <button class="bg-transparent border-none text-brand cursor-pointer text-[1.1rem] p-1 rounded-full flex items-center justify-center" onclick="window.app.goToday()"><i class="ph-bold ph-calendar-check"></i></button>
            </div>
        </div>
    </header>

    <div class="w-full max-w-[900px] mx-auto p-4 overflow-x-hidden">
        <div id="auth-status" class="text-center text-[0.85rem] text-text-mute mx-auto mb-5 py-2.5 px-4 w-fit bg-card border border-border rounded-full hidden items-center justify-center gap-2.5 shadow-sm">Conectando...</div>

        <!-- RELOJ -->
        <div class="bg-card rounded-2xl border border-border py-5 px-2.5 text-center mb-5 shadow-sm relative overflow-hidden">
            <!-- Loader Overlay -->
            <div id="mainLoader" class="absolute inset-0 bg-card/90 flex items-center justify-center z-10 rounded-2xl hidden">
                <div class="spinner"></div>
            </div>

            <!-- Timer Grid -->
            <div class="grid grid-cols-[1fr_1.2fr_1fr] items-center gap-1.5 mb-5" id="timersDisplay" style="display:none;">
                <!-- Ba√±o -->
                <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-80 transition-all cursor-pointer" id="clockBathContainer" onclick="window.app.openTimerEdit('bathroom')" type="button">
                    <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-toilet"></i> Ba√±o <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                    </div>
                    <div class="font-mono font-bold text-base text-text tabular-nums" id="dispBath">00:00</div>
                    <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limBath">15</span>m</div>
                    <div id="remBath" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                </button>
                
                <!-- Reloj Principal -->
                <div class="flex flex-col items-center">
                    <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-1.5" id="clockStatus">TURNO ACTIVO</div>
                    <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text tabular-nums leading-none" id="clockDisplay">00:00</div>
                    <div id="networkTimeBadge" class="text-[0.65rem] text-money font-bold mt-1.5 opacity-0 transition-opacity duration-500">
                        <i class="ph-bold ph-globe"></i> Local
                    </div>
                </div>

                <!-- Comida -->
                <button class="side-clock flex flex-col items-center justify-center opacity-50 p-1.5 rounded-lg relative z-10 w-full h-full border-none hover:bg-bg hover:opacity-80 transition-all cursor-pointer" id="clockFoodContainer" onclick="window.app.openTimerEdit('food')" type="button">
                    <div class="text-[0.65rem] font-extrabold uppercase text-text-mute mb-1 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-hamburger"></i> Comida <i class="ph-bold ph-pencil-simple text-brand text-[0.9em]"></i>
                    </div>
                    <div class="font-mono font-bold text-base text-text tabular-nums" id="dispFood">00:00</div>
                    <div class="text-[0.65rem] text-text-mute mt-0.5">/ <span id="limFood">45</span>m</div>
                    <div id="remFood" class="text-[0.7rem] font-extrabold mt-1 text-money">Restan: --</div>
                </button>
            </div>

            <!-- Offline Display -->
            <div id="offlineDisplay" style="display:block;">
                <div class="text-[0.7rem] uppercase tracking-widest text-text-mute font-extrabold mb-2.5">FUERA DE TURNO</div>
                <div class="text-[clamp(2.5rem,12vw,4rem)] font-extrabold text-text-mute tabular-nums leading-none mb-5">--:--:--</div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="grid grid-cols-2 gap-2.5 mt-4" id="actionButtons"></div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Semanal -->
            <div class="bg-card border border-border rounded-xl p-4">
                <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                    <div class="flex items-center gap-2">
                        <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0" onclick="window.app.changeWeek(-1)"><i class="ph-bold ph-caret-left"></i></button>
                        <span class="text-[0.9rem] font-extrabold text-text">Semana <span id="weekNum">--</span></span>
                        <button class="bg-transparent border-none text-brand cursor-pointer text-base p-0" onclick="window.app.changeWeek(1)"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <span id="weekBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-100 text-emerald-700">0h</span>
                </div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="weekTarget" class="text-text">0:00</strong></div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="weekWorked">0:00</strong></div>
                <div class="flex justify-between items-center mt-2.5 pt-1.5 border-t border-dashed border-border text-[0.9rem]">
                    <span class="text-text-mute">Pago Extra</span><strong class="text-money" id="weekPay">$0</strong>
                </div>
            </div>

            <!-- Quincenal -->
            <div class="bg-card border border-border rounded-xl p-4">
                <div class="flex justify-between items-center mb-2.5 pb-2 border-b border-border">
                    <span class="text-[0.9rem] font-extrabold text-text">Quincena <span id="qName">--</span></span>
                    <span id="qBalance" class="px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] bg-emerald-100 text-emerald-700">0h</span>
                </div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Meta</span><strong id="qTarget" class="text-text">0:00</strong></div>
                <div class="flex justify-between items-center mb-1 text-[0.9rem]"><span class="text-text-mute">Trabajado</span><strong class="text-brand" id="qWorked">0:00</strong></div>
                <div class="flex justify-between items-center mt-2.5 text-[0.9rem]"><span class="text-alert">Faltas</span><strong class="text-alert" id="qFails">0</strong></div>
            </div>
        </div>

        <!-- LISTA HISTORIAL -->
        <div class="bg-card border border-border rounded-2xl overflow-hidden shadow-sm mb-6">
            <div class="px-5 py-4 bg-bg font-extrabold text-text-mute text-[0.75rem] border-b border-border flex justify-between items-center tracking-wide">
                <span id="logListTitle">HISTORIAL</span>
                <button onclick="window.app.openModal()" class="border-none bg-transparent text-brand font-extrabold cursor-pointer hover:underline">+ MANUAL</button>
            </div>
            <div id="logList"></div>
        </div>

        <!-- GR√ÅFICOS ELIMINADOS -->
    </div>

    <!-- MODALES (Usando clases Tailwind para estructura, CSS para funcionalidad display) -->
    
    <!-- MENU CONFIGURACION -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="configModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 max-h-[85vh] overflow-y-auto border border-border">
            <h3 class="text-center mb-4 text-text font-bold text-lg">Configuraci√≥n</h3>
            
            <div class="flex border-b border-border mb-4">
                <div class="tab active flex-1 text-center p-2.5 text-[0.8rem] font-extrabold text-text-mute cursor-pointer border-b-[3px] border-transparent" onclick="window.app.switchTab('tAccount')">Cuenta</div>
                <div class="tab flex-1 text-center p-2.5 text-[0.8rem] font-extrabold text-text-mute cursor-pointer border-b-[3px] border-transparent" onclick="window.app.switchTab('tDesign')">Dise√±o</div>
                <div class="tab flex-1 text-center p-2.5 text-[0.8rem] font-extrabold text-text-mute cursor-pointer border-b-[3px] border-transparent" onclick="window.app.switchTab('tSettings')">Ajustes</div>
                <div class="tab flex-1 text-center p-2.5 text-[0.8rem] font-extrabold text-text-mute cursor-pointer border-b-[3px] border-transparent" onclick="window.app.switchTab('tData')">Datos</div>
            </div>

            <!-- TAB CUENTA -->
            <div id="tAccount" class="tab-content active block">
                <div id="authenticatedView" class="hidden bg-bg p-2.5 rounded-lg mb-4 border border-border">
                    <div id="userProfile" class="font-bold mb-1.5 text-text">...</div>
                    <button class="w-full p-2 rounded-lg font-bold cursor-pointer border border-border bg-transparent text-text-mute hover:bg-white/5" onclick="window.app.logout()">Cerrar Sesi√≥n</button>
                </div>
                <div id="unauthenticatedView" class="block text-center">
                    <p class="text-[0.8rem] text-text-mute mb-4">La autenticaci√≥n es centralizada en GodsPlan.site.</p>
                    <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-brand text-white hover:opacity-90 transition-opacity" onclick="window.app.redirectToAuth()">
                        <i class="ph-bold ph-sign-in"></i> Iniciar Sesi√≥n en GodsPlan.site
                    </button>
                </div>
            </div>

            <!-- TAB DISE√ëO -->
            <div id="tDesign" class="tab-content hidden">
                <p class="text-[0.7rem] font-bold text-text-mute mb-2.5">TEMA DE LA APP</p>
                <div class="grid grid-cols-2 gap-2.5 mb-4">
                    <button class="theme-btn p-2.5 rounded-lg border border-border bg-bg text-text cursor-pointer text-[0.8rem] font-bold flex items-center justify-center gap-1.5" id="btnThemeLight" onclick="window.app.setTheme('light')"><i class="ph-bold ph-sun"></i> Claro</button>
                    <button class="theme-btn p-2.5 rounded-lg border border-border bg-bg text-text cursor-pointer text-[0.8rem] font-bold flex items-center justify-center gap-1.5" id="btnThemeDark" onclick="window.app.setTheme('dark')"><i class="ph-bold ph-moon"></i> Oscuro</button>
                    <button class="theme-btn p-2.5 rounded-lg border border-border bg-bg text-text cursor-pointer text-[0.8rem] font-bold flex items-center justify-center gap-1.5" id="btnThemeRed" onclick="window.app.setTheme('red')"><i class="ph-bold ph-fire"></i> Red Core</button>
                    <button class="theme-btn p-2.5 rounded-lg border border-border bg-bg text-text cursor-pointer text-[0.8rem] font-bold flex items-center justify-center gap-1.5" id="btnThemeCustom" onclick="window.app.setTheme('custom')"><i class="ph-bold ph-palette"></i> Custom</button>
                </div>

                <div id="customColorsPanel" class="hidden bg-bg p-2.5 rounded-lg border border-border text-text">
                    <p class="text-[0.7rem] font-bold mb-2.5">COLORES PERSONALIZADOS</p>
                    <div class="flex items-center justify-between mb-2"><span>Fondo (BG)</span> <input type="color" id="ccBg" onchange="window.app.updateCustomTheme()"></div>
                    <div class="flex items-center justify-between mb-2"><span>Tarjetas</span> <input type="color" id="ccCard" onchange="window.app.updateCustomTheme()"></div>
                    <div class="flex items-center justify-between mb-2"><span>Texto</span> <input type="color" id="ccText" onchange="window.app.updateCustomTheme()"></div>
                    <div class="flex items-center justify-between mb-2"><span>Marca (Brand)</span> <input type="color" id="ccBrand" onchange="window.app.updateCustomTheme()"></div>
                </div>
            </div>

            <!-- TAB AJUSTES -->
            <div id="tSettings" class="tab-content hidden">
                <p class="text-[0.7rem] font-bold text-brand mb-1.5">TIEMPOS (MIN)</p>
                <div class="grid grid-cols-2 gap-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Ba√±o</label><input type="number" id="cfgBath" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Comida</label><input type="number" id="cfgFood" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                </div>
                <p class="text-[0.7rem] font-bold text-money my-2.5 mb-1.5">PAGOS ($)</p>
                <div class="grid grid-cols-2 gap-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Base</label><input type="number" id="cfgRate1" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Excedente</label><input type="number" id="cfgRate2" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                </div>
            </div>

            <!-- TAB DATOS -->
            <div id="tData" class="tab-content hidden">
                <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-brand text-white" onclick="window.app.openImportModal()">Importar Excel</button>
                <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute mb-2.5" onclick="window.app.exportBackup()">Descargar Backup</button>
                <div class="border-t border-border my-4"></div>
                <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer mb-2.5 text-alert border border-alert bg-transparent hover:bg-red-500/10" onclick="window.app.resetData()">Borrar Todo y Reiniciar</button>
            </div>

            <div class="mt-4 flex gap-2.5">
                <button class="flex-1 bg-text text-bg p-3 rounded-lg font-extrabold cursor-pointer border-none" onclick="window.app.saveConfig()">Guardar Cambios</button>
                <button class="flex-1 bg-transparent border border-border text-text-mute p-3 rounded-lg font-extrabold cursor-pointer" onclick="window.app.closeModalById('configModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- LOG MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="logModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Registro Manual</h3>
            
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Fecha</label>
            <input type="date" id="inpDate" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5">
            
            <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Tipo</label>
            <select id="inpType" onchange="window.app.toggleTimeInputs()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text mb-2.5">
                <option value="Laboral">Laboral</option>
                <option value="Descanso">Descanso</option>
                <option value="Falta">Falta</option>
                <option value="Vacaciones">Vacaciones</option>
            </select>

            <div id="timeInputs">
                <div class="grid grid-cols-2 gap-2.5 mb-2.5">
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Entrada</label><input type="time" id="inpIn" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                    <div><label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Salida</label><input type="time" id="inpOut" onchange="window.app.calcPreview()" class="bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text"></div>
                </div>
                <div class="bg-bg p-2.5 rounded-lg mb-2.5 border border-border">
                    <label class="block text-text-mute text-xs font-extrabold mb-1 uppercase">Minutos Reales:</label>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Ba√±o</label><input type="number" id="inpBathTime" value="0" oninput="window.app.calcPreview()" class="bg-card border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Comida</label><input type="number" id="inpFoodTime" value="0" oninput="window.app.calcPreview()" class="bg-card border border-border w-full p-1.5 rounded text-sm text-text"></div>
                        <div><label class="block text-text-mute text-[0.65rem] font-bold mb-1">Pausa</label><input type="number" id="inpPauseTime" value="0" oninput="window.app.calcPreview()" class="bg-card border border-border w-full p-1.5 rounded text-sm text-text"></div>
                    </div>
                </div>
                <p class="text-right text-text-mute text-sm">Neto Calculado: <strong id="calcHoursDisplay" class="text-text">0:00</strong></p>
            </div>

            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-text text-bg mt-4" onclick="window.app.saveLog()">Guardar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer mb-2.5 text-alert border border-alert bg-transparent hidden" id="btnDelete" onclick="window.app.deleteLog()">Eliminar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute" onclick="window.app.closeModalById('logModal')">Cancelar</button>
        </div>
    </div>

    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="clockOutModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <h3 class="text-text font-bold text-lg mb-4">¬øTerminar Turno?</h3>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-alert text-white mt-4 mb-2.5" onclick="window.app.finishShiftReal()">TERMINAR</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute" onclick="window.app.cancelClockOut()">Cancelar</button>
        </div>
    </div>

    <!-- EDITAR TIEMPO MODAL -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="timerEditModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Ajustar Tiempo</h3>
            <p class="text-sm mb-2.5 text-text-mute">
                Ingresa el tiempo acumulado para <strong id="timerEditTitle" class="text-text">--</strong>.
                <br><span class="text-xs">(Formatos aceptados: "15", "3.5" o "3:14")</span>
            </p>
            <input type="text" id="inpTimerEdit" placeholder="Ej. 3:14" class="text-lg text-center bg-input-bg border border-border w-full p-2.5 rounded-lg font-semibold text-text">
            <div class="flex gap-2.5 mt-4">
                <button class="flex-1 bg-text text-bg p-3 rounded-lg font-extrabold cursor-pointer border-none" onclick="window.app.saveTimerEdit()">Actualizar</button>
                <button class="flex-1 bg-transparent border border-border text-text-mute p-3 rounded-lg font-extrabold cursor-pointer" onclick="window.app.closeModalById('timerEditModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXTENSI√ìN -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="extensionModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[400px] p-5 border border-border text-left">
            <h3 class="text-money font-bold text-lg mb-2.5">‚úÖ Aviso de Seguridad</h3>
            <p class="font-bold mb-1.5 text-text">Integridad de TouchPoint Confirmada.</p>
            <p class="text-text-mute text-sm mb-4">Esta es una extensi√≥n de Solo Lectura (Read-Only) üîí.</p>
            <div class="flex flex-col gap-2.5">
                <a href="https://drive.usercontent.google.com/download?id=1TFqG9DAag7bVGEvt3J9ApXmmLtXNAsWh&export=download&authuser=0&confirm=t&uuid=d30b9e7f-cba4-4fab-b446-f2b8742d671e&at=ALWLOp6ky2w0gxN8yuHKk6f-jMCx:1765495468040" 
                   class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-brand text-white text-center no-underline block hover:opacity-90" 
                   download>
                    <i class="ph-bold ph-download-simple"></i> Agregar Extensi√≥n
                </a>
                <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute" onclick="window.app.closeModalById('extensionModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- UTILS MODALS -->
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="msgModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border text-center">
            <i id="msgIcon" class="text-[2.5rem] mb-2.5 block"></i>
            <p id="msgText" class="font-bold mb-5 text-text"></p>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none bg-text text-bg" onclick="window.app.closeModalById('msgModal')">OK</button>
        </div>
    </div>
    <div class="modal fixed inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[1000]" id="importModal">
        <div class="bg-card rounded-2xl w-[90%] max-w-[380px] p-5 border border-border">
            <h3 class="text-text font-bold text-lg mb-4">Importar Excel</h3>
            <textarea id="importTextArea" rows="6" class="font-mono text-xs w-full bg-input-bg border border-border p-2.5 rounded-lg text-text mb-4"></textarea>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border-none mb-2.5 bg-text text-bg" onclick="window.app.processImport()">Procesar</button>
            <button class="w-full p-3 rounded-lg font-extrabold cursor-pointer border border-border bg-transparent text-text-mute" onclick="window.app.closeModalById('importModal')">Cancelar</button>
        </div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } = window.firebaseImports;
        
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) { console.error(e); }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db;
        function showGlobalError(m) { const x = document.getElementById('msgModal'); if (x) { document.getElementById('msgText').textContent = m; document.getElementById('msgIcon').className = 'ph-fill ph-warning-circle text-alert'; x.classList.remove('hidden'); x.classList.add('flex'); } else alert(m); }
        window.onerror = function (m) { if (!String(m).includes('popup')) showGlobalError(m); };

        try { 
            const fbApp = initializeApp(firebaseConfig); 
            auth = getAuth(fbApp); 
            db = getFirestore(fbApp); 
        } catch (e) { setTimeout(() => showGlobalError(e.message), 1000); }

        window.app = {
            data: { logs: [], config: { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 }, activeShift: null },
            userId: null, offline: false, editingId: null, date: new Date(), timer: null, processing: false, authMode: 'login',
            currentTheme: 'light', editingTimerType: null, timeOffset: 0, lastSync: 0, isSyncing: false, nextSyncAllowed: 0,

            init() {
                // Se elimin√≥ la llamada a syncNetworkTime para evitar errores de conexi√≥n
                
                // Forzar actualizaci√≥n inmediata del reloj
                this.updateRealClockUI();
                // ACTUALIZADOR DEL RELOJ REAL (Header) - Loop normal
                setInterval(() => this.updateRealClockUI(), 1000);

                document.getElementById('auth-status').classList.remove('hidden');
                document.getElementById('auth-status').classList.add('flex');
                const savedTheme = localStorage.getItem('gp_theme') || 'dark';
                this.setTheme(savedTheme);
                const customColors = JSON.parse(localStorage.getItem('gp_custom_colors'));
                if (customColors) this.applyCustomColors(customColors);

                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'GODSPLAN_COMMAND') {
                        switch(event.data.action) {
                            case 'START_SHIFT': if (!this.data.activeShift) this.clockIn(); break;
                            case 'START_BREAK_FOOD': if (this.data.activeShift?.breakType !== 'food') this.toggleBreak('food'); break;
                            case 'START_BREAK_BATH': if (this.data.activeShift?.breakType !== 'bathroom') this.toggleBreak('bathroom'); break;
                            case 'RESUME_WORK': if (this.data.activeShift?.breakStart) this.stopBreak(); break;
                            case 'END_SHIFT': if (this.data.activeShift) this.confirmClockOut(); break;
                        }
                    }
                });

                if (!auth) return this.goOffline();

                onAuthStateChanged(auth, async u => {
                    if (u) { 
                        this.userId = u.uid; 
                        this.offline = false; 
                        this.renderAuth(u); 
                        await this.load(); 
                    } else {
                        if (initialAuthToken) {
                             try { await signInWithCustomToken(auth, initialAuthToken); return; } catch(e) { await signInAnonymously(auth).catch(() => this.goOffline()); }
                        } else {
                            await signInAnonymously(auth).catch(() => this.goOffline());
                        }
                    }
                    this.loadLocal(); 
                });
            },

            // Funci√≥n simplificada para el Sync Time (Solo stubs para evitar errores)
            async syncNetworkTime(force = false) {
                // Ya no intentamos conectar a servidores externos para evitar ERR_CONNECTION_RESET
                this.isSyncing = false;
            },

            // Funci√≥n dedicada para actualizar el Reloj Real del Header
            updateRealClockUI() {
                const now = new Date();
                const clockEl = document.getElementById('realClockTime');
                
                if (clockEl) {
                    try {
                        // Formatea la hora especificando la zona horaria de CDMX
                        const horaCDMX = new Intl.DateTimeFormat('es-MX', {
                            timeZone: 'America/Mexico_City',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false // Cambia a true si prefieres formato AM/PM
                        }).format(now);
                        
                        clockEl.textContent = horaCDMX;
                    } catch (e) {
                        // Fallback simple
                        clockEl.textContent = now.toLocaleTimeString();
                    }
                }
            },

            getNow() { return Date.now() + this.timeOffset; },

            getCDMXDate(ms) {
                 return new Date(ms).toLocaleDateString('en-CA', { timeZone: 'America/Mexico_City' });
            },

            getCDMXTime(ms) {
                return new Date(ms).toLocaleTimeString('es-MX', { 
                    timeZone: 'America/Mexico_City',
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: false 
                }).slice(0, 5);
            },

            setTheme(t) {
                this.currentTheme = t;
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('gp_theme', t);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById(t === 'light' ? 'btnThemeLight' : t === 'dark' ? 'btnThemeDark' : t === 'red' ? 'btnThemeRed' : 'btnThemeCustom');
                if (btn) btn.classList.add('active');
                document.getElementById('customColorsPanel').style.display = t === 'custom' ? 'block' : 'none';
                if (t !== 'custom') {
                    document.documentElement.style.removeProperty('--bg'); document.documentElement.style.removeProperty('--card');
                    document.documentElement.style.removeProperty('--text'); document.documentElement.style.removeProperty('--brand');
                } else {
                    const cc = JSON.parse(localStorage.getItem('gp_custom_colors'));
                    if (cc) this.applyCustomColors(cc);
                }
            },

            toggleTheme() {
                const order = ['light', 'dark', 'red'];
                let idx = order.indexOf(this.currentTheme);
                if (idx === -1) idx = 0; 
                this.setTheme(order[(idx + 1) % order.length]);
            },

            updateCustomTheme() {
                const colors = { bg: document.getElementById('ccBg').value, card: document.getElementById('ccCard').value, text: document.getElementById('ccText').value, brand: document.getElementById('ccBrand').value };
                this.applyCustomColors(colors);
                localStorage.setItem('gp_custom_colors', JSON.stringify(colors));
            },

            applyCustomColors(c) {
                const r = document.documentElement.style;
                r.setProperty('--bg', c.bg); r.setProperty('--card', c.card); r.setProperty('--text', c.text); r.setProperty('--brand', c.brand);
                document.getElementById('ccBg').value = c.bg; document.getElementById('ccCard').value = c.card; document.getElementById('ccText').value = c.text; document.getElementById('ccBrand').value = c.brand;
            },

            goOffline() { this.offline = true; document.getElementById('auth-status').innerHTML = `<i class="ph-bold ph-wifi-slash"></i> Offline`; this.loadLocal(); },
            
            renderAuth(u) {
                const isRealUser = u && !u.isAnonymous;
                document.getElementById('authenticatedView').style.display = isRealUser ? 'block' : 'none';
                document.getElementById('unauthenticatedView').style.display = isRealUser ? 'none' : 'block';
                let t = u ? (u.isAnonymous ? "AN√ìNIMO" : (u.displayName || "Usuario")) : "DESCONECTADO";
                if (isRealUser && u.email && u.email.includes('@godsplan.site')) t = u.email.split('@')[0];
                document.getElementById('auth-status').innerHTML = `<i class="ph-fill ph-user-circle"></i> ${t}`;
                document.getElementById('userProfile').textContent = t;
            },

            loadLocal() { const d = localStorage.getItem('godsPlanData'); if (d) { try { this.data = JSON.parse(d); this.render(); this.uiClock(); } catch (e) { } } },
            
            async load() {
                if (this.offline || !this.userId) return;
                try {
                    const docRef = doc(db, "godsPlanData", this.userId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) { 
                        this.data = snap.data(); 
                        this.data.logs = this.data.logs || []; 
                        this.data.config = this.data.config || { rate1: 50, rate2: 75, bathAllow: 15, foodAllow: 45 };
                    } else if (auth.currentUser.isAnonymous) { 
                        const l = localStorage.getItem('godsPlanData'); 
                        if (l) { this.data = JSON.parse(l); this.save(); } 
                    }
                    this.render(); this.uiClock();
                } catch (e) { console.error(e); }
            },
            
            async save() {
                localStorage.setItem('godsPlanData', JSON.stringify(this.data));
                if (!this.offline && this.userId) {
                    const docRef = doc(db, "godsPlanData", this.userId);
                    await setDoc(docRef, this.data);
                }
            },
            
            syncData() { this.load(); this.showSuccess("Sincronizado"); this.syncNetworkTime(true); },
            openExtensionModal() { document.getElementById('extensionModal').classList.remove('hidden'); document.getElementById('extensionModal').classList.add('flex'); },

            uiClock() {
                const s = this.data.activeShift;
                const area = document.getElementById('actionButtons');
                const off = document.getElementById('offlineDisplay');
                const on = document.getElementById('timersDisplay');
                const config = this.data.config || {}; 
                const bl = config.bathAllow || 15;
                const fl = config.foodAllow || 45;

                // CLASES DE BOTONES COMUNES
                const btnBase = "btn-ctrl h-[55px] rounded-lg border-none font-extrabold text-[0.85rem] cursor-pointer flex flex-col items-center justify-center gap-0.5 uppercase transition-all relative overflow-hidden active:scale-95";
                const btnStart = `${btnBase} col-span-2 text-lg h-[70px] text-white bg-gradient-to-br from-blue-600 to-blue-800`;
                const btnStop = `${btnBase} col-span-2 text-white bg-gradient-to-br from-red-600 to-red-800`;
                const btnBath = `${btnBase} bg-bg text-text-mute border border-border`;
                const btnFood = `${btnBase} bg-bg text-text-mute border border-border`;
                const btnPause = `${btnBase} col-span-2 bg-bg text-text-mute border border-border`;

                if (!s) {
                    off.style.display = 'block'; on.style.display = 'none';
                    area.innerHTML = `<button class="${btnStart}" onclick="window.app.clockIn()"><i class="ph-bold ph-play"></i> INICIAR JORNADA</button>`;
                    if (this.timer) clearInterval(this.timer);
                    document.getElementById('clockStatus').textContent = "FUERA DE TURNO";
                    document.getElementById('clockStatus').classList.remove('animate-pulse-custom');
                    document.getElementById('clockStatus').classList.remove('text-warn');
                } else {
                    if (!s.breaks) { s.breaks = { bathroom: 0, food: 0, pause: 0 }; this.save(); }
                    if (s.breaks.pause === undefined) s.breaks.pause = 0;

                    off.style.display = 'none'; on.style.display = 'grid';
                    document.getElementById('limBath').textContent = bl;
                    document.getElementById('limFood').textContent = fl;
                    const bathEl = document.getElementById('clockBathContainer');
                    const foodEl = document.getElementById('clockFoodContainer');
                    
                    area.innerHTML = `
                        <button class="${btnBath} ${s.breakType === 'bathroom' ? 'active-bath' : ''}" onclick="window.app.toggleBreak('bathroom')"><i class="ph-bold ph-toilet"></i> BA√ëO</button>
                        <button class="${btnFood} ${s.breakType === 'food' ? 'active-food' : ''}" onclick="window.app.toggleBreak('food')"><i class="ph-bold ph-hamburger"></i> COMIDA</button>
                        <button class="${btnPause} ${s.breakType === 'pause' ? 'active-pause' : ''}" onclick="window.app.toggleBreak('pause')"><i class="ph-bold ph-pause-circle"></i> ${s.breakType === 'pause' ? 'REANUDAR' : 'PAUSAR / DESCONEXI√ìN'}</button>
                        <button class="${btnStop}" onclick="window.app.confirmClockOut()"><i class="ph-bold ph-stop"></i> TERMINAR JORNADA</button>
                    `;

                    if (this.timer) clearInterval(this.timer);
                    this.timer = setInterval(() => {
                        const now = this.getNow();
                        
                        let totalPauseAccumulated = (s.breaks.pause || 0) * 60000;
                        let currentPauseDuration = 0;

                        if (s.breakType === 'pause') {
                            document.getElementById('clockStatus').textContent = "PAUSADO";
                            document.getElementById('clockStatus').classList.add('animate-pulse-custom');
                            document.getElementById('clockStatus').classList.add('text-warn');
                            
                            currentPauseDuration = now - s.breakStart;
                        } else {
                            document.getElementById('clockStatus').textContent = "TURNO ACTIVO";
                            document.getElementById('clockStatus').classList.remove('animate-pulse-custom');
                            document.getElementById('clockStatus').classList.remove('text-warn');
                        }

                        let displayTime = (now - s.start) - totalPauseAccumulated - currentPauseDuration;
                        document.getElementById('clockDisplay').textContent = this.msToTime(displayTime);

                        let b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                        if (s.breakStart) {
                            const d = (now - s.breakStart) / 60000;
                            if (s.breakType === 'bathroom') b += d; else if (s.breakType === 'food') f += d;
                        }
                        
                        document.getElementById('dispBath').textContent = this.fmtBreak(b);
                        if (s.breakType === 'bathroom') bathEl.classList.add('active'); else bathEl.classList.remove('active');
                        if (b > bl) bathEl.classList.add('danger'); else bathEl.classList.remove('danger');

                        const bathRem = (config.bathAllow || 15) - b;
                        const elRemBath = document.getElementById('remBath');
                        if (elRemBath) {
                            elRemBath.textContent = bathRem >= 0 ? `Restan: ${this.fmtBreak(bathRem)}` : `Exceso: ${this.fmtBreak(Math.abs(bathRem))}`;
                            elRemBath.className = bathRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }

                        document.getElementById('dispFood').textContent = this.fmtBreak(f);
                        if (s.breakType === 'food') foodEl.classList.add('active'); else foodEl.classList.remove('active');
                        if (f > fl) foodEl.classList.add('danger'); else foodEl.classList.remove('danger');

                        const foodRem = (config.foodAllow || 45) - f;
                        const elRemFood = document.getElementById('remFood');
                        if (elRemFood) {
                            elRemFood.textContent = foodRem >= 0 ? `Restan: ${this.fmtBreak(foodRem)}` : `Exceso: ${this.fmtBreak(Math.abs(foodRem))}`;
                            elRemFood.className = foodRem >= 0 ? 'text-[0.7rem] font-extrabold mt-1 text-money' : 'text-[0.7rem] font-extrabold mt-1 text-alert';
                        }
                    }, 1000);
                }
            },
            
            openTimerEdit(type) {
                if (!this.data.activeShift) return;
                this.editingTimerType = type;
                let currentTotal = this.data.activeShift.breaks[type] || 0;
                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === type) {
                    currentTotal += (this.getNow() - this.data.activeShift.breakStart) / 60000;
                }
                document.getElementById('timerEditTitle').textContent = type === 'bathroom' ? 'Ba√±o' : 'Comida';
                const m = Math.floor(currentTotal);
                const s = Math.floor((currentTotal % 1) * 60);
                document.getElementById('inpTimerEdit').value = `${m}:${s.toString().padStart(2, '0')}`; 
                const modal = document.getElementById('timerEditModal');
                if(modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                setTimeout(() => document.getElementById('inpTimerEdit').focus(), 100);
            },

            saveTimerEdit() {
                if (!this.editingTimerType || !this.data.activeShift) return;
                const valStr = document.getElementById('inpTimerEdit').value.trim();
                let newVal = 0;
                if (valStr.includes(':')) {
                    const parts = valStr.split(':');
                    newVal = (parseInt(parts[0]) || 0) + ((parseInt(parts[1]) || 0) / 60);
                } else newVal = parseFloat(valStr);
                
                if (isNaN(newVal) || newVal < 0) return this.showMessage("Tiempo inv√°lido");

                if (this.data.activeShift.breakStart && this.data.activeShift.breakType === this.editingTimerType) {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                    this.data.activeShift.breakStart = this.getNow();
                } else {
                    this.data.activeShift.breaks[this.editingTimerType] = newVal;
                }
                this.save(); this.uiClock();
                document.getElementById('timerEditModal').classList.remove('flex');
                document.getElementById('timerEditModal').classList.add('hidden');
            },

            clockIn() {
                if (auth.currentUser?.isAnonymous) {
                    this.showMessage("Inicia sesi√≥n primero.");
                    this.redirectToAuth();
                    return;
                }
                if (this.processing) return; this.processing = true;
                this.stopBreak();
                this.data.activeShift = { start: this.getNow(), breaks: { bathroom: 0, food: 0, pause: 0 }, breakStart: null, breakType: null };
                this.save(); this.uiClock(); this.processing = false;
            },
            toggleBreak(type) {
                const s = this.data.activeShift; if (!s) return;
                if (s.breakStart) {
                    const prev = s.breakType;
                    this.stopBreak();
                    if (prev !== type) setTimeout(() => this.startBreak(type), 50);
                } else this.startBreak(type);
            },
            startBreak(t) { 
                this.data.activeShift.breakStart = this.getNow(); 
                this.data.activeShift.breakType = t; 
                this.save(); this.uiClock(); 
            },
            stopBreak() {
                const s = this.data.activeShift;
                if (s && s.breakStart) {
                    if (s.breakType) {
                        if (s.breaks[s.breakType] === undefined) s.breaks[s.breakType] = 0;
                        s.breaks[s.breakType] += (this.getNow() - s.breakStart) / 60000;
                    }
                    s.breakStart = null; s.breakType = null;
                    this.save(); this.uiClock();
                }
            },
            confirmClockOut() {
                if (this.data.activeShift.breakStart) this.stopBreak();
                if (this.data.activeShift) {
                    const m = document.getElementById('clockOutModal');
                    m.classList.remove('hidden');
                    m.classList.add('flex');
                }
            },
            finishShiftReal() {
                const s = this.data.activeShift;
                if (!s) return;
                if (s.breakStart) this.stopBreak(); 
                if (!s.breaks) s.breaks = { bathroom: 0, food: 0, pause: 0 };
                
                const end = this.getNow();
                const totalWallTime = (end - s.start) / 60000;
                const pauseTime = s.breaks.pause || 0;
                const gross = totalWallTime - pauseTime;
                
                const b = s.breaks.bathroom || 0, f = s.breaks.food || 0;
                const config = this.data.config || {}; 
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                const logDate = this.getCDMXDate(s.start);
                const logIn = this.getCDMXTime(s.start);
                const logOut = this.getCDMXTime(end);

                this.data.logs.push({
                    id: this.getNow(), 
                    date: logDate, 
                    type: 'Laboral',
                    in: logIn,        
                    out: logOut,     
                    hours: gross, 
                    disconnection: disc, 
                    details: { bath: b, food: f, pause: pauseTime }
                });
                this.data.activeShift = null;
                this.save(); this.render(); this.uiClock();
                document.getElementById('clockOutModal').classList.remove('flex');
                document.getElementById('clockOutModal').classList.add('hidden');
            },
            cancelClockOut() { 
                document.getElementById('clockOutModal').classList.remove('flex'); 
                document.getElementById('clockOutModal').classList.add('hidden'); 
            },

            render() {
                const d = this.date, m = d.getMonth(), y = d.getFullYear();
                document.getElementById('monthLabel').textContent = `${["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"][m]} ${y}`;
                const wn = this.getWeek(d);
                document.getElementById('weekNum').textContent = wn;

                const wLogs = this.data.logs.filter(l => this.getWeek(new Date(l.date + 'T00:00')) === wn && new Date(l.date).getFullYear() === y);
                const wRes = this.calcStats(wLogs);
                document.getElementById('weekTarget').textContent = this.fmt(wRes.target);
                document.getElementById('weekWorked').textContent = this.fmt(wRes.worked);
                this.setBadge('weekBalance', wRes.bal);
                const config = this.data.config || {}; 
                let pay = 0, he = Math.floor(wRes.bal / 60);
                if (wRes.bal > 0) pay = (he <= 12) ? he * (config.rate1 || 50) : (12 * (config.rate1 || 50)) + ((he - 12) * (config.rate1 || 50));
                document.getElementById('weekPay').textContent = `$${Math.round(pay)}`;

                const isQ1 = d.getDate() <= 15;
                document.getElementById('qName').textContent = isQ1 ? 'Q1' : 'Q2';
                const qLogs = this.data.logs.filter(l => { const x = new Date(l.date + 'T00:00'); return x.getMonth() === m && (isQ1 ? x.getDate() <= 15 : x.getDate() > 15); });
                const qRes = this.calcStats(qLogs);
                document.getElementById('qTarget').textContent = this.fmt(qRes.target);
                document.getElementById('qWorked').textContent = this.fmt(qRes.worked);
                this.setBadge('qBalance', qRes.bal);
                document.getElementById('qFails').textContent = qRes.fails;

                const list = document.getElementById('logList'); list.innerHTML = '';
                const mLogs = this.data.logs.filter(l => new Date(l.date + 'T00:00').getMonth() === m).sort((a, b) => new Date(b.date) - new Date(a.date));
                mLogs.forEach(l => {
                    const x = new Date(l.date + 'T00:00');
                    const net = (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0;
                    const bal = net - ((l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0);
                    let chips = '';
                    if (l.details) {
                        const pillClass = "px-1.5 py-0.5 rounded flex items-center gap-1 font-semibold text-[0.7rem] border border-border bg-bg text-text-mute";
                        const excessClass = "bg-red-100 text-red-800 border-red-200 dark:bg-red-900 dark:text-red-300 dark:border-red-800";

                        if (l.details.bath > 0) chips += `<span class="${pillClass} ${l.details.bath > (config.bathAllow || 15) ? excessClass : ''}"><i class="ph-bold ph-toilet"></i> ${Math.round(l.details.bath)}m</span>`;
                        if (l.details.food > 0) chips += `<span class="${pillClass} ${l.details.food > (config.foodAllow || 45) ? excessClass : ''}"><i class="ph-bold ph-hamburger"></i> ${Math.round(l.details.food)}m</span>`;
                        if (l.details.pause > 0) chips += `<span class="${pillClass} text-warn border-warn"><i class="ph-bold ph-pause-circle"></i> ${Math.round(l.details.pause)}m</span>`;
                    }
                    const hourText = (l.type === 'Laboral' || (l.type === 'Descanso' && l.hours > 0)) ? `${l.in ? l.in + '-' + l.out + ' ‚Ä¢ ' : ''}<b>${this.fmt(net)}</b>` : '';

                    // TAG STYLES
                    let tagClass = "px-2.5 py-1 rounded-md text-[0.7rem] font-extrabold uppercase inline-flex items-center justify-center leading-none tracking-wide ";
                    if(l.type === 'Laboral') tagClass += "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";
                    else if(l.type === 'Descanso') tagClass += "bg-slate-100 text-slate-600 border border-border dark:bg-slate-800 dark:text-slate-300 dark:border-transparent";
                    else if(l.type === 'Falta') tagClass += "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";
                    else if(l.type === 'Vacaciones') tagClass += "bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200";

                    // BALANCE STYLES
                    const balClass = bal >= 0 ? "bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-300" : "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";

                    const html = `
                    <div class="bg-bg border border-border rounded-lg text-center py-1.5 flex flex-col items-center justify-center">
                        <div class="text-base font-extrabold text-text leading-none mb-0.5">${x.getDate()}</div>
                        <div class="text-[0.65rem] uppercase text-text-mute font-bold">${['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][x.getDay()]}</div>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="flex items-center text-[0.85rem] font-semibold text-text"><span class="${tagClass}">${l.type}</span></div>
                        ${hourText ? `<div class="text-[0.8rem] text-text-mute flex gap-2 items-center font-medium">${hourText}</div>` : ''}
                        <div class="flex gap-1.5 flex-wrap text-[0.7rem]">${chips}</div>
                    </div>
                    <div class="text-center font-extrabold text-[0.8rem] px-2 py-1 rounded-md justify-self-end min-w-[60px] ${balClass}">${bal > 0 ? '+' : ''}${this.fmt(bal)}</div>`;
                    const div = document.createElement('div'); 
                    div.className = 'p-4 border-b border-border grid grid-cols-[45px_1fr_auto] gap-4 items-center hover:bg-bg transition-colors cursor-pointer last:border-b-0'; 
                    div.onclick = () => window.app.openModal(l.id); 
                    div.innerHTML = html;
                    list.appendChild(div);
                });
            },

            calcStats(logs) { let t = 0, w = 0, f = 0; logs.forEach(l => { t += (l.type === 'Laboral' || l.type === 'Falta') ? 480 : 0; w += (l.type === 'Laboral' || l.type === 'Descanso') ? (l.hours - (l.disconnection || 0)) : 0; if (l.type === 'Falta') f++; }); return { target: t, worked: w, bal: w - t, fails: f }; },
            fmt(m) { const a = Math.abs(m); return `${m < 0 ? '-' : ''}${Math.floor(a / 60)}:${Math.floor(a % 60).toString().padStart(2, '0')}`; },
            fmtBreak(m) { return `${Math.floor(m).toString().padStart(2, '0')}:${Math.floor((m % 1) * 60).toString().padStart(2, '0')}`; },
            msToTime(ms) { const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60); return `${h}:${(m % 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; },
            getWeek(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - y) / 86400000) + 1) / 7); },
            setBadge(id, v) { 
                const e = document.getElementById(id); 
                e.textContent = (v > 0 ? '+' : '') + this.fmt(v); 
                e.className = `px-2 py-0.5 rounded-md font-extrabold text-[0.8rem] ${v >= 0 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}`; 
            },
            changeMonth(n) { this.date.setMonth(this.date.getMonth() + n); this.date.setDate(1); this.render(); },
            changeWeek(n) { this.date.setDate(this.date.getDate() + (n * 7)); this.render(); },
            goToday() { this.date = new Date(); this.render(); },

            openConfigModal() { 
                const m = document.getElementById('configModal');
                m.classList.remove('hidden');
                m.classList.add('flex');
                document.getElementById('cfgBath').value = this.data.config.bathAllow || 15; document.getElementById('cfgFood').value = this.data.config.foodAllow || 45; document.getElementById('cfgRate1').value = this.data.config.rate1; document.getElementById('cfgRate2').value = this.data.config.rate2; this.switchTab('tAccount'); 
            },
            saveConfig() { this.data.config.bathAllow = parseFloat(document.getElementById('cfgBath').value) || 15; this.data.config.foodAllow = parseFloat(document.getElementById('cfgFood').value) || 45; this.data.config.rate1 = parseFloat(document.getElementById('cfgRate1').value) || 50; this.data.config.rate2 = parseFloat(document.getElementById('cfgRate2').value) || 75; this.save(); document.getElementById('configModal').classList.remove('active'); document.getElementById('configModal').classList.add('hidden'); document.getElementById('configModal').classList.remove('flex'); },
            switchTab(id) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('block')); document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); event.target.classList.add('active'); document.getElementById(id).classList.add('active'); document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('block'); },
            
            redirectToAuth() {
                 this.showMessage("Redirigiendo a GodsPlan.site para iniciar sesi√≥n...");
                 setTimeout(() => { window.location.href = "https://godsplan.site"; }, 1500);
            },
            
            openAuthModal(m) { this.redirectToAuth(); },
            async processAuth() { this.redirectToAuth(); },
            async loginWithGoogle() { this.redirectToAuth(); },
            
            logout() { signOut(auth).then(() => window.location.href = "https://godsplan.site"); }, 
            
            resetData() { if (confirm("¬øBorrar todo?")) { this.data = { logs: [], config: this.data.config, activeShift: null }; this.save(); location.reload(); } },

            openModal(id = null) {
                this.editingId = id; 
                const m = document.getElementById('logModal');
                m.classList.remove('hidden');
                m.classList.add('flex');

                const now = new Date().toISOString().split('T')[0];
                document.getElementById('inpDate').value = now; document.getElementById('inpType').value = 'Laboral';
                document.getElementById('inpIn').value = ''; document.getElementById('inpOut').value = '';
                document.getElementById('inpBathTime').value = 0; document.getElementById('inpFoodTime').value = 0;
                document.getElementById('inpPauseTime').value = 0;

                const btnDel = document.getElementById('btnDelete');
                if (id) {
                    btnDel.classList.remove('hidden');
                    const l = this.data.logs.find(x => x.id === id);
                    document.getElementById('inpDate').value = l.date; document.getElementById('inpType').value = l.type;
                    document.getElementById('inpIn').value = l.in; document.getElementById('inpOut').value = l.out;
                    if (l.details) { 
                        document.getElementById('inpBathTime').value = Math.round(l.details.bath); 
                        document.getElementById('inpFoodTime').value = Math.round(l.details.food); 
                        document.getElementById('inpPauseTime').value = l.details.pause ? Math.round(l.details.pause) : 0;
                    }
                } else {
                    btnDel.classList.add('hidden');
                }
                this.toggleTimeInputs();
            },
            toggleTimeInputs() { 
                const type = document.getElementById('inpType').value;
                document.getElementById('timeInputs').style.display = (type === 'Falta' || type === 'Vacaciones') ? 'none' : 'block'; 
            },
            calcPreview() { 
                const i = document.getElementById('inpIn').value, o = document.getElementById('inpOut').value;
                const b = parseFloat(document.getElementById('inpBathTime').value) || 0;
                const f = parseFloat(document.getElementById('inpFoodTime').value) || 0; 
                const p = parseFloat(document.getElementById('inpPauseTime').value) || 0; 

                const g = this.calcHours(i, o);
                const config = this.data.config || {};
                const disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                
                document.getElementById('calcHoursDisplay').textContent = g === -1 ? 'Error' : this.fmt(g - p - disc);
            },
            saveLog() {
                const d = document.getElementById('inpDate').value, t = document.getElementById('inpType').value, i = document.getElementById('inpIn').value, o = document.getElementById('inpOut').value;
                const b = parseFloat(document.getElementById('inpBathTime').value) || 0, f = parseFloat(document.getElementById('inpFoodTime').value) || 0;
                const p = parseFloat(document.getElementById('inpPauseTime').value) || 0;

                if (!d) return this.showMessage("Fecha requerida");
                let h = 0, disc = 0; 
                
                if (t === 'Laboral') {
                    if (!i || !o) return this.showMessage("Laboral requiere entrada y salida");
                    h = this.calcHours(i, o) - p; 
                    if (h <= 0) return this.showMessage("Horario inv√°lido o pausa excede turno"); 
                } else if (t === 'Descanso') {
                    if (i && o) {
                        h = this.calcHours(i, o) - p;
                        if (h < 0) return this.showMessage("Horario inv√°lido");
                    } else {
                        h = 0;
                    }
                }

                if (t === 'Laboral' || (t === 'Descanso' && h > 0)) {
                        const config = this.data.config || {};
                        disc = Math.max(0, b - (config.bathAllow || 15)) + Math.max(0, f - (config.foodAllow || 45));
                }

                const log = { id: this.editingId || this.getNow(), date: d, type: t, in: i || '', out: o || '', hours: h, disconnection: disc, details: { bath: b, food: f, pause: p } };
                if (this.editingId) this.data.logs[this.data.logs.findIndex(x => x.id === this.editingId)] = log; else this.data.logs.push(log);
                this.save(); this.render(); 
                this.closeModalById('logModal');
            },
            deleteLog() { if (confirm("¬øEliminar?")) { this.data.logs = this.data.logs.filter(x => x.id !== this.editingId); this.save(); this.render(); this.closeModalById('logModal'); } },
            
            closeModalById(id) {
                const m = document.getElementById(id);
                if(m) {
                    m.classList.remove('flex');
                    m.classList.add('hidden');
                }
            },

            showMessage(m) { 
                document.getElementById('msgText').textContent = m; 
                document.getElementById('msgIcon').className = 'ph-fill ph-warning-circle text-alert'; 
                const mod = document.getElementById('msgModal');
                mod.classList.remove('hidden');
                mod.classList.add('flex');
            },
            showSuccess(m) { 
                document.getElementById('msgText').textContent = m; 
                document.getElementById('msgIcon').className = 'ph-fill ph-check-circle text-money'; 
                const mod = document.getElementById('msgModal');
                mod.classList.remove('hidden');
                mod.classList.add('flex');
            },
            closeMessageModal() { 
                this.closeModalById('msgModal');
            },

            openImportModal() { 
                const m = document.getElementById('importModal');
                m.classList.remove('hidden');
                m.classList.add('flex');
            },
            processImport() { const t = document.getElementById('importTextArea').value; if (!t) return; const l = t.split('\n'); let c = 0; l.forEach(x => { const p = x.split(/[\t,]+/); if (p.length >= 4) { this.data.logs.push({ id: Date.now() + c, date: p[0], type: p[1], in: p[2], out: p[3], hours: this.calcHours(p[2], p[3]), disconnection: 0 }); c++; } }); this.save(); this.closeModalById('importModal'); this.showSuccess(c + " importados"); },
            exportBackup() { const a = document.createElement('a'); a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.data)); a.download = 'backup.json'; a.click(); },

            calcHours(i, o) { if (!i || !o) return 0; const [h1, m1] = i.split(':'), [h2, m2] = o.split(':'); const d = ((h2 * 60 + +m2) - (h1 * 60 + +m1)); return d < 0 ? -1 : d; },
            toggleLoader(s) { 
                const l = document.getElementById('mainLoader');
                if(s) l.classList.remove('hidden'); else l.classList.add('hidden');
            }
        };
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>

</html>
