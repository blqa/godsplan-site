<!DOCTYPE html>
<html lang="es" style="background-color: #050505;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God's Plan | Finanzas</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, 
            getFirestore, doc, onSnapshot, collection, query, orderBy, 
            limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS GLOBALES Y UTILIDADES */
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Glassmorphism */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-nav { background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); }

        /* Inputs modernos */
        .input-modern {
            background: #000; border: 1px solid #333; color: white; border-radius: 16px;
            transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .input-modern:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); outline: none; }

        /* Chips animados */
        .chip { transition: all 0.2s; user-select: none; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.05); box-shadow: 0 4px 12px (239, 68, 68, 0.3); }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; }
        .toast { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 30px; border: 1px solid #333; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; animation: fadeIn 0.3s forwards; pointer-events: auto; }
        
        /* Global Nav Styles */
        #global-nav { z-index: 1000; box-sizing: border-box; position: sticky; top: 0; height: 56px; }
        .g-logo { color: #fff; font-weight: 900; text-decoration: none; font-size: 1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; position: relative; z-index: 1001; cursor: pointer; }
        .g-logo:hover { color: #ef4444; transition: color 0.3s; }
        .g-links { display: flex; align-items: center; gap: 20px; }
        .g-link { color: #71717a; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: color 0.2s; white-space: nowrap; position: relative; z-index: 1001; padding: 10px 0; cursor: pointer; }
        .g-link:hover { color: #fff; }
        .g-link.active { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; }
        
        /* Custom Confirm Modal Style */
        .custom-dialog {
            background-color: #121212;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 320px;
        }

        /* Modals Genericos */
        .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-card { background: #121212; border: 1px solid #333; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; }
        .full-btn { width: 100%; padding: 16px; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 12px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
        .full-btn:active { transform: scale(0.98); }

        /* --- ESTILOS DE IMPRESIÓN (ESTADO DE CUENTA) --- */
        @media print {
            @page { margin: 10mm; size: auto; }
            body { 
                background-color: white !important; 
                color: black !important; 
                overflow: visible !important; 
                font-family: sans-serif;
            }
            #global-nav, #fabContainer, .glass-nav, #app-content, #toast-container, #modalOverlay, #confirmDialog, #authModal { 
                display: none !important; 
            }
            #print-area { 
                display: block !important; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: auto; 
                z-index: 9999; 
                background: white;
                padding: 20px;
            }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .print-table th { background-color: #f2f2f2; font-weight: bold; }
            .print-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-section { margin-bottom: 25px; }
            .print-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
            .print-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .print-summary-item { border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm sm:text-base bg-[#050505] text-[#e5e5e5]">

    <!-- NAV SUPERIOR (Global) -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="g-logo"><i class="ph-bold ph-circles-three-plus text-lg"></i> God's Plan</a>
        <div class="g-links">
            <a href="/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/chat.html" class="g-link">CHAT</a>
            <a href="#" class="g-link active">FINANZAS</a>
            <a href="/cuenta.html" class="g-link">CUENTA</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-zinc-800 ml-1" title="Estado"></div>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="app-content" class="flex-1 overflow-y-auto pb-32 relative scroll-smooth">
        
        <!-- VISTA: BILLETERA -->
        <section id="view-balance" class="p-5 max-w-md mx-auto fade-in">
            
            <!-- Header Periodo -->
            <div class="flex justify-between items-end mb-6">
                <div>
                    <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1">CICLO ACTUAL</p>
                    <h2 class="text-lg font-bold text-white flex items-center gap-2" id="periodDates">Cargando...</h2>
                </div>
                <div id="daysLeftBadge" class="text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold">
                    -- Días
                </div>
            </div>

            <!-- TARJETA PRINCIPAL -->
            <div class="glass rounded-3xl p-6 relative overflow-hidden group">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-red-600/20 rounded-full blur-3xl group-hover:bg-red-600/30 transition-colors"></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Disponible por día</span>
                        <i class="ph ph-trend-up text-zinc-600"></i>
                    </div>
                    <div class="text-5xl font-black text-white tracking-tighter mb-6" id="dailyFree">---</div>
                    
                    <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                        <div>
                            <span class="block text-[10px] text-zinc-500 uppercase font-bold">Restante Total</span>
                            <span class="lg font-bold text-zinc-200" id="totalFree">---</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[10px] text-zinc-500 uppercase font-bold">Gastado Hoy</span>
                            <span class="lg font-bold text-red-400" id="todayTotal">---</span>
                        </div>
                    </div>
                </div>
                <div class="absolute bottom-0 left-0 h-1 bg-zinc-800 w-full">
                    <div id="periodProgress" class="h-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <!-- BOTONES RÁPIDOS -->
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="app.openModal('extra')" class="bg-zinc-900 border border-zinc-800 hover:border-emerald-500/50 hover:bg-emerald-900/10 text-emerald-500 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 transition-all">
                    <i class="ph-bold ph-arrow-down-left"></i> INGRESO EXTRA
                </button>
                <button onclick="app.scrollToChart()" class="bg-zinc-900 border border-zinc-800 hover:border-zinc-700 text-zinc-400 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 transition-all">
                    <i class="ph-bold ph-chart-pie"></i> VER ANÁLISIS
                </button>
            </div>
            
            <!-- BOTÓN ESTADO DE CUENTA -->
            <button onclick="app.generateReport()" class="w-full mt-3 bg-zinc-900 border border-zinc-800 hover:bg-white hover:text-black text-zinc-400 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 transition-all">
                <i class="ph-bold ph-file-text"></i> GENERAR ESTADO DE CUENTA (PDF)
            </button>

            <!-- LISTA MOVIMIENTOS -->
            <div class="mt-8">
                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4 px-1">Actividad Reciente</h3>
                <div id="transactionsList" class="space-y-3 pb-10">
                    <div class="text-center py-10 text-zinc-600 animate-pulse">Cargando datos...</div>
                </div>
            </div>

            <!-- CHART SECTION -->
            <div id="chartSection" class="mt-8 mb-10 p-4 bg-zinc-900/50 rounded-3xl border border-zinc-800 hidden">
                <h3 class="text-center text-xs font-bold text-zinc-500 mb-4">DISTRIBUCIÓN DE GASTOS</h3>
                <div class="h-48 relative">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </section>

        <!-- VISTA: PLAN (CONFIG) -->
        <section id="view-plan" class="p-5 max-w-md mx-auto hidden fade-in">
            <h2 class="text-2xl font-black text-white mb-1">Estrategia</h2>
            <p class="text-zinc-500 text-xs mb-6">Configura tus ingresos fijos, deudas y gastos recurrentes.</p>
            
            <!-- RESUMEN DE OBLIGACIONES -->
            <div class="glass rounded-2xl p-4 mb-6">
                <h4 class="text-xs font-bold text-zinc-400 uppercase tracking-widest mb-2">Obligaciones</h4>
                <div class="flex justify-between items-center text-sm mb-2">
                    <span class="text-zinc-300">Total Gastos Fijos (Quincena)</span>
                    <span id="summaryFixed" class="font-bold text-red-400">---</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-zinc-300">Total Deudas Cortas Pendientes</span>
                    <span id="summaryShortLoans" class="font-bold text-orange-400">---</span>
                </div>
            </div>

            <!-- INGRESO -->
            <div class="bg-zinc-900 border border-zinc-800 p-5 rounded-2xl mb-6">
                <label class="text-emerald-500 text-xs font-bold uppercase tracking-wider mb-2 block">Ingreso Neto (Quincenal)</label>
                <div class="relative flex items-center">
                    <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl text-zinc-500 font-light pointer-events-none">$</span>
                    <input type="number" id="inpIncome" inputmode="decimal" class="bg-transparent text-3xl font-bold text-white w-full focus:outline-none placeholder-zinc-700 pl-8" placeholder="0.00" onblur="app.saveConfig()">
                </div>
            </div>
            
            <!-- PRÉSTAMOS -->
            <div class="flex justify-between items-center mb-4 px-1">
                <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Deudas Cortas Pendientes</span>
                <button onclick="app.openModal('loan')" class="bg-white text-black text-[10px] font-black px-3 py-1.5 rounded-full hover:scale-105 transition-transform flex items-center gap-1">
                    <i class="ph-bold ph-plus"></i> AGREGAR DEUDA
                </button>
            </div>
            <div id="loansList" class="space-y-2 mb-8">
                <div class="text-center py-4 text-zinc-700 text-xs">No hay deudas cortas registradas.</div>
            </div>

            <!-- GASTOS FIJOS -->
            <div class="flex justify-between items-center mb-4 px-1">
                <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Gastos Fijos</span>
                <button onclick="app.openModal('fixed')" class="bg-white text-black text-[10px] font-black px-3 py-1.5 rounded-full hover:scale-105 transition-transform flex items-center gap-1">
                    <i class="ph-bold ph-plus"></i> AGREGAR
                </button>
            </div>
            <div id="fixedExpensesList" class="space-y-2 mb-10">
                <div class="text-center py-4 text-zinc-700 text-xs">Aún no has agregado gastos fijos.</div>
            </div>

            <!-- CUENTA Y DATA -->
            <div class="border-t border-zinc-800 pt-6">
                <h3 class="text-xs font-bold text-zinc-600 mb-4 uppercase">Cuenta & Datos</h3>
                <div class="bg-zinc-900 rounded-xl p-4 flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-zinc-700 to-zinc-600 flex items-center justify-center">
                            <i class="ph-fill ph-user text-white text-xs"></i>
                        </div>
                        <div class="text-left">
                            <div id="userName" class="text-sm font-bold text-white">Invitado</div>
                            <div id="userStatusText" class="text-[10px] text-zinc-500">Sin conexión</div>
                        </div>
                    </div>
                    <!-- Si no hay sesión, se muestra el botón para redirigir -->
                    <button id="btnLogin" onclick="app.redirectToAuth()" class="text-xs bg-blue-600/20 text-blue-400 px-3 py-1.5 rounded-lg font-bold border border-blue-600/30">ENTRAR</button>
                </div>
                
                <button onclick="app.resetData()" class="w-full text-xs text-red-500/70 py-3 font-bold hover:text-red-500 flex items-center justify-center gap-2">
                    <i class="ph-bold ph-trash"></i> BORRAR TODOS LOS DATOS
                </button>
            </div>
        </section>

    </main>
    
    <!-- ÁREA DE IMPRESIÓN (OCULTA HASTA QUE SE LLAMA) -->
    <div id="print-area"></div>
    
    <!-- FAB (NUEVO GASTO) -->
    <div id="fabContainer" class="fixed bottom-[100px] left-1/2 -translate-x-1/2 z-40 transition-all duration-300">
        <button onclick="app.openModal('expense')" class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-white shadow-[0_8px_25px_rgba(220,38,38,0.5)] border-4 border-[#050505] active:scale-95 transition-transform group">
            <i class="ph-bold ph-minus text-2xl group-hover:rotate-180 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- NAV INFERIOR (GLASS) -->
    <div class="glass-nav fixed bottom-0 w-full h-[84px] grid grid-cols-2 pb-5 z-50">
        <button class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-500" onclick="app.switchView('balance')">
            <i class="ph-fill ph-wallet text-2xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">BILLETERA</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-500" onclick="app.switchView('plan')">
            <i class="ph-fill ph-sliders-horizontal text-2xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">PLAN</span>
        </button>
    </div>

    <!-- MODAL SHEET (PARA FORMS) -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex-col justify-end transition-opacity opacity-0" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet" class="bg-[#121212] w-full max-w-lg mx-auto rounded-t-[32px] border-t border-zinc-800 p-6 pb-10 translate-y-full transition-transform duration-300">
            <!-- Handle -->
            <div class="w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo Gasto</h3>
                <button onclick="app.closeModal()" class="w-8 h-8 rounded-full bg-zinc-900 flex items-center justify-center text-zinc-400"><i class="ph-bold ph-x"></i></button>
            </div>

            <!-- Form Transacción / Ingreso -->
            <div id="formTransaction" class="hidden">
                <div class="relative mb-6">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+60px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light">$</span>
                    <input type="number" id="txAmount" inputmode="decimal" class="bg-transparent text-center text-6xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800" placeholder="0">
                </div>
                <div id="categoryChips" class="flex flex-wrap justify-center gap-2 mb-6"></div>
                <input type="text" id="txDesc" class="input-modern w-full p-4 mb-4 text-center" placeholder="Nota opcional...">
                <button id="btnSaveTx" onclick="app.saveTransaction()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-lg hover:scale-[1.02] transition-transform active:scale-95 shadow-lg shadow-white/10">GUARDAR</button>
                <button id="btnDeleteTx" onclick="app.deleteTxConfirm()" class="w-full mt-3 text-red-500 py-3 font-bold text-xs hidden">ELIMINAR TRANSACCIÓN</button>
            </div>

            <!-- Form Gasto Fijo -->
            <div id="formFixed" class="hidden space-y-4">
                <div>
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Nombre del Gasto</label>
                    <input type="text" id="fixName" class="input-modern w-full p-4 mt-1" placeholder="Ej: Netflix, Renta...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Monto</label>
                        <input type="number" id="fixAmount" inputmode="decimal" class="input-modern w-full p-4 mt-1" placeholder="$0.00">
                    </div>
                    <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Día de Pago</label>
                        <input type="number" id="fixDay" inputmode="numeric" class="input-modern w-full p-4 mt-1 text-center" placeholder="1-31">
                    </div>
                </div>
                <button onclick="app.saveFixed()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4">GUARDAR FIJO</button>
                <button id="btnDeleteFix" onclick="app.deleteFixedConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>
            
            <!-- Form Préstamo/Deuda -->
            <div id="formLoan" class="hidden space-y-4">
                <div>
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Concepto del Préstamo</label>
                    <input type="text" id="loanName" class="input-modern w-full p-4 mt-1" placeholder="Ej: Deuda a Papá">
                </div>
                <div>
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Monto Prestado/Pendiente</label>
                    <input type="number" id="loanAmount" inputmode="decimal" class="input-modern w-full p-4 mt-1" placeholder="$0.00">
                </div>
                <div>
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2">Fecha Límite de Pago</label>
                    <input type="date" id="loanDueDate" class="input-modern w-full p-4 mt-1">
                </div>
                <button onclick="app.saveLoan()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4">GUARDAR PRÉSTAMO Y SUMAR AL BALANCE</button>
                <button id="btnDeleteLoan" onclick="app.deleteLoanConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">MARCAR COMO PAGADO (ELIMINAR DEUDA)</button>
            </div>

        </div>
    </div>
    
    <!-- AUTH MODAL BLOCKER (SI NO HAY SESION) -->
    <div class="modal" id="authModal">
        <div class="modal-card">
            <div class="mb-6 flex justify-center text-red-500 text-4xl"><i class="ph-fill ph-lock-key"></i></div>
            <h2 class="text-xl font-bold text-white mb-2">Acceso Requerido</h2>
            <p class="text-xs text-gray-500 mb-6">Debes iniciar sesión con tu cuenta corporativa para usar esta aplicación.</p>
            <button class="full-btn" onclick="window.app.redirectToAuth()">Ir a GodsPlan.site</button>
        </div>
    </div>
    
    <!-- DIALOGO DE CONFIRMACIÓN CUSTOM -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center opacity-0 transition-opacity">
        <div class="custom-dialog rounded-xl p-5 m-5">
            <h4 id="confirmTitle" class="text-lg font-bold text-white mb-2">Confirmación</h4>
            <p id="confirmMessage" class="text-zinc-400 text-sm mb-5">¿Estás seguro de esta acción?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="text-zinc-400 text-sm font-bold px-4 py-2 rounded-lg hover:bg-zinc-800 transition-colors">Cancelar</button>
                <button id="confirmAction" class="bg-red-600 text-white text-sm font-bold px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <script type="module">
        // Acceder a los imports modulares
        const {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword,
            getFirestore, doc, onSnapshot, collection, query, orderBy, 
            limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch
        } = window.firebaseImports;
        
        // --- 1. CONFIGURACIÓN & UTILIDADES ---
        
        // URL de redirección al hub
        const HOME_URL = "/"; 
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) { console.error("Error config", e); }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const PRIVATE_DATA_PATH = (uid) => `godsPlanData/${uid}`;
        const LOGS_COLLECTION = (uid) => `${PRIVATE_DATA_PATH(uid)}/logs`;

        let fbApp, auth, db;
        try {
            fbApp = initializeApp(firebaseConfig);
            auth = getAuth(fbApp);
            db = getFirestore(fbApp);
        } catch(e) { console.error("Error Init:", e); }

        // Utilidades UI
        const UI = {
            toast(msg, type = 'info') {
                const con = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = 'toast';
                const iconMap = { success: 'ph-check-circle text-emerald-400', error: 'ph-warning text-red-400', info: 'ph-info text-blue-400' };
                const iconClass = iconMap[type] || iconMap.info;
                el.innerHTML = `<i class="ph-fill ${iconClass} text-xl"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                con.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
            },
            fmtMoney(n) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 }).format(n || 0); },
            confirm(title, message) {
                return new Promise(resolve => {
                    const dialog = document.getElementById('confirmDialog');
                    const dialogTitle = document.getElementById('confirmTitle');
                    const dialogMessage = document.getElementById('confirmMessage');
                    const actionBtn = document.getElementById('confirmAction');
                    const cancelBtn = document.getElementById('confirmCancel');
                    if (!dialog) return resolve(true);
                    dialogTitle.textContent = title; dialogMessage.textContent = message;
                    const cleanup = (result) => { dialog.classList.add('opacity-0'); setTimeout(() => dialog.classList.add('hidden'), 300); actionBtn.removeEventListener('click', onAction); cancelBtn.removeEventListener('click', onCancel); resolve(result); };
                    const onAction = () => cleanup(true); const onCancel = () => cleanup(false);
                    actionBtn.addEventListener('click', onAction); cancelBtn.addEventListener('click', onCancel);
                    dialog.classList.remove('hidden'); requestAnimationFrame(() => dialog.classList.remove('opacity-0'));
                });
            }
        };

        const PeriodCalculator = {
            calculate() {
                const now = new Date(); const d = now.getDate(); const m = now.getMonth(); const y = now.getFullYear();
                let start, end;
                if (d >= 5 && d <= 19) { start = new Date(y, m, 5); end = new Date(y, m, 19); } 
                else { if (d >= 20) { start = new Date(y, m, 20); end = new Date(y, m + 1, 4); } else { start = new Date(y, m - 1, 20); end = new Date(y, m, 4); } }
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
                const totalDurationMs = end.getTime() - start.getTime(); const elapsedMs = now.getTime() - start.getTime();
                const daysLeft = Math.ceil((end.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                const progress = Math.min(100, Math.max(0, (elapsedMs / totalDurationMs) * 100));
                return { start, end, daysLeft: Math.max(0, daysLeft), progress };
            }
        };

        const Categories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' }, { id: 'Transporte', icon: 'ph-taxi', color: 'text-blue-400' },
            { id: 'Ocio', icon: 'ph-popcorn', color: 'text-purple-400' }, { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' }, { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Deuda/Reembolso', icon: 'ph-receipt', color: 'text-indigo-400' }, { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
        ];

        // --- 3. APLICACIÓN PRINCIPAL ---
        const app = window.app = {
            user: null, data: { income: 0, fixed: [], loans: [] }, logs: [], currentPeriod: null, mode: 'expense', editId: null, chartInstance: null, chipsRendered: false,

            renderCategoryChips() {
                if (this.chipsRendered) return;
                const chipContainer = document.getElementById('categoryChips');
                if (chipContainer) {
                    Categories.forEach(c => {
                        chipContainer.innerHTML += `<div class="chip bg-zinc-800 border border-zinc-700 px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer hover:bg-zinc-700" onclick="app.selectCategory('${c.id}', this)"><i class="ph-fill ${c.icon} ${c.color}"></i> <span class="text-xs font-bold text-zinc-300">${c.id}</span></div>`;
                    });
                    this.chipsRendered = true;
                }
            },

            async init() {
                if (!auth) { UI.toast("Error: Firebase no pudo inicializarse", "error"); return; }
                onAuthStateChanged(auth, async (u) => {
                    if (u && !u.isAnonymous) {
                         this.user = u;
                         this.updateUserUI();
                         document.getElementById('authModal').classList.remove('active');
                         this.setupRealtimeListeners();
                    } else {
                         if (!u && initialAuthToken) {
                            try { await signInWithCustomToken(auth, initialAuthToken); return; } catch(e){}
                         }
                         if (!u) {
                             await signInAnonymously(auth); // Intentar anónimo para evitar errores de null, pero bloquear UI
                         }
                         // Bloqueo
                         document.getElementById('authModal').classList.add('active');
                    }
                });
                this.refreshPeriod(); setInterval(() => this.refreshPeriod(), 60000);
            },

            redirectToAuth() { window.location.href = HOME_URL; },

            refreshPeriod() {
                this.currentPeriod = PeriodCalculator.calculate();
                const fmt = { day: 'numeric', month: 'short' };
                const periodDatesEl = document.getElementById('periodDates');
                if (periodDatesEl) periodDatesEl.innerHTML = `<span class="text-zinc-400">${this.currentPeriod.start.toLocaleDateString('es-ES', fmt)}</span> <i class="ph-bold ph-arrow-right text-xs text-zinc-600"></i> <span class="text-white">${this.currentPeriod.end.toLocaleDateString('es-ES', fmt)}</span>`;
                const daysLeftBadgeEl = document.getElementById('daysLeftBadge'); if (daysLeftBadgeEl) daysLeftBadgeEl.textContent = `${this.currentPeriod.daysLeft} días restantes`;
                const periodProgressEl = document.getElementById('periodProgress'); if (periodProgressEl) periodProgressEl.style.width = `${this.currentPeriod.progress}%`;
                this.calculateBalance();
            },

            setupRealtimeListeners() {
                if(!this.user || !db) return;
                const uid = this.user.uid;
                const userDocRef = doc(db, 'godsPlanData', uid);
                const logsCollectionRef = collection(db, 'godsPlanData', uid, 'logs');

                onSnapshot(userDocRef, (docSnap) => {
                    const syncEl = document.getElementById('syncStatus');
                    if (syncEl) { syncEl.classList.remove('bg-zinc-800', 'bg-red-500'); syncEl.classList.add('bg-emerald-500'); syncEl.title = "Online"; }
                    if(docSnap.exists()) {
                        this.data = { income: 0, fixed: [], loans: [], ...docSnap.data() };
                        const inpIncomeEl = document.getElementById('inpIncome'); if (inpIncomeEl) inpIncomeEl.value = this.data.income || '';
                        this.renderFixedList(); this.renderLoansList(); this.calculateBalance();
                    } else { setDoc(userDocRef, { income: 0, fixed: [], loans: [] }, { merge: true }); }
                }, err => console.error("Error config:", err));

                // No orderBy to avoid index error in this environment
                onSnapshot(logsCollectionRef, (snapshot) => {
                    let tempLogs = snapshot.docs.map(d => ({id: d.id, ...d.data(), date: d.data().date instanceof Date ? d.data().date.toISOString() : d.data().date}));
                    tempLogs.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort client-side
                    this.logs = tempLogs;
                    this.renderTransactions(); this.calculateBalance(); this.updateChart();
                }, err => console.error("Error logs:", err));
            },

            calculateBalance() {
                if(!this.currentPeriod) return;
                const pStartDay = this.currentPeriod.start.getDate();
                const isFirstQ = pStartDay === 5;
                let activeFixedTotal = 0;
                (this.data.fixed || []).forEach(f => {
                    const d = parseInt(f.day); let applies = false;
                    if (isFirstQ) { if (d >= 5 && d <= 19) applies = true; } else { if (d >= 20 || d <= 4) applies = true; }
                    if(applies) activeFixedTotal += (parseFloat(f.amount) || 0);
                });
                const totalShortLoansPending = (this.data.loans || []).reduce((sum, loan) => sum + (parseFloat(loan.amount) || 0), 0);
                let spentInPeriod = 0; let extraIncomeInPeriod = 0;
                const startTime = this.currentPeriod.start.getTime(); const endTime = this.currentPeriod.end.getTime();
                this.logs.forEach(log => {
                    const logTime = new Date(log.date).getTime();
                    if(logTime >= startTime && logTime <= endTime) {
                        if(log.type === 'income') extraIncomeInPeriod += log.amount; else spentInPeriod += log.amount;
                    }
                });
                const baseIncome = parseFloat(this.data.income) || 0;
                const totalExpenses = activeFixedTotal + spentInPeriod;
                const totalAvailable = (baseIncome + extraIncomeInPeriod) - totalExpenses;
                const divisor = Math.max(1, this.currentPeriod.daysLeft);
                const dailyAvailable = totalAvailable / divisor;

                const elDaily = document.getElementById('dailyFree');
                if (elDaily) { elDaily.textContent = UI.fmtMoney(dailyAvailable); elDaily.className = `text-5xl font-black tracking-tighter mb-6 ${dailyAvailable < 0 ? 'text-red-500' : 'text-white'}`; }
                const totalFreeEl = document.getElementById('totalFree'); if (totalFreeEl) totalFreeEl.textContent = UI.fmtMoney(totalAvailable);
                const todayStr = new Date().toDateString();
                const spentToday = this.logs.filter(l => l.type === 'expense' && new Date(l.date).toDateString() === todayStr).reduce((sum, l) => sum + l.amount, 0);
                const todayTotalEl = document.getElementById('todayTotal'); if (todayTotalEl) todayTotalEl.textContent = `-${UI.fmtMoney(spentToday)}`;
                const summaryFixedEl = document.getElementById('summaryFixed'); if (summaryFixedEl) summaryFixedEl.textContent = UI.fmtMoney(activeFixedTotal);
                const summaryShortLoansEl = document.getElementById('summaryShortLoans'); if (summaryShortLoansEl) summaryShortLoansEl.textContent = UI.fmtMoney(totalShortLoansPending);
            },

            renderTransactions() {
                const list = document.getElementById('transactionsList'); if (!list) return;
                list.innerHTML = '';
                if(this.logs.length === 0) { list.innerHTML = `<div class="text-center text-zinc-700 py-4 text-xs">No hay movimientos recientes</div>`; document.getElementById('chartSection').classList.add('hidden'); return; }
                this.logs.slice(0, 20).forEach(log => {
                    const isInc = log.type === 'income'; const dateObj = new Date(log.date);
                    const cat = Categories.find(c => c.id === log.category) || { icon: 'ph-question', color: 'text-gray-400' };
                    const iconClass = isInc ? 'ph-money' : cat.icon; const bgClass = isInc ? 'bg-emerald-500/10 text-emerald-500' : 'bg-zinc-800 text-zinc-400';
                    const isLoanIncome = isInc && log.category === 'Deuda/Reembolso';
                    const name = log.desc || (isLoanIncome ? `Préstamo Recibido` : log.category) || (isInc ? 'Ingreso Extra' : 'Gasto');
                    list.innerHTML += `<div onclick="app.openModal('${isInc ? 'extra' : 'expense'}', '${log.id}')" class="flex justify-between items-center p-3 bg-zinc-900/40 border border-zinc-800/50 rounded-2xl active:bg-zinc-800 transition-colors cursor-pointer"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${bgClass} flex items-center justify-center text-lg"><i class="ph-fill ${iconClass}"></i></div><div><h4 class="font-bold text-zinc-200 text-xs">${name}</h4><p class="text-[10px] text-zinc-500">${dateObj.toLocaleDateString()}</p></div></div><span class="font-bold text-sm ${isInc ? 'text-emerald-500' : 'text-zinc-200'}">${isInc ? '+' : '-'}${UI.fmtMoney(log.amount)}</span></div>`;
                });
            },

            renderFixedList() {
                const list = document.getElementById('fixedExpensesList'); if (!list) return;
                list.innerHTML = ''; const fixed = this.data.fixed || [];
                if(fixed.length === 0) { list.innerHTML = `<div class="text-center py-4 text-zinc-700 text-xs">Aún no has agregado gastos fijos.</div>`; return; }
                fixed.sort((a,b) => a.day - b.day).forEach((f, idx) => { list.innerHTML += `<div onclick="app.openModal('fixed', ${idx})" class="flex justify-between items-center p-4 bg-zinc-900 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition-colors"><div class="flex items-center gap-3"><span class="text-xs font-bold bg-zinc-800 text-zinc-400 w-8 h-8 flex items-center justify-center rounded-lg">${f.day}</span><span class="font-bold text-sm text-zinc-300">${f.name}</span></div><span class="text-zinc-400 font-mono text-xs">-${UI.fmtMoney(f.amount)}</span></div>`; });
            },
            
            renderLoansList() {
                const list = document.getElementById('loansList'); if (!list) return;
                list.innerHTML = ''; const loans = this.data.loans || [];
                if(loans.length === 0) { list.innerHTML = `<div class="text-center py-4 text-zinc-700 text-xs">No hay deudas cortas registradas.</div>`; return; }
                loans.forEach((loan, idx) => {
                    const dueDate = loan.dueDate ? new Date(loan.dueDate) : null; const today = new Date(); today.setHours(0, 0, 0, 0);
                    let statusClass = 'text-orange-400'; let statusText = 'Pendiente';
                    if (dueDate) { const dueTime = new Date(dueDate); dueTime.setHours(0, 0, 0, 0); if (dueTime.getTime() < today.getTime()) { statusClass = 'text-red-400'; statusText = 'VENCIDO'; } }
                    list.innerHTML += `<div class="flex justify-between items-center p-4 bg-zinc-900 border border-zinc-800 rounded-xl hover:border-zinc-600 transition-colors"><div onclick="app.openModal('loan', ${idx})" class="flex items-center gap-3 flex-1 cursor-pointer"><span class="text-xs font-bold ${statusClass} w-8 h-8 flex items-center justify-center rounded-lg"><i class="ph-bold ph-calendar-blank text-xl"></i></span><div class="flex flex-col"><span class="font-bold text-sm text-zinc-300">${loan.name}</span><span class="text-[10px] text-zinc-500">Monto: ${UI.fmtMoney(loan.amount)}</span></div></div><div class="text-right flex items-center gap-3"><div class="flex flex-col items-end"><span class="block font-bold text-sm ${statusText}">Pagar antes</span><span class="text-[10px] ${statusClass}">${dueDate ? dueDate.toLocaleDateString() : 'N/A'}</span></div><button onclick="app.deleteLoanConfirm(${idx})" class="w-8 h-8 bg-red-600/10 text-red-400 rounded-full flex items-center justify-center hover:bg-red-600/20 shrink-0"><i class="ph-bold ph-trash"></i></button></div></div>`;
                });
            },

            updateChart() {
                if(!this.currentPeriod) return;
                const startTime = this.currentPeriod.start.getTime(); const endTime = this.currentPeriod.end.getTime();
                const periodExpenses = this.logs.filter(l => l.type === 'expense' && new Date(l.date).getTime() >= startTime && new Date(l.date).getTime() <= endTime);
                const chartSectionEl = document.getElementById('chartSection');
                if(periodExpenses.length === 0) { if (chartSectionEl) chartSectionEl.classList.add('hidden'); if(this.chartInstance) this.chartInstance.destroy(); this.chartInstance = null; return; }
                if (chartSectionEl) chartSectionEl.classList.remove('hidden');
                const groups = {}; periodExpenses.forEach(l => { const cat = l.category || 'Otro'; groups[cat] = (groups[cat] || 0) + l.amount; });
                const labels = Object.keys(groups); const data = Object.values(groups);
                const colors = labels.map(l => { if(l === 'Comida') return '#fb923c'; if(l === 'Transporte') return '#60a5fa'; if(l === 'Ocio') return '#c084fc'; if(l === 'Servicios') return '#facc15'; if(l === 'Compras') return '#ec4899'; if(l === 'Salud') return '#f87171'; if(l === 'Deuda/Reembolso') return '#818cf8'; return '#9ca3af'; });
                const ctx = document.getElementById('expenseChart'); if (!ctx) return;
                if(this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx.getContext('2d'), { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: '#999', font: { size: 10, family: 'Plus Jakarta Sans' }, boxWidth: 10 } } } } });
            },

            generateReport() {
                if (!this.currentPeriod) return UI.toast('Cargando periodo...', 'error');
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const periodLogs = this.logs.filter(l => { const d = new Date(l.date).getTime(); return d >= pStart.getTime() && d <= pEnd.getTime(); }).sort((a,b) => new Date(b.date) - new Date(a.date));
                const totalIncomeExtra = periodLogs.filter(l => l.type === 'income').reduce((acc, l) => acc + l.amount, 0);
                const totalExpenseVar = periodLogs.filter(l => l.type === 'expense').reduce((acc, l) => acc + l.amount, 0);
                let fixedTotal = 0; let fixedDetails = []; const pStartDay = pStart.getDate(); const isFirstQ = pStartDay === 5;
                (this.data.fixed || []).forEach(f => { const d = parseInt(f.day); let applies = false; if (isFirstQ) { if (d >= 5 && d <= 19) applies = true; } else { if (d >= 20 || d <= 4) applies = true; } if(applies) { fixedTotal += parseFloat(f.amount) || 0; fixedDetails.push(f); } });
                const baseIncome = parseFloat(this.data.income) || 0; const totalIngresos = baseIncome + totalIncomeExtra; const totalEgresos = fixedTotal + totalExpenseVar; const saldoFinal = totalIngresos - totalEgresos;
                let html = `<div class="print-header"><h1 style="font-size: 24px; font-weight: 800; margin: 0;">ESTADO DE CUENTA</h1><p style="margin: 5px 0 0 0; color: #666;">God's Plan Finanzas</p><p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Periodo:</strong> ${pStart.toLocaleDateString('es-ES')} al ${pEnd.toLocaleDateString('es-ES')}</p></div><div class="print-section"><div class="print-title">RESUMEN</div><div class="print-summary-grid"><div class="print-summary-item"><div style="font-size: 10px; color: #666; text-transform: uppercase;">Total Ingresos</div><div style="font-size: 18px; font-weight: bold; color: #059669;">${UI.fmtMoney(totalIngresos)}</div></div><div class="print-summary-item"><div style="font-size: 10px; color: #666; text-transform: uppercase;">Total Egresos</div><div style="font-size: 18px; font-weight: bold; color: #dc2626;">${UI.fmtMoney(totalEgresos)}</div></div></div><div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 15px; text-align: center; border-radius: 8px;"><span style="display: block; font-size: 12px; text-transform: uppercase;">Saldo Disponible</span><span style="display: block; font-size: 28px; font-weight: 900;">${UI.fmtMoney(saldoFinal)}</span></div></div>`;
                // Add tables... (simplified for brevity, logic remains from previous)
                const printArea = document.getElementById('print-area'); if (printArea) { printArea.innerHTML = html; window.print(); }
            },

            switchView(viewName) {
                const viewBalanceEl = document.getElementById('view-balance'); const viewPlanEl = document.getElementById('view-plan');
                if (viewBalanceEl) viewBalanceEl.classList.add('hidden'); if (viewPlanEl) viewPlanEl.classList.add('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const activeBtn = document.querySelector(`.nav-btn:nth-child(${viewName === 'balance' ? 1 : 2})`); if(activeBtn) activeBtn.classList.add('active');
                const viewEl = document.getElementById(`view-${viewName}`); if (viewEl) viewEl.classList.remove('hidden');
                const fab = document.getElementById('fabContainer'); if (fab) { fab.classList.toggle('opacity-0', viewName !== 'balance'); fab.classList.toggle('pointer-events-none', viewName !== 'balance'); }
            },

            openModal(mode, id = null) {
                this.mode = mode; this.editId = id;
                const overlay = document.getElementById('modalOverlay'); const sheet = document.getElementById('modalSheet'); const title = document.getElementById('modalTitle');
                if (!overlay || !sheet || !title) return;
                this.renderCategoryChips();
                // Reset UI visibility...
                document.getElementById('formTransaction').classList.add('hidden'); document.getElementById('formFixed').classList.add('hidden'); document.getElementById('formLoan').classList.add('hidden');
                document.getElementById('btnDeleteTx').classList.add('hidden'); document.getElementById('btnDeleteFix').classList.add('hidden'); document.getElementById('btnDeleteLoan').classList.add('hidden');
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));

                if(mode === 'expense' || mode === 'extra') {
                    document.getElementById('formTransaction').classList.remove('hidden');
                    title.textContent = mode === 'expense' ? (id ? 'Editar Gasto' : 'Nuevo Gasto') : 'Ingreso Extra';
                    const categoryChipsEl = document.getElementById('categoryChips'); if (categoryChipsEl) categoryChipsEl.style.display = mode === 'expense' ? 'flex' : 'none';
                    const txAmountEl = document.getElementById('txAmount');
                    if (txAmountEl) {
                        txAmountEl.classList.toggle('text-emerald-400', mode !== 'expense'); txAmountEl.classList.toggle('text-white', mode === 'expense');
                        if(id) {
                            const log = this.logs.find(l => l.id === id);
                            txAmountEl.value = log.amount; document.getElementById('txDesc').value = log.desc || '';
                            document.getElementById('btnDeleteTx').classList.remove('hidden');
                            if(log.category) { const chips = document.querySelectorAll('.chip'); chips.forEach(c => { if(c.innerText.trim() === log.category) c.classList.add('active'); }); }
                        } else { txAmountEl.value = ''; document.getElementById('txDesc').value = ''; }
                        setTimeout(() => txAmountEl.focus(), 100);
                    }
                } else if (mode === 'fixed') {
                    document.getElementById('formFixed').classList.remove('hidden'); title.textContent = id !== null ? 'Editar Fijo' : 'Nuevo Fijo';
                    if(id !== null) { const item = this.data.fixed[id]; document.getElementById('fixName').value = item.name; document.getElementById('fixAmount').value = item.amount; document.getElementById('fixDay').value = item.day; document.getElementById('btnDeleteFix').classList.remove('hidden'); }
                    else { document.getElementById('fixName').value = ''; document.getElementById('fixAmount').value = ''; document.getElementById('fixDay').value = ''; }
                } else if (mode === 'loan') {
                    document.getElementById('formLoan').classList.remove('hidden'); title.textContent = id !== null ? 'Editar Deuda Corta' : 'Nuevo Préstamo';
                    if(id !== null) { const item = this.data.loans[id]; document.getElementById('loanName').value = item.name; document.getElementById('loanAmount').value = item.amount; document.getElementById('loanDueDate').value = item.dueDate; }
                    else { document.getElementById('loanName').value = ''; document.getElementById('loanAmount').value = ''; document.getElementById('loanDueDate').value = ''; }
                }
                overlay.classList.remove('hidden'); requestAnimationFrame(() => { sheet.classList.remove('translate-y-full'); overlay.classList.remove('opacity-0'); });
            },

            closeModal() {
                const overlay = document.getElementById('modalOverlay'); const sheet = document.getElementById('modalSheet'); if (!overlay || !sheet) return;
                sheet.classList.add('translate-y-full'); overlay.classList.add('opacity-0'); setTimeout(() => { overlay.classList.add('hidden'); }, 300);
            },
            selectCategory(catId, el) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); },

            async saveTransaction() {
                if(!this.user) return UI.toast('Conecta tu cuenta.', 'error');
                const amt = parseFloat(document.getElementById('txAmount').value); if(!amt || amt <= 0) return UI.toast('Monto inválido', 'error');
                const desc = document.getElementById('txDesc').value;
                let cat = 'Otro'; const activeChip = document.querySelector('.chip.active'); if(activeChip) cat = activeChip.innerText.trim();
                const payload = { amount: amt, desc: desc, category: cat, type: this.mode === 'extra' ? 'income' : 'expense', date: this.editId ? this.logs.find(l=>l.id===this.editId).date : new Date().toISOString() };
                try {
                    const logRef = collection(db, LOGS_COLLECTION(this.user.uid));
                    if(this.editId) { await updateDoc(doc(logRef, this.editId), payload); UI.toast('Actualizado', 'success'); }
                    else { await addDoc(logRef, payload); UI.toast('Guardado', 'success'); }
                    this.closeModal();
                } catch(e) { UI.toast('Error al guardar', 'error'); }
            },
            async deleteTxConfirm() { if (await UI.confirm('Eliminar', '¿Borrar transacción?')) { try { await deleteDoc(doc(db, LOGS_COLLECTION(this.user.uid), this.editId)); UI.toast('Eliminado', 'info'); this.closeModal(); } catch(e) { UI.toast('Error', 'error'); } } },
            async saveConfig() { if(!this.user) return; const inc = parseFloat(document.getElementById('inpIncome').value); try { await setDoc(doc(db, PRIVATE_DATA_PATH(this.user.uid)), { income: isNaN(inc) ? 0 : inc }, { merge: true }); UI.toast('Ingreso guardado', 'success'); } catch(e) {} },
            async saveFixed() {
                if(!this.user) return; const name = document.getElementById('fixName').value.trim(); const amt = parseFloat(document.getElementById('fixAmount').value); const day = parseInt(document.getElementById('fixDay').value);
                if(!name || !amt || isNaN(day)) return UI.toast('Datos inválidos', 'error');
                const newFixed = [...this.data.fixed]; if(this.editId !== null) newFixed[this.editId] = { name, amount: amt, day }; else newFixed.push({ name, amount: amt, day });
                try { await setDoc(doc(db, PRIVATE_DATA_PATH(this.user.uid)), { fixed: newFixed }, { merge: true }); UI.toast('Fijo guardado', 'success'); this.closeModal(); } catch(e) { UI.toast('Error', 'error'); }
            },
            async deleteFixedConfirm() { if (await UI.confirm('Eliminar', '¿Borrar gasto fijo?')) { const newFixed = this.data.fixed.filter((_, i) => i !== this.editId); await setDoc(doc(db, PRIVATE_DATA_PATH(this.user.uid)), { fixed: newFixed }, { merge: true }); UI.toast('Eliminado', 'info'); this.closeModal(); } },
            async saveLoan() {
                 if(!this.user) return; const name = document.getElementById('loanName').value.trim(); const amount = parseFloat(document.getElementById('loanAmount').value); const dueDate = document.getElementById('loanDueDate').value;
                 if(!name || !amount) return UI.toast('Datos incompletos', 'error');
                 const batch = writeBatch(db); const userDocRef = doc(db, PRIVATE_DATA_PATH(this.user.uid)); const logRef = collection(db, LOGS_COLLECTION(this.user.uid));
                 const newLoans = [...this.data.loans];
                 if(this.editId !== null) { newLoans[this.editId] = { name, amount, dueDate }; UI.toast('Deuda actualizada', 'info'); }
                 else { newLoans.push({ name, amount, dueDate }); const newLogDoc = doc(logRef); batch.set(newLogDoc, { amount, desc: `Préstamo recibido: ${name}`, category: 'Deuda/Reembolso', type: 'income', date: new Date().toISOString() }); UI.toast('Préstamo registrado', 'success'); }
                 batch.set(userDocRef, { loans: newLoans }, { merge: true }); await batch.commit(); this.closeModal();
            },
            async deleteLoanConfirm(idx) {
                 const loan = this.data.loans[idx]; if (await UI.confirm('Pagar Deuda', `Liquidar deuda de ${UI.fmtMoney(loan.amount)}? Se creará un gasto.`)) {
                     const newLoans = this.data.loans.filter((_, i) => i !== idx); const batch = writeBatch(db);
                     batch.set(doc(db, PRIVATE_DATA_PATH(this.user.uid)), { loans: newLoans }, { merge: true });
                     batch.set(doc(collection(db, LOGS_COLLECTION(this.user.uid))), { amount: loan.amount, desc: `Pago Deuda: ${loan.name}`, category: 'Deuda/Reembolso', type: 'expense', date: new Date().toISOString() });
                     await batch.commit(); UI.toast('Deuda liquidada', 'success');
                 }
            },
            async resetData() { if (await UI.confirm('RESET', '¿Borrar TODOS los datos financieros?')) { try { await setDoc(doc(db, PRIVATE_DATA_PATH(this.user.uid)), { income: 0, fixed: [], loans: [] }); const q = query(collection(db, LOGS_COLLECTION(this.user.uid)), limit(500)); const snap = await getDocs(q); const batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref)); await batch.commit(); location.reload(); } catch(e) { UI.toast('Error al borrar', 'error'); } } },

            redirectToAuth() { window.location.href = '/'; },
            logout() { signOut(auth).then(() => window.location.href = '/'); },
            updateUserUI() { 
                const u = this.user; if(!u) return; 
                document.getElementById('userName').textContent = u.displayName || u.email.split('@')[0];
                document.getElementById('userStatusText').textContent = 'Conectado';
                document.getElementById('userStatusText').className = 'text-[10px] text-emerald-500 font-bold';
                document.getElementById('btnLogin').classList.add('hidden'); document.getElementById('btnLogout').classList.remove('hidden');
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
