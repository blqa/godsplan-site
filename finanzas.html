<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>God's Plan | Finanzas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: { 
                        dark: { 900: '#050505', card: '#18181b' },
                        primary: '#ef4444'
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulseRed 3s infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        pulseRed: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.5' } }
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; height: 100dvh; }
        
        /* Inputs & Form */
        input, select, textarea { font-size: 16px !important; }
        input:focus, select:focus, textarea:focus { outline: none; }
        
        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Glass Effects */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-highlight { background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.08); }
        .glass-nav { background: rgba(5, 5, 5, 0.90); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); padding-bottom: var(--sab); }
        .glass-input { background: #09090b; border: 1px solid #27272a; color: white; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .glass-input:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); background: #18181b; }

        /* Links & Nav */
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { font-size: 11px; font-weight: 700; letter-spacing: 0.05em; color: #71717a; transition: color 0.2s; text-decoration: none; white-space: nowrap; text-transform: uppercase; cursor: pointer; }
        .g-link:hover, .g-link.active { color: white; }
        .g-link.active { position: relative; }
        .g-link.active::after { content: ''; position: absolute; bottom: -18px; left: 0; width: 100%; height: 2px; background: #ef4444; box-shadow: 0 -4px 10px rgba(239, 68, 68, 0.5); }
        
        /* Modal Animation & Layout */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; align-items: flex-end; justify-content: center; }
        .modal-overlay.is-open { opacity: 1; pointer-events: auto; }
        
        .modal-sheet { background: #121212; width: 100%; max-height: 90dvh; border-top-left-radius: 32px; border-top-right-radius: 32px; border-top: 1px solid #27272a; padding: 24px; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: calc(40px + var(--sab)); }
        .modal-overlay.is-open .modal-sheet { transform: translateY(0); }
        
        @media (min-width: 768px) {
            .modal-overlay { align-items: center; padding: 20px; }
            .modal-sheet { width: 100%; max-width: 420px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); max-height: 85vh; padding: 24px; transform: scale(0.95); opacity: 0; transition: all 0.2s ease-out; }
            .modal-overlay.is-open .modal-sheet { transform: scale(1); opacity: 1; }
            main { padding-bottom: 20px !important; }
        }

        /* Chips */
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; border: 1px solid #27272a; background: #09090b; color: #a1a1aa; }
        .chip:hover { background: #27272a; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border-color: #ef4444; }

        /* Loader */
        .loader-dots span { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; animation: loader 1.4s infinite ease-in-out both; margin: 0 2px; }
        .loader-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loader-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loader { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm sm:text-base">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-[#050505] z-[2000] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader-dots mb-4"><span></span><span></span><span></span></div>
        <p class="text-zinc-500 font-bold text-xs uppercase tracking-widest animate-pulse">Cargando...</p>
    </div>

    <!-- LOGIN / REGISTER VIEW -->
    <div id="login-view" class="fixed inset-0 z-[1500] bg-[#050505] flex flex-col items-center justify-center p-6 hidden">
        <!-- Radial BG -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-red-600/20 rounded-full blur-[100px] pointer-events-none"></div>

        <div class="w-full max-w-sm glass rounded-[2rem] p-8 relative z-10 fade-in border border-white/10">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_rgba(220,38,38,0.4)] text-white">
                    <i class="ph-bold ph-wallet text-3xl"></i>
                </div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight">GOD'S PLAN</h1>
                <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1">Control Financiero</p>
            </div>

            <!-- Toggles -->
            <div class="flex p-1 bg-zinc-900 rounded-xl mb-6 border border-zinc-800">
                <button onclick="window.authApp.toggleAuth('login')" id="tab-login" class="flex-1 py-2.5 text-xs font-bold rounded-lg bg-[#27272a] text-white shadow transition-all">INGRESAR</button>
                <button onclick="window.authApp.toggleAuth('register')" id="tab-register" class="flex-1 py-2.5 text-xs font-bold text-zinc-500 hover:text-zinc-300 transition-all">REGISTRO</button>
            </div>

            <form onsubmit="event.preventDefault(); window.authApp.handleAuthSubmit();" class="space-y-4">
                <div id="field-name" class="hidden">
                    <div class="relative">
                        <i class="ph-bold ph-user absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                        <input type="text" id="input-name" class="glass-input w-full pl-10 pr-4 py-3.5 rounded-xl outline-none text-sm font-bold placeholder-zinc-700" placeholder="Tu Nombre">
                    </div>
                </div>
                <div>
                    <div class="relative">
                        <i class="ph-bold ph-envelope absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                        <input type="text" id="input-id" class="glass-input w-full pl-10 pr-4 py-3.5 rounded-xl outline-none text-sm font-bold placeholder-zinc-700" placeholder="Usuario o Email" required>
                    </div>
                </div>
                <div>
                    <div class="relative">
                        <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                        <input type="password" id="input-pass" class="glass-input w-full pl-10 pr-4 py-3.5 rounded-xl outline-none text-sm font-bold placeholder-zinc-700" placeholder="••••••••" required>
                    </div>
                </div>

                <div id="auth-error-msg" class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-2">
                    <i class="ph-fill ph-warning-circle text-red-500"></i>
                    <span id="auth-error-txt" class="text-xs text-red-400 font-bold">Error</span>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-white text-black py-3.5 rounded-xl font-black text-sm hover:bg-zinc-200 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                    <span id="btn-text">INICIAR SESIÓN</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    
    <!-- NAVBAR TOP -->
    <nav id="global-nav" class="h-16 bg-[#050505]/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50 sticky top-0">
        <div class="flex items-center gap-3">
             <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center text-white shadow-lg shadow-red-900/20">
                <i class="ph-bold ph-wallet text-lg"></i>
            </div>
            <div>
                <h1 class="text-white font-extrabold text-sm tracking-tight leading-none">GOD'S PLAN</h1>
                <p class="text-[10px] text-zinc-500 font-medium" id="current-date-header">...</p>
            </div>
        </div>
        
        <!-- Desktop Tabs -->
        <div class="hidden md:flex g-links no-scrollbar ml-8">
            <a onclick="switchTab('dashboard')" class="g-link active" id="desk-link-dashboard">Panel</a>
            <a onclick="switchTab('history')" class="g-link" id="desk-link-history">Historial</a>
            <a onclick="switchTab('fixed')" class="g-link" id="desk-link-fixed">Fijos</a>
            <a onclick="switchTab('settings')" class="g-link" id="desk-link-settings">Ajustes</a>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-zinc-900/50 border border-white/5 rounded-full p-1">
                 <button onclick="changeMonth(-1)" class="w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-zinc-800 transition"><i class="ph-bold ph-caret-left"></i></button>
                 <button onclick="goToCurrentMonth()" class="text-[10px] font-bold text-zinc-300 px-2 uppercase hover:text-white transition">Hoy</button>
                 <button onclick="changeMonth(1)" class="w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:bg-zinc-800 transition"><i class="ph-bold ph-caret-right"></i></button>
            </div>
            <div class="w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-zinc-400" id="user-avatar">
                <i class="ph-fill ph-user"></i>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main id="main-container" class="flex-1 overflow-y-auto pb-32 relative scroll-smooth overflow-x-hidden md:px-6 hidden">
        <div class="w-full max-w-lg md:max-w-5xl mx-auto h-full pt-6">

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="px-5 md:px-0 fade-in">
                
                <div class="grid grid-cols-1 md:grid-cols-12 md:gap-8 items-start">
                    
                    <!-- LEFT COL -->
                    <div class="md:col-span-5 lg:col-span-4 md:sticky md:top-6">
                        
                        <!-- Header Balance -->
                        <div class="flex justify-between items-end mb-4 px-1">
                            <div>
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1">
                                    BALANCE <span id="balance-period-label">MENSUAL</span>
                                </p>
                                <div class="flex items-center gap-2">
                                     <button onclick="toggleBalanceMode()" class="text-xs bg-zinc-900 border border-zinc-800 px-2 py-1 rounded text-zinc-400 hover:text-white transition">
                                        <i class="ph-bold ph-arrows-left-right"></i> Cambiar
                                     </button>
                                </div>
                            </div>
                            <div id="payday-badge" class="text-[10px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(16,185,129,0.1)]">
                                ...
                            </div>
                        </div>

                        <!-- MAIN CARD -->
                        <div class="glass rounded-[2rem] p-6 relative overflow-hidden group mb-6 shadow-2xl shadow-black/50 border-t border-white/10">
                            <!-- Glow -->
                            <div class="absolute -top-12 -right-12 w-40 h-40 bg-red-600/30 rounded-full blur-[60px] animate-pulse-slow"></div>
                            
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Disponible</span>
                                    <button onclick="openAdjustModal()" class="text-zinc-500 hover:text-white transition"><i class="ph-bold ph-scales"></i></button>
                                </div>
                                
                                <!-- Big Money -->
                                <div class="text-5xl font-black text-white tracking-tighter mb-4 break-all relative leading-none" id="total-balance">
                                    $0.00
                                </div>
                                
                                <!-- Progress -->
                                <div class="mb-6">
                                    <div class="flex justify-between text-[10px] font-bold text-zinc-500 mb-1.5 uppercase tracking-wide">
                                        <span>Gasto vs Ingreso</span>
                                        <span id="progress-percent">0%</span>
                                    </div>
                                    <div class="h-1.5 bg-zinc-800 rounded-full w-full overflow-hidden">
                                        <div id="balance-progress" class="h-full bg-gradient-to-r from-red-500 to-orange-500 w-0 transition-all duration-1000"></div>
                                    </div>
                                </div>

                                <!-- Stats Footer -->
                                <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                                    <div>
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1 flex items-center gap-1"><i class="ph-fill ph-arrow-down-left text-emerald-500"></i> Ingresos</span>
                                        <span class="text-lg font-bold text-zinc-200 tracking-tight" id="total-income">$0.00</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1 flex items-center gap-1 justify-end">Gastos <i class="ph-fill ph-arrow-up-right text-red-500"></i></span>
                                        <span class="text-lg font-bold text-red-400 tracking-tight" id="total-expense">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-2 gap-3 mb-8">
                            <button onclick="openAddModal('income')" class="glass-highlight h-14 rounded-2xl text-emerald-500 font-bold text-xs flex items-center justify-center gap-2 transition-all hover:bg-emerald-500/10 border-transparent hover:border-emerald-500/30 active:scale-95">
                                <i class="ph-bold ph-arrow-down-left text-lg"></i> INGRESO
                            </button>
                            <button onclick="openAddModal('expense')" class="glass-highlight h-14 rounded-2xl text-white font-bold text-xs flex items-center justify-center gap-2 transition-all hover:bg-red-600 hover:border-red-500 bg-red-600/10 border-red-600/30 active:scale-95 shadow-[0_0_15px_rgba(220,38,38,0.1)]">
                                <i class="ph-bold ph-minus text-lg"></i> GASTO
                            </button>
                        </div>
                        
                        <!-- Chart Container (Desktop) -->
                        <div class="hidden md:block glass rounded-2xl p-5 border border-white/5 mb-6">
                            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Análisis</h3>
                            <div class="h-40 relative">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>

                    </div> <!-- End Left Col -->

                    <!-- RIGHT COL (List) -->
                    <div class="md:col-span-7 lg:col-span-8">
                        
                        <!-- Daily Budget Info (Formula) -->
                         <div class="mb-6 bg-gradient-to-r from-zinc-900 to-black border border-zinc-800 rounded-2xl p-4 flex justify-between items-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-blue-500/5"></div>
                            <div class="relative z-10">
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-0.5">Presupuesto Diario</p>
                                <p class="text-[10px] text-blue-400 font-bold" id="formula-days-left">Calculando...</p>
                            </div>
                            <span class="font-mono font-bold text-2xl text-white relative z-10 tracking-tight" id="formula-daily">$0.00</span>
                        </div>

                        <div class="flex justify-between items-center mb-4 px-1">
                             <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Actividad Reciente</h3>
                             <button onclick="switchTab('history')" class="text-[10px] font-bold text-red-500 hover:text-white transition">VER TODO</button>
                        </div>

                        <div id="recent-list" class="space-y-3 pb-24 md:pb-0">
                            <!-- JS Injected -->
                        </div>
                    </div>

                </div>
            </section>

            <!-- VIEW: HISTORY -->
            <section id="view-history" class="px-5 md:px-0 hidden fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white">Historial</h2>
                     <div class="flex gap-2">
                        <button onclick="filterHistory('all')" class="filter-btn active chip px-4 py-1.5 rounded-full text-[10px] font-bold uppercase" data-filter="all">Todos</button>
                        <button onclick="filterHistory('income')" class="filter-btn chip px-4 py-1.5 rounded-full text-[10px] font-bold uppercase" data-filter="income">Ingresos</button>
                        <button onclick="filterHistory('expense')" class="filter-btn chip px-4 py-1.5 rounded-full text-[10px] font-bold uppercase" data-filter="expense">Gastos</button>
                    </div>
                </div>
                <div id="full-history-list" class="space-y-3 pb-24">
                    <div class="text-center text-zinc-600 py-10 text-xs font-mono">Cargando datos...</div>
                </div>
            </section>

            <!-- VIEW: FIXED -->
            <section id="view-fixed" class="px-5 md:px-0 hidden fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white">Pagos Fijos</h2>
                    <button onclick="openModal('fixed-modal')" class="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 border border-zinc-700 transition">
                        <i class="ph-bold ph-plus"></i> Nuevo
                    </button>
                </div>
                 <div class="bg-blue-900/10 border border-blue-500/20 rounded-xl p-4 mb-6 flex gap-3">
                    <i class="ph-fill ph-info text-blue-400 text-lg flex-shrink-0"></i>
                    <p class="text-xs text-blue-200/70 leading-relaxed">Gestiona tus suscripciones y rentas. Pulsa el check para registrarlos como pagados este mes. Los pagados no se restan del presupuesto diario.</p>
                </div>
                <div id="fixed-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 pb-24">
                    <!-- JS Injected -->
                </div>
            </section>

            <!-- VIEW: SETTINGS -->
            <section id="view-settings" class="px-5 md:px-0 hidden fade-in">
                <h2 class="text-xl font-bold text-white mb-6">Configuración</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-24">
                    <!-- Account -->
                    <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl">
                         <div class="flex items-center gap-4 mb-6">
                            <div class="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center text-white text-xl">
                                <i class="ph-bold ph-user"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg" id="user-display-name">Usuario</h3>
                                <p class="text-xs text-zinc-500 font-mono" id="user-display-email">ID: ...</p>
                            </div>
                        </div>
                        <button onclick="window.authApp.logout()" class="w-full py-3 rounded-xl border border-zinc-700 text-zinc-400 font-bold text-xs hover:bg-red-900/20 hover:text-red-400 hover:border-red-900/50 transition">
                            CERRAR SESIÓN
                        </button>
                    </div>

                    <!-- Payday Config -->
                    <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl">
                        <h3 class="font-bold text-zinc-200 text-sm mb-4 flex items-center gap-2"><i class="ph-fill ph-calendar text-emerald-500"></i> Frecuencia de Cobro</h3>
                        
                        <div class="space-y-3 mb-4">
                            <label class="flex items-center gap-3 p-3 bg-black/40 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-900/10">
                                <input type="radio" name="pay-freq" value="biweekly" class="hidden peer" onchange="togglePaydayInput()">
                                <div class="w-4 h-4 rounded-full border border-zinc-600 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 bg-black rounded-full opacity-0 peer-checked:opacity-100"></div>
                                </div>
                                <span class="text-xs font-bold text-zinc-300">Quincenal (15 y 30)</span>
                            </label>

                            <label class="flex items-center gap-3 p-3 bg-black/40 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-900/10">
                                <input type="radio" name="pay-freq" value="biweekly-custom" class="hidden peer" onchange="togglePaydayInput()">
                                <div class="w-4 h-4 rounded-full border border-zinc-600 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 bg-black rounded-full opacity-0 peer-checked:opacity-100"></div>
                                </div>
                                <span class="text-xs font-bold text-zinc-300">Quincenal (Personalizado)</span>
                            </label>
                            
                            <label class="flex items-center gap-3 p-3 bg-black/40 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-900/10">
                                <input type="radio" name="pay-freq" value="monthly" class="hidden peer" onchange="togglePaydayInput()">
                                <div class="w-4 h-4 rounded-full border border-zinc-600 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 bg-black rounded-full opacity-0 peer-checked:opacity-100"></div>
                                </div>
                                <span class="text-xs font-bold text-zinc-300">Mensual</span>
                            </label>
                        </div>

                        <!-- Monthly Input -->
                        <div id="monthly-select-container" class="hidden mb-4">
                            <label class="text-[10px] text-zinc-500 font-bold uppercase mb-2 block">Día de pago</label>
                            <select id="payday-select" class="glass-input w-full p-2.5 rounded-lg text-xs font-bold appearance-none">
                                <option value="">Seleccionar día</option>
                            </select>
                        </div>

                        <!-- Custom Bi-weekly Input -->
                        <div id="biweekly-custom-container" class="hidden grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-[10px] text-zinc-500 font-bold uppercase mb-2 block">Pago 1</label>
                                <select id="payday-1-select" class="glass-input w-full p-2.5 rounded-lg text-xs font-bold appearance-none">
                                    <!-- JS fills -->
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 font-bold uppercase mb-2 block">Pago 2</label>
                                <select id="payday-2-select" class="glass-input w-full p-2.5 rounded-lg text-xs font-bold appearance-none">
                                    <!-- JS fills -->
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="saveSettings()" class="w-full bg-white text-black py-3 rounded-xl font-bold text-xs hover:bg-zinc-200 transition">GUARDAR CAMBIOS</button>
                    </div>

                    <!-- Forced Savings -->
                    <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl md:col-span-2">
                        <h3 class="font-bold text-zinc-200 text-sm mb-4 flex items-center gap-2"><i class="ph-fill ph-brain text-purple-500"></i> Psicología Financiera</h3>
                        <label class="flex items-center justify-between p-4 bg-black/40 border border-zinc-800 rounded-xl cursor-pointer hover:border-zinc-600 transition">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-zinc-200">Modo "Ahorro Forzoso"</span>
                                <span class="text-[10px] text-zinc-500 font-medium">Oculta el 10% de tu saldo disponible para engañar a tu cerebro.</span>
                            </div>
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-forced-savings" class="sr-only peer" onchange="saveSettings()">
                                <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </div>
                        </label>
                    </div>

                    <!-- Data -->
                    <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-2xl md:col-span-2">
                        <h3 class="font-bold text-zinc-200 text-sm mb-4">Gestión de Datos</h3>
                        <div class="flex gap-4">
                            <button onclick="exportData()" class="flex-1 bg-black border border-zinc-800 py-4 rounded-xl text-zinc-400 font-bold text-xs hover:text-white transition flex flex-col items-center gap-2">
                                <i class="ph-bold ph-download-simple text-xl"></i> Backup JSON
                            </button>
                            <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-black border border-zinc-800 py-4 rounded-xl text-zinc-400 font-bold text-xs hover:text-white transition flex flex-col items-center gap-2">
                                <i class="ph-bold ph-upload-simple text-xl"></i> Restaurar
                            </button>
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                        </div>
                        <button onclick="resetApp()" class="w-full mt-4 text-red-500 text-[10px] font-bold uppercase hover:text-red-400">Eliminar todos mis datos</button>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- MOBILE FAB -->
    <div class="md:hidden fixed bottom-[calc(90px+var(--sab))] left-1/2 -translate-x-1/2 z-40" id="fab-container">
        <button onclick="openAddModal('expense')" class="w-16 h-16 bg-gradient-to-b from-red-600 to-red-700 rounded-full flex items-center justify-center text-white shadow-[0_8px_30px_rgba(220,38,38,0.4)] border-[6px] border-[#050505] active:scale-90 transition-transform duration-200 group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <i class="ph-bold ph-plus text-3xl relative z-10"></i>
        </button>
    </div>

    <!-- MOBILE NAV -->
    <nav class="md:hidden glass-nav fixed bottom-0 w-full h-[80px] grid grid-cols-4 z-50 pb-2" id="bottom-nav">
        <button onclick="switchTab('dashboard')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" id="nav-dashboard">
            <div class="relative p-1"><i class="ph-fill ph-squares-four text-2xl group-[.active]:text-white"></i></div>
        </button>
        <button onclick="switchTab('history')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" id="nav-history">
            <div class="relative p-1"><i class="ph-fill ph-list-dashes text-2xl group-[.active]:text-white"></i></div>
        </button>
         <button onclick="switchTab('fixed')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" id="nav-fixed">
            <div class="relative p-1"><i class="ph-fill ph-receipt text-2xl group-[.active]:text-white"></i></div>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" id="nav-settings">
            <div class="relative p-1"><i class="ph-fill ph-gear text-2xl group-[.active]:text-white"></i></div>
        </button>
    </nav>

    <!-- MODAL: TRANSACTION -->
    <div id="transaction-modal" class="modal-overlay">
        <div id="transaction-modal-content" class="modal-sheet">
             <div class="w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0 md:hidden"></div>
             
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white" id="modal-tx-title">Nuevo Movimiento</h3>
                <button onclick="closeModal('transaction-modal')" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white transition">
                    <i class="ph-bold ph-x"></i>
                </button>
             </div>

             <form id="transaction-form" onsubmit="addTransaction(event)">
                <!-- Hidden inputs -->
                <div class="hidden">
                     <input type="radio" name="type" value="expense" id="radio-expense" checked>
                     <input type="radio" name="type" value="income" id="radio-income">
                     <input type="hidden" id="t-fixed-id">
                </div>

                <div class="relative mb-8 text-center">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+80px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none">$</span>
                    <input type="number" id="t-amount" step="0.01" class="bg-transparent text-center text-5xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800 h-16" placeholder="0" required>
                </div>

                <div class="mb-6">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-2 block">Categoría</label>
                    <div class="flex flex-wrap gap-2" id="category-chips">
                        <!-- JS renders chips -->
                    </div>
                    <input type="hidden" id="t-category" required>
                </div>

                <div class="mb-4">
                     <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Concepto</label>
                     <input type="text" id="t-title" class="glass-input w-full p-4 rounded-xl text-sm font-bold placeholder-zinc-600" placeholder="¿Qué compraste?">
                </div>

                <div class="mb-6">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Fecha y Hora</label>
                    <input type="datetime-local" id="t-date" class="glass-input w-full p-4 rounded-xl text-sm font-bold text-center appearance-none" required>
                </div>

                <div class="flex flex-col gap-3">
                    <button type="submit" id="btn-save-tx" class="w-full bg-white text-black h-14 rounded-2xl font-black text-sm hover:bg-zinc-200 transition-colors shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                        GUARDAR
                    </button>
                    <!-- Delete button hidden by default, shown via JS when editing -->
                    <button type="button" id="btn-delete-tx" onclick="deleteCurrentTransaction()" class="hidden w-full bg-red-500/10 text-red-500 h-14 rounded-2xl font-black text-sm hover:bg-red-500 hover:text-white transition-colors border border-red-500/20">
                        ELIMINAR
                    </button>
                </div>
             </form>
        </div>
    </div>

    <!-- MODAL: ADJUST -->
    <div id="adjust-modal" class="modal-overlay">
        <div id="adjust-modal-content" class="modal-sheet">
            <div class="w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0 md:hidden"></div>
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white"><i class="ph-bold ph-scales text-blue-500"></i> Ajustar Saldo</h3>
                <button onclick="closeModal('adjust-modal')" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white transition">
                    <i class="ph-bold ph-x"></i>
                </button>
             </div>
             <div class="bg-blue-900/10 border border-blue-500/20 p-4 rounded-2xl mb-6 text-center">
                 <p class="text-[10px] text-blue-400 uppercase font-bold mb-1">Saldo Sistema (Real)</p>
                 <p class="text-2xl font-black text-white" id="adjust-current-display">$0.00</p>
             </div>
             <form onsubmit="submitAdjustment(event)">
                <div class="relative mb-6">
                     <p class="text-center text-[10px] text-zinc-500 uppercase font-bold mb-2">¿Cuánto tienes realmente?</p>
                    <input type="number" id="adjust-amount" step="0.01" class="glass-input w-full p-4 rounded-2xl text-3xl font-black text-center text-white placeholder-zinc-800" placeholder="0.00" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white h-14 rounded-2xl font-black text-sm hover:bg-blue-500 transition-colors">AJUSTAR AHORA</button>
             </form>
        </div>
    </div>

    <!-- MODAL: FIXED -->
    <div id="fixed-modal" class="modal-overlay">
        <div id="fixed-modal-content" class="modal-sheet">
            <div class="w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0 md:hidden"></div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Nuevo Pago Fijo</h3>
                <button onclick="closeModal('fixed-modal')" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white transition">
                    <i class="ph-bold ph-x"></i>
                </button>
             </div>
             <form id="fixed-form" onsubmit="addFixed(event)">
                 <div class="mb-4">
                      <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Nombre</label>
                      <input type="text" id="f-title" class="glass-input w-full p-4 rounded-xl text-sm font-bold placeholder-zinc-600" placeholder="Ej. Netflix" required>
                 </div>
                 <div class="grid grid-cols-2 gap-4 mb-6">
                      <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Monto</label>
                        <input type="number" id="f-amount" step="0.01" class="glass-input w-full p-4 rounded-xl text-sm font-bold placeholder-zinc-600" placeholder="0.00" required>
                      </div>
                      <div>
                        <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Día Pago</label>
                        <select id="f-day" class="glass-input w-full p-4 rounded-xl text-sm font-bold appearance-none">
                            <!-- JS Fills -->
                        </select>
                      </div>
                 </div>
                 <button type="submit" class="w-full bg-white text-black h-14 rounded-2xl font-black text-sm hover:bg-zinc-200 transition-colors">GUARDAR</button>
             </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-zinc-900 border border-zinc-800 text-white px-6 py-3 rounded-full shadow-2xl z-[2000] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2">
        <div class="w-2 h-2 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]"></div>
        <span id="toast-msg" class="text-xs font-bold uppercase tracking-wide">Acción realizada</span>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let listeners = [];
        let editingTransactionId = null;

        // GLOBAL STATE
        window.appData = {
            transactions: [],
            fixed: [],
            settings: { frequency: 'biweekly', payday: null, forcedSavings: false }
        };

        // --- AUTH FUNCTIONS ---
        window.authApp = {
            isRegistering: false,
            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                const nameField = document.getElementById('field-name');
                const btnLogin = document.getElementById('tab-login');
                const btnReg = document.getElementById('tab-register');
                const err = document.getElementById('auth-error-msg');
                if(err) err.classList.add('hidden');

                document.getElementById('btn-text').textContent = this.isRegistering ? "CREAR CUENTA" : "INICIAR SESIÓN";
                
                if (this.isRegistering) {
                    nameField.classList.remove('hidden');
                    btnReg.className = "flex-1 py-2.5 text-xs font-bold rounded-lg bg-[#27272a] text-white shadow transition-all";
                    btnLogin.className = "flex-1 py-2.5 text-xs font-bold text-zinc-500 hover:text-zinc-300 transition-all";
                } else {
                    nameField.classList.add('hidden');
                    btnLogin.className = "flex-1 py-2.5 text-xs font-bold rounded-lg bg-[#27272a] text-white shadow transition-all";
                    btnReg.className = "flex-1 py-2.5 text-xs font-bold text-zinc-500 hover:text-zinc-300 transition-all";
                }
            },
            async handleAuthSubmit() {
                const btn = document.getElementById('btn-submit');
                const id = document.getElementById('input-id').value.trim();
                const pass = document.getElementById('input-pass').value;
                const name = document.getElementById('input-name').value.trim();
                
                if (!id || !pass) return this.showError("Faltan datos");
                if (this.isRegistering && !name) return this.showError("Nombre requerido");
                
                const finalId = id.includes('@') ? id : `${id}@godsplan.site`;
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i>';

                try {
                    if (this.isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, finalId, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalId, pass);
                    }
                } catch (error) {
                    console.error(error);
                    this.showError("Error: Credenciales inválidas");
                    btn.disabled = false;
                    btn.innerHTML = '<span id="btn-text">REINTENTAR</span>';
                }
            },
            showError(msg) {
                document.getElementById('auth-error-txt').textContent = msg;
                document.getElementById('auth-error-msg').classList.remove('hidden');
            },
            logout() {
                if(confirm('¿Cerrar sesión?')) signOut(auth);
            }
        };

        // --- INIT ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) {}
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const loginView = document.getElementById('login-view');
            const mainApp = document.getElementById('main-container');
            const bottomNav = document.getElementById('bottom-nav');
            const fab = document.getElementById('fab-container');
            const globalNav = document.getElementById('global-nav');
            const loading = document.getElementById('loading-screen');

            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                fab.classList.remove('hidden');
                globalNav.classList.remove('hidden');
                
                document.getElementById('user-display-name').textContent = user.displayName || 'Usuario';
                document.getElementById('user-display-email').textContent = user.email;

                loading.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loading.classList.add('hidden'), 500);

                setupListeners(user.uid);
            } else {
                currentUser = null;
                mainApp.classList.add('hidden');
                bottomNav.classList.add('hidden');
                fab.classList.add('hidden');
                globalNav.classList.add('hidden');
                loginView.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        function setupListeners(userId) {
            listeners.forEach(u => u()); listeners = [];
            
            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), (snap) => {
                window.appData.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Wrap renders in try-catch to prevent one error stopping the others
                try { renderDashboard(); } catch(e) { console.error("Dash error", e); }
                try { renderHistory(); } catch(e) { console.error("Hist error", e); }
                try { renderFixed(); } catch(e) { console.error("Fixed error", e); }
            }));

            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'fixed'), (snap) => {
                window.appData.fixed = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                try { renderFixed(); } catch(e) {}
            }));

            listeners.push(onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), (snap) => {
                if(snap.exists()) window.appData.settings = { ...window.appData.settings, ...snap.data() };
                try { setupSettingsUI(); renderDashboard(); } catch(e) {}
            }));
        }

        // --- EXPORTED FUNCTIONS ---
        
        window.openAddModal = function(type, fixedId = null) {
            editingTransactionId = null;
            document.getElementById('modal-tx-title').textContent = type === 'expense' ? "Nuevo Gasto" : "Nuevo Ingreso";
            document.getElementById('btn-save-tx').textContent = "GUARDAR";
            document.getElementById('btn-delete-tx').classList.add('hidden');
            document.getElementById('transaction-form').reset();
            
            // Set current datetime-local
            const now = new Date();
            // Subtract timezone offset to get local ISO string correctly for input value
            const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('t-date').value = localIso;
            
            document.getElementById(type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = fixedId || ''; // Set fixed ID if coming from fixed list
            
            renderCategoryChips(type);
            
            openModal('transaction-modal');
        };

        window.addTransaction = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const title = document.getElementById('t-title').value || (type === 'expense' ? 'Gasto' : 'Ingreso');
            const category = document.getElementById('t-category').value || 'General';
            const date = document.getElementById('t-date').value; // Now returns YYYY-MM-DDTHH:MM
            const fixedPaymentId = document.getElementById('t-fixed-id').value;

            const txData = { type, amount, title, category, date, createdAt: new Date().toISOString() };
            if(fixedPaymentId) txData.fixedPaymentId = fixedPaymentId;

            try {
                if (editingTransactionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId), txData);
                    showToast('Actualizado');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), txData);
                    showToast('Guardado');
                }
                closeModal('transaction-modal');
            } catch(e) { console.error(e); }
        };

        window.deleteTransaction = async function(id) {
            // Stop propagation handled in HTML onclick for list items
            if(confirm('¿Eliminar este movimiento?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id));
                showToast('Eliminado');
            }
        };
        
        window.deleteCurrentTransaction = async function() {
            if(!editingTransactionId) return;
            if(confirm('¿Eliminar este movimiento permanentemente?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId));
                showToast('Eliminado');
                closeModal('transaction-modal');
            }
        }

        window.editTransaction = function(id) {
            const tx = window.appData.transactions.find(t => t.id === id);
            if(!tx) return;
            editingTransactionId = id;
            document.getElementById('modal-tx-title').textContent = "Editar Movimiento";
            document.getElementById('btn-save-tx').textContent = "ACTUALIZAR";
            document.getElementById('btn-delete-tx').classList.remove('hidden'); // Show delete button in modal
            
            document.getElementById('t-amount').value = tx.amount;
            document.getElementById('t-title').value = tx.title;
            
            // Handle legacy date format (YYYY-MM-DD) vs new (YYYY-MM-DDTHH:MM)
            let dateVal = tx.date;
            if (dateVal && dateVal.length === 10) {
                dateVal += "T12:00"; // Default time for legacy data
            }
            document.getElementById('t-date').value = dateVal;
            
            document.getElementById(tx.type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = tx.fixedPaymentId || '';
            
            renderCategoryChips(tx.type);
            selectChip(tx.category);
            openModal('transaction-modal');
        };

        // --- FIXED ---
        window.addFixed = async function(e) {
            e.preventDefault();
            const title = document.getElementById('f-title').value;
            const amount = parseFloat(document.getElementById('f-amount').value);
            const day = document.getElementById('f-day').value;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), { title, amount, day });
            closeModal('fixed-modal');
            showToast('Pago Fijo Guardado');
        };

        window.payFixed = function(id) {
            const f = window.appData.fixed.find(x => x.id === id);
            window.openAddModal('expense', id); // Pass ID to link transaction
            document.getElementById('t-amount').value = f.amount;
            document.getElementById('t-title').value = f.title;
            selectChip('Servicios');
        };

        window.deleteFixed = async function(id) {
            if(confirm('¿Borrar?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id));
        };

        // --- SETTINGS ---
        window.saveSettings = async function() {
            const freq = document.querySelector('input[name="pay-freq"]:checked').value;
            const payday = document.getElementById('payday-select').value;
            const payday1 = document.getElementById('payday-1-select').value;
            const payday2 = document.getElementById('payday-2-select').value;
            const forcedSavings = document.getElementById('toggle-forced-savings').checked;
            
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), { 
                frequency: freq, 
                payday, 
                payday1, 
                payday2,
                forcedSavings
            }, { merge: true });
            showToast('Configuración Guardada');
        };

        window.resetApp = async function() {
            if(confirm('¿BORRAR TODO?')) {
                const txs = window.appData.transactions;
                const fxs = window.appData.fixed;
                txs.forEach(t => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', t.id)));
                fxs.forEach(f => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', f.id)));
                showToast('Limpieza Completada');
            }
        };
        
        // --- ADJUSTMENT ---
        window.openAdjustModal = function() {
            // Integer math for precise sum
            let balCents = 0;
            window.appData.transactions.forEach(t => {
                const amountCents = Math.round(t.amount * 100);
                if (t.type === 'income') balCents += amountCents;
                else balCents -= amountCents;
            });
            const bal = balCents / 100;

            document.getElementById('adjust-current-display').textContent = formatCurrency(bal);
            document.getElementById('adjust-current-display').dataset.raw = bal;
            document.getElementById('adjust-amount').value = '';
            openModal('adjust-modal');
        }

        window.submitAdjustment = async function(e) {
            e.preventDefault();
            const real = parseFloat(document.getElementById('adjust-amount').value);
            const sys = parseFloat(document.getElementById('adjust-current-display').dataset.raw);
            
            // Integer Math to find difference
            // Example: 10.01 - 10.00 = 0.009999 (Floating Point Error)
            // Fix: (1001 - 1000) / 100 = 0.01 (Correct)
            const diff = (Math.round(real * 100) - Math.round(sys * 100)) / 100;
            
            if(Math.abs(diff) < 0.01) return closeModal('adjust-modal');
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                type: diff > 0 ? 'income' : 'expense',
                amount: Math.abs(diff),
                title: 'Ajuste de Saldo',
                category: 'Ajuste',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            });
            closeModal('adjust-modal');
            showToast('Saldo Ajustado');
        }

        // --- JSON IMPORT/EXPORT ---
        window.exportData = function() {
            const data = { transactions: window.appData.transactions, fixed: window.appData.fixed, settings: window.appData.settings };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "backup_godsplan.json"; a.click();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = JSON.parse(e.target.result);
                if(json.transactions) json.transactions.forEach(t => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), t));
                if(json.fixed) json.fixed.forEach(f => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), f));
                showToast('Datos Importados');
            };
            reader.readAsText(file);
        }

        initAuth();
    </script>

    <!-- UI Logic Script -->
    <script>
        let currentViewDate = new Date();
        let balanceMode = 'month';
        let chartInstance = null;
        
        // --- CONSTANTS ---
        const COMMON_HOLIDAYS = ['01-01', '02-05', '03-21', '05-01', '09-16', '11-20', '12-25'];

        const CATEGORIES = {
            expense: [
                { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' },
                { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
                { id: 'Hogar', icon: 'ph-house', color: 'text-purple-400' },
                { id: 'Ocio', icon: 'ph-film-strip', color: 'text-pink-400' },
                { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
                { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
                { id: 'Otros', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
            ],
            income: [
                { id: 'Nómina', icon: 'ph-money', color: 'text-emerald-400' },
                { id: 'Venta', icon: 'ph-tag', color: 'text-blue-400' },
                { id: 'Regalo', icon: 'ph-gift', color: 'text-pink-400' },
                { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
            ]
        };

        // --- HELPERS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        
        function updateDateHeader() {
            const str = currentViewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('current-date-header').textContent = str.charAt(0).toUpperCase() + str.slice(1);
        }

        function changeMonth(dir) {
            currentViewDate.setMonth(currentViewDate.getMonth() + dir);
            updateDateHeader();
            renderDashboard();
        }
        function goToCurrentMonth() {
            currentViewDate = new Date();
            updateDateHeader();
            renderDashboard();
        }
        function toggleBalanceMode() {
            balanceMode = balanceMode === 'month' ? 'total' : 'month';
            document.getElementById('balance-period-label').textContent = balanceMode === 'month' ? 'MENSUAL' : 'TOTAL';
            renderDashboard();
        }

        // New Helper: Check if fixed payment is paid in current month
        function isFixedPaidThisMonth(fixedId) {
            const now = new Date();
            const m = now.getMonth();
            const y = now.getFullYear();
            return window.appData.transactions.some(t => {
                // Parse date carefully, assuming t.date is YYYY-MM-DD or YYYY-MM-DDTHH:MM
                if (!t.date) return false;
                
                // Safe Date parsing
                const d = new Date(t.date);
                if (isNaN(d.getTime())) return false; // Invalid date check
                
                return t.fixedPaymentId === fixedId && d.getMonth() === m && d.getFullYear() === y;
            });
        }

        // --- RENDERING ---
        function renderDashboard() {
            if (!window.appData || !window.appData.transactions) return;
            
            // Filter Logic
            const m = currentViewDate.getMonth();
            const y = currentViewDate.getFullYear();
            
            const monthlyTx = window.appData.transactions.filter(t => {
                if (!t.date) return false;
                // Robust parsing for filter
                const d = new Date(t.date);
                if(isNaN(d.getTime())) return false;
                
                return d.getMonth() === m && d.getFullYear() === y;
            });

            // Calcs (Month) - Using Integer Math
            let incMCents = 0, expMCents = 0;
            monthlyTx.forEach(t => {
                const val = Math.round(t.amount * 100);
                if (t.type === 'income') incMCents += val;
                else expMCents += val;
            });
            const incM = incMCents / 100;
            const expM = expMCents / 100;
            
            // Calcs (Total) - Using Integer Math
            let incTCents = 0, expTCents = 0;
            window.appData.transactions.forEach(t => {
                 const val = Math.round(t.amount * 100);
                 if (t.type === 'income') incTCents += val;
                 else expTCents += val;
            });
            const incT = incTCents / 100;
            const expT = expTCents / 100;
            
            const totalBalanceReal = (incTCents - expTCents) / 100;

            // Display Values (Based on Mode)
            const showInc = balanceMode === 'month' ? incM : incT;
            const showExp = balanceMode === 'month' ? expM : expT;
            let bal = showInc - showExp;

            // FORCED SAVINGS LOGIC (VISUAL REDUCTION)
            if (window.appData.settings.forcedSavings) {
                bal = bal * 0.90; // Reduce by 10%
            }

            document.getElementById('total-balance').textContent = formatCurrency(bal);
            document.getElementById('total-income').textContent = formatCurrency(showInc);
            document.getElementById('total-expense').textContent = formatCurrency(showExp);

            // Progress Bar
            const percent = showInc > 0 ? Math.min((showExp / showInc) * 100, 100) : (showExp > 0 ? 100 : 0);
            document.getElementById('balance-progress').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;

            // List - Optimized DOM Rendering (No innerHTML += in loop)
            const listEl = document.getElementById('recent-list');
            const displayTx = balanceMode === 'month' ? monthlyTx : [...window.appData.transactions];
            
            // SORT BY FULL DATE OBJECT (Includes time)
            displayTx.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(displayTx.length === 0) {
                listEl.innerHTML = '<div class="text-center text-zinc-600 text-xs py-8">Sin movimientos</div>';
            } else {
                const listHTML = displayTx.slice(0, 5).map(t => createTxHTML(t)).join('');
                listEl.innerHTML = listHTML;
            }
            
            // Formula & Payday - Pass the modified balance if Forced Savings is on
            // This ensures the daily budget also reflects the scarcity
            updatePaydayInfo(bal);
            updateChart(displayTx);
        }

        function createTxHTML(t) {
            const isInc = t.type === 'income';
            // Find icon
            const catObj = [...CATEGORIES.expense, ...CATEGORIES.income].find(c => c.id === t.category);
            const icon = catObj ? catObj.icon : 'ph-circle';
            const iconColor = catObj ? catObj.color : 'text-zinc-400';
            
            // Format Date Subtitle
            let dateDisplay = '';
            
            if (t.date) {
                if (t.date.includes('T')) {
                    // New Format: YYYY-MM-DDTHH:MM
                    const d = new Date(t.date);
                    if (!isNaN(d.getTime())) {
                        const day = d.getDate().toString().padStart(2, '0');
                        const month = (d.getMonth() + 1).toString().padStart(2, '0');
                        const hour = d.getHours().toString().padStart(2, '0');
                        const min = d.getMinutes().toString().padStart(2, '0');
                        dateDisplay = `${day}/${month} ${hour}:${min}`;
                    }
                } else {
                    // Old Format: YYYY-MM-DD
                    const parts = t.date.split('-');
                    if (parts.length === 3) {
                        dateDisplay = `${parts[2]}/${parts[1]}`; // DD/MM
                    }
                }
            }

            return `
            <div class="flex justify-between items-center p-3 rounded-2xl bg-zinc-900/30 hover:bg-zinc-800 transition-colors border border-white/5 group relative">
                <div class="flex items-center gap-3 overflow-hidden flex-1 cursor-pointer" onclick="editTransaction('${t.id}')">
                    <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                        <i class="ph-fill ${icon} ${iconColor} text-lg"></i>
                    </div>
                    <div class="min-w-0">
                        <h4 class="font-bold text-zinc-300 text-xs truncate">${t.title}</h4>
                        <p class="text-[10px] text-zinc-600 uppercase font-bold">
                            ${t.category} ${dateDisplay ? '• ' + dateDisplay : ''}
                        </p>
                    </div>
                </div>
                
                <div class="flex flex-col items-end gap-1">
                    <span class="font-bold text-sm ${isInc ? 'text-emerald-500' : 'text-zinc-200'} whitespace-nowrap">
                        ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                    </span>
                    <button onclick="event.stopPropagation(); deleteTransaction('${t.id}')" class="text-zinc-600 hover:text-red-500 p-1 rounded-md hover:bg-red-500/10 transition z-10" title="Eliminar">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </div>
            </div>
            `;
        }

        function renderHistory() {
            // FIX: Safely get filter, default to 'all' if element not found yet
            const activeBtn = document.querySelector('.filter-btn.active');
            const filter = activeBtn ? activeBtn.dataset.filter : 'all';
            
            const list = document.getElementById('full-history-list');
            list.innerHTML = '';
            
            // Sort by full date time
            let txs = [...window.appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filter !== 'all') txs = txs.filter(t => t.type === filter);
            
            if(txs.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-600 py-10">Nada por aquí</div>';
                return;
            }

            // GROUPING LOGIC (BY DAY)
            const grouped = {};
            txs.forEach(t => {
                if(!t.date) return;
                // Robust key generation (take first 10 chars YYYY-MM-DD)
                const dateKey = t.date.substring(0, 10);
                if(!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            // RENDER GROUPS
            Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                const groupDiv = document.createElement('div');
                // Force time to midnight to avoid timezone shift on just the date part
                const dateObj = new Date(date + 'T00:00:00');
                
                const today = new Date(); today.setHours(0,0,0,0);
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
                
                let label = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                if(dateObj.getTime() === today.getTime()) label = "Hoy";
                else if(dateObj.getTime() === yesterday.getTime()) label = "Ayer";

                // Optimized DOM Rendering (No innerHTML += in loop)
                const txItemsHTML = grouped[date].map(t => createTxHTML(t)).join('');
                
                groupDiv.innerHTML = `
                    <h3 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mt-6 mb-2 pl-2">${label}</h3>
                    <div class="space-y-2">
                        ${txItemsHTML}
                    </div>
                `;
                list.appendChild(groupDiv);
            });
        }

        function renderFixed() {
            const list = document.getElementById('fixed-list');
            
            if(window.appData.fixed.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-600 py-10 col-span-full">Sin pagos fijos</div>';
                return;
            }

            // Optimized DOM Rendering (No innerHTML += in loop)
            const fixedHTML = window.appData.fixed.map(f => {
                const isPaid = isFixedPaidThisMonth(f.id);
                
                // Styles based on status
                const containerClass = isPaid 
                    ? "bg-emerald-900/10 border border-emerald-500/50 p-4 rounded-2xl flex justify-between items-center transition-all"
                    : "bg-zinc-900/50 border border-zinc-800 p-4 rounded-2xl flex justify-between items-center transition-all";
                
                const textClass = isPaid ? "text-emerald-400" : "text-zinc-200";
                
                const actionBtn = isPaid 
                    ? `<div class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-500/50 flex items-center justify-center text-emerald-500 cursor-default"><i class="ph-bold ph-check"></i></div>`
                    : `<button onclick="payFixed('${f.id}')" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-emerald-500 hover:bg-emerald-500 hover:text-white transition shadow-lg"><i class="ph-bold ph-check"></i></button>`;

                return `
                <div class="${containerClass}">
                    <div>
                        <p class="font-bold ${textClass} text-sm">${f.title}</p>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase">Día ${f.day} • ${formatCurrency(f.amount)}</p>
                    </div>
                    <div class="flex gap-2">
                        ${actionBtn}
                        <button onclick="deleteFixed('${f.id}')" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            list.innerHTML = fixedHTML;
        }

        // --- FORMULA & PAYDAY (LOGIC UPDATE: MONTH END FIX + HOLIDAYS + PENDING FIXED) ---
        function updatePaydayInfo(totalBalance) {
            const set = window.appData.settings;
            const badge = document.getElementById('payday-badge');
            
            if(!set || (set.frequency === 'monthly' && !set.payday)) {
                badge.textContent = "Sin Config";
                badge.className = "text-[10px] bg-zinc-800 text-zinc-500 border border-zinc-700 px-3 py-1.5 rounded-full font-mono font-bold";
                document.getElementById('formula-days-left').textContent = "Configura tu cobro";
                document.getElementById('formula-daily').textContent = "$0.00";
                return;
            }
            
            const nextDate = getNextPayday();
            if (!nextDate) return;

            const today = new Date(); today.setHours(0,0,0,0);
            const diff = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
            
            // Badge Update
            badge.textContent = diff <= 0 ? "¡Hoy Cobras!" : `${diff} Días Restantes`;
            badge.className = diff <= 3 
                ? "text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(239,68,68,0.1)]"
                : "text-[10px] bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(16,185,129,0.1)]";

            // Formula Calculation
            updateDailyFormula(totalBalance, diff, nextDate);
        }

        function getNextPayday() {
            const today = new Date(); today.setHours(0,0,0,0);
            let candidates = [];
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const s = window.appData.settings;
            
            // Logic to handle month overflow (Day 0 of next month = Last day of current month)
            const getSafeDate = (year, month, day) => {
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const safeDay = Math.min(day, lastDayOfMonth);
                return new Date(year, month, safeDay);
            };

            if (s.frequency === 'biweekly') {
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    candidates.push(getSafeDate(year, monthIndex, 15));
                    candidates.push(getSafeDate(year, monthIndex, 30)); // 30 will auto-adjust for Feb
                }
            } else if (s.frequency === 'biweekly-custom' && s.payday1 && s.payday2) {
                const p1 = parseInt(s.payday1); const p2 = parseInt(s.payday2);
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    candidates.push(getSafeDate(year, monthIndex, p1));
                    candidates.push(getSafeDate(year, monthIndex, p2));
                }
            } else if (s.frequency === 'monthly' && s.payday) {
                const day = parseInt(s.payday);
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    candidates.push(getSafeDate(year, monthIndex, day));
                }
            }
            
            // Apply Holiday/Weekend Shift Logic to ALL candidates first
            let adjustedCandidates = candidates.map(d => getNextBusinessDay(d));
            adjustedCandidates.sort((a,b) => a - b);
            
            // Find first date that is >= Today
            for (let d of adjustedCandidates) {
                d.setHours(0,0,0,0);
                if (d >= today) return d;
            }
            return adjustedCandidates[0]; // Fallback
        }

        function getNextBusinessDay(date) {
            let d = new Date(date);
            // Helper to format MM-DD for comparison
            const fmt = (x) => `${(x.getMonth()+1).toString().padStart(2,'0')}-${x.getDate().toString().padStart(2,'0')}`;

            // Check if Sat(6), Sun(0) or Holiday
            while (d.getDay() === 0 || d.getDay() === 6 || COMMON_HOLIDAYS.includes(fmt(d))) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        function updateDailyFormula(totalBalance, daysLeft, nextPaydayDate) {
            if(daysLeft <= 0) {
                // It's payday!
                document.getElementById('formula-days-left').textContent = "¡Hoy Cobras!";
                document.getElementById('formula-days-left').className = "text-[10px] text-emerald-400 font-bold uppercase tracking-wider mb-0.5";
                document.getElementById('formula-daily').textContent = formatCurrency(totalBalance);
                return;
            }

            // Logic: Calculate Sum of Fixed Payments due strictly in the remaining period
            let pendingFixedSum = 0;
            const today = new Date(); today.setHours(0,0,0,0);
            
            // Loop through each day from Tomorrow until Payday
            // We check if any fixed payment falls on these days
            for(let i=1; i <= daysLeft; i++) {
                let checkDate = new Date(today);
                checkDate.setDate(today.getDate() + i);
                const dayNum = checkDate.getDate();
                
                // Find fixed payments that match this day number
                window.appData.fixed.forEach(f => {
                    if(parseInt(f.day) === dayNum) {
                        // Check if this specific Fixed Payment has been paid this month
                        if (!isFixedPaidThisMonth(f.id)) {
                             // Integer math for accumulation
                             pendingFixedSum = (Math.round(pendingFixedSum * 100) + Math.round(parseFloat(f.amount) * 100)) / 100;
                        }
                    }
                });
            }

            // New Formula: (Balance - Pending Fixed) / Days
            // Ensure precise subtraction
            const balanceCents = Math.round(totalBalance * 100);
            const pendingCents = Math.round(pendingFixedSum * 100);
            const effectiveBalance = (balanceCents - pendingCents) / 100;
            
            const daily = effectiveBalance > 0 ? (effectiveBalance / daysLeft) : 0;

            document.getElementById('formula-days-left').textContent = `${daysLeft} días • -${formatCurrency(pendingFixedSum)} fijos`;
            document.getElementById('formula-days-left').className = "text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-0.5";
            document.getElementById('formula-daily').textContent = formatCurrency(daily);
        }

        // --- CHART JS ---
        function updateChart(txs) {
            const ctx = document.getElementById('financeChart');
            if(!ctx) return;
            
            // Aggregate Expenses by Category
            const cats = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                // Precise addition using Integer Math
                const currentValCents = Math.round((cats[t.category] || 0) * 100);
                const addValCents = Math.round(t.amount * 100);
                cats[t.category] = (currentValCents + addValCents) / 100;
            });

            const labels = Object.keys(cats);
            const data = Object.values(cats);

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#ef4444',
                        borderRadius: 4,
                        barThickness: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // --- UI INTERACTION ---
        function switchTab(id) {
            document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            // Mobile Nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn i').forEach(i => i.classList.remove('text-white'));
            const mobBtn = document.getElementById(`nav-${id}`);
            if(mobBtn) {
                mobBtn.classList.add('active');
                mobBtn.querySelector('i').classList.add('text-white');
            }

            // Desktop Nav
            document.querySelectorAll('.g-link').forEach(l => l.classList.remove('active'));
            const deskLink = document.getElementById(`desk-link-${id}`);
            if(deskLink) deskLink.classList.add('active');

            if(id === 'dashboard') renderDashboard();
            if(id === 'history') renderHistory();
            if(id === 'fixed') renderFixed();
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${type}"]`).classList.add('active');
            renderHistory();
        }

        function renderCategoryChips(type) {
            const container = document.getElementById('category-chips');
            container.innerHTML = '';
            const list = type === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
            
            // Use DocumentFragment for performant DOM Insertion
            const fragment = document.createDocumentFragment();
            
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = "chip px-4 py-2 rounded-full text-[10px] font-bold cursor-pointer flex items-center gap-1";
                div.innerHTML = `<i class="ph-fill ${c.icon} ${c.color}"></i> ${c.id}`;
                div.onclick = () => selectChip(c.id);
                div.dataset.id = c.id;
                fragment.appendChild(div);
            });
            
            container.appendChild(fragment);
        }

        function selectChip(catId) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            const selected = document.querySelector(`.chip[data-id="${catId}"]`);
            if(selected) selected.classList.add('active');
            document.getElementById('t-category').value = catId;
        }

        function setupSettingsUI() {
            if(!window.appData.settings) return;
            const s = window.appData.settings;
            const radios = document.getElementsByName('pay-freq');
            for(let r of radios) { if(r.value === s.frequency) r.checked = true; }
            
            const selPayday = document.getElementById('payday-select'); if(selPayday && s.payday) selPayday.value = s.payday;
            const selP1 = document.getElementById('payday-1-select'); if(selP1 && s.payday1) selP1.value = s.payday1;
            const selP2 = document.getElementById('payday-2-select'); if(selP2 && s.payday2) selP2.value = s.payday2;
            
            // Forced Savings Toggle
            const toggle = document.getElementById('toggle-forced-savings');
            if(toggle && s.forcedSavings !== undefined) toggle.checked = s.forcedSavings;
            
            togglePaydayInput();
        }

        function togglePaydayInput() {
            const freq = document.querySelector('input[name="pay-freq"]:checked')?.value || 'biweekly';
            const mCont = document.getElementById('monthly-select-container');
            const bCont = document.getElementById('biweekly-custom-container');
            
            if (mCont) mCont.classList.add('hidden');
            if (bCont) bCont.classList.add('hidden');
            
            if (freq === 'monthly' && mCont) mCont.classList.remove('hidden');
            if (freq === 'biweekly-custom' && bCont) bCont.classList.remove('hidden');
        }

        // MODAL HELPERS
        function openModal(id) {
            const overlay = document.getElementById(id);
            overlay.classList.add('is-open'); // Removed hidden handling for CSS transition
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('is-open');
        }
        
        // Show Toast Helper
        function showToast(msg) {
            const t = document.getElementById('toast');
            const tm = document.getElementById('toast-msg');
            tm.textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                 t.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        // Init Selects
        document.addEventListener('DOMContentLoaded', () => {
            const sels = [document.getElementById('f-day'), document.getElementById('payday-select'), document.getElementById('payday-1-select'), document.getElementById('payday-2-select')];
            sels.forEach(s => {
                if(s) {
                    for(let i=1; i<=31; i++) s.innerHTML += `<option value="${i}">${i}</option>`;
                }
            });
            updateDateHeader();
        });

    </script>
</body>
</html>
