<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>God's Plan | Finanzas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: { 
                        brand: '#FF2A2A',
                        dark: { 900: '#030303', card: '#0D0D0D' } 
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #030303; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; height: 100dvh; }
        
        /* Glassmorphism consistente con Main Page */
        .glass { background: rgba(13, 13, 13, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-nav { background: rgba(3, 3, 3, 0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); padding-bottom: var(--sab); }
        
        /* Inputs & UI Elements */
        .input-modern { background: #090909; border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; transition: all 0.2s; font-size: 16px !important; }
        .input-modern:focus { border-color: #FF2A2A; outline: none; background: #0D0D0D; }
        
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip.active { background: #FF2A2A; color: white; border-color: #FF2A2A; box-shadow: 0 4px 12px rgba(255, 42, 42, 0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .toast { pointer-events: auto; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { transform: translateX(0); }

        /* Modal Transitions */
        #modalOverlay { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #modalOverlay.is-open { opacity: 1; pointer-events: auto; }
        #modalSheet { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        #modalOverlay.is-open #modalSheet { transform: translateY(0); }
        
        @media (min-width: 768px) {
            #modalSheet { transform: scale(0.95); opacity: 0; }
            #modalOverlay.is-open #modalSheet { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm sm:text-base selection:bg-brand selection:text-white">

    <!-- NAV SUPERIOR -->
    <nav class="h-16 border-b border-white/5 flex items-center justify-between px-4 md:px-8 bg-black/50 backdrop-blur-md z-50 shrink-0">
        <div class="flex items-center gap-4">
            <!-- BOTÓN PARA VOLVER AL DASHBOARD PRINCIPAL -->
            <a href="/" class="w-10 h-10 rounded-full border border-white/10 hover:bg-white/5 flex items-center justify-center text-zinc-400 hover:text-white transition-colors">
                <i class="ph-bold ph-arrow-left text-lg"></i>
            </a>
            <div class="flex flex-col">
                <span class="font-bold tracking-tight text-white flex items-center gap-2">
                    FINANZAS <span class="text-[10px] bg-brand/10 text-brand px-1.5 py-0.5 rounded border border-brand/20">LITE</span>
                </span>
                <span id="navUserEmail" class="text-[10px] text-zinc-500 font-mono">Conectando...</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <div id="syncStatus" class="w-2 h-2 rounded-full bg-zinc-800 animate-pulse" title="Sincronizando"></div>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 overflow-y-auto relative scroll-smooth overflow-x-hidden md:px-6 pb-24 md:pb-8">
        <div class="w-full max-w-lg md:max-w-4xl mx-auto pt-6">

            <!-- VISTA: BALANCE -->
            <section id="view-balance" class="px-4 md:px-0 animate-fade-in">
                
                <!-- Tarjeta Principal -->
                <div class="glass rounded-3xl p-6 relative overflow-hidden group mb-6">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-brand/5 rounded-full blur-[80px] -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold text-zinc-500 uppercase tracking-widest flex items-center gap-2">
                                <i class="ph-fill ph-wallet"></i> Disponible Hoy
                            </span>
                            <button onclick="app.openModal('adjustment')" class="text-zinc-500 hover:text-white transition-colors p-1" title="Ajustar Saldo Real">
                                <i class="ph-bold ph-sliders-horizontal"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-baseline gap-1 mb-6">
                            <span id="mainAmountDisplay" class="text-5xl md:text-6xl font-black text-white tracking-tighter transition-all">---</span>
                        </div>

                        <!-- Mini Stats -->
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5">
                            <div>
                                <span class="text-[10px] text-zinc-500 uppercase font-bold block mb-1">Saldo Real Total</span>
                                <span id="realBalanceDisplay" class="text-lg font-mono font-bold text-zinc-300">---</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-zinc-500 uppercase font-bold block mb-1">Retenido (Fijos)</span>
                                <span id="reservedFixedDisplay" class="text-lg font-mono font-bold text-orange-500">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción Rápida -->
                <div class="grid grid-cols-2 gap-3 mb-8">
                    <button onclick="app.openModal('extra')" class="h-14 rounded-xl bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 text-green-500 font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i class="ph-bold ph-arrow-down-left"></i> INGRESO
                    </button>
                    <button onclick="app.openModal('expense')" class="h-14 rounded-xl bg-brand/10 hover:bg-brand/20 border border-brand/20 text-brand font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i class="ph-bold ph-arrow-up-right"></i> GASTO
                    </button>
                </div>

                <!-- Próximo Pago Config -->
                <div onclick="app.openModal('nextpay')" class="mb-8 p-4 rounded-xl border border-white/5 bg-white/5 hover:bg-white/10 transition-colors cursor-pointer flex items-center justify-between group">
                    <div>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-1">Próximo Corte / Pago</p>
                        <h3 id="nextPayDateDisplay" class="text-white font-bold font-mono">Sin definir</h3>
                    </div>
                    <div id="daysLeftBadge" class="px-3 py-1 rounded bg-zinc-900 text-xs font-mono text-zinc-400 border border-zinc-800">--</div>
                </div>

                <!-- Lista de Transacciones -->
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-white">Actividad Reciente</h3>
                    <div class="relative w-32">
                        <input type="text" id="searchTx" placeholder="Buscar..." onkeyup="app.filterTransactions()" class="w-full bg-transparent border-b border-white/10 py-1 text-xs text-white focus:border-brand focus:outline-none placeholder-zinc-700">
                    </div>
                </div>

                <div id="transactionsList" class="space-y-2 pb-10">
                    <div class="text-center py-10 text-zinc-600 animate-pulse text-xs">Cargando datos...</div>
                </div>
            </section>

            <!-- VISTA: GASTOS FIJOS -->
            <section id="view-plan" class="hidden px-4 md:px-0 animate-fade-in">
                <div class="glass p-6 rounded-3xl mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-white">Gastos Recurrentes</h2>
                            <p class="text-xs text-zinc-500 mt-1">Suscripciones, renta, servicios.</p>
                        </div>
                        <button onclick="app.openModal('fixed')" class="w-10 h-10 rounded-full bg-brand text-white flex items-center justify-center hover:bg-brand/80 transition-colors shadow-lg shadow-brand/20">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                    </div>
                    <div id="fixedExpensesList" class="space-y-3">
                        <!-- JS Render -->
                    </div>
                </div>
                
                <div class="p-6 rounded-3xl bg-zinc-900/50 border border-white/5">
                    <h3 class="text-sm font-bold text-white mb-4">Zona de Peligro</h3>
                    <button onclick="app.resetData()" class="w-full py-3 rounded-xl border border-red-900/30 text-red-500 hover:bg-red-900/10 text-xs font-bold transition-all flex items-center justify-center gap-2">
                        <i class="ph-bold ph-trash"></i> ELIMINAR TODOS LOS DATOS
                    </button>
                </div>
            </section>

        </div>
    </main>

    <!-- BOTTOM NAV (MÓVIL) -->
    <div class="md:hidden fixed bottom-0 left-0 w-full h-20 glass-nav z-40 grid grid-cols-2 px-6">
        <button onclick="app.switchView('balance')" class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-600 transition-colors">
            <i class="ph-fill ph-wallet text-2xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[10px] font-bold group-[.active]:text-white">Balance</span>
        </button>
        <button onclick="app.switchView('plan')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 transition-colors">
            <i class="ph-fill ph-calendar-check text-2xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[10px] font-bold group-[.active]:text-white">Fijos</span>
        </button>
    </div>

    <!-- MODAL OVERLAY -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 z-[100] flex items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-sm" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet" class="w-full md:max-w-md bg-[#0F0F0F] rounded-t-3xl md:rounded-3xl border-t md:border border-white/10 p-6 max-h-[85vh] overflow-y-auto">
            
            <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6 md:hidden"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-white">Nuevo</h3>
                <button onclick="app.closeModal()" class="w-8 h-8 rounded-full bg-zinc-900 flex items-center justify-center text-zinc-400 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>

            <!-- Formularios Dinámicos -->
            <div id="modalContent">
                
                <!-- Categorías -->
                <div id="categoryChips" class="flex flex-wrap gap-2 mb-6 hidden"></div>

                <!-- Input Monto -->
                <div id="inputAmountGroup" class="mb-4 hidden">
                    <label class="text-[10px] font-bold text-zinc-500 uppercase ml-1 mb-1 block">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 font-bold">$</span>
                        <input type="number" id="inpAmount" class="input-modern w-full p-4 pl-8 text-2xl font-bold font-mono" placeholder="0.00" inputmode="decimal">
                    </div>
                </div>

                <!-- Input Texto -->
                <div id="inputTextGroup" class="mb-4 hidden">
                    <label class="text-[10px] font-bold text-zinc-500 uppercase ml-1 mb-1 block">Descripción / Nombre</label>
                    <input type="text" id="inpText" class="input-modern w-full p-4" placeholder="...">
                </div>

                <!-- Input Fecha -->
                <div id="inputDateGroup" class="mb-4 hidden">
                    <label class="text-[10px] font-bold text-zinc-500 uppercase ml-1 mb-1 block">Fecha / Día</label>
                    <input type="date" id="inpDate" class="input-modern w-full p-4 text-center">
                    <input type="number" id="inpDayNum" class="input-modern w-full p-4 text-center hidden" placeholder="Día del mes (ej: 15)" max="31">
                </div>

                <!-- Botón Acción -->
                <button id="modalActionBtn" class="w-full py-4 rounded-xl bg-white text-black font-bold text-lg hover:bg-zinc-200 transition-colors mt-2">
                    Guardar
                </button>
                
                <button id="modalDeleteBtn" class="w-full py-3 mt-2 text-red-500 font-bold text-sm hidden hover:bg-red-500/10 rounded-xl">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- TOASTS -->
    <div id="toast-container"></div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            setPersistence, 
            browserLocalPersistence,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, 
            limit, 
            setDoc, 
            updateDoc, 
            addDoc, 
            deleteDoc, 
            getDocs, 
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración idéntica a la página principal
        const firebaseConfig = {
            apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
            authDomain: "godsplan-blqa.firebaseapp.com",
            projectId: "godsplan-blqa",
            storageBucket: "godsplan-blqa.firebasestorage.app",
            messagingSenderId: "1008783768310",
            appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // CLAVE: Esto permite compartir la sesión con la página principal si están en el mismo dominio
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        // ID de la App eliminado de la ruta (ahora usamos root users)
        // const APP_ID = 'gods-plan-lite-v1'; 

        const UI = {
            toast(msg, type = 'default') {
                const con = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600', default: 'bg-zinc-800' };
                el.className = `toast px-4 py-3 rounded-xl shadow-2xl text-white font-bold text-sm flex items-center gap-2 ${colors[type] || colors.default}`;
                el.innerHTML = `<i class="ph-bold ${type==='success'?'ph-check':type==='error'?'ph-warning':'ph-info'}"></i> ${msg}`;
                con.appendChild(el);
                requestAnimationFrame(() => el.classList.add('show'));
                setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
            },
            fmtMoney: (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n || 0)
        };

        const Categories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' },
            { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
            { id: 'Casa', icon: 'ph-house', color: 'text-purple-400' },
            { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' },
            { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Ocio', icon: 'ph-game-controller', color: 'text-indigo-400' },
            { id: 'Otros', icon: 'ph-dots-three-circle', color: 'text-zinc-400' }
        ];

        window.app = {
            user: null,
            data: { fixed: [], nextPayDate: null },
            logs: [],
            currentModal: null,
            editId: null,

            init() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.user = user;
                        document.getElementById('navUserEmail').textContent = user.email || "Invitado";
                        document.getElementById('syncStatus').classList.replace('bg-zinc-800', 'bg-green-500');
                        this.setupListeners();
                        console.log("Conectado como:", user.uid);
                    } else {
                        // Si no hay usuario, redirigir al login principal o intentar anónimo
                        // En este caso, para no romper el flujo, iniciaremos anónimo si falla, 
                        // pero mostramos un aviso.
                        document.getElementById('navUserEmail').textContent = "Desconectado";
                        UI.toast("Sesión no detectada. Redirigiendo...", "error");
                        // Opcional: window.location.href = "/";
                        signInAnonymously(auth);
                    }
                });
            },

            setupListeners() {
                // Listener de Configuración de Usuario DIRECTO A ROOT
                const userRef = doc(db, 'users', this.user.uid, 'finance', 'data');
                onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        this.data = { fixed: [], ...snap.data() };
                    } else {
                        setDoc(userRef, { fixed: [] });
                    }
                    this.renderFixed();
                    this.calcBalance();
                });

                // Listener de Transacciones DIRECTO A ROOT
                const logsRef = collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions');
                const q = query(logsRef, orderBy('date', 'desc'), limit(500));
                
                onSnapshot(q, (snap) => {
                    this.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderLogs();
                    this.calcBalance();
                });
            },

            calcBalance() {
                let total = 0;
                this.logs.forEach(l => {
                    if (l.type === 'income') total += l.amount;
                    else total -= l.amount;
                });

                // Lógica de "Disponible Hoy"
                let reserved = 0;
                let displayAmount = total;
                let daysLeft = 0;

                if (this.data.nextPayDate) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const payDate = new Date(this.data.nextPayDate + 'T00:00:00');
                    const diff = payDate - today;
                    daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));

                    document.getElementById('nextPayDateDisplay').textContent = payDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'long' });
                    document.getElementById('daysLeftBadge').textContent = daysLeft <= 0 ? "¡Hoy!" : `${daysLeft} días`;

                    // Calcular retenidos (lógica simplificada para demo)
                    const currentDay = today.getDate();
                    (this.data.fixed || []).forEach(f => {
                         // Si el día de pago es hoy o futuro cercano antes del pago...
                         if (f.day >= currentDay) reserved += parseFloat(f.amount);
                    });
                    
                    if (daysLeft > 0) displayAmount = (total - reserved) / daysLeft;
                } else {
                    document.getElementById('nextPayDateDisplay').textContent = "Sin definir";
                    document.getElementById('daysLeftBadge').textContent = "--";
                }

                document.getElementById('mainAmountDisplay').textContent = UI.fmtMoney(displayAmount);
                document.getElementById('realBalanceDisplay').textContent = UI.fmtMoney(total);
                document.getElementById('reservedFixedDisplay').textContent = reserved > 0 ? `-${UI.fmtMoney(reserved)}` : '$0.00';
            },

            renderLogs() {
                const list = document.getElementById('transactionsList');
                list.innerHTML = '';
                
                const filter = document.getElementById('searchTx').value.toLowerCase();
                const visible = this.logs.filter(l => (l.desc||'').toLowerCase().includes(filter) || (l.category||'').toLowerCase().includes(filter));

                if (visible.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-zinc-600 text-xs">Sin movimientos recientes</div>';
                    return;
                }

                visible.forEach(l => {
                    const isInc = l.type === 'income';
                    const cat = Categories.find(c => c.id === l.category) || { icon: 'ph-arrow-right', color: 'text-zinc-400' };
                    
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 rounded-xl hover:bg-white/5 cursor-pointer transition-colors border border-transparent hover:border-white/5';
                    el.onclick = () => this.openModal(isInc ? 'extra' : 'expense', l.id);
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0">
                                <i class="ph-fill ${isInc ? 'ph-arrow-down-left text-green-500' : cat.icon + ' ' + cat.color} text-lg"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="font-bold text-zinc-300 text-sm truncate">${l.desc || l.category}</div>
                                <div class="text-[10px] text-zinc-500">${new Date(l.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="font-bold font-mono ${isInc ? 'text-green-500' : 'text-zinc-300'}">
                            ${isInc ? '+' : '-'}${UI.fmtMoney(l.amount)}
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            renderFixed() {
                const list = document.getElementById('fixedExpensesList');
                list.innerHTML = '';
                const sorted = (this.data.fixed || []).sort((a,b) => a.day - b.day);

                if (sorted.length === 0) {
                    list.innerHTML = '<div class="p-4 rounded-xl border border-dashed border-zinc-800 text-center text-zinc-600 text-xs">No hay gastos fijos. Pulsa + para agregar.</div>';
                    return;
                }

                sorted.forEach((f, idx) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-4 bg-zinc-900/40 border border-zinc-800 rounded-2xl cursor-pointer hover:border-brand/30 transition-colors';
                    el.onclick = () => this.openModal('fixed', idx);
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg bg-black border border-zinc-800 flex items-center justify-center font-bold text-zinc-400 font-mono">
                                ${f.day}
                            </div>
                            <div>
                                <div class="font-bold text-zinc-200 text-sm">${f.name}</div>
                                <div class="text-xs text-zinc-500">${UI.fmtMoney(f.amount)}</div>
                            </div>
                        </div>
                        <i class="ph-bold ph-caret-right text-zinc-600"></i>
                    `;
                    list.appendChild(el);
                });
            },

            filterTransactions() { this.renderLogs(); },

            // GESTIÓN DE MODALES
            openModal(type, id = null) {
                this.currentModal = type;
                this.editId = id;
                
                const title = document.getElementById('modalTitle');
                const catContainer = document.getElementById('categoryChips');
                const inpAmtGrp = document.getElementById('inputAmountGroup');
                const inpTxtGrp = document.getElementById('inputTextGroup');
                const inpDateGrp = document.getElementById('inputDateGroup');
                const btn = document.getElementById('modalActionBtn');
                const btnDel = document.getElementById('modalDeleteBtn');

                // Reset UI
                catContainer.classList.add('hidden');
                inpAmtGrp.classList.add('hidden');
                inpTxtGrp.classList.add('hidden');
                inpDateGrp.classList.add('hidden');
                btnDel.classList.add('hidden');
                
                document.getElementById('inpAmount').value = '';
                document.getElementById('inpText').value = '';
                
                // Configurar según tipo
                if (type === 'expense' || type === 'extra' || type === 'adjustment') {
                    title.textContent = type === 'expense' ? 'Registrar Gasto' : (type === 'adjustment' ? 'Ajustar Saldo' : 'Registrar Ingreso');
                    inpAmtGrp.classList.remove('hidden');
                    inpTxtGrp.classList.remove('hidden');
                    inpDateGrp.classList.remove('hidden');
                    
                    document.getElementById('inpDate').classList.remove('hidden');
                    document.getElementById('inpDayNum').classList.add('hidden');
                    
                    // Categorías
                    if (type === 'expense') {
                        catContainer.classList.remove('hidden');
                        catContainer.innerHTML = Categories.map(c => `
                            <div onclick="document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); this.classList.add('active')" class="chip px-3 py-1.5 rounded-full bg-zinc-900 border border-zinc-800 text-zinc-400 text-xs cursor-pointer flex items-center gap-1">
                                <i class="ph-fill ${c.icon}"></i> ${c.id}
                            </div>
                        `).join('');
                        setTimeout(() => catContainer.children[0]?.click(), 10);
                    }

                    // Cargar datos si es edición
                    if (id !== null) {
                        const log = this.logs.find(l => l.id === id);
                        if (log) {
                            document.getElementById('inpAmount').value = log.amount;
                            document.getElementById('inpText').value = log.desc;
                            document.getElementById('inpDate').value = log.date.split('T')[0];
                            btnDel.classList.remove('hidden');
                            // Seleccionar categoría si existe
                            if(type === 'expense') setTimeout(() => {
                                Array.from(catContainer.children).forEach(c => {
                                    if(c.textContent.trim().includes(log.category)) c.click();
                                });
                            }, 50);
                        }
                    } else {
                        document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
                    }
                } 
                else if (type === 'fixed') {
                    title.textContent = 'Gasto Recurrente';
                    inpAmtGrp.classList.remove('hidden');
                    inpTxtGrp.classList.remove('hidden');
                    inpDateGrp.classList.remove('hidden');
                    
                    document.getElementById('inpDate').classList.add('hidden');
                    document.getElementById('inpDayNum').classList.remove('hidden');
                    document.getElementById('inpDayNum').placeholder = "Día del mes (1-31)";

                    if (id !== null) {
                        const f = this.data.fixed[id];
                        document.getElementById('inpAmount').value = f.amount;
                        document.getElementById('inpText').value = f.name;
                        document.getElementById('inpDayNum').value = f.day;
                        btnDel.classList.remove('hidden');
                    }
                }
                else if (type === 'nextpay') {
                    title.textContent = 'Configurar Fecha Pago';
                    inpDateGrp.classList.remove('hidden');
                    document.getElementById('inpDate').classList.remove('hidden');
                    document.getElementById('inpDayNum').classList.add('hidden');
                    
                    if (this.data.nextPayDate) {
                        document.getElementById('inpDate').value = this.data.nextPayDate;
                    }
                }

                // Mostrar Modal
                document.getElementById('modalOverlay').classList.add('is-open');
                
                // Asignar Acciones
                btn.onclick = () => this.saveData();
                btnDel.onclick = () => this.deleteData();
            },

            closeModal() {
                document.getElementById('modalOverlay').classList.remove('is-open');
                this.currentModal = null;
                this.editId = null;
            },

            async saveData() {
                const amt = parseFloat(document.getElementById('inpAmount').value);
                const txt = document.getElementById('inpText').value;
                const type = this.currentModal;

                // Guardar Transacción
                if (type === 'expense' || type === 'extra' || type === 'adjustment') {
                    if (isNaN(amt)) return UI.toast('Monto inválido', 'error');
                    
                    const catEl = document.querySelector('.chip.active');
                    const category = type === 'expense' ? (catEl ? catEl.textContent.trim() : 'Otros') : (type === 'extra' ? 'Ingreso' : 'Ajuste');
                    
                    const dateVal = document.getElementById('inpDate').value || new Date().toISOString();
                    const finalDate = new Date(dateVal);
                    // Mantener hora actual para ordenamiento
                    const now = new Date();
                    finalDate.setHours(now.getHours(), now.getMinutes());

                    const payload = {
                        amount: type === 'adjustment' ? 0 : amt, // Ajuste se calcula abajo
                        desc: txt || (type === 'adjustment' ? 'Ajuste Manual' : category),
                        category: category,
                        type: type === 'extra' ? 'income' : 'expense',
                        date: finalDate.toISOString()
                    };

                    if (type === 'adjustment') {
                        // Calcular diferencia para ajustar
                        let currentTotal = 0;
                        this.logs.forEach(l => currentTotal += (l.type === 'income' ? l.amount : -l.amount));
                        const diff = amt - currentTotal;
                        payload.amount = Math.abs(diff);
                        payload.type = diff > 0 ? 'income' : 'expense';
                    }

                    const ref = collection(db, 'users', this.user.uid, 'finance', 'data', 'transactions');
                    
                    if (this.editId && type !== 'adjustment') {
                        await updateDoc(doc(ref, this.editId), payload);
                        UI.toast('Actualizado', 'success');
                    } else {
                        await addDoc(ref, payload);
                        UI.toast('Guardado', 'success');
                    }
                }
                
                // Guardar Fijo
                else if (type === 'fixed') {
                    const day = parseInt(document.getElementById('inpDayNum').value);
                    if (isNaN(amt) || isNaN(day) || !txt) return UI.toast('Datos incompletos', 'error');

                    const newItem = { name: txt, amount: amt, day: day };
                    const newFixed = [...(this.data.fixed || [])];

                    if (this.editId !== null) newFixed[this.editId] = newItem;
                    else newFixed.push(newItem);

                    await updateDoc(doc(db, 'users', this.user.uid, 'finance', 'data'), { fixed: newFixed });
                    UI.toast('Fijo guardado', 'success');
                }

                // Guardar Fecha Pago
                else if (type === 'nextpay') {
                    const date = document.getElementById('inpDate').value;
                    if (!date) return UI.toast('Fecha requerida', 'error');
                    await updateDoc(doc(db, 'users', this.user.uid, 'finance', 'data'), { nextPayDate: date });
                    UI.toast('Configuración guardada', 'success');
                }

                this.closeModal();
            },

            async deleteData() {
                if (!confirm("¿Seguro que quieres eliminar esto?")) return;

                if (this.currentModal === 'fixed') {
                    const newFixed = this.data.fixed.filter((_, i) => i !== this.editId);
                    await updateDoc(doc(db, 'users', this.user.uid, 'finance', 'data'), { fixed: newFixed });
                } else if (this.editId) {
                    await deleteDoc(doc(db, 'users', this.user.uid, 'finance', 'data', 'transactions', this.editId));
                }
                
                UI.toast('Eliminado', 'default');
                this.closeModal();
            },

            async resetData() {
                if(confirm("ATENCIÓN: Esto borrará TODAS las transacciones y configuraciones. ¿Continuar?")) {
                    const batch = writeBatch(db);
                    const userRef = doc(db, 'users', this.user.uid, 'finance', 'data');
                    
                    // Reset config
                    batch.set(userRef, { fixed: [], nextPayDate: null });
                    
                    // Delete logs
                    this.logs.forEach(l => {
                        const ref = doc(db, 'users', this.user.uid, 'finance', 'data', 'transactions', l.id);
                        batch.delete(ref);
                    });

                    await batch.commit();
                    UI.toast('Sistema reiniciado', 'default');
                }
            },

            switchView(view) {
                document.getElementById('view-balance').classList.add('hidden');
                document.getElementById('view-plan').classList.add('hidden');
                document.getElementById('view-' + view).classList.remove('hidden');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
            }
        };

        app.init();
    </script>
</body>
</html>
