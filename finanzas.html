<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinanzasPro - God's Plan</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Base */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom UI */
        .nav-item.active { color: #2563eb; }
        .nav-item.active i { font-weight: bold; }
        .toggle-btn { transition: all 0.2s ease; }
        
        /* SafeArea for mobile */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .tab-btn {
            @apply px-4 py-2 rounded-lg font-medium text-sm transition-colors;
        }

        /* Login Transition */
        .login-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <!-- Loading Overlay (Global) -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-center">
            <i class="ph ph-circle-notch text-4xl text-blue-600 animate-spin mb-4 inline-block"></i>
            <p class="text-gray-400 font-medium text-sm animate-pulse">Cargando...</p>
        </div>
    </div>

    <!-- VISTA LOGIN / REGISTER (Z-INDEX ALTO PARA CUBRIR LA APP) -->
    <div id="login-view" class="fixed inset-0 z-[200] bg-gray-50 flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-xl border border-gray-100 p-8 login-enter">
            <div class="text-center mb-8">
                <div class="bg-blue-600 text-white w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <i class="ph-bold ph-wallet text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">GOD'S PLAN</h1>
                <p class="text-gray-500 text-sm font-medium">Portal de Acceso Financiero</p>
            </div>

            <!-- Botones Toggle -->
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                <button onclick="window.authApp.toggleAuth('login')" id="tab-login" class="flex-1 py-2.5 text-sm font-bold rounded-lg shadow-sm bg-white text-gray-900 transition-all">INGRESAR</button>
                <button onclick="window.authApp.toggleAuth('register')" id="tab-register" class="flex-1 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 transition-all">REGISTRARSE</button>
            </div>

            <form onsubmit="event.preventDefault(); window.authApp.handleAuthSubmit();" class="space-y-4">
                <!-- Campo Nombre (Solo registro) -->
                <div id="field-name" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1 uppercase">Tu Nombre</label>
                    <div class="relative">
                        <i class="ph-bold ph-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="input-name" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all text-sm font-medium" placeholder="Nombre completo">
                    </div>
                </div>
                
                <!-- Campo Email/ID -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1 uppercase">ID o Email</label>
                    <div class="relative">
                        <i class="ph-bold ph-identification-card absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="input-id" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all text-sm font-medium" placeholder="Ej: 17620" required>
                    </div>
                </div>
                
                <!-- Campo Password -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1 uppercase">Contrase√±a</label>
                    <div class="relative">
                        <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="password" id="input-pass" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all text-sm font-medium" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                </div>

                <!-- Mensaje de Error -->
                <div id="auth-error-msg" class="hidden p-3 bg-red-50 border border-red-100 rounded-xl flex items-center gap-2">
                    <i class="ph-fill ph-warning-circle text-red-500"></i>
                    <span id="auth-error-txt" class="text-xs text-red-600 font-medium">Error</span>
                </div>

                <!-- Bot√≥n Submit -->
                <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2">
                    <span id="btn-text">INICIAR SESI√ìN</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>
            </form>
            
            <p class="text-center text-[10px] text-gray-400 mt-6">
                Acceso seguro v3.1 ‚Ä¢ God's Plan Adherencia
            </p>
        </div>
    </div>

    <!-- Main Content Area (App Dashboard) -->
    <main id="main-container" class="flex-1 overflow-y-auto hide-scrollbar relative pb-24 hidden">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-40 shadow-sm/50 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">FinanzasPro</h1>
                    <div class="flex items-center gap-1 mt-1">
                        <button onclick="changeMonth(-1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-600 active:bg-gray-200 transition">
                            <i class="ph ph-caret-left text-lg"></i>
                        </button>
                        <div class="flex flex-col items-center mx-1">
                            <p class="text-sm font-bold text-blue-600 w-28 text-center select-none" id="current-date">...</p>
                        </div>
                        <button onclick="changeMonth(1)" class="p-1 rounded-full hover:bg-gray-100 text-gray-600 active:bg-gray-200 transition">
                            <i class="ph ph-caret-right text-lg"></i>
                        </button>
                        <button onclick="goToCurrentMonth()" class="ml-2 text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-md border border-blue-100 hover:bg-blue-100 transition" title="Ir al mes actual">HOY</button>
                    </div>
                </div>
                <button onclick="openModal('transaction-modal')" class="bg-blue-600 text-white w-10 h-10 rounded-full shadow-lg shadow-blue-200 hover:bg-blue-700 transition active:scale-95 flex items-center justify-center">
                    <i class="ph ph-plus text-xl font-bold"></i>
                </button>
            </div>
        </header>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="p-4 space-y-5 fade-in pb-32">
            <!-- Balance Card -->
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl shadow-blue-200 relative overflow-hidden transition-all duration-300">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="ph ph-wallet text-9xl"></i>
                </div>
                <div class="absolute top-4 right-4 flex bg-black/20 backdrop-blur-md rounded-lg p-1">
                    <button onclick="setBalanceMode('month')" id="btn-mode-month" class="toggle-btn px-3 py-1 rounded-md text-[10px] font-bold bg-white text-blue-900 shadow-sm">Mes</button>
                    <button onclick="setBalanceMode('total')" id="btn-mode-total" class="toggle-btn px-3 py-1 rounded-md text-[10px] font-medium text-blue-100 hover:bg-white/10">Total</button>
                </div>
                <p class="text-blue-100 text-xs font-medium mb-1 mt-6 opacity-80" id="balance-label">Saldo del Mes</p>
                <h2 class="text-4xl font-bold mb-4 tracking-tight" id="total-balance">$0.00</h2>
                <div class="flex gap-3">
                    <div class="bg-white/10 rounded-xl p-2 px-3 backdrop-blur-sm flex-1 border border-white/10">
                        <p class="text-[10px] text-blue-100 mb-1 flex items-center gap-1 opacity-80"><i class="ph ph-arrow-down text-emerald-300"></i> Ingresos</p>
                        <p class="font-semibold text-sm" id="total-income">$0.00</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-2 px-3 backdrop-blur-sm flex-1 border border-white/10">
                        <p class="text-[10px] text-blue-100 mb-1 flex items-center gap-1 opacity-80"><i class="ph ph-arrow-up text-rose-300"></i> Gastos</p>
                        <p class="font-semibold text-sm" id="total-expense">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Payday Widget -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-50 p-2.5 rounded-xl text-purple-600">
                        <i class="ph ph-calendar-check text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-900">Pr√≥xima N√≥mina</p>
                        <p class="text-xs text-gray-500 font-medium" id="payday-countdown">Calculando...</p>
                        <p class="text-[10px] text-gray-400 mt-0.5" id="payday-detail"></p>
                    </div>
                </div>
                <button onclick="switchTab('settings')" class="text-gray-300 hover:text-blue-600 p-2"><i class="ph ph-gear-six"></i></button>
            </div>

            <!-- Chart Section -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-semibold text-gray-900 text-sm" id="chart-title">Resumen</h3>
                    <div class="flex bg-gray-50 rounded-lg p-1 border border-gray-100">
                         <button onclick="setChartType('balance')" id="btn-chart-balance" class="toggle-btn px-3 py-1 rounded-md text-[10px] font-bold bg-white text-gray-800 shadow-sm border border-gray-100">Balance</button>
                         <button onclick="setChartType('categories')" id="btn-chart-categories" class="toggle-btn px-3 py-1 rounded-md text-[10px] font-medium text-gray-500 hover:bg-gray-200">Categor√≠as</button>
                    </div>
                </div>
                <div class="h-48 w-full relative flex items-center justify-center">
                    <canvas id="financeChart"></canvas>
                </div>
                <div id="chart-insight" class="mt-4 p-3 bg-blue-50/50 rounded-lg text-xs text-blue-800 flex items-start gap-2 hidden border border-blue-100">
                    <i class="ph-fill ph-lightbulb text-base flex-shrink-0 text-amber-500"></i>
                    <span id="chart-insight-text">Analizando datos...</span>
                </div>
            </div>

            <!-- Flow Formula Card -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-gray-50">
                    <i class="ph-fill ph-function text-[100px]"></i>
                </div>
                <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2 relative z-10 text-sm">
                    <div class="w-1 h-4 bg-blue-500 rounded-full"></div> An√°lisis de Flujo Real
                </h3>
                <div class="space-y-3 relative z-10">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500">Saldo Anterior</span>
                        <span class="font-mono font-medium text-gray-700" id="formula-prev">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 flex items-center gap-1"><i class="ph-fill ph-plus-circle text-emerald-500"></i> Ingresos Mes</span>
                        <span class="font-mono font-medium text-emerald-600" id="formula-income">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 flex items-center gap-1"><i class="ph-fill ph-minus-circle text-rose-500"></i> Gastos Mes</span>
                        <span class="font-mono font-medium text-rose-600" id="formula-expense">$0.00</span>
                    </div>
                    <div class="border-t border-gray-100 pt-3 mt-1 flex justify-between items-center">
                        <span class="font-bold text-gray-900 text-sm">Total Disponible</span>
                        <span class="font-bold text-lg text-blue-600 font-mono tracking-tight" id="formula-total">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions Preview -->
            <div>
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="font-semibold text-gray-900 text-sm">Recientes</h3>
                    <button onclick="switchTab('history')" class="text-blue-600 text-xs font-medium hover:underline">Ver todo</button>
                </div>
                <div id="recent-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- VIEW: HISTORY -->
        <div id="view-history" class="p-4 hidden fade-in pb-32">
            <h2 class="text-xl font-bold mb-4 px-1">Historial</h2>
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2 hide-scrollbar px-1">
                <button onclick="filterHistory('all')" class="filter-btn active px-4 py-2 rounded-full bg-blue-600 text-white text-xs font-medium whitespace-nowrap transition shadow-sm shadow-blue-200" data-filter="all">Todos</button>
                <button onclick="filterHistory('income')" class="filter-btn px-4 py-2 rounded-full bg-white text-gray-600 border border-gray-200 text-xs font-medium whitespace-nowrap transition" data-filter="income">Ingresos</button>
                <button onclick="filterHistory('expense')" class="filter-btn px-4 py-2 rounded-full bg-white text-gray-600 border border-gray-200 text-xs font-medium whitespace-nowrap transition" data-filter="expense">Gastos</button>
            </div>
            <div id="full-history-list" class="space-y-3">
                <div class="text-center text-gray-400 py-10 text-sm">Cargando historial...</div>
            </div>
        </div>

        <!-- VIEW: FIXED PAYMENTS -->
        <div id="view-fixed" class="p-4 hidden fade-in pb-32">
            <div class="flex justify-between items-center mb-6 px-1">
                <h2 class="text-xl font-bold">Pagos Fijos</h2>
                <button onclick="openModal('fixed-modal')" class="text-blue-600 text-xs font-bold bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 flex items-center gap-1 active:bg-blue-100 transition"><i class="ph-bold ph-plus"></i> Nuevo</button>
            </div>
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 flex gap-3">
                <i class="ph-fill ph-info text-blue-500 text-xl flex-shrink-0 mt-0.5"></i>
                <p class="text-xs text-blue-800 leading-relaxed">Aqu√≠ puedes ver tus suscripciones o rentas. Usa el bot√≥n de <i class="ph-bold ph-check text-blue-600"></i> para registrarlos r√°pidamente como pagados este mes.</p>
            </div>
            <div id="fixed-list" class="space-y-3 grid grid-cols-1 gap-3">
                <div class="text-center text-gray-400 py-10 text-sm">Cargando pagos fijos...</div>
            </div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="p-4 hidden fade-in pb-32">
            <h2 class="text-xl font-bold mb-6 px-1">Configuraci√≥n</h2>
            <div class="space-y-6">
                
                <!-- Account Info -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-gray-900"><div class="p-1.5 bg-blue-100 rounded-md text-blue-600"><i class="ph-bold ph-user"></i></div> Cuenta</h3>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center text-gray-500 font-bold">
                            <i class="ph-bold ph-user"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-gray-900" id="user-display-name">Usuario</p>
                            <p class="text-xs text-gray-500" id="user-display-email">ID: ...</p>
                        </div>
                    </div>
                    <button onclick="window.authApp.logout()" class="w-full border border-gray-200 text-gray-600 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-50 transition flex items-center justify-center gap-2">
                        <i class="ph-bold ph-sign-out"></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <!-- Payday Setting -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-sm mb-2 flex items-center gap-2 text-gray-900"><div class="p-1.5 bg-green-100 rounded-md text-green-600"><i class="ph-bold ph-money"></i></div> Frecuencia de Ingresos</h3>
                    <p class="text-xs text-gray-500 mb-4 leading-relaxed">Configura cu√°ndo recibes dinero. El sistema calcular√° autom√°ticamente los d√≠as restantes.</p>
                    
                    <div class="space-y-3 mb-4">
                        <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50/50">
                            <input type="radio" name="pay-freq" value="biweekly" class="w-4 h-4 text-blue-600 accent-blue-600" onchange="togglePaydayInput()">
                            <div>
                                <span class="block font-semibold text-sm text-gray-900">Quincenal (15 y 30)</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50/50">
                            <input type="radio" name="pay-freq" value="biweekly-custom" class="w-4 h-4 text-blue-600 accent-blue-600" onchange="togglePaydayInput()">
                            <div>
                                <span class="block font-semibold text-sm text-gray-900">Quincenal (Personalizado)</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50/50">
                            <input type="radio" name="pay-freq" value="monthly" class="w-4 h-4 text-blue-600 accent-blue-600" onchange="togglePaydayInput()">
                            <div>
                                <span class="block font-semibold text-sm text-gray-900">Mensual</span>
                            </div>
                        </label>
                    </div>

                    <!-- Monthly Input -->
                    <div id="monthly-select-container" class="hidden mb-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">D√≠a de pago</label>
                        <select id="payday-select" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 outline-none focus:border-blue-500 text-sm">
                            <option value="">Seleccionar d√≠a</option>
                            <!-- JS fills 1-31 -->
                        </select>
                    </div>

                    <!-- Custom Bi-weekly Input -->
                    <div id="biweekly-custom-container" class="hidden grid grid-cols-2 gap-4 mb-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Pago 1</label>
                            <select id="payday-1-select" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 outline-none focus:border-blue-500 text-sm">
                                <!-- JS fills 1-31 -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Pago 2</label>
                            <select id="payday-2-select" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 outline-none focus:border-blue-500 text-sm">
                                <!-- JS fills 1-31 -->
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="mt-2 w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-black transition shadow-lg shadow-gray-200">Guardar Cambios</button>
                </div>

                <!-- IMPORT / EXPORT SECTION -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-gray-900">
                        <div class="p-1.5 bg-indigo-100 rounded-md text-indigo-600"><i class="ph-bold ph-arrows-left-right"></i></div>
                        Respaldo y Datos
                    </h3>
                    <div class="flex gap-3">
                        <button onclick="exportData()" class="flex-1 bg-gray-50 border border-gray-200 text-gray-700 py-3 rounded-xl font-bold text-xs hover:bg-gray-100 transition flex flex-col items-center gap-2">
                            <i class="ph-bold ph-download-simple text-xl"></i> Exportar JSON
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-gray-50 border border-gray-200 text-gray-700 py-3 rounded-xl font-bold text-xs hover:bg-gray-100 transition flex flex-col items-center gap-2">
                            <i class="ph-bold ph-upload-simple text-xl"></i> Importar JSON
                        </button>
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                    </div>
                     <p class="text-[10px] text-gray-400 mt-3 leading-tight">
                        Descarga una copia de seguridad o restaura tus datos desde un archivo JSON.
                    </p>
                </div>

                <!-- Data Management -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-sm mb-2 flex items-center gap-2 text-gray-900"><div class="p-1.5 bg-red-100 rounded-md text-red-600"><i class="ph-bold ph-trash"></i></div> Zona de Peligro</h3>
                    <button onclick="resetApp()" class="w-full border border-red-100 text-red-500 py-3 rounded-xl font-bold text-sm hover:bg-red-50 transition flex items-center justify-center gap-2">
                        <i class="ph-bold ph-trash"></i> Borrar todos mis datos
                    </button>
                </div>

                <div class="text-center text-[10px] text-gray-400 mt-8 pb-4">
                    FinanzasPro v3.1 (JSON Import/Export)
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe z-30 shadow-[0_-5px_10px_rgba(0,0,0,0.02)] hidden" id="bottom-nav">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-gray-400 transition hover:bg-gray-50" id="nav-dashboard">
                <i class="ph-fill ph-squares-four text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Inicio</span>
            </button>
            <button onclick="switchTab('history')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition hover:bg-gray-50" id="nav-history">
                <i class="ph-fill ph-list-dashes text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Historial</span>
            </button>
            <button onclick="switchTab('fixed')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition hover:bg-gray-50" id="nav-fixed">
                <i class="ph-fill ph-receipt text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Fijos</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition hover:bg-gray-50" id="nav-settings">
                <i class="ph-fill ph-gear text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Ajustes</span>
            </button>
        </div>
    </nav>

    <!-- MODAL: ADD TRANSACTION -->
    <div id="transaction-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('transaction-modal')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe" id="transaction-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">Nuevo Movimiento</h3>
                <button onclick="closeModal('transaction-modal')" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="ph-bold ph-x"></i></button>
            </div>
            <form id="transaction-form" onsubmit="addTransaction(event)">
                <div class="grid grid-cols-2 gap-3 mb-5">
                    <label class="cursor-pointer">
                        <input type="radio" name="type" value="expense" class="peer sr-only" checked id="radio-expense">
                        <div class="p-3 text-center border-2 border-transparent bg-gray-50 rounded-xl peer-checked:bg-red-50 peer-checked:border-red-500 peer-checked:text-red-700 text-gray-500 transition-all font-medium text-sm flex items-center justify-center gap-2">
                            <i class="ph-bold ph-minus-circle"></i> Gasto
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="type" value="income" class="peer sr-only" id="radio-income">
                        <div class="p-3 text-center border-2 border-transparent bg-gray-50 rounded-xl peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 text-gray-500 transition-all font-medium text-sm flex items-center justify-center gap-2">
                            <i class="ph-bold ph-plus-circle"></i> Ingreso
                        </div>
                    </label>
                </div>
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl font-bold">$</span>
                        <input type="number" id="t-amount" step="0.01" class="w-full pl-10 pr-4 py-4 bg-gray-50 border border-transparent focus:bg-white focus:border-blue-500 rounded-xl outline-none text-3xl font-bold text-gray-900 placeholder-gray-300 transition-all" placeholder="0.00" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Concepto</label>
                    <input type="text" id="t-title" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all font-medium text-gray-900" placeholder="¬øEn qu√© gastaste?" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Categor√≠a</label>
                        <select id="t-category" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all text-sm font-medium text-gray-900 appearance-none">
                            <option value="Comida">üçî Comida</option>
                            <option value="Transporte">üöå Transporte</option>
                            <option value="Hogar">üè† Hogar</option>
                            <option value="Entretenimiento">üé¨ Ocio</option>
                            <option value="Salud">üè• Salud</option>
                            <option value="Deuda">üí∏ Deuda</option>
                            <option value="Servicios">üí° Servicios</option>
                            <option value="N√≥mina">üí∞ N√≥mina</option>
                            <option value="Otros">üìù Otros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Fecha</label>
                        <input type="date" id="t-date" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all text-sm font-medium text-gray-900" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition">Guardar Movimiento</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD FIXED -->
    <div id="fixed-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('fixed-modal')"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full pb-safe" id="fixed-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">Nuevo Pago Fijo</h3>
                <button onclick="closeModal('fixed-modal')" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="ph-bold ph-x"></i></button>
            </div>
            <form id="fixed-form" onsubmit="addFixed(event)">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Nombre</label>
                    <input type="text" id="f-title" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all font-medium text-gray-900" placeholder="Ej. Netflix, Renta" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">Costo Aprox.</label>
                        <input type="number" id="f-amount" step="0.01" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all font-medium text-gray-900" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">D√≠a de Pago</label>
                        <select id="f-day" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all font-medium text-gray-900 appearance-none" required>
                            <!-- JS fills 1-31 -->
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition">Guardar Pago Fijo</button>
            </form>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl z-[400] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2">
        <i class="ph-fill ph-check-circle text-green-400 text-xl"></i>
        <span id="toast-msg" class="text-sm font-medium">Acci√≥n realizada</span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let listeners = [];

        // --- GLOBAL STATE ---
        window.appData = {
            transactions: [],
            fixed: [],
            settings: { frequency: 'biweekly', payday: null, payday1: null, payday2: null }
        };

        // --- IMPORT/EXPORT LOGIC ---
        window.exportData = function() {
            if(!window.appData || !currentUser) return;
            
            const data = {
                transactions: window.appData.transactions,
                fixed: window.appData.fixed,
                settings: window.appData.settings,
                meta: { 
                    version: '3.1', 
                    exportedAt: new Date().toISOString(), 
                    user: currentUser.uid 
                }
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const fileName = `finanzas_backup_${new Date().toISOString().slice(0,10)}.json`;
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showToast('Copia de seguridad descargada');
        };

        window.importData = async function(input) {
            const file = input.files[0];
            if(!file || !currentUser) return;

            if(!confirm("‚ö†Ô∏è Importar datos mezclar√° la informaci√≥n del archivo con tus datos actuales. Si existen duplicados, se actualizar√°n. ¬øDeseas continuar?")) {
                input.value = ''; // Reset
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Basic validation
                    if(!json.transactions && !json.fixed) throw new Error("Formato de archivo inv√°lido");

                    showToast("Procesando importaci√≥n...");

                    const batchPromises = [];

                    // Process Transactions
                    if(json.transactions && Array.isArray(json.transactions)) {
                        json.transactions.forEach(t => {
                            const { id, ...data } = t;
                            const docId = id || Date.now().toString() + Math.random().toString(36).substr(2, 9); 
                            batchPromises.push(
                                setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', docId), data, { merge: true })
                            );
                        });
                    }

                    // Process Fixed Payments
                    if(json.fixed && Array.isArray(json.fixed)) {
                        json.fixed.forEach(f => {
                            const { id, ...data } = f;
                            const docId = id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
                            batchPromises.push(
                                setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', docId), data, { merge: true })
                            );
                        });
                    }

                    // Process Settings
                    if(json.settings) {
                        batchPromises.push(
                            setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), json.settings, { merge: true })
                        );
                    }

                    await Promise.all(batchPromises);

                    showToast("Importaci√≥n exitosa ‚úÖ");
                    
                } catch(err) {
                    console.error(err);
                    showToast("Error al importar: Archivo corrupto o inv√°lido");
                } finally {
                    input.value = ''; // Reset input
                }
            };
            reader.readAsText(file);
        };

        // --- AUTH LOGIC (INTEGRATED) ---
        
        // Element Helpers
        const getElement = (id) => document.getElementById(id);
        const setText = (id, text) => { const el = getElement(id); if (el) el.textContent = text; };

        // Expose Auth functions to Window for HTML buttons
        window.authApp = {
            isRegistering: false,

            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                const nameField = getElement('field-name');
                const errorMsg = getElement('auth-error-msg');
                const btnLogin = getElement('tab-login');
                const btnReg = getElement('tab-register');

                setText('btn-text', this.isRegistering ? "CREAR CUENTA" : "INICIAR SESI√ìN");
                
                if (this.isRegistering) {
                    nameField.classList.remove('hidden');
                    btnReg.className = "flex-1 py-2.5 text-sm font-bold rounded-lg shadow-sm bg-white text-gray-900 transition-all";
                    btnLogin.className = "flex-1 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";
                } else {
                    nameField.classList.add('hidden');
                    btnLogin.className = "flex-1 py-2.5 text-sm font-bold rounded-lg shadow-sm bg-white text-gray-900 transition-all";
                    btnReg.className = "flex-1 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";
                }
                
                if(errorMsg) errorMsg.classList.add('hidden');
            },

            async handleAuthSubmit() {
                const btn = getElement('btn-submit');
                const id = getElement('input-id').value.trim();
                const pass = getElement('input-pass').value;
                const name = getElement('input-name').value.trim();
                const errMsg = getElement('auth-error-msg');

                if (!id || !pass) return this.showAuthError("Completa todos los campos");
                if (this.isRegistering && !name) return this.showAuthError("El nombre es obligatorio");
                
                const finalId = id.includes('@') ? id : `${id}@godsplan.site`;

                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> PROCESANDO...';
                if(errMsg) errMsg.classList.add('hidden');

                try {
                    if (this.isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, finalId, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalId, pass);
                    }
                } catch (error) {
                    console.error(error);
                    this.showAuthError(this.mapAuthError(error.code));
                    btn.disabled = false; 
                    btn.innerHTML = this.isRegistering ? '<span id="btn-text">CREAR CUENTA</span><i class="ph-bold ph-arrow-right"></i>' : '<span id="btn-text">INICIAR SESI√ìN</span><i class="ph-bold ph-arrow-right"></i>'; 
                }
            },

            logout() {
                if(confirm('¬øSeguro que deseas salir?')) {
                    signOut(auth);
                }
            },

            showAuthError(msg) {
                setText('auth-error-txt', msg);
                getElement('auth-error-msg').classList.remove('hidden');
                const btn = getElement('btn-submit');
                btn.disabled = false;
                btn.innerHTML = this.isRegistering ? '<span id="btn-text">CREAR CUENTA</span><i class="ph-bold ph-arrow-right"></i>' : '<span id="btn-text">INICIAR SESI√ìN</span><i class="ph-bold ph-arrow-right"></i>'; 
            },
            
            mapAuthError(code) {
                const errs = { 
                    'auth/email-already-in-use': "ID ya registrado.", 
                    'auth/invalid-email': "ID inv√°lido.", 
                    'auth/user-not-found': "Usuario no encontrado.", 
                    'auth/wrong-password': "Contrase√±a incorrecta.",
                    'auth/weak-password': "Contrase√±a d√©bil (min 6 chars).",
                    'auth/invalid-credential': "Credenciales incorrectas."
                };
                return errs[code] || "Error: " + code.split('/')[1];
            }
        };

        // --- AUTH LISTENER & INIT ---
        
        async function initAuth() {
            // Check for system token first (auto-login environment)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) { 
                    console.error("Custom token error", error); 
                    // Do NOT sign in anonymously fallback here, let user see login screen
                }
            }
            // If no token, we wait for user interaction in the Login View
        }

        onAuthStateChanged(auth, async (user) => {
            const loginView = document.getElementById('login-view');
            const mainApp = document.getElementById('main-container');
            const bottomNav = document.getElementById('bottom-nav');
            const loading = document.getElementById('loading-screen');

            if (user) {
                currentUser = user;
                // Transition to App
                loginView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                
                // Update User Profile in Settings
                setText('user-display-name', user.displayName || 'Usuario');
                setText('user-display-email', user.email);

                showApp(); // Init Data Listeners
            } else {
                currentUser = null;
                // Transition to Login
                mainApp.classList.add('hidden');
                bottomNav.classList.add('hidden');
                loginView.classList.remove('hidden');
                
                // Hide global loader if present
                loading.classList.add('hidden');
                
                // Reset Login UI
                const btn = getElement('btn-submit');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span id="btn-text">INICIAR SESI√ìN</span><i class="ph-bold ph-arrow-right"></i>';
                }
            }
        });

        function showApp() {
             const loadingScreen = document.getElementById('loading-screen');
             
             // Ocultar loading y mostrar app
             loadingScreen.classList.add('opacity-0', 'pointer-events-none');
             setTimeout(() => loadingScreen.classList.add('hidden'), 500);
             
             setupRealtimeListeners(currentUser.uid);
             renderDashboard();
        }

        // --- FIRESTORE LISTENERS ---
        function setupRealtimeListeners(userId) {
            listeners.forEach(unsub => unsub());
            listeners = [];

            const txQuery = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            const unsubTx = onSnapshot(txQuery, (snapshot) => {
                window.appData.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                renderHistory();
            });
            listeners.push(unsubTx);

            const fixedQuery = collection(db, 'artifacts', appId, 'users', userId, 'fixed');
            const unsubFixed = onSnapshot(fixedQuery, (snapshot) => {
                window.appData.fixed = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFixed();
            });
            listeners.push(unsubFixed);

            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config');
            const unsubSettings = onSnapshot(settingsDoc, (snapshot) => {
                if (snapshot.exists()) {
                    window.appData.settings = { ...window.appData.settings, ...snapshot.data() };
                }
                setupSettingsUI(); 
                renderDashboard(); 
            });
            listeners.push(unsubSettings);
        }

        // --- DATA HELPERS ---
        window.addTransaction = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            const form = document.getElementById('transaction-form');
            const type = form.querySelector('input[name="type"]:checked').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const title = document.getElementById('t-title').value;
            const category = document.getElementById('t-category').value;
            const dateStr = document.getElementById('t-date').value;
            const newTx = { type, amount, title, category, date: dateStr, createdAt: new Date().toISOString() };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), newTx);
                form.reset();
                document.getElementById('t-date').valueAsDate = new Date();
                document.getElementById('radio-expense').checked = true;
                const txDate = new Date(dateStr + 'T00:00:00');
                window.currentViewDate = new Date(txDate.getFullYear(), txDate.getMonth(), 1);
                updateHeaderDate();
                closeModal('transaction-modal');
                showToast('Movimiento guardado');
            } catch(err) { console.error(err); showToast("Error al guardar"); }
        };

        window.deleteTransaction = async function(id) {
            if(confirm('¬øEliminar este movimiento?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id));
                    showToast("Eliminado");
                } catch(err) { showToast("Error al eliminar"); }
            }
        };

        window.addFixed = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            const title = document.getElementById('f-title').value;
            const amount = parseFloat(document.getElementById('f-amount').value);
            const day = document.getElementById('f-day').value;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), { title, amount, day });
                document.getElementById('fixed-form').reset();
                closeModal('fixed-modal');
                showToast('Pago fijo agregado');
            } catch(err) { showToast("Error al guardar"); }
        };

        window.deleteFixed = async function(id) {
            if(confirm('¬øDejar de rastrear este pago fijo?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id));
                    showToast("Eliminado");
                } catch(err) { showToast("Error"); }
            }
        };

        window.payFixed = function(id) {
            const item = window.appData.fixed.find(f => f.id === id);
            if (!item) return;
            openModal('transaction-modal');
            document.getElementById('t-title').value = item.title;
            document.getElementById('t-amount').value = item.amount;
            document.getElementById('radio-expense').checked = true;
            document.getElementById('t-category').value = "Servicios"; 
            document.getElementById('t-date').valueAsDate = new Date();
            showToast('Confirma el pago');
        };

        window.saveSettings = async function() {
            if (!currentUser) return;
            const freq = document.querySelector('input[name="pay-freq"]:checked').value;
            const newSettings = {
                frequency: freq,
                payday: document.getElementById('payday-select').value || null,
                payday1: document.getElementById('payday-1-select').value || null,
                payday2: document.getElementById('payday-2-select').value || null
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), newSettings, { merge: true });
                showToast('Configuraci√≥n guardada');
            } catch(err) { showToast("Error al guardar"); }
        };

        window.resetApp = async function() {
            if(confirm('‚ö†Ô∏è ¬øBorrar TODOS tus datos? Se perder√° todo el historial.')) {
                const txs = window.appData.transactions;
                const fixs = window.appData.fixed;
                txs.forEach(t => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', t.id)));
                fixs.forEach(f => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', f.id)));
                showToast("Datos eliminados");
            }
        };

        initAuth();
    </script>

    <!-- Standard UI Scripts -->
    <script>
        let currentViewDate = new Date();
        let balanceMode = 'month'; 
        let chartType = 'balance';
        let financeChart = null;
        const COMMON_HOLIDAYS = ['01-01', '01-05', '16-09', '20-11', '25-12'];

        document.addEventListener('DOMContentLoaded', () => {
            initDate();
            initSelects();
        });

        function initDate() {
            const dateInput = document.getElementById('t-date');
            if(dateInput) dateInput.valueAsDate = new Date();
            updateHeaderDate();
        }

        function updateHeaderDate() {
            const options = { year: 'numeric', month: 'long' };
            let dateStr = currentViewDate.toLocaleDateString('es-ES', options);
            dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            const el = document.getElementById('current-date');
            if(el) el.textContent = dateStr;
        }

        function changeMonth(offset) {
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            updateHeaderDate();
            if(balanceMode === 'total') setBalanceMode('month');
            else renderDashboard();
        }

        function goToCurrentMonth() {
            currentViewDate = new Date();
            updateHeaderDate();
            if(balanceMode === 'total') setBalanceMode('month');
            else renderDashboard();
        }

        function initSelects() {
            const selects = [
                document.getElementById('f-day'), 
                document.getElementById('payday-select'),
                document.getElementById('payday-1-select'),
                document.getElementById('payday-2-select')
            ];
            selects.forEach(sel => {
                if(!sel) return;
                sel.innerHTML = '<option value="">D√≠a</option>'; 
                for(let i=1; i<=31; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    sel.appendChild(opt);
                }
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-blue-600');
                el.classList.add('text-gray-400');
                // Icons update
                const icon = el.querySelector('i');
                if(icon.classList.contains('ph-fill')) {
                    icon.classList.remove('ph-fill');
                    icon.classList.add('ph');
                }
            });
            const activeBtn = document.getElementById(`nav-${tabId}`);
            if(activeBtn) {
                activeBtn.classList.add('active', 'text-blue-600');
                activeBtn.classList.remove('text-gray-400');
                const icon = activeBtn.querySelector('i');
                icon.classList.remove('ph');
                icon.classList.add('ph-fill');
            }
            if(tabId === 'dashboard') renderDashboard();
            if(tabId === 'history') renderHistory();
            if(tabId === 'fixed') renderFixed();
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            const content = modal.querySelector('div[id$="-content"]');
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const content = modal.querySelector('div[id$="-content"]');
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function showToast(message) {
            const t = document.getElementById('toast');
            const m = document.getElementById('toast-msg');
            m.textContent = message;
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        function setBalanceMode(mode) {
            balanceMode = mode;
            renderDashboard();
        }

        function setChartType(type) {
            chartType = type;
            renderDashboard();
        }

        function renderDashboard() {
            if (!window.appData || !window.appData.transactions) return;
            const viewMonth = currentViewDate.getMonth();
            const viewYear = currentViewDate.getFullYear();
            let monthIncome = 0; let monthExpense = 0; let categoryExpenses = {};
            const monthlyTx = window.appData.transactions.filter(t => {
                const d = new Date(t.date + 'T00:00:00');
                return d.getMonth() === viewMonth && d.getFullYear() === viewYear;
            });
            monthlyTx.forEach(t => {
                if(t.type === 'income') monthIncome += t.amount; 
                else {
                    monthExpense += t.amount;
                    if(!categoryExpenses[t.category]) categoryExpenses[t.category] = 0;
                    categoryExpenses[t.category] += t.amount;
                }
            });
            let totalIncome = 0; let totalExpense = 0;
            window.appData.transactions.forEach(t => {
                if(t.type === 'income') totalIncome += t.amount; else totalExpense += t.amount;
            });
            const displayBalance = balanceMode === 'month' ? (monthIncome - monthExpense) : (totalIncome - totalExpense);
            const displayIncome = balanceMode === 'month' ? monthIncome : totalIncome;
            const displayExpense = balanceMode === 'month' ? monthExpense : totalExpense;

            const labelEl = document.getElementById('balance-label');
            if(labelEl) {
                if (balanceMode === 'month') {
                    labelEl.textContent = "Saldo de " + currentViewDate.toLocaleDateString('es-ES', { month: 'long' });
                    toggleBtnStyles('btn-mode-month', 'btn-mode-total');
                } else {
                    labelEl.textContent = "Saldo Hist√≥rico Total";
                    toggleBtnStyles('btn-mode-total', 'btn-mode-month');
                }
            }
            document.getElementById('total-balance').textContent = formatCurrency(displayBalance);
            document.getElementById('total-income').textContent = formatCurrency(displayIncome);
            document.getElementById('total-expense').textContent = formatCurrency(displayExpense);

            updatePaydayWidget();

            const recentList = document.getElementById('recent-list');
            if(recentList) {
                recentList.innerHTML = '';
                let listTx = balanceMode === 'month' ? monthlyTx : [...window.appData.transactions];
                listTx.sort((a,b) => new Date(b.date) - new Date(a.date));
                if(listTx.length === 0) recentList.innerHTML = '<div class="text-center p-8 bg-gray-50 rounded-xl border border-dashed border-gray-200"><p class="text-sm text-gray-400">No hay movimientos a√∫n.</p></div>';
                else listTx.slice(0, 5).forEach(t => recentList.innerHTML += createTransactionHTML(t));
            }

            if (chartType === 'balance') {
                toggleBtnStyles('btn-chart-balance', 'btn-chart-categories');
                const title = document.getElementById('chart-title'); if(title) title.textContent = "Balance General";
                updateChart(displayIncome, displayExpense);
            } else {
                toggleBtnStyles('btn-chart-categories', 'btn-chart-balance');
                const title = document.getElementById('chart-title'); if(title) title.textContent = "Gastos por Categor√≠a";
                let targetCats = categoryExpenses;
                if(balanceMode === 'total') {
                    targetCats = {};
                    window.appData.transactions.forEach(t => {
                        if(t.type === 'expense') {
                             if(!targetCats[t.category]) targetCats[t.category] = 0;
                            targetCats[t.category] += t.amount;
                        }
                    });
                }
                updateCategoryChart(targetCats);
            }
            updateSmartInsight(categoryExpenses, monthIncome, monthExpense);
            updateFormulaCard(viewMonth, viewYear, monthIncome, monthExpense);
        }

        function toggleBtnStyles(activeId, inactiveId) {
            const active = document.getElementById(activeId);
            const inactive = document.getElementById(inactiveId);
            if(!active || !inactive) return;
            // Reset base
            active.className = "toggle-btn px-3 py-1 rounded-md text-[10px] font-bold shadow-sm";
            inactive.className = "toggle-btn px-3 py-1 rounded-md text-[10px] font-medium";

            if(activeId.includes('mode')) {
                active.classList.add('bg-white', 'text-blue-900');
                inactive.classList.add('text-blue-100', 'hover:bg-white/10');
            } else {
                active.classList.add('bg-white', 'text-gray-800', 'border', 'border-gray-100');
                inactive.classList.add('text-gray-500', 'hover:bg-gray-200');
            }
        }

        function createTransactionHTML(t) {
            const isIncome = t.type === 'income';
            const colorClass = isIncome ? 'text-emerald-600' : 'text-gray-900';
            const iconBg = isIncome ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-500';
            const icon = isIncome ? 'ph-arrow-down-left' : 'ph-shopping-cart';
            const sign = isIncome ? '+' : '-';
            return `
                <div class="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="${iconBg} p-2.5 rounded-xl text-lg">
                            <i class="ph-bold ${icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-gray-900">${t.title}</p>
                            <p class="text-xs text-gray-500 font-medium">${t.category}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm ${colorClass}">${sign}${formatCurrency(t.amount)}</p>
                        <button onclick="deleteTransaction('${t.id}')" class="text-[10px] font-medium text-red-300 hover:text-red-500 mt-0.5 transition-colors">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function renderHistory() {
            if(!window.appData) return;
            const activeBtn = document.querySelector('.filter-btn.active');
            const activeFilter = activeBtn ? activeBtn.dataset.filter : 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === activeFilter) {
                    btn.classList.add('active', 'bg-blue-600', 'text-white', 'border-transparent', 'shadow-sm', 'shadow-blue-200');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
                } else {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white', 'border-transparent', 'shadow-sm', 'shadow-blue-200');
                    btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
                }
            });
            const list = document.getElementById('full-history-list');
            if(!list) return;
            list.innerHTML = '';
            const filtered = window.appData.transactions.filter(t => {
                if(activeFilter === 'all') return true;
                return t.type === activeFilter;
            });
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center p-10 bg-gray-50 rounded-xl border border-dashed border-gray-200"><p class="text-sm text-gray-400">No se encontraron movimientos.</p></div>';
                return;
            }
            const grouped = {};
            filtered.forEach(t => {
                if(!grouped[t.date]) grouped[t.date] = [];
                grouped[t.date].push(t);
            });
            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            sortedDates.forEach(date => {
                const dateHeader = document.createElement('div');
                const fancyDate = new Date(date + 'T00:00:00').toLocaleDateString('es-ES', {weekday:'short', day:'numeric', month:'long'});
                dateHeader.className = "text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-6 mb-2 ml-1";
                dateHeader.textContent = fancyDate;
                list.appendChild(dateHeader);
                grouped[date].forEach(t => {
                    const div = document.createElement('div');
                    div.innerHTML = createTransactionHTML(t);
                    list.appendChild(div.firstElementChild);
                });
            });
        }

        function renderFixed() {
            if(!window.appData) return;
            const list = document.getElementById('fixed-list');
            if(!list) return;
            list.innerHTML = '';
            if(window.appData.fixed.length === 0) {
                list.innerHTML = '<div class="text-center p-10 bg-gray-50 rounded-xl border border-dashed border-gray-200"><p class="text-sm text-gray-400">No hay pagos fijos configurados.</p></div>';
                return;
            }
            window.appData.fixed.forEach(f => {
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-50 text-gray-500 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors p-2.5 rounded-xl text-xl">
                                <i class="ph-bold ph-receipt"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-900">${f.title}</p>
                                <p class="text-xs text-gray-500 font-medium">D√≠a ${f.day} de cada mes</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-right">
                             <div class="mr-2 text-right">
                                <p class="font-bold text-sm text-gray-900">${formatCurrency(f.amount)}</p>
                            </div>
                            <button onclick="payFixed('${f.id}')" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-600 hover:text-white active:scale-95 transition" title="Registrar pago">
                                <i class="ph-bold ph-check"></i>
                            </button>
                            <button onclick="deleteFixed('${f.id}')" class="bg-gray-50 text-gray-400 p-2 rounded-lg hover:bg-red-50 hover:text-red-500 transition" title="Eliminar">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function setupSettingsUI() {
            if(!window.appData.settings) return;
            const s = window.appData.settings;
            const radios = document.getElementsByName('pay-freq');
            for(let r of radios) { if(r.value === s.frequency) r.checked = true; }
            const selPayday = document.getElementById('payday-select'); if(selPayday && s.payday) selPayday.value = s.payday;
            const selP1 = document.getElementById('payday-1-select'); if(selP1 && s.payday1) selP1.value = s.payday1;
            const selP2 = document.getElementById('payday-2-select'); if(selP2 && s.payday2) selP2.value = s.payday2;
            togglePaydayInput();
        }

        function togglePaydayInput() {
            const freq = document.querySelector('input[name="pay-freq"]:checked')?.value || 'biweekly';
            const mCont = document.getElementById('monthly-select-container'); if(mCont) mCont.classList.add('hidden');
            const bCont = document.getElementById('biweekly-custom-container'); if(bCont) bCont.classList.add('hidden');
            if (freq === 'monthly' && mCont) mCont.classList.remove('hidden');
            else if (freq === 'biweekly-custom' && bCont) bCont.classList.remove('hidden');
        }

        function updateChart(income, expense) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (financeChart) financeChart.destroy();
            let data = [income, expense];
            let colors = ['#10b981', '#ef4444'];
            if(income === 0 && expense === 0) { data = [1]; colors = ['#f3f4f6']; }
            financeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10, family: 'Inter' }, padding: 20 } }, tooltip: { enabled: (income > 0 || expense > 0) } },
                    cutout: '75%',
                }
            });
        }

        function updateCategoryChart(categories) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (financeChart) financeChart.destroy();
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const combined = labels.map((label, i) => ({ label, data: data[i] })).sort((a,b) => b.data - a.data);
            const sortedLabels = combined.map(c => c.label);
            const sortedData = combined.map(c => c.data);
            if(sortedData.length === 0) {
                 financeChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Sin datos'], datasets: [{ label: 'Gastos', data: [0], backgroundColor: '#e5e7eb', borderRadius: 5 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
                });
                return;
            }
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{ label: 'Gastos', data: sortedData, backgroundColor: '#3b82f6', borderRadius: 6, barThickness: 20 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.raw) } } },
                    scales: { x: { display: false, grid: { display: false } }, y: { grid: { display: false }, ticks: { font: { size: 10, family: 'Inter' }, color: '#6b7280' } } }
                }
            });
        }

        function updateSmartInsight(categories, income, expense) {
            const insightBox = document.getElementById('chart-insight');
            const insightText = document.getElementById('chart-insight-text');
            if(!insightBox || !insightText) return;
            if (balanceMode === 'month') {
                if (expense > income && income > 0) {
                    insightBox.classList.remove('hidden');
                    insightBox.className = "mt-4 p-3 bg-red-50 rounded-lg text-xs text-red-800 flex items-start gap-2 border border-red-100";
                    insightBox.querySelector('i').className = "ph-fill ph-warning-circle text-base flex-shrink-0 text-red-500";
                    insightText.innerHTML = `<strong>¬°Cuidado!</strong> Est√°s gastando m√°s de lo que ingresas este mes.`;
                    return;
                }
                let topCat = ''; let topAmount = 0;
                for (const [cat, amount] of Object.entries(categories)) {
                    if (amount > topAmount) { topAmount = amount; topCat = cat; }
                }
                if (topCat) {
                    insightBox.classList.remove('hidden');
                    insightBox.className = "mt-4 p-3 bg-blue-50/50 rounded-lg text-xs text-blue-800 flex items-start gap-2 border border-blue-100";
                    insightBox.querySelector('i').className = "ph-fill ph-lightbulb text-base flex-shrink-0 text-amber-500";
                    insightText.innerHTML = `<strong>Dato:</strong> Tu mayor gasto es en <strong>${topCat}</strong> (${formatCurrency(topAmount)}).`;
                } else {
                    insightBox.classList.add('hidden');
                }
            } else {
                 insightBox.classList.add('hidden');
            }
        }

        function updateFormulaCard(viewMonth, viewYear, currentMonthIncome, currentMonthExpense) {
            let prevIncome = 0; let prevExpense = 0;
            const startOfMonth = new Date(viewYear, viewMonth, 1);
            window.appData.transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                if (tDate < startOfMonth) {
                    if (t.type === 'income') prevIncome += t.amount; else prevExpense += t.amount;
                }
            });
            const prevBalance = prevIncome - prevExpense;
            const formulaTotal = prevBalance + currentMonthIncome - currentMonthExpense;
            const prevEl = document.getElementById('formula-prev');
            if(prevEl) {
                prevEl.textContent = formatCurrency(prevBalance);
                prevEl.className = prevBalance >= 0 ? "font-mono font-medium text-gray-700" : "font-mono font-medium text-red-500";
            }
            const elInc = document.getElementById('formula-income'); if(elInc) elInc.textContent = formatCurrency(currentMonthIncome);
            const elExp = document.getElementById('formula-expense'); if(elExp) elExp.textContent = formatCurrency(currentMonthExpense);
            const elTot = document.getElementById('formula-total'); if(elTot) elTot.textContent = formatCurrency(formulaTotal);
        }

        function updatePaydayWidget() {
            if(!window.appData.settings) return;
            const widget = document.getElementById('payday-countdown');
            const detail = document.getElementById('payday-detail');
            if(!widget || !detail) return;
            const freq = window.appData.settings.frequency;
            let configured = true;
            if (freq === 'monthly' && !window.appData.settings.payday) configured = false;
            const nextDate = getNextPayday();
            if (!configured || !nextDate) {
                widget.textContent = "Configura tu fecha en Ajustes";
                detail.textContent = "";
                return;
            }
            const today = new Date(); today.setHours(0,0,0,0);
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays === 0) widget.textContent = "¬°Hoy es d√≠a de pago! üéâ";
            else if (diffDays === 1) widget.textContent = "¬°Ma√±ana pagan!";
            else widget.textContent = `Faltan ${diffDays} d√≠as`;
            const options = { weekday: 'long', day: 'numeric', month: 'short' };
            detail.textContent = `Pr√≥ximo: ${nextDate.toLocaleDateString('es-ES', options)}`;
        }

        function getNextPayday() {
            const today = new Date(); today.setHours(0,0,0,0);
            let candidates = [];
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const freq = window.appData.settings.frequency;
            const s = window.appData.settings;
            if (freq === 'biweekly') {
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    candidates.push(new Date(year, monthIndex, 15));
                    candidates.push(new Date(year, monthIndex + 1, 0));
                }
            } else if (freq === 'biweekly-custom' && s.payday1 && s.payday2) {
                const p1 = parseInt(s.payday1); const p2 = parseInt(s.payday2);
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    const maxDay = new Date(year, monthIndex + 1, 0).getDate();
                    candidates.push(new Date(year, monthIndex, Math.min(p1, maxDay)));
                    candidates.push(new Date(year, monthIndex, Math.min(p2, maxDay)));
                }
            } else if (freq === 'monthly' && s.payday) {
                const day = parseInt(s.payday);
                for(let m = 0; m <= 1; m++) {
                    let monthIndex = currentMonth + m; let year = currentYear;
                    if(monthIndex > 11) { monthIndex = 0; year++; }
                    let maxDay = new Date(year, monthIndex + 1, 0).getDate();
                    candidates.push(new Date(year, monthIndex, Math.min(day, maxDay)));
                }
            }
            let adjustedCandidates = candidates.map(d => getNextBusinessDay(d));
            adjustedCandidates.sort((a,b) => a - b);
            for (let d of adjustedCandidates) {
                d.setHours(0,0,0,0);
                if (d >= today) return d;
            }
            return adjustedCandidates[0]; 
        }

        function getNextBusinessDay(date) {
            let d = new Date(date);
            let dayOfWeek = d.getDay();
            const isHoliday = (date) => {
                const dd = date.getDate().toString().padStart(2, '0');
                const mm = (date.getMonth() + 1).toString().padStart(2, '0');
                return COMMON_HOLIDAYS.includes(`${dd}-${mm}`);
            }
            while (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday(d)) {
                d.setDate(d.getDate() + 1);
                dayOfWeek = d.getDay();
            }
            return d;
        }

        function filterHistory(filterType) {
            document.querySelectorAll('.filter-btn.active').forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white', 'border-transparent', 'shadow-sm', 'shadow-blue-200'));
            document.querySelectorAll('.filter-btn.active').forEach(btn => btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200'));
            
            document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(btn => btn.classList.add('active'));
            renderHistory();
        }
    </script>
</body>
</html>
