<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>God's Plan | Ultimate</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE MODULAR -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, 
            getFirestore, doc, onSnapshot, collection, query, orderBy, 
            limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc, serverTimestamp
        };
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    screens: { 'xs': '375px', 'md': '768px', 'lg': '1024px' },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-red': 'pulseRed 2s infinite',
                        'pulse-green': 'pulseGreen 2s infinite'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        pulseRed: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.5' } },
                        pulseGreen: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(16, 185, 129, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(16, 185, 129, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(16, 185, 129, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS GLOBALES */
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            --nav-height: 65px;
        }
        body { 
            background-color: #050505; 
            color: #e5e5e5; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            height: 100vh;
            height: 100dvh; 
        }
        
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-highlight { background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.08); }
        .glass-nav { 
            background: rgba(5, 5, 5, 0.95); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-bottom: var(--sab);
        }

        /* Nav Global Links CSS */
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { 
            font-size: 10px; font-weight: 800; letter-spacing: 0.05em; color: #71717a; 
            transition: color 0.2s; text-decoration: none; white-space: nowrap; 
        }
        .g-link:hover, .g-link.active { color: white; }

        /* Inputs Modernos */
        .input-modern {
            background: #09090b; border: 1px solid #27272a; color: white; border-radius: 16px;
            transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            font-size: 16px !important; 
        }
        .input-modern:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); outline: none; background: #18181b; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        
        /* Chips */
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border-color: #ef4444; }

        /* Toast */
        #toast-container { position: fixed; top: calc(20px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; animation: fadeIn 0.3s forwards; pointer-events: auto; }
        
        /* Modales */
        #modalOverlay {
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 1100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex; align-items: flex-end; justify-content: center;
        }
        #modalOverlay.is-open { opacity: 1; pointer-events: auto; }
        #modalSheet {
            background: #121212; width: 100%; max-height: 90vh;
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            border-top: 1px solid #27272a; padding: 24px;
            overflow-y: auto; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            padding-bottom: calc(40px + var(--sab));
        }
        #modalOverlay.is-open #modalSheet { transform: translateY(0); }

        @media (min-width: 768px) {
            #modalOverlay { align-items: center; padding: 20px; }
            #modalSheet { width: 100%; max-width: 480px; border-radius: 24px; max-height: 85vh; transform: scale(0.95); opacity: 0; transition: all 0.2s ease-out; }
            #modalOverlay.is-open #modalSheet { transform: scale(1); opacity: 1; }
        }

        /* Utilities */
        .chart-container { position: relative; width: 100%; height: 200px; }
        .nav-link-desk { color: #71717a; padding: 6px 16px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; transition: all 0.2s; }
        .nav-link-desk:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-link-desk.active { color: white; background: #27272a; }
        .custom-dialog { background-color: #121212; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 340px; width: 90%; }
        
        /* Ticket Style for Reports */
        .ticket-edge { 
            position: absolute; bottom: -6px; left: 0; width: 100%; height: 12px; 
            background-image: radial-gradient(circle, transparent 70%, #18181b 70%);
            background-size: 20px 20px; background-position: top center; background-repeat: repeat-x; transform: rotate(180deg);
        }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm sm:text-base bg-[#050505] text-[#e5e5e5]">

    <!-- NAV SUPERIOR (Global - RESTAURADA) -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="flex items-center gap-2 text-white font-black text-lg tracking-tight decoration-none"><i class="ph-bold ph-circles-three-plus text-red-500 text-lg"></i> God's Plan</a>
        <div class="g-links no-scrollbar hidden md:flex">
            <a href="/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/chat.html" class="g-link">CHAT</a>
            <a href="#" class="g-link active">FINANZAS</a>
            <a href="/cuenta.html" class="g-link">CUENTA</a>
        </div>
        <div class="flex items-center gap-3">
             <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-zinc-800 transition-colors duration-500" title="Estado"></div>
             <!-- Mobile Menu Icon (Solo decorativo en esta demo) -->
             <i class="ph-bold ph-list text-zinc-500 md:hidden"></i>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="app-content" class="flex-1 overflow-y-auto pb-36 relative scroll-smooth overflow-x-hidden md:px-6">
        
        <div class="w-full max-w-lg md:max-w-6xl mx-auto h-full pt-4 md:pt-8">

             <!-- ALERTA DE CIERRE INTELIGENTE (NUEVO) -->
            <div id="closureAlert" class="hidden mx-4 md:mx-0 mb-6 bg-gradient-to-r from-amber-900/40 to-amber-800/20 border border-amber-700/50 rounded-2xl p-4 flex items-center justify-between animate-fade-in">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-500 animate-pulse-slow">
                        <i class="ph-fill ph-warning-circle text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-amber-200 text-sm">Ciclo Finalizado</h4>
                        <p class="text-[10px] text-amber-400/80">Cierra tu mes/quincena para guardar el reporte.</p>
                    </div>
                </div>
                <button onclick="app.openClosureModal()" class="bg-amber-500 hover:bg-amber-400 text-black font-bold text-xs px-4 py-2 rounded-lg transition-colors shadow-lg shadow-amber-900/20">
                    Cerrar
                </button>
            </div>

            <!-- SUB-NAV DESKTOP -->
            <div class="hidden md:flex justify-center mb-8 fade-in">
                <div class="bg-zinc-900/80 border border-white/10 p-1.5 rounded-full flex items-center gap-1 shadow-lg backdrop-blur-sm">
                    <button onclick="app.switchView('balance')" class="nav-link-desk active px-5" data-view="balance">Billetera</button>
                    <button onclick="app.switchView('analysis')" class="nav-link-desk px-5" data-view="analysis">Análisis</button>
                    <button onclick="app.switchView('simulation')" class="nav-link-desk px-5" data-view="simulation">Simulación</button>
                    <button onclick="app.switchView('history')" class="nav-link-desk px-5" data-view="history">Historial</button>
                    <button onclick="app.switchView('plan')" class="nav-link-desk px-5" data-view="plan">Planificación</button>
                </div>
            </div>

            <!-- VISTA: BILLETERA -->
            <section id="view-balance" class="p-4 sm:p-0 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-12 md:gap-8 items-start">
                    
                    <!-- Columna Izquierda -->
                    <div class="md:col-span-5 lg:col-span-4 md:sticky md:top-4">
                        <!-- Header Periodo -->
                        <div class="flex justify-between items-end mb-4 px-1">
                            <div onclick="app.openModal('config')" class="cursor-pointer group py-2">
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1 group-hover:text-red-500 transition-colors">CICLO ACTUAL <i class="ph-bold ph-gear inline align-middle ml-1"></i></p>
                                <h2 class="text-base font-bold text-white flex items-center gap-2" id="periodDates">Cargando...</h2>
                            </div>
                            <div id="daysLeftBadge" class="text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(239,68,68,0.1)]">
                                -- Días
                            </div>
                        </div>

                        <!-- TARJETA PRINCIPAL -->
                        <div id="mainCard" class="glass rounded-[2rem] p-6 relative overflow-hidden group mb-6 transition-all active:scale-[0.98] md:hover:scale-[1.01] md:active:scale-100 shadow-2xl shadow-black/50">
                            <div id="mainCardBg" class="absolute -top-10 -right-10 w-32 h-32 bg-red-600/20 rounded-full blur-3xl transition-colors duration-500"></div>
                            
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <span id="labelDailyState" class="text-xs font-bold text-zinc-400 uppercase tracking-widest transition-colors">Disponible Hoy</span>
                                    <button onclick="app.togglePrivacy()" class="text-zinc-600 hover:text-white transition-colors p-2 -mr-2 -mt-2"><i id="eyeIcon" class="ph ph-eye text-lg"></i></button>
                                </div>
                                <div class="text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black text-white tracking-tighter mb-2 break-all relative leading-none transition-colors" id="dailyFreeContainer">
                                    <span id="dailyFree">---</span>
                                    <div id="dailyFreeBlur" class="hidden absolute inset-0 bg-zinc-900/50 backdrop-blur-md rounded-lg z-20 flex items-center justify-center"><i class="ph-fill ph-lock-key text-zinc-600 text-3xl"></i></div>
                                </div>
                                <div class="flex items-center gap-3 mb-6 font-mono text-xs">
                                    <div class="text-zinc-500">Límite: <span id="valDailyLimit" class="text-zinc-300 font-bold">---</span></div>
                                    <div class="w-1 h-1 bg-zinc-700 rounded-full"></div>
                                    <div class="text-zinc-500">Gastado: <span id="valTodaySpent" class="text-red-400 font-bold">---</span></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                                    <div>
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Restante Total</span>
                                        <span class="text-lg font-bold text-zinc-200" id="totalFree">---</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Gastado</span>
                                        <span class="text-lg font-bold text-red-400" id="cycleSpent">---</span>
                                    </div>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 h-1.5 bg-zinc-800 w-full">
                                <div id="periodProgress" class="h-full bg-gradient-to-r from-red-600 to-orange-600 shadow-[0_0_10px_rgba(239,68,68,0.5)] w-0 transition-all duration-1000 ease-out"></div>
                            </div>
                        </div>

                         <!-- WIDGET HORAS EXTRAS (RESTAURADO) -->
                        <div id="adherenceCard" class="hidden mb-6 relative overflow-hidden rounded-[2rem] border border-emerald-900/30 bg-emerald-950/10 p-5 group transition-all">
                             <div class="absolute top-4 right-4 z-20 flex items-center gap-2">
                                <span class="text-[9px] font-bold text-emerald-500/50 uppercase tracking-widest">Simular</span>
                                <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="simToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-emerald-900/50 transition-all duration-300" onclick="app.toggleSimulation()"/>
                                    <label for="simToggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-emerald-900/30 cursor-pointer"></label>
                                </div>
                             </div>
                             <div class="flex justify-between items-start mb-3 relative z-10">
                                 <div>
                                    <div class="text-[10px] text-emerald-400 font-black uppercase tracking-widest mb-1 flex items-center gap-1"><i class="ph-fill ph-clock-countdown"></i> EXTRA</div>
                                    <div class="relative flex items-center group focus-within:border-emerald-500/50 border-b border-transparent transition-colors mt-1">
                                        <span class="text-emerald-500 text-xl font-bold mr-1">$</span>
                                        <input type="number" id="manualExtraPay" inputmode="decimal" class="bg-transparent text-2xl font-bold text-white w-full focus:outline-none placeholder-emerald-500/30 font-mono" placeholder="0.00" onblur="app.saveExtraPayValue(this.value)">
                                    </div>
                                 </div>
                                 <div class="text-right mt-7">
                                     <div class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-1">COBRO</div>
                                     <input type="date" id="extraPayDateInput" onchange="app.saveExtraPayDate(this.value)" class="bg-emerald-900/30 text-white font-bold text-sm px-2 py-1 rounded-md border border-emerald-500/20 text-center w-28 focus:outline-none focus:border-emerald-500 cursor-pointer">
                                     <div class="text-[10px] text-zinc-500 mt-1" id="daysToTuesday">-- días</div>
                                 </div>
                             </div>
                             <button id="btnImportExtras" onclick="app.importExtraMoney()" class="w-full bg-emerald-600/20 hover:bg-emerald-500 text-emerald-300 hover:text-white py-3 rounded-xl font-bold text-xs uppercase tracking-wider border border-emerald-500/30 transition-all flex items-center justify-center gap-2 relative z-10">
                                 <i class="ph-bold ph-download-simple"></i> Sumar a Billetera
                             </button>
                             <div class="absolute -bottom-6 -right-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition-colors"></div>
                        </div>

                        <!-- ACCIONES RÁPIDAS -->
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button onclick="app.openModal('extra')" class="glass-highlight h-14 rounded-2xl text-emerald-500 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 md:hover:scale-105 hover:bg-emerald-500/10 border-transparent hover:border-emerald-500/30">
                                <i class="ph-bold ph-arrow-down-left text-lg"></i> INGRESO
                            </button>
                            <button onclick="app.switchView('analysis')" class="md:hidden glass-highlight h-14 rounded-2xl text-zinc-400 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 hover:bg-white/5 hover:text-white">
                                <i class="ph-bold ph-chart-line-up text-lg"></i> ANÁLISIS
                            </button>
                            <button onclick="app.openModal('expense')" class="hidden md:flex glass-highlight h-14 rounded-2xl text-white font-bold text-xs items-center justify-center gap-2 transition-all hover:scale-105 hover:bg-red-600 hover:border-red-500 bg-red-600/10 border-red-600/30">
                                <i class="ph-bold ph-minus text-lg"></i> GASTO
                            </button>
                        </div>
                    </div>

                    <!-- Columna Derecha (Lista Transacciones) -->
                    <div class="md:col-span-7 lg:col-span-8">
                         <div class="flex justify-between items-center mb-4 px-1 md:bg-zinc-900/30 md:p-3 md:rounded-xl md:border md:border-white/5">
                            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest hidden md:block">Movimientos Recientes</h3>
                            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest md:hidden">Actividad</h3>
                            <div class="relative w-36 md:w-64">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 text-sm"></i>
                                <input type="text" id="searchTx" placeholder="Buscar..." onkeyup="app.filterTransactions()" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl py-2 pl-9 pr-3 text-sm text-white focus:outline-none focus:border-zinc-600 placeholder-zinc-700">
                            </div>
                        </div>
                        <div id="transactionsList" class="space-y-3 min-h-[100px] pb-24 md:pb-0">
                            <div class="text-center py-10 text-zinc-600 animate-pulse">Sincronizando...</div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- VISTA: ANÁLISIS (Gráficas) -->
            <section id="view-analysis" class="p-4 sm:p-0 hidden fade-in max-w-4xl mx-auto">
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="glass p-5 rounded-2xl">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Promedio Diario</div>
                        <div class="text-xl font-bold text-white" id="statDailyAvg">---</div>
                    </div>
                    <div class="glass p-5 rounded-2xl">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Mayor Categoría</div>
                        <div class="text-xl font-bold text-white truncate" id="statMaxCat">---</div>
                    </div>
                 </div>
                <div id="chartSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="glass rounded-3xl p-5 relative">
                        <h3 class="text-center text-xs font-bold text-zinc-500 mb-4 tracking-widest">TENDENCIA DEL CICLO</h3>
                        <div class="chart-container"><canvas id="trendChart"></canvas></div>
                    </div>
                    <div class="glass rounded-3xl p-5">
                        <h3 class="text-center text-xs font-bold text-zinc-500 mb-4 tracking-widest">DISTRIBUCIÓN</h3>
                        <div class="chart-container"><canvas id="expenseChart"></canvas></div>
                    </div>
                </div>
            </section>

             <!-- VISTA: SIMULACIÓN (RESTAURADA) -->
            <section id="view-simulation" class="p-4 sm:p-0 hidden fade-in max-w-2xl mx-auto pb-24">
                <h2 class="text-2xl font-black text-white mb-1">Simulador Mensual</h2>
                <p class="text-zinc-500 text-xs mb-6">Proyección real (Ingreso - Fijos).</p>

                <!-- RESULTADO PRINCIPAL -->
                <div class="glass-highlight rounded-3xl p-6 text-center mb-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-xs font-bold text-zinc-400 uppercase tracking-widest mb-2">Flujo Libre Mensual</div>
                        <div class="text-5xl font-black text-white tracking-tight" id="simFreeMoney">---</div>
                        <div class="text-xs text-zinc-500 mt-2">Dinero disponible tras pagar TODO</div>
                    </div>
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-indigo-500"></div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 rounded-2xl bg-zinc-900/50 border border-zinc-800">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500"><i class="ph-bold ph-money text-xl"></i></div>
                            <div><div class="text-sm font-bold text-white">Salario Base</div></div>
                        </div>
                        <div class="font-bold text-emerald-400" id="simBaseIncomeVal">---</div>
                    </div>
                    <div class="rounded-2xl bg-zinc-900/50 border border-zinc-800 overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-zinc-800/50 bg-zinc-900/30">
                             <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500"><i class="ph-bold ph-trend-up text-xl"></i></div>
                                <div><div class="text-sm font-bold text-white">Ingresos Adicionales</div></div>
                            </div>
                             <div class="font-bold text-blue-400" id="simTotalExtraVal">---</div>
                        </div>
                        <div id="simExtraList" class="p-2 space-y-1"></div>
                    </div>
                     <div class="flex justify-between items-center px-4 py-3 bg-zinc-800/50 rounded-xl border border-zinc-700/50">
                          <span class="text-xs font-bold text-zinc-300 uppercase tracking-wider">Total Ingresos Reales</span>
                          <span class="text-base font-bold text-white" id="simTotalIncomeSum">---</span>
                     </div>
                     <div class="flex items-center gap-4 py-2"><div class="h-px bg-zinc-800 flex-1"></div><span class="text-[10px] text-zinc-500 font-bold uppercase">Menos Gastos Fijos</span><div class="h-px bg-zinc-800 flex-1"></div></div>
                     <div id="simFixedList" class="space-y-2"></div>
                      <div class="flex justify-between items-center px-4 py-2"><span class="text-xs text-zinc-500">Total Fijos Mensuales</span><span class="text-sm font-bold text-red-400" id="simTotalFixed">---</span></div>
                </div>
            </section>

            <!-- VISTA: HISTORIAL (MEJORADA CON REPORTES) -->
            <section id="view-history" class="p-4 sm:p-0 hidden fade-in max-w-4xl mx-auto">
                 <div class="mb-6 text-center md:text-left">
                    <h2 class="text-2xl font-black text-white mb-1">Historial Inteligente</h2>
                    <p class="text-zinc-500 text-xs">Reportes cerrados y línea de tiempo.</p>
                </div>

                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Ciclos Cerrados (Reportes)</h3>
                <div id="reportsList" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                     <div class="text-center col-span-full py-4 text-zinc-600 italic text-xs">Sin reportes cerrados aún.</div>
                </div>
                
                 <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Línea de Tiempo (Quincenas)</h3>
                <div id="historyList" class="space-y-4 pb-20"></div>
            </section>

            <!-- VISTA: PLAN (CONFIG COMPLETA) -->
            <section id="view-plan" class="p-4 sm:p-0 hidden fade-in max-w-2xl mx-auto">
                <div class="glass-highlight rounded-2xl p-5 mb-6">
                    <div class="flex justify-between items-center text-sm mb-3">
                        <span class="text-zinc-400 text-xs font-bold uppercase">Gastos Fijos</span>
                        <span id="summaryFixed" class="font-bold text-red-400 font-mono text-base">---</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-zinc-400 text-xs font-bold uppercase">Deudas (Ciclo)</span>
                        <span id="summaryShortLoans" class="font-bold text-orange-400 font-mono text-base">---</span>
                    </div>
                </div>

                <!-- Config Inputs -->
                <div class="bg-[#09090b] border border-zinc-800 p-5 rounded-2xl mb-8">
                    <div class="mb-4">
                        <label class="text-emerald-500 text-[10px] font-black uppercase tracking-wider mb-2 block">Ingreso Base</label>
                        <div class="relative flex items-center">
                            <span class="absolute left-0 text-2xl text-zinc-600 font-light pl-2">$</span>
                            <input type="number" id="inpIncome" class="bg-transparent text-3xl font-bold text-white w-full focus:outline-none placeholder-zinc-800 pl-8 h-10" placeholder="0.00" onblur="app.saveConfig()">
                        </div>
                    </div>
                    <div id="divIncomeQ2" class="border-t border-zinc-800 pt-4 mt-4 hidden">
                         <label class="text-emerald-500 text-[10px] font-black uppercase tracking-wider mb-2 block">Ingreso 2da Quincena</label>
                        <input type="number" id="inpIncomeQ2" class="bg-transparent text-2xl font-bold text-white w-full focus:outline-none placeholder-zinc-800" placeholder="Igual al base..." onblur="app.saveConfig()">
                    </div>
                </div>

                <!-- Account -->
                <div class="bg-zinc-900/30 rounded-xl p-4 border border-zinc-800/50 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center"><i class="ph-fill ph-user text-white"></i></div>
                            <div><div id="userName" class="text-base font-bold text-white">Usuario</div><div class="text-[10px] text-emerald-500 font-bold">Sincronizado</div></div>
                        </div>
                        <button onclick="app.logout()" class="text-zinc-500 hover:text-red-500 p-3"><i class="ph-bold ph-sign-out text-xl"></i></button>
                    </div>
                    <button onclick="app.resetData()" class="w-full text-xs text-zinc-600 hover:text-red-500 py-3 font-bold border border-zinc-800 rounded-lg hover:bg-red-900/10">RESETEAR DATOS</button>
                </div>

                <!-- Lists -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest flex items-center gap-2"><i class="ph-fill ph-piggy-bank text-pink-500"></i> Metas</span>
                        <button onclick="app.openModal('goal')" class="bg-zinc-800 w-8 h-8 rounded-full flex items-center justify-center"><i class="ph-bold ph-plus text-sm"></i></button>
                    </div>
                    <div id="goalsList" class="space-y-3 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
                 <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Gastos Fijos</span>
                        <button onclick="app.openModal('fixed')" class="bg-zinc-800 w-8 h-8 rounded-full flex items-center justify-center"><i class="ph-bold ph-plus text-sm"></i></button>
                    </div>
                    <div id="fixedExpensesList" class="space-y-2 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Deudas</span>
                        <button onclick="app.openModal('loan')" class="bg-zinc-800 w-8 h-8 rounded-full flex items-center justify-center"><i class="ph-bold ph-plus text-sm"></i></button>
                    </div>
                    <div id="loansList" class="space-y-2 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
            </section>
        
        </div>
    </main>
    
    <!-- FAB (NUEVO GASTO) - SOLO MÓVIL (RESTAURADO) -->
    <div id="fabContainer" class="md:hidden fixed bottom-[calc(90px+var(--sab))] left-1/2 -translate-x-1/2 z-40">
        <button onclick="app.openModal('expense')" class="w-16 h-16 bg-gradient-to-b from-red-600 to-red-700 rounded-full flex items-center justify-center text-white shadow-[0_8px_30px_rgba(220,38,38,0.4)] border-[6px] border-[#050505] active:scale-90 transition-transform duration-200 group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <i class="ph-bold ph-plus text-3xl relative z-10"></i>
        </button>
    </div>

    <!-- NAV INFERIOR - MÓVIL (GRID DE 5) -->
    <div class="md:hidden glass-nav fixed bottom-0 w-full h-[80px] grid grid-cols-5 z-50">
        <button class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('balance')">
            <i class="ph-fill ph-wallet text-xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[9px] font-bold group-[.active]:text-white transition-colors">Balance</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('analysis')">
            <i class="ph-fill ph-chart-pie-slice text-xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[9px] font-bold group-[.active]:text-white transition-colors">Análisis</span>
        </button>
         <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('simulation')">
            <i class="ph-fill ph-crystal-ball text-xl group-[.active]:text-purple-400 transition-colors"></i>
            <span class="text-[9px] font-bold group-[.active]:text-purple-400 transition-colors">Simular</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('history')">
            <i class="ph-fill ph-scroll text-xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[9px] font-bold group-[.active]:text-white transition-colors">Historial</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('plan')">
            <i class="ph-fill ph-sliders-horizontal text-xl group-[.active]:text-white transition-colors"></i>
            <span class="text-[9px] font-bold group-[.active]:text-white transition-colors">Plan</span>
        </button>
    </div>

    <!-- MODAL PRINCIPAL -->
    <div id="modalOverlay" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#121212] z-10 pb-2 border-b border-transparent">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo</h3>
                <button onclick="app.closeModal()" class="w-10 h-10 rounded-full bg-zinc-900 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 transition-colors active:scale-90"><i class="ph-bold ph-x text-lg"></i></button>
            </div>

            <!-- Form Transacción -->
            <div id="formTransaction" class="hidden pb-4">
                <div class="relative mb-8">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+60px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none">$</span>
                    <input type="number" id="txAmount" inputmode="decimal" class="bg-transparent text-center text-6xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800 h-16" placeholder="0">
                </div>
                <div class="mb-6"><div id="categoryChips" class="flex flex-wrap gap-2.5 no-scrollbar overflow-x-auto pb-2"></div></div>
                <input type="date" id="txDate" class="input-modern w-full p-4 mb-4 text-center h-14 font-bold">
                <input type="text" id="txDesc" class="input-modern w-full p-4 mb-6 text-center placeholder-zinc-600 h-14" placeholder="Nota opcional...">
                <button onclick="app.saveTransaction()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-lg hover:bg-zinc-200 transition-colors h-16">GUARDAR</button>
                <button id="btnDeleteTx" onclick="app.deleteTxConfirm()" class="w-full mt-4 text-red-500 py-3 font-bold text-xs hidden opacity-70 hover:opacity-100">ELIMINAR TRANSACCIÓN</button>
            </div>

            <!-- Form Gasto Fijo -->
            <div id="formFixed" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Nombre</label><input type="text" id="fixName" class="input-modern w-full p-4 h-14" placeholder="Ej: Netflix"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto</label><input type="number" id="fixAmount" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Día Pago</label><input type="number" id="fixDay" class="input-modern w-full p-4 h-14 text-center" placeholder="1-31"></div>
                </div>
                <button onclick="app.saveFixed()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4 h-16">GUARDAR FIJO</button>
                <button id="btnDeleteFix" onclick="app.deleteFixedConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>
            
            <!-- Form Goal -->
             <div id="formGoal" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Meta</label><input type="text" id="goalName" class="input-modern w-full p-4 h-14" placeholder="Nombre..."></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Objetivo</label><input type="number" id="goalTarget" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Ahorrado</label><input type="number" id="goalSaved" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <button onclick="app.saveGoal()" class="w-full bg-pink-500 text-white py-4 rounded-2xl font-black mt-4 h-16">GUARDAR META</button>
                <button id="btnDeleteGoal" onclick="app.deleteGoalConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>

            <!-- Form Loan -->
            <div id="formLoan" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Deuda</label><input type="text" id="loanName" class="input-modern w-full p-4 h-14" placeholder="Ej: Visa"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto</label><input type="number" id="loanAmount" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Fecha Límite</label><input type="date" id="loanDueDate" class="input-modern w-full p-4 h-14"></div>
                <button onclick="app.saveLoan()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4 h-16">GUARDAR DEUDA</button>
                <button id="btnDeleteLoan" onclick="app.deleteLoanConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">BORRAR</button>
            </div>
            
            <!-- Config Ciclo -->
            <div id="formConfig" class="hidden space-y-4 pb-4">
                 <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.setCycleMode('biweekly')" id="btnCycleBi" class="border border-zinc-700 p-4 rounded-2xl text-center w-full h-32 flex flex-col items-center justify-center">
                        <i class="ph-bold ph-calendar-check text-3xl text-emerald-500 mb-2"></i><span class="font-bold text-sm text-white">Quincenal</span>
                    </button>
                    <button onclick="app.setCycleMode('monthly')" id="btnCycleMo" class="border border-zinc-700 p-4 rounded-2xl text-center w-full h-32 flex flex-col items-center justify-center">
                        <i class="ph-bold ph-calendar text-3xl text-blue-500 mb-2"></i><span class="font-bold text-sm text-white">Mensual</span>
                    </button>
                </div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Día de Inicio</label><input type="number" id="configStartDay" class="input-modern w-full p-4 text-center" value="1"></div>
                <!-- Toggle Adherence -->
                <div class="mt-6 flex items-center justify-between bg-zinc-900/50 p-4 rounded-xl border border-zinc-800">
                    <div><div class="text-sm font-bold text-white">Adherencia</div><div class="text-[10px] text-zinc-500">Panel de horas extras</div></div>
                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="adhToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-zinc-700 transition-all duration-300" onclick="app.toggleAdherenceModule()"/>
                        <label for="adhToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-zinc-800 cursor-pointer"></label>
                    </div>
                </div>
                <button onclick="app.saveCycleConfig()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-6 h-16">APLICAR</button>
            </div>

            <!-- MODAL DE CIERRE (CLOSURE) -->
            <div id="formClosure" class="hidden pb-4">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/20">
                        <i class="ph-fill ph-check-circle text-emerald-500 text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Cierre de Ciclo</h3>
                    <p class="text-zinc-500 text-xs mt-1" id="closurePeriodName">---</p>
                </div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 mb-6 space-y-3">
                    <div class="flex justify-between items-center"><span class="text-zinc-400 text-xs">Ingresos</span><span id="closureInc" class="text-emerald-400 font-bold font-mono">---</span></div>
                    <div class="flex justify-between items-center"><span class="text-zinc-400 text-xs">Gastos</span><span id="closureExp" class="text-red-400 font-bold font-mono">---</span></div>
                    <div class="w-full h-px bg-zinc-800"></div>
                    <div class="flex justify-between items-center"><span class="text-white font-bold text-sm">Balance Final</span><span id="closureBal" class="text-white font-black text-lg font-mono">---</span></div>
                </div>
                <button onclick="app.executeClosure()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-black py-4 rounded-2xl font-black text-lg transition-colors h-16 shadow-[0_0_20px_rgba(16,185,129,0.3)]">
                    CONFIRMAR CIERRE
                </button>
            </div>
        </div>
    </div>
    
    <!-- AUTH BLOCKER -->
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[2000] hidden flex items-center justify-center" id="authModal">
        <div class="custom-dialog rounded-2xl p-8 text-center bg-[#121212] border border-zinc-800">
            <i class="ph-fill ph-lock-key text-red-500 text-4xl mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Autenticación</h2>
            <button class="w-full bg-white text-black py-4 rounded-xl font-bold mt-6 h-14" onclick="window.app.redirectToAuth()">Entrar</button>
        </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast-container"></div>
    <!-- CONFIRM -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[1200] hidden flex items-center justify-center opacity-0 transition-opacity p-5">
        <div class="custom-dialog rounded-3xl p-6 bg-[#121212] border border-zinc-800 transform scale-95 transition-transform duration-200 w-full max-w-xs" id="confirmBox">
            <h4 id="confirmTitle" class="text-lg font-bold text-white mb-2">Confirmar</h4>
            <p id="confirmMessage" class="text-zinc-400 text-sm mb-8 leading-relaxed">¿Estás seguro?</p>
            <div class="flex justify-end gap-3"><button id="confirmCancel" class="text-zinc-400 text-xs font-bold px-4 py-3 rounded-xl bg-zinc-900">Cancelar</button><button id="confirmAction" class="bg-red-600 text-white text-xs font-bold px-4 py-3 rounded-xl">Aceptar</button></div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const UI = {
            toast(msg, type='info') {
                const con = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'toast';
                const icons = { success: 'ph-check-circle text-emerald-400', error: 'ph-warning-circle text-red-400', info: 'ph-info text-blue-400' };
                el.innerHTML = `<i class="ph-fill ${icons[type]||icons.info} text-xl"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                con.appendChild(el); setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 3000);
            },
            fmtMoney(n) { return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n||0); },
            confirm(title, msg) {
                return new Promise(resolve => {
                    const d = document.getElementById('confirmDialog'); const box = document.getElementById('confirmBox');
                    document.getElementById('confirmTitle').textContent=title; document.getElementById('confirmMessage').textContent=msg;
                    const cleanup = (res) => { d.classList.add('opacity-0'); box.classList.remove('scale-100'); setTimeout(()=>{d.classList.add('hidden');},200); document.getElementById('confirmAction').onclick=null; document.getElementById('confirmCancel').onclick=null; resolve(res); };
                    document.getElementById('confirmAction').onclick=()=>cleanup(true); document.getElementById('confirmCancel').onclick=()=>cleanup(false);
                    d.classList.remove('hidden'); requestAnimationFrame(()=>{d.classList.remove('opacity-0'); box.classList.add('scale-100');});
                });
            }
        };

        const Categories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' }, 
            { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
            { id: 'Ocio', icon: 'ph-popcorn', color: 'text-purple-400' }, 
            { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' }, 
            { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Super', icon: 'ph-basket', color: 'text-emerald-400' },
            { id: 'Deuda', icon: 'ph-receipt', color: 'text-indigo-400' }, 
            { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
        ];

        window.app = {
            user: null, 
            data: { income: 0, incomeQ2: 0, fixed: [], cycle: 'biweekly', startDay: 1, lastClosedDate: null, loans: [], goals: [], enableAdherence: true, extraPayAmount: 0 }, 
            logs: [], reports: [],
            currentPeriod: null, 
            pendingClosure: null,
            charts: {},
            isSimulating: false,

            async init() {
                const { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, serverTimestamp } = window.firebaseImports;
                
                const firebaseConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
                const fbApp = initializeApp(firebaseConfig);
                this.auth = getAuth(fbApp);
                this.db = getFirestore(fbApp);
                this.APP_ID = 'gods-plan-smart-v1';

                onAuthStateChanged(this.auth, async (u) => {
                    if (u) {
                        this.user = u;
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('syncStatus').classList.add('bg-emerald-500');
                        document.getElementById('userName').textContent = u.displayName || 'Usuario';
                        this.setupListeners();
                    } else {
                         signInAnonymously(this.auth);
                    }
                });
            },

            setupListeners() {
                const { doc, onSnapshot, collection, query, orderBy, limit, setDoc } = window.firebaseImports;
                const uid = this.user.uid;
                
                // 1. Config
                onSnapshot(doc(this.db, 'artifacts', this.APP_ID, 'users', uid, 'data', 'financials'), (snap) => {
                    if(snap.exists()) {
                        this.data = { income: 0, fixed: [], cycle: 'biweekly', startDay: 1, lastClosedDate: null, loans: [], goals: [], enableAdherence: true, extraPayAmount: 0, ...snap.data() };
                        this.renderConfigUI();
                        this.calcPeriod();
                    } else {
                        setDoc(doc(this.db, 'artifacts', this.APP_ID, 'users', uid, 'data', 'financials'), { income: 0 });
                    }
                });

                // 2. Transactions
                const q = query(collection(this.db, 'artifacts', this.APP_ID, 'users', uid, 'transactions'), orderBy('date', 'desc'), limit(500));
                onSnapshot(q, (snap) => {
                    this.logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    this.refreshUI();
                });

                // 3. Reports
                const rQ = query(collection(this.db, 'artifacts', this.APP_ID, 'users', uid, 'reports'), orderBy('periodEnd', 'desc'));
                onSnapshot(rQ, (snap) => {
                    this.reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    this.renderReportsList();
                    this.checkForClosure();
                });
            },

            refreshUI() {
                this.calcPeriod();
                this.renderTransactions();
                this.renderHistoryTimeline();
                this.updateCharts();
            },

            calcPeriod() {
                const now = new Date();
                const d = now.getDate(); const m = now.getMonth(); const y = now.getFullYear();
                const startDay = this.data.startDay || 1;
                let start, end;

                if (this.data.cycle === 'monthly') {
                    if (d >= startDay) { start = new Date(y, m, startDay); end = new Date(y, m + 1, startDay - 1); }
                    else { start = new Date(y, m - 1, startDay); end = new Date(y, m, startDay - 1); }
                } else {
                    const midDay = startDay + 15;
                    if (d >= startDay && d < midDay) {
                        start = new Date(y, m, startDay); end = new Date(y, m, midDay - 1);
                    } else {
                        if (d >= midDay) { start = new Date(y, m, midDay); end = new Date(y, m + 1, startDay - 1); }
                        else { start = new Date(y, m - 1, midDay); end = new Date(y, m, startDay - 1); }
                    }
                }
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
                
                const daysLeft = Math.ceil((end - now) / (86400000));
                const progress = Math.min(100, Math.max(0, ((now - start) / (end - start)) * 100));

                this.currentPeriod = { start, end, daysLeft: Math.max(1, daysLeft) };
                
                document.getElementById('periodDates').textContent = `${start.getDate()} ${start.toLocaleString('es',{month:'short'})} - ${end.getDate()} ${end.toLocaleString('es',{month:'short'})}`;
                document.getElementById('daysLeftBadge').textContent = `${daysLeft} días`;
                document.getElementById('periodProgress').style.width = `${progress}%`;
                
                this.calcBalance();
                this.checkForClosure();
                this.renderAdherence();
            },

            checkForClosure() {
                if (!this.currentPeriod) return;
                const lastReport = this.reports[0];
                const currentStartMs = this.currentPeriod.start.getTime();
                
                if (!lastReport || new Date(lastReport.periodEnd).getTime() < (currentStartMs - 1000)) {
                    let prevStart, prevEnd;
                    prevEnd = new Date(this.currentPeriod.start);
                    prevEnd.setDate(prevEnd.getDate() - 1);
                    prevEnd.setHours(23,59,59,999);
                    
                    prevStart = new Date(prevEnd);
                    if(this.data.cycle === 'biweekly') prevStart.setDate(prevStart.getDate() - 14);
                    else prevStart.setMonth(prevStart.getMonth() - 1);
                    
                    const hasLogs = this.logs.some(l => {
                        const t = new Date(l.date).getTime();
                        return t >= prevStart.getTime() && t <= prevEnd.getTime();
                    });

                    if (hasLogs) {
                        this.pendingClosure = { start: prevStart, end: prevEnd };
                        document.getElementById('closureAlert').classList.remove('hidden');
                    } else {
                         document.getElementById('closureAlert').classList.add('hidden');
                    }
                } else {
                    document.getElementById('closureAlert').classList.add('hidden');
                }
            },

            calcBalance() {
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const periodLogs = this.logs.filter(l => { const d = new Date(l.date); return d >= pStart && d <= pEnd; });
                const todayStr = new Date().toDateString();
                const todaySpent = periodLogs.filter(l => l.type === 'expense' && new Date(l.date).toDateString() === todayStr).reduce((a, b) => a + b.amount, 0);

                let totalSpent = 0; let extraInc = 0;
                periodLogs.forEach(l => { if(l.type === 'income') extraInc += l.amount; else totalSpent += l.amount; });

                if (this.isSimulating) extraInc += (this.data.extraPayAmount || 0);

                const fixedTotal = (this.data.fixed || []).reduce((a,b)=>a+b.amount,0);
                const totalLoans = (this.data.loans||[]).filter(l => !l.dueDate || new Date(l.dueDate) <= pEnd).reduce((a,b)=>a+b.amount,0);

                let baseInc = parseFloat(this.data.income) || 0;
                if(this.data.cycle === 'biweekly' && this.data.incomeQ2 && this.currentPeriod.start.getDate() > 10) baseInc = parseFloat(this.data.incomeQ2);

                const totalIncome = baseInc + extraInc;
                const remaining = totalIncome - fixedTotal - totalLoans - totalSpent;
                const dailyLimit = (remaining + todaySpent) / this.currentPeriod.daysLeft;
                const availableToday = dailyLimit - todaySpent;

                document.getElementById('dailyFree').textContent = UI.fmtMoney(availableToday);
                document.getElementById('dailyFree').className = availableToday < 0 ? 'text-red-500 font-black' : (this.isSimulating ? 'text-emerald-400 font-black' : 'text-white');
                document.getElementById('valDailyLimit').textContent = UI.fmtMoney(dailyLimit);
                document.getElementById('valTodaySpent').textContent = UI.fmtMoney(todaySpent);
                document.getElementById('totalFree').textContent = UI.fmtMoney(remaining);
                document.getElementById('cycleSpent').textContent = UI.fmtMoney(totalSpent);
                document.getElementById('summaryFixed').textContent = UI.fmtMoney(fixedTotal);
                document.getElementById('summaryShortLoans').textContent = UI.fmtMoney(totalLoans);
                document.getElementById('statDailyAvg').textContent = UI.fmtMoney(totalSpent / Math.max(1, (new Date().getDate() - pStart.getDate() + 1)));

                // Update Simulation View
                document.getElementById('simFreeMoney').textContent = UI.fmtMoney(remaining + totalSpent); // Before spent in this view logic usually? No, free money implies net.
                // Actually simulation view implies "Monthly" projection usually. Let's stick to current period for consistency.
                document.getElementById('simBaseIncomeVal').textContent = UI.fmtMoney(baseInc);
                document.getElementById('simTotalExtraVal').textContent = UI.fmtMoney(extraInc);
                document.getElementById('simTotalIncomeSum').textContent = UI.fmtMoney(totalIncome);
                document.getElementById('simTotalFixed').textContent = UI.fmtMoney(fixedTotal + totalLoans);
                
                // Sim Extras List
                const exList = document.getElementById('simExtraList'); exList.innerHTML = '';
                if(this.data.extraPayAmount > 0) exList.innerHTML += `<div class="flex justify-between text-xs text-emerald-400"><span>Simulado</span><span>+${UI.fmtMoney(this.data.extraPayAmount)}</span></div>`;
                periodLogs.filter(l=>l.type==='income').forEach(l=> exList.innerHTML += `<div class="flex justify-between text-xs text-zinc-400"><span>${l.desc||l.category}</span><span>+${UI.fmtMoney(l.amount)}</span></div>`);
                
                // Sim Fixed List
                const fixList = document.getElementById('simFixedList'); fixList.innerHTML = '';
                (this.data.fixed||[]).forEach(f => fixList.innerHTML += `<div class="flex justify-between text-xs text-zinc-400"><span>${f.name}</span><span>-${UI.fmtMoney(f.amount)}</span></div>`);
                 (this.data.loans||[]).forEach(f => fixList.innerHTML += `<div class="flex justify-between text-xs text-orange-400"><span>Deuda: ${f.name}</span><span>-${UI.fmtMoney(f.amount)}</span></div>`);
            },
            
            toggleSimulation() { this.isSimulating = document.getElementById('simToggle').checked; this.calcBalance(); },
            
            // --- CLOSURE ---
            openClosureModal() {
                if(!this.pendingClosure) return;
                const { start, end } = this.pendingClosure;
                const logs = this.logs.filter(l => { const t = new Date(l.date).getTime(); return t >= start.getTime() && t <= end.getTime(); });
                
                let baseInc = parseFloat(this.data.income) || 0;
                if(this.data.cycle === 'biweekly' && this.data.incomeQ2 && start.getDate() > 10) baseInc = parseFloat(this.data.incomeQ2);
                
                const extraInc = logs.filter(l=>l.type==='income').reduce((a,b)=>a+b.amount,0);
                const totalInc = baseInc + extraInc;
                const expenses = logs.filter(l=>l.type==='expense').reduce((a,b)=>a+b.amount,0);
                const fixed = (this.data.fixed || []).reduce((a,b)=>a+b.amount,0);
                 const loans = (this.data.loans || []).reduce((a,b)=>a+b.amount,0);
                const balance = totalInc - fixed - loans - expenses;

                document.getElementById('closurePeriodName').textContent = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
                document.getElementById('closureInc').textContent = UI.fmtMoney(totalInc);
                document.getElementById('closureExp').textContent = UI.fmtMoney(expenses + fixed + loans);
                document.getElementById('closureBal').textContent = UI.fmtMoney(balance);
                
                this.closureData = { 
                    periodStart: start.toISOString(), periodEnd: end.toISOString(),
                    totalIncome: totalInc, totalExpenses: expenses + fixed + loans, balance: balance,
                    savingsRate: Math.round((balance / totalInc) * 100), txCount: logs.length
                };
                this.openModal('closure');
            },

            async executeClosure() {
                if(!this.closureData) return;
                const { addDoc, collection, updateDoc, doc } = window.firebaseImports;
                let score = 70;
                if(this.closureData.balance > 0) score += 10;
                if(this.closureData.savingsRate > 10) score += 10;
                if(this.closureData.savingsRate > 20) score += 10;
                if(this.closureData.balance < 0) score = Math.max(0, score - 30);
                
                await addDoc(collection(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'reports'), { ...this.closureData, score: score, createdAt: new Date().toISOString() });
                await updateDoc(doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'data', 'financials'), { lastClosedDate: this.closureData.periodEnd });
                UI.toast(`Score: ${score}/100`, 'success'); this.closeModal(); this.switchView('history');
            },

            renderReportsList() {
                const el = document.getElementById('reportsList');
                if(!this.reports.length) return; 
                el.innerHTML = this.reports.map(r => {
                    const dateObj = new Date(r.periodEnd);
                    const color = r.score >= 80 ? 'text-emerald-400' : 'text-zinc-400';
                    return `
                    <div class="relative bg-zinc-900 border border-zinc-800 rounded-2xl p-4 overflow-hidden group hover:bg-zinc-800 transition-colors">
                        <div class="ticket-edge"></div>
                        <div class="flex justify-between items-start">
                            <div><h4 class="text-white font-bold capitalize text-sm">${dateObj.toLocaleString('es',{month:'long'})} ${dateObj.getFullYear()}</h4><p class="text-[10px] text-zinc-500">${new Date(r.periodStart).getDate()} - ${new Date(r.periodEnd).getDate()}</p></div>
                            <div class="text-right"><div class="text-xl font-black ${color}">${r.score}</div><div class="text-[9px] text-zinc-600 font-bold uppercase">Score</div></div>
                        </div>
                    </div>`;
                }).join('');
            },
            
            renderHistoryTimeline() {
                 const container = document.getElementById('historyList');
                 if(!this.logs.length) { container.innerHTML = '<div class="text-center py-10 text-zinc-600">Sin historial</div>'; return; }
                 const groups = {};
                 this.logs.forEach(l => {
                    const d = new Date(l.date); const k = `${d.getFullYear()}-${d.getMonth()}`;
                    if(!groups[k]) groups[k] = { logs:[], total:0, month: d.toLocaleString('es',{month:'long'}) };
                    groups[k].logs.push(l);
                    if(l.type==='expense') groups[k].total += l.amount;
                 });
                 container.innerHTML = Object.keys(groups).sort().reverse().map(k => {
                     const g = groups[k];
                     return `<div class="mb-4"><h4 class="text-zinc-500 font-bold text-xs uppercase mb-2 ml-1 capitalize">${g.month}</h4>
                     ${g.logs.map(l => `<div class="flex justify-between p-3 bg-zinc-900/50 rounded-xl mb-1 border border-transparent hover:border-zinc-800"><span class="text-xs text-zinc-300">${l.desc||l.category}</span><span class="text-xs ${l.type==='income'?'text-emerald-500':'text-zinc-400'}">${UI.fmtMoney(l.amount)}</span></div>`).join('')}</div>`;
                 }).join('');
            },

            // --- STANDARD ---
            renderTransactions() {
                const list = document.getElementById('transactionsList'); list.innerHTML = '';
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const queryStr = (document.getElementById('searchTx').value || '').toLowerCase();
                const visibleLogs = this.logs.filter(l => {
                    const d = new Date(l.date); const inPeriod = d >= pStart && d <= pEnd;
                    const matches = !queryStr || (l.desc||'').toLowerCase().includes(queryStr);
                    return inPeriod && matches;
                });
                if(!visibleLogs.length) { list.innerHTML = `<div class="text-center py-6 text-zinc-600 text-xs italic">Sin movimientos en este ciclo.</div>`; return; }
                visibleLogs.forEach(l => {
                    const isInc = l.type === 'income';
                    const cat = Categories.find(c=>c.id === l.category) || {icon:'ph-question',color:'text-gray-500'};
                    list.innerHTML += `
                    <div onclick="app.openModal('${isInc?'extra':'expense'}','${l.id}')" class="flex justify-between items-center p-3 rounded-2xl hover:bg-zinc-900/50 transition-colors cursor-pointer border border-transparent hover:border-zinc-800 group active:scale-[0.99] active:bg-zinc-900 md:bg-zinc-900/20 md:mb-2">
                        <div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0 md:bg-black"><i class="ph-fill ${isInc?'ph-arrow-down-left text-emerald-500':cat.icon + ' ' + cat.color} text-lg"></i></div><div><h4 class="font-bold text-zinc-300 text-sm">${l.desc || l.category}</h4><p class="text-[10px] text-zinc-500">${new Date(l.date).toLocaleDateString()}</p></div></div><span class="font-bold text-sm ${isInc?'text-emerald-500':'text-zinc-300'}">${isInc?'+':'-'}${UI.fmtMoney(l.amount)}</span>
                    </div>`;
                });
            },
            
            updateCharts() {
                if(!this.logs.length) return;
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const plogs = this.logs.filter(l => l.type==='expense' && new Date(l.date) >= pStart && new Date(l.date) <= pEnd);
                const cats = {}; plogs.forEach(l=>cats[l.category]=(cats[l.category]||0)+l.amount);
                if(this.charts.donut) this.charts.donut.destroy();
                this.charts.donut = new Chart(document.getElementById('expenseChart'), { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#f87171','#fb923c','#fbbf24','#34d399','#60a5fa','#818cf8','#c084fc','#f472b6'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'right',labels:{color:'#71717a',boxWidth:10,font:{size:10}}}} } });
                const days = []; const accum = []; let sum = 0;
                for(let d=new Date(pStart); d<=pEnd; d.setDate(d.getDate()+1)) { days.push(d.getDate()); const dailySum = plogs.filter(l=>new Date(l.date).toDateString()===d.toDateString()).reduce((a,b)=>a+b.amount,0); sum += dailySum; accum.push(sum); }
                if(this.charts.line) this.charts.line.destroy();
                this.charts.line = new Chart(document.getElementById('trendChart'), { type:'line', data:{labels:days,datasets:[{label:'Gasto',data:accum,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true,tension:0.4,pointRadius:0}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#52525b'}},y:{display:false}}} });
            },

            // --- HELPERS (Adherence, Forms, etc.) ---
            renderAdherence() {
                const card = document.getElementById('adherenceCard');
                if (this.data.enableAdherence === false) { card.classList.add('hidden'); return; }
                card.classList.remove('hidden');
                document.getElementById('manualExtraPay').value = this.data.extraPayAmount > 0 ? this.data.extraPayAmount : '';
            },
            async saveExtraPayValue(val) { await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'), { extraPayAmount: parseFloat(val)||0 }); },
            async importExtraMoney() { if(confirm('¿Importar?')) { const {addDoc,collection} = window.firebaseImports; await addDoc(collection(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'transactions'), { amount: this.data.extraPayAmount, desc:'Cobro Extra', category:'Otro', type:'income', date:new Date().toISOString() }); UI.toast('Importado','success'); } },
            toggleAdherenceModule() { const isEnabled = document.getElementById('adhToggle').checked; window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'), { enableAdherence: isEnabled }); },

            // --- VIEW MGMT ---
            switchView(v) {
                ['balance','reports','analysis','plan','simulation','history'].forEach(id => {
                    const el = document.getElementById('view-'+id); if(el) el.classList.add('hidden');
                    document.querySelectorAll(`[data-view="${id}"]`).forEach(e=>e.classList.remove('active'));
                });
                document.getElementById('view-'+v).classList.remove('hidden');
                document.querySelectorAll(`[data-view="${v}"]`).forEach(e=>e.classList.add('active'));
                if(v === 'analysis') setTimeout(() => { this.charts.donut.resize(); this.charts.line.resize(); }, 100);
            },

            // --- MODALS & LISTS (Goals/Loans/Fixed) ---
            openModal(type, id=null) {
                this.modalType = type; this.editId = id;
                document.querySelectorAll('#modalSheet > div[id^="form"]').forEach(d=>d.classList.add('hidden'));
                document.getElementById('modalOverlay').classList.add('is-open');
                
                if(type==='closure') document.getElementById('formClosure').classList.remove('hidden');
                else if(type==='expense'||type==='extra') {
                    document.getElementById('formTransaction').classList.remove('hidden');
                    document.getElementById('modalTitle').textContent = type==='expense'?'Gasto':'Ingreso';
                    document.getElementById('categoryChips').innerHTML = Categories.map(c => `<div onclick="app.selCat(this)" class="chip bg-zinc-900 px-4 py-2 rounded-full text-xs font-bold text-zinc-400 cursor-pointer border border-zinc-800 flex items-center gap-2"><i class="ph-fill ${c.icon} ${c.color}"></i>${c.id}</div>`).join('');
                    const l = id ? this.logs.find(x=>x.id===id) : null;
                    document.getElementById('txAmount').value = l ? l.amount : ''; document.getElementById('txDesc').value = l ? l.desc : ''; document.getElementById('txDate').value = l ? new Date(l.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                    if(l) setTimeout(()=>document.querySelectorAll('.chip').forEach(c=>{if(c.textContent.includes(l.category))c.classList.add('active')}),50);
                    else if(type==='expense') setTimeout(()=>document.querySelector('.chip').classList.add('active'),50);
                    document.getElementById('btnDeleteTx').classList.toggle('hidden', !l);
                } else if(type==='fixed') { document.getElementById('formFixed').classList.remove('hidden'); this.renderFixedList(); }
                else if(type==='config') { document.getElementById('formConfig').classList.remove('hidden'); this.renderConfigUI(); }
                else if(type==='goal') { document.getElementById('formGoal').classList.remove('hidden'); const g = id!==null ? this.data.goals[id] : {}; document.getElementById('goalName').value=g.name||''; document.getElementById('goalTarget').value=g.target||''; document.getElementById('goalSaved').value=g.saved||''; document.getElementById('btnDeleteGoal').classList.toggle('hidden', id===null); }
                else if(type==='loan') { document.getElementById('formLoan').classList.remove('hidden'); const l = id!==null ? this.data.loans[id] : {}; document.getElementById('loanName').value=l.name||''; document.getElementById('loanAmount').value=l.amount||''; document.getElementById('loanDueDate').value=l.dueDate||''; document.getElementById('btnDeleteLoan').classList.toggle('hidden', id===null); }
            },
            closeModal() { document.getElementById('modalOverlay').classList.remove('is-open'); },
            selCat(el) { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); },
            
            async saveTransaction() {
                const { addDoc, collection, updateDoc, doc } = window.firebaseImports;
                const amt = parseFloat(document.getElementById('txAmount').value);
                if(!amt) return UI.toast('Monto requerido', 'error');
                const cat = document.querySelector('.chip.active')?.textContent || 'Otro';
                const payload = { amount: amt, category: cat, desc: document.getElementById('txDesc').value, type: this.modalType==='extra'?'income':'expense', date: new Date(document.getElementById('txDate').value + 'T12:00:00').toISOString() };
                if(this.editId) await updateDoc(doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'transactions', this.editId), payload);
                else await addDoc(collection(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'transactions'), payload);
                this.closeModal(); UI.toast('Guardado', 'success');
            },
            async deleteTxConfirm() { if(await UI.confirm('Borrar', '¿Eliminar?')) { await window.firebaseImports.deleteDoc(window.firebaseImports.doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'transactions', this.editId)); this.closeModal(); } },

            renderFixedList() { const c = document.getElementById('fixedListContainer'); c.innerHTML=''; (this.data.fixed||[]).forEach((f,i) => c.innerHTML += `<div class="flex justify-between items-center bg-zinc-900 p-3 rounded-xl border border-zinc-800 mb-2"><div class="text-xs font-bold text-white">${f.name} <span class="text-zinc-500 font-normal ml-1">Day ${f.day}</span></div><div class="flex items-center gap-3"><span class="text-red-400 font-mono text-xs">${UI.fmtMoney(f.amount)}</span><button onclick="app.delFixed(${i})" class="text-zinc-600 hover:text-red-500"><i class="ph-bold ph-trash"></i></button></div></div>`); },
            async saveFixed() { const arr = [...(this.data.fixed||[])]; arr.push({ name: document.getElementById('fixName').value, amount: parseFloat(document.getElementById('fixAmount').value), day: parseInt(document.getElementById('fixDay').value) }); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'data', 'financials'), { fixed: arr }); document.getElementById('fixName').value=''; document.getElementById('fixAmount').value=''; this.renderFixedList(); },
            async delFixed(i) { const arr = this.data.fixed.filter((_,idx)=>idx!==i); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'data', 'financials'), { fixed: arr }); this.renderFixedList(); },

            async saveGoal() { const arr = [...(this.data.goals||[])]; const item = { name: document.getElementById('goalName').value, target: parseFloat(document.getElementById('goalTarget').value), saved: parseFloat(document.getElementById('goalSaved').value) }; if(this.editId!==null) arr[this.editId]=item; else arr.push(item); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'),{goals:arr}); this.closeModal(); this.renderPlanLists(); },
            async deleteGoalConfirm() { if(await UI.confirm('Borrar','¿Eliminar?')) { const arr=this.data.goals.filter((_,i)=>i!==this.editId); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'),{goals:arr}); this.closeModal(); this.renderPlanLists(); } },

            async saveLoan() { const arr = [...(this.data.loans||[])]; const item = { name: document.getElementById('loanName').value, amount: parseFloat(document.getElementById('loanAmount').value), dueDate: document.getElementById('loanDueDate').value }; if(this.editId!==null) arr[this.editId]=item; else arr.push(item); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'),{loans:arr}); this.closeModal(); this.renderPlanLists(); },
            async deleteLoanConfirm() { if(await UI.confirm('Borrar','¿Eliminar?')) { const arr=this.data.loans.filter((_,i)=>i!==this.editId); await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'),{loans:arr}); this.closeModal(); this.renderPlanLists(); } },

            renderConfigUI() { 
                document.getElementById('inpIncome').value = this.data.income; document.getElementById('inpIncomeQ2').value = this.data.incomeQ2 || ''; 
                this.setCycleMode(this.data.cycle || 'biweekly'); document.getElementById('adhToggle').checked = this.data.enableAdherence !== false;
                this.renderPlanLists();
            },
            setCycleMode(m) { this.tempCycle = m; document.getElementById('btnCycleBi').className = `border p-4 rounded-2xl text-center w-full h-32 flex flex-col items-center justify-center transition-all ${m==='biweekly'?'border-emerald-500 bg-emerald-500/10 text-emerald-500':'border-zinc-700 text-zinc-500'}`; document.getElementById('btnCycleMo').className = `border p-4 rounded-2xl text-center w-full h-32 flex flex-col items-center justify-center transition-all ${m==='monthly'?'border-blue-500 bg-blue-500/10 text-blue-500':'border-zinc-700 text-zinc-500'}`; document.getElementById('configStartDay').value = this.data.startDay; },
            async saveConfig() { await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'data', 'financials'), { income: parseFloat(document.getElementById('inpIncome').value)||0, incomeQ2: parseFloat(document.getElementById('inpIncomeQ2').value)||0 }); },
            async saveCycleConfig() { await window.firebaseImports.updateDoc(window.firebaseImports.doc(this.db, 'artifacts', this.APP_ID, 'users', this.user.uid, 'data', 'financials'), { cycle: this.tempCycle, startDay: parseInt(document.getElementById('configStartDay').value) }); this.closeModal(); },
            
            renderPlanLists() {
                 const gEl = document.getElementById('goalsList'); gEl.innerHTML='';
                 (this.data.goals||[]).forEach((g,i) => { const pct = Math.min(100,Math.round((g.saved/g.target)*100)); gEl.innerHTML+=`<div onclick="app.openModal('goal',${i})" class="p-3 bg-zinc-900 border border-zinc-800 rounded-2xl cursor-pointer"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-white">${g.name}</span><span class="text-[10px] text-pink-400 font-bold">${UI.fmtMoney(g.saved)} / ${UI.fmtMoney(g.target)}</span></div><div class="w-full h-2 bg-zinc-800 rounded-full overflow-hidden"><div class="h-full bg-pink-500" style="width:${pct}%"></div></div></div>`});
                 const lEl = document.getElementById('loansList'); lEl.innerHTML='';
                 (this.data.loans||[]).forEach((l,i) => lEl.innerHTML+=`<div onclick="app.openModal('loan',${i})" class="p-4 bg-zinc-900 border border-zinc-800 rounded-2xl cursor-pointer flex justify-between items-center"><div><div class="font-bold text-sm text-white">${l.name}</div><div class="text-xs text-red-400">${l.dueDate||'Sin fecha'}</div></div><div class="font-bold text-base text-zinc-300">${UI.fmtMoney(l.amount)}</div></div>`);
                 const fEl = document.getElementById('fixedExpensesList'); fEl.innerHTML='';
                 (this.data.fixed||[]).forEach((f,i) => fEl.innerHTML+=`<div onclick="app.openModal('fixed',${i})" class="p-4 bg-zinc-900 border border-zinc-800 rounded-2xl cursor-pointer flex justify-between items-center"><div><div class="font-bold text-sm text-white">${f.name}</div><div class="text-xs text-zinc-500">Día ${f.day}</div></div><div class="font-bold text-base text-red-400">${UI.fmtMoney(f.amount)}</div></div>`);
            },
            togglePrivacy() { document.getElementById('dailyFreeBlur').classList.toggle('hidden'); document.getElementById('eyeIcon').classList.toggle('ph-eye-slash'); },
            async resetData() { if(await UI.confirm('Resetear', '¿Borrar todo?')) { const {writeBatch,collection,getDocs,doc} = window.firebaseImports; const batch = writeBatch(this.db); batch.set(doc(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'data','financials'), {income:0,fixed:[],loans:[],goals:[]}); const q = await getDocs(collection(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'transactions')); q.forEach(d => batch.delete(d.ref)); const r = await getDocs(collection(this.db,'artifacts',this.APP_ID,'users',this.user.uid,'reports')); r.forEach(d => batch.delete(d.ref)); await batch.commit(); window.location.reload(); } },
            logout() { window.location.reload(); }
        };
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
