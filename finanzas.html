<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>God's Plan | Finanzas Ultimate</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE MODULAR -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, 
            getFirestore, doc, onSnapshot, collection, query, orderBy, 
            limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch
        };
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    screens: { 'xs': '375px', 'md': '768px', 'lg': '1024px' },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS GLOBALES */
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            --nav-height: 65px;
        }
        body { 
            background-color: #050505; 
            color: #e5e5e5; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            height: 100vh;
            height: 100dvh; 
        }
        
        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-highlight { background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.08); }
        
        /* Nav Mobile */
        .glass-nav { 
            background: rgba(5, 5, 5, 0.95); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-bottom: var(--sab);
        }

        /* Nav Global Links CSS */
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { 
            font-size: 10px; font-weight: 800; letter-spacing: 0.05em; color: #71717a; 
            transition: color 0.2s; text-decoration: none; white-space: nowrap; 
        }
        .g-link:hover, .g-link.active { color: white; }

        /* Inputs Modernos */
        .input-modern {
            background: #09090b; border: 1px solid #27272a; color: white; border-radius: 16px;
            transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            font-size: 16px !important; 
        }
        .input-modern:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); outline: none; background: #18181b; }
        
        /* Chips */
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border-color: #ef4444; }

        /* Toast */
        #toast-container { position: fixed; top: calc(20px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; animation: fadeIn 0.3s forwards; pointer-events: auto; }
        
        /* Layout */
        #global-nav { position: sticky; top: 0; z-index: 1000; }
        .g-logo { color: #fff; font-weight: 800; text-decoration: none; font-size: 1.1rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; position: relative; z-index: 1001; cursor: pointer; white-space: nowrap; }
        
        /* =========================================
           SISTEMA DE MODALES (CORREGIDO PC/MÓVIL)
           ========================================= */
        #modalOverlay {
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 1100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end; 
            justify-content: center;
        }

        #modalOverlay.is-open {
            opacity: 1; pointer-events: auto;
        }

        #modalSheet {
            background: #121212;
            width: 100%;
            max-height: 90vh;
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            border-top: 1px solid #27272a;
            padding: 24px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            padding-bottom: calc(40px + var(--sab));
        }

        #modalOverlay.is-open #modalSheet {
            transform: translateY(0);
        }

        @media (min-width: 768px) {
            #modalOverlay { align-items: center; padding: 20px; }
            #modalSheet {
                width: 100%; max-width: 480px; border-radius: 24px;
                border: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                max-height: 85vh; padding-bottom: 24px;
                transform: scale(0.95); opacity: 0;
                transition: all 0.2s ease-out;
            }
            #modalOverlay.is-open #modalSheet { transform: scale(1); opacity: 1; }
            main { padding-bottom: 20px !important; }
        }

        /* Utilities */
        .text-xxs { font-size: 10px; }
        .chart-container { position: relative; width: 100%; height: 200px; }
        
        .nav-link-desk {
            color: #71717a; padding: 6px 16px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; transition: all 0.2s;
        }
        .nav-link-desk:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-link-desk.active { color: white; background: #27272a; }

        .custom-dialog { background-color: #121212; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 340px; width: 90%; }
        .modal-auth { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-auth.active { display: flex; }

        /* =========================================
           IMPRESIÓN / REPORTE PREMIUM DARK MODE (RED EDITION)
           ========================================= */
        @media print {
            /* 1. ELIMINAR BORDES BLANCOS DEL NAVEGADOR */
            @page { 
                margin: 0 !important; /* Crucial: Elimina margen del navegador */
                size: auto; 
            }

            /* 2. FORZAR FONDO NEGRO Y AJUSTES GLOBALES */
            html, body {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                background-color: #000000 !important; /* Negro Puro */
                -webkit-print-color-adjust: exact !important; /* Obligar a imprimir fondos */
                print-color-adjust: exact !important;
            }

            /* 3. OCULTAR UI DE LA APP */
            #global-nav, #fabContainer, .glass-nav, #app-content, #toast-container, #modalOverlay, #confirmDialog, #authModal, .no-print-btn { 
                display: none !important; 
            }
            
            /* 4. MOSTRAR ÁREA DE IMPRESIÓN */
            #print-area { 
                display: block !important; 
                position: relative !important;
                width: 100% !important;
                background-color: #000000 !important; /* Fondo Negro Puro */
                color: #e5e5e5 !important;
                padding: 15mm !important; /* Padding interno manual ya que quitamos el @page margin */
                box-sizing: border-box;
            }

            /* =========================================
               ESTILOS ESPECÍFICOS: NEGRO & ROJO
               ========================================= */
            
            /* Header */
            .print-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                border-bottom: 2px solid #ef4444 !important; /* ROJO INTENSO */
                padding-bottom: 20px; 
                margin-bottom: 30px; 
            }
            .print-logo { 
                color: #ffffff !important; 
                font-size: 26px; 
                font-weight: 900; 
                display: flex; 
                align-items: center; 
                gap: 10px; 
                letter-spacing: -0.5px;
            }
            .logo-accent { color: #ef4444 !important; } /* Acento rojo en logo */
            
            .print-meta { 
                text-align: right; 
                color: #a1a1aa !important; /* Gris claro para meta datos */
                font-size: 12px; 
            }

            /* Grid y Cards */
            .print-grid { 
                display: grid; 
                grid-template-columns: repeat(4, 1fr); 
                gap: 15px; 
                margin-bottom: 30px; 
            }
            .print-card { 
                background-color: #0a0a0a !important; /* Casi negro */
                border: 1px solid #7f1d1d !important; /* Borde ROJO OSCURO */
                border-radius: 8px; 
                padding: 15px; 
                display: flex; 
                flex-direction: column; 
                justify-content: center;
                box-shadow: none !important;
            }
            .print-label { 
                font-size: 10px; 
                text-transform: uppercase; 
                color: #ef4444 !important; /* ROJO para etiquetas */
                font-weight: 700; 
                margin-bottom: 6px; 
                letter-spacing: 0.5px;
            }
            .print-val { 
                font-size: 20px; 
                font-weight: 800; 
                color: #ffffff !important; 
            }

            /* Gráficos (Simulados con cajas) */
            .print-charts-row { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 20px; 
                margin-bottom: 30px; 
                height: 250px; 
            }
            .print-chart-box { 
                background-color: #0a0a0a !important; 
                border: 1px solid #450a0a !important; /* Borde rojo muy oscuro */
                border-radius: 12px; 
                padding: 15px; 
                position: relative; 
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #7f1d1d;
                font-weight: bold;
            }
            
            /* Tablas */
            .print-table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 11px; 
            }
            .print-table th { 
                text-align: left; 
                color: #ef4444 !important; /* Encabezados ROJOS */
                text-transform: uppercase; 
                font-weight: 800; 
                padding: 12px 10px; 
                border-bottom: 2px solid #7f1d1d !important; /* Línea roja oscura */
            }
            .print-table td { 
                padding: 10px; 
                border-bottom: 1px solid #280505 !important; /* Separador sutil rojizo */
                color: #d4d4d8 !important; 
            }
            .print-table tr:nth-child(even) td { 
                background-color: #0f0202 !important; /* Cebra muy sutil rojiza/negra */
            }
            
            /* Footer */
            .print-footer { 
                margin-top: 40px; 
                border-top: 1px solid #450a0a !important; 
                padding-top: 20px; 
                text-align: center; 
                color: #71717a !important; 
                font-size: 10px; 
            }
            
            /* Evitar cortes */
            .print-card, .print-chart-box, tr { page-break-inside: avoid; }
        }

        /* Ocultar área de impresión en pantalla normal */
        #print-area { display: none; }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm sm:text-base bg-[#050505] text-[#e5e5e5]">

    <!-- NAV SUPERIOR (Global) -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="g-logo"><i class="ph-bold ph-circles-three-plus text-lg text-red-500"></i> God's Plan</a>
        <div class="g-links no-scrollbar">
            <a href="/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/chat.html" class="g-link">CHAT</a>
            <a href="#" class="g-link active">FINANZAS</a>
            <a href="/cuenta.html" class="g-link">CUENTA</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-zinc-800 ml-1 flex-shrink-0 transition-all duration-500" title="Estado"></div>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="app-content" class="flex-1 overflow-y-auto pb-36 relative scroll-smooth overflow-x-hidden md:px-6">
        
        <div class="w-full max-w-lg md:max-w-6xl mx-auto h-full pt-4 md:pt-8">

            <!-- SUB-NAV DESKTOP -->
            <div class="hidden md:flex justify-center mb-8 fade-in">
                <div class="bg-zinc-900/80 border border-white/10 p-1.5 rounded-full flex items-center gap-1 shadow-lg backdrop-blur-sm">
                    <button onclick="app.switchView('balance')" class="nav-link-desk active px-6" data-view="balance">Billetera</button>
                    <button onclick="app.switchView('analysis')" class="nav-link-desk px-6" data-view="analysis">Análisis</button>
                    <button onclick="app.switchView('plan')" class="nav-link-desk px-6" data-view="plan">Planificación</button>
                </div>
            </div>

            <!-- VISTA: BILLETERA -->
            <section id="view-balance" class="p-4 sm:p-0 fade-in">
                
                <!-- Layout Grid para Desktop -->
                <div class="grid grid-cols-1 md:grid-cols-12 md:gap-8 items-start">
                    
                    <!-- Columna Izquierda (Resumen) -->
                    <div class="md:col-span-5 lg:col-span-4 md:sticky md:top-4">
                        <!-- Header Periodo -->
                        <div class="flex justify-between items-end mb-4 px-1">
                            <div onclick="app.openModal('config')" class="cursor-pointer group py-2">
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1 group-hover:text-red-500 transition-colors">CICLO ACTUAL <i class="ph-bold ph-gear inline align-middle ml-1"></i></p>
                                <h2 class="text-base font-bold text-white flex items-center gap-2" id="periodDates">Cargando...</h2>
                            </div>
                            <div id="daysLeftBadge" class="text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(239,68,68,0.1)]">
                                -- Días
                            </div>
                        </div>

                        <!-- TARJETA PRINCIPAL (Daily Budget) -->
                        <div class="glass rounded-[2rem] p-6 relative overflow-hidden group mb-6 transition-all active:scale-[0.98] md:hover:scale-[1.01] md:active:scale-100 shadow-2xl shadow-black/50">
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-red-600/20 rounded-full blur-3xl group-hover:bg-red-600/30 transition-colors"></div>
                            
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Disponible Hoy</span>
                                    <button onclick="app.togglePrivacy()" class="text-zinc-600 hover:text-white transition-colors p-2 -mr-2 -mt-2">
                                       <i id="eyeIcon" class="ph ph-eye text-lg"></i>
                                    </button>
                                </div>
                                <!-- Valor principal -->
                                <div class="text-5xl xs:text-6xl md:text-5xl lg:text-6xl font-black text-white tracking-tighter mb-8 break-all relative leading-none" id="dailyFreeContainer">
                                    <span id="dailyFree">---</span>
                                    <div id="dailyFreeBlur" class="hidden absolute inset-0 bg-zinc-900/50 backdrop-blur-md rounded-lg z-20 flex items-center justify-center">
                                        <i class="ph-fill ph-lock-key text-zinc-600 text-3xl"></i>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                                    <div>
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Restante Total</span>
                                        <span class="text-lg font-bold text-zinc-200" id="totalFree">---</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1">Gastado Hoy</span>
                                        <span class="text-lg font-bold text-red-400" id="todayTotal">---</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Barra de progreso -->
                            <div class="absolute bottom-0 left-0 h-1.5 bg-zinc-800 w-full">
                                <div id="periodProgress" class="h-full bg-gradient-to-r from-red-600 to-orange-600 shadow-[0_0_10px_rgba(239,68,68,0.5)] w-0 transition-all duration-1000 ease-out"></div>
                            </div>
                        </div>

                        <!-- ACCIONES RÁPIDAS -->
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button onclick="app.openModal('extra')" class="glass-highlight h-14 rounded-2xl text-emerald-500 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 md:hover:scale-105 hover:bg-emerald-500/10 border-transparent hover:border-emerald-500/30">
                                <i class="ph-bold ph-arrow-down-left text-lg"></i> INGRESO
                            </button>
                            <!-- Solo visible en móvil, en PC está en el header -->
                            <button onclick="app.switchView('analysis')" class="md:hidden glass-highlight h-14 rounded-2xl text-zinc-400 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 hover:bg-white/5 hover:text-white">
                                <i class="ph-bold ph-chart-line-up text-lg"></i> ANÁLISIS
                            </button>
                            <!-- Botón "Añadir Gasto" visible solo en Desktop aquí (FAB se oculta) -->
                            <button onclick="app.openModal('expense')" class="hidden md:flex glass-highlight h-14 rounded-2xl text-white font-bold text-xs items-center justify-center gap-2 transition-all hover:scale-105 hover:bg-red-600 hover:border-red-500 bg-red-600/10 border-red-600/30">
                                <i class="ph-bold ph-minus text-lg"></i> GASTO
                            </button>
                        </div>
                    </div>

                    <!-- Columna Derecha (Lista Transacciones) -->
                    <div class="md:col-span-7 lg:col-span-8">
                        <div class="mt-2 md:mt-0">
                            <div class="flex justify-between items-center mb-4 px-1 md:bg-zinc-900/30 md:p-3 md:rounded-xl md:border md:border-white/5">
                                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest hidden md:block">Movimientos Recientes</h3>
                                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest md:hidden">Actividad</h3>
                                <div class="relative w-36 md:w-64 transition-all focus-within:w-full md:focus-within:w-64">
                                     <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 text-sm"></i>
                                     <input type="text" id="searchTx" placeholder="Buscar..." onkeyup="app.filterTransactions()" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl py-2 pl-9 pr-3 text-sm text-white focus:outline-none focus:border-zinc-600 placeholder-zinc-700 transition-colors">
                                </div>
                            </div>
                            
                            <div id="transactionsList" class="space-y-3 min-h-[100px] pb-24 md:pb-0">
                                <div class="text-center py-10 text-zinc-600 animate-pulse">Sincronizando...</div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- VISTA: ANÁLISIS (HISTORIAL + GRAFICOS + METRICAS) -->
            <section id="view-analysis" class="p-4 sm:p-0 hidden fade-in max-w-4xl mx-auto">
                 <div class="md:flex md:justify-between md:items-end mb-6">
                     <div>
                         <h2 class="text-2xl font-black text-white mb-1">Análisis Financiero</h2>
                         <p class="text-zinc-500 text-xs">Desglose detallado del ciclo actual.</p>
                     </div>
                     <div class="flex gap-2 mt-4 md:mt-0">
                         <button onclick="app.generateReport()" class="text-zinc-400 hover:text-white text-xs px-4 py-2 font-bold flex items-center gap-2 border border-zinc-800 rounded-lg hover:bg-zinc-800 transition-colors group">
                            <i class="ph-bold ph-printer group-hover:text-red-500"></i> PRINT
                         </button>
                         <button onclick="app.exportCSV()" class="text-emerald-500 hover:text-emerald-400 text-xs px-4 py-2 font-bold flex items-center gap-2 border border-emerald-900/30 bg-emerald-900/10 rounded-lg hover:bg-emerald-900/20 transition-colors">
                            <i class="ph-bold ph-export"></i> Exp
                         </button>
                         <!-- Nuevo Botón Importar -->
                         <button onclick="app.importCSV()" class="text-blue-500 hover:text-blue-400 text-xs px-4 py-2 font-bold flex items-center gap-2 border border-blue-900/30 bg-blue-900/10 rounded-lg hover:bg-blue-900/20 transition-colors">
                            <i class="ph-bold ph-download"></i> Imp
                         </button>
                         <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="app.processCSV(this)">
                     </div>
                 </div>

                <!-- METRICAS RAPIDAS -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="glass p-5 rounded-2xl">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Promedio Diario</div>
                        <div class="text-xl font-bold text-white" id="statDailyAvg">---</div>
                    </div>
                    <div class="glass p-5 rounded-2xl">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Mayor Gasto</div>
                        <div class="text-xl font-bold text-white truncate" id="statMaxCat">---</div>
                    </div>
                     <div class="glass p-5 rounded-2xl hidden md:block">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Ingresos</div>
                        <div class="text-xl font-bold text-emerald-500 truncate" id="statTotalInc">---</div>
                    </div>
                     <div class="glass p-5 rounded-2xl hidden md:block">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Total Gastos</div>
                        <div class="text-xl font-bold text-red-500 truncate" id="statTotalExp">---</div>
                    </div>
                </div>

                <!-- CHART SECTION -->
                <div id="chartSection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Burn down Chart -->
                    <div class="glass rounded-3xl p-5 relative">
                        <h3 class="text-center text-xs font-bold text-zinc-500 mb-4 tracking-widest">TENDENCIA DEL CICLO</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <!-- Donut Chart -->
                    <div class="glass rounded-3xl p-5">
                        <h3 class="text-center text-xs font-bold text-zinc-500 mb-4 tracking-widest">DISTRIBUCIÓN</h3>
                        <div class="chart-container">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VISTA: PLAN (CONFIG) -->
            <section id="view-plan" class="p-4 sm:p-0 hidden fade-in max-w-2xl mx-auto">
                <h2 class="text-2xl font-black text-white mb-1">Estrategia</h2>
                <p class="text-zinc-500 text-xs mb-6">Administra tus fijos, deudas y metas.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <!-- RESUMEN DE OBLIGACIONES -->
                        <div class="glass-highlight rounded-2xl p-5 mb-6 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-24 h-full bg-gradient-to-l from-[#050505] to-transparent pointer-events-none"></div>
                            <div class="flex justify-between items-center text-sm mb-3">
                                <span class="text-zinc-400 text-xs font-bold uppercase">Gastos Fijos</span>
                                <span id="summaryFixed" class="font-bold text-red-400 font-mono text-base">---</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-zinc-400 text-xs font-bold uppercase">Deudas</span>
                                <span id="summaryShortLoans" class="font-bold text-orange-400 font-mono text-base">---</span>
                            </div>
                        </div>

                        <!-- INGRESO -->
                        <div class="bg-[#09090b] border border-zinc-800 p-5 rounded-2xl mb-8 shadow-inner group focus-within:border-zinc-600 transition-colors">
                            <label class="text-emerald-500 text-xxs font-black uppercase tracking-wider mb-2 block">Ingreso Base (Por Ciclo)</label>
                            <div class="relative flex items-center">
                                <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none group-focus-within:text-emerald-500 transition-colors">$</span>
                                <input type="number" id="inpIncome" inputmode="decimal" class="bg-transparent text-3xl font-bold text-white w-full focus:outline-none placeholder-zinc-800 pl-6 h-10" placeholder="0.00" onblur="app.saveConfig()">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                         <!-- CUENTA -->
                        <div class="bg-zinc-900/30 rounded-xl p-4 border border-zinc-800/50 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-zinc-700 to-zinc-600 flex items-center justify-center shadow-lg">
                                        <i class="ph-fill ph-user text-white text-base"></i>
                                    </div>
                                    <div class="text-left">
                                        <div id="userName" class="text-base font-bold text-white">Usuario</div>
                                        <div id="userStatusText" class="text-[10px] text-zinc-500">Desconectado</div>
                                    </div>
                                </div>
                                <button id="btnLogout" onclick="app.logout()" class="text-zinc-500 hover:text-red-500 transition-colors p-3 hover:bg-zinc-800 rounded-full" title="Salir"><i class="ph-bold ph-sign-out text-xl"></i></button>
                            </div>
                            <button onclick="app.resetData()" class="w-full text-xs text-zinc-600 hover:text-red-500 py-3 font-bold flex items-center justify-center gap-2 transition-colors border border-zinc-800 hover:border-red-900/50 rounded-lg hover:bg-red-900/10">
                                <i class="ph-bold ph-trash text-lg"></i> RESETEAR DATOS
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- METAS DE AHORRO -->
                 <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest flex items-center gap-2"><i class="ph-fill ph-piggy-bank text-pink-500 text-base"></i> Metas Ahorro</span>
                        <button onclick="app.openModal('goal')" class="bg-zinc-800 text-zinc-300 w-8 h-8 rounded-full hover:bg-white hover:text-black transition-colors flex items-center justify-center active:scale-90">
                            <i class="ph-bold ph-plus text-sm"></i>
                        </button>
                    </div>
                    <div id="goalsList" class="space-y-3 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
                
                <!-- GASTOS FIJOS -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Gastos Fijos</span>
                        <button onclick="app.openModal('fixed')" class="bg-zinc-800 text-zinc-300 w-8 h-8 rounded-full hover:bg-white hover:text-black transition-colors flex items-center justify-center active:scale-90">
                            <i class="ph-bold ph-plus text-sm"></i>
                        </button>
                    </div>
                    <div id="fixedExpensesList" class="space-y-2 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
                
                <!-- DEUDAS -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4 px-1 border-b border-white/5 pb-2">
                        <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Deudas Activas</span>
                        <button onclick="app.openModal('loan')" class="bg-zinc-800 text-zinc-300 w-8 h-8 rounded-full hover:bg-white hover:text-black transition-colors flex items-center justify-center active:scale-90">
                            <i class="ph-bold ph-plus text-sm"></i>
                        </button>
                    </div>
                    <div id="loansList" class="space-y-2 grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                </div>
            </section>
        
        </div>

    </main>
    
    <!-- ÁREA DE IMPRESIÓN (OCULTO EN PANTALLA, VISIBLE EN PRINT) -->
    <div id="print-area"></div>
    
    <!-- FAB (NUEVO GASTO) - SOLO MÓVIL (En Desktop está arriba) -->
    <div id="fabContainer" class="md:hidden fixed bottom-[calc(90px+var(--sab))] left-1/2 -translate-x-1/2 z-40">
        <button onclick="app.openModal('expense')" class="w-16 h-16 bg-gradient-to-b from-red-600 to-red-700 rounded-full flex items-center justify-center text-white shadow-[0_8px_30px_rgba(220,38,38,0.4)] border-[6px] border-[#050505] active:scale-90 transition-transform duration-200 group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <i class="ph-bold ph-plus text-3xl group-hover:rotate-90 transition-transform duration-300 relative z-10"></i>
        </button>
    </div>

    <!-- NAV INFERIOR - SOLO MÓVIL -->
    <div class="md:hidden glass-nav fixed bottom-0 w-full h-[80px] grid grid-cols-3 z-50">
        <button class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('balance')">
            <div class="relative p-1">
                <i class="ph-fill ph-wallet text-2xl group-[.active]:text-white transition-colors duration-300"></i>
                <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-red-500 rounded-full opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
            </div>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">Balance</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('analysis')">
            <div class="relative p-1">
                <i class="ph-fill ph-chart-pie-slice text-2xl group-[.active]:text-white transition-colors duration-300"></i>
                <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-red-500 rounded-full opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
            </div>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">Análisis</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('plan')">
            <div class="relative p-1">
                <i class="ph-fill ph-sliders-horizontal text-2xl group-[.active]:text-white transition-colors duration-300"></i>
                <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-red-500 rounded-full opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
            </div>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">Plan</span>
        </button>
    </div>

    <!-- MODAL (ADAPTATIVO) -->
    <div id="modalOverlay" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet">
            <!-- Handle solo para móvil -->
            <div class="md:hidden w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0"></div>
            
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#121212] z-10 pb-2 border-b border-transparent">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo</h3>
                <button onclick="app.closeModal()" class="w-10 h-10 rounded-full bg-zinc-900 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 transition-colors active:scale-90"><i class="ph-bold ph-x text-lg"></i></button>
            </div>

            <!-- Form Transacción -->
            <div id="formTransaction" class="hidden pb-4">
                <div class="relative mb-8">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+60px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none">$</span>
                    <input type="number" id="txAmount" inputmode="decimal" class="bg-transparent text-center text-6xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800 h-16" placeholder="0">
                </div>
                
                <div class="mb-6">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-2 block">Categoría</label>
                    <div id="categoryChips" class="flex flex-wrap gap-2.5 no-scrollbar overflow-x-auto pb-2"></div>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Fecha</label>
                    <input type="date" id="txDate" class="input-modern w-full p-4 text-center h-14 font-bold cursor-pointer">
                </div>
                
                <input type="text" id="txDesc" class="input-modern w-full p-4 mb-6 text-center placeholder-zinc-600 h-14" placeholder="Nota opcional...">
                <button id="btnSaveTx" onclick="app.saveTransaction()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-lg hover:bg-zinc-200 transition-colors active:scale-95 shadow-lg shadow-white/10 h-16">GUARDAR</button>
                <button id="btnDeleteTx" onclick="app.deleteTxConfirm()" class="w-full mt-4 text-red-500 py-3 font-bold text-xs hidden opacity-70 hover:opacity-100">ELIMINAR TRANSACCIÓN</button>
            </div>

            <!-- Form Gasto Fijo -->
            <div id="formFixed" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Nombre</label><input type="text" id="fixName" class="input-modern w-full p-4 h-14" placeholder="Ej: Netflix"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto</label><input type="number" id="fixAmount" inputmode="decimal" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Día Pago</label><input type="number" id="fixDay" inputmode="numeric" class="input-modern w-full p-4 h-14 text-center" placeholder="1-31"></div>
                </div>
                <button onclick="app.saveFixed()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4 h-16 hover:bg-zinc-200">GUARDAR FIJO</button>
                <button id="btnDeleteFix" onclick="app.deleteFixedConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>
            
            <!-- Form Goal (Ahorro) -->
            <div id="formGoal" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Meta (Ej: Coche, Viaje)</label><input type="text" id="goalName" class="input-modern w-full p-4 h-14" placeholder="Nombre..."></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Objetivo ($)</label><input type="number" id="goalTarget" inputmode="decimal" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Ahorrado Actualmente ($)</label><input type="number" id="goalSaved" inputmode="decimal" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <button onclick="app.saveGoal()" class="w-full bg-pink-500 text-white py-4 rounded-2xl font-black mt-4 shadow-[0_4px_20px_rgba(236,72,153,0.4)] h-16 hover:bg-pink-400">GUARDAR META</button>
                <button id="btnDeleteGoal" onclick="app.deleteGoalConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>

            <!-- Form Deuda -->
            <div id="formLoan" class="hidden space-y-4 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Concepto</label><input type="text" id="loanName" class="input-modern w-full p-4 h-14" placeholder="Ej: Visa"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto Pendiente</label><input type="number" id="loanAmount" inputmode="decimal" class="input-modern w-full p-4 h-14" placeholder="$0.00"></div>
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Fecha Límite</label><input type="date" id="loanDueDate" class="input-modern w-full p-4 h-14 cursor-pointer"></div>
                <button onclick="app.saveLoan()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4 h-16 hover:bg-zinc-200">GUARDAR DEUDA</button>
                <button id="btnDeleteLoan" onclick="app.deleteLoanConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">LIQUIDAR / BORRAR</button>
            </div>
            
            <!-- Configuración Ciclo -->
            <div id="formConfig" class="hidden space-y-4 pb-4">
                <p class="text-zinc-400 text-xs text-center mb-4">Define cómo y cuándo recibes tus ingresos.</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.setCycleMode('biweekly')" id="btnCycleBi" class="border border-zinc-700 p-4 rounded-2xl text-center hover:bg-zinc-800 transition-colors h-32 flex flex-col items-center justify-center active:scale-95">
                        <i class="ph-bold ph-calendar-check text-3xl text-emerald-500 mb-2"></i>
                        <div class="font-bold text-sm text-white">Quincenal</div>
                        <div class="text-[10px] text-zinc-500 mt-1">2 Pagos al mes</div>
                    </button>
                    <button onclick="app.setCycleMode('monthly')" id="btnCycleMo" class="border border-zinc-700 p-4 rounded-2xl text-center hover:bg-zinc-800 transition-colors h-32 flex flex-col items-center justify-center active:scale-95">
                        <i class="ph-bold ph-calendar text-3xl text-blue-500 mb-2"></i>
                        <div class="font-bold text-sm text-white">Mensual</div>
                        <div class="text-[10px] text-zinc-500 mt-1">Pago único (Día 1)</div>
                    </button>
                </div>
                
                 <div id="customStartDayDiv" class="hidden mt-6">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block" id="lblStartDay">Día de Inicio</label>
                    <input type="number" id="configStartDay" class="input-modern w-full p-4 mt-1 text-center" placeholder="Día del mes (ej: 1, 5, 15)" value="1" min="1" max="28">
                    <p class="text-[10px] text-zinc-600 mt-2 text-center">Si eliges 10, tus cortes serán 10 y 25.</p>
                </div>
                
                <button onclick="app.saveCycleConfig()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-6 h-16 hover:bg-zinc-200">APLICAR CONFIGURACIÓN</button>
            </div>

        </div>
    </div>
    
    <!-- AUTH BLOCKER -->
    <div class="modal-auth" id="authModal">
        <div class="custom-dialog rounded-2xl p-8 text-center bg-[#121212] border border-zinc-800">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-lock-key text-red-500 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">Autenticación</h2>
            <p class="text-xs text-zinc-500 mb-6 leading-relaxed">Inicia sesión para sincronizar tus finanzas en todos tus dispositivos.</p>
            <button class="w-full bg-white text-black py-4 rounded-xl font-bold hover:bg-zinc-200 transition-colors h-14" onclick="window.app.redirectToAuth()">Iniciar Sesión</button>
        </div>
    </div>
    
    <!-- CONFIRMATION DIALOG -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[1200] hidden flex items-center justify-center opacity-0 transition-opacity p-5">
        <div class="custom-dialog rounded-3xl p-6 bg-[#121212] border border-zinc-800 transform scale-95 transition-transform duration-200 w-full max-w-xs" id="confirmBox">
            <h4 id="confirmTitle" class="text-lg font-bold text-white mb-2">Confirmar</h4>
            <p id="confirmMessage" class="text-zinc-400 text-sm mb-8 leading-relaxed">¿Estás seguro?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="text-zinc-400 text-xs font-bold px-4 py-3 rounded-xl hover:bg-zinc-800 transition-colors uppercase tracking-wider flex-1 bg-zinc-900">Cancelar</button>
                <button id="confirmAction" class="bg-red-600 text-white text-xs font-bold px-4 py-3 rounded-xl hover:bg-red-700 transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20 flex-1">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-container"></div>

    <!-- LOGIC -->
    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch } = window.firebaseImports;
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-ultimate-v3';
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        
        let fbApp, auth, db;
        try { fbApp = initializeApp(firebaseConfig); auth = getAuth(fbApp); db = getFirestore(fbApp); } catch(e) { console.error(e); }

        // --- HELPERS ---
        const UI = {
            toast(msg, type='info') {
                const con = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'toast';
                const icons = { success: 'ph-check-circle text-emerald-400', error: 'ph-warning-circle text-red-400', info: 'ph-info text-blue-400' };
                el.innerHTML = `<i class="ph-fill ${icons[type]||icons.info} text-xl"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                con.appendChild(el); setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 3000);
            },
            fmtMoney(n) { return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n||0); },
            confirm(title, msg) {
                return new Promise(resolve => {
                    const d = document.getElementById('confirmDialog'); const box = document.getElementById('confirmBox');
                    document.getElementById('confirmTitle').textContent=title; document.getElementById('confirmMessage').textContent=msg;
                    const cleanup = (res) => { d.classList.add('opacity-0'); box.classList.remove('scale-100'); setTimeout(()=>{d.classList.add('hidden');},200); document.getElementById('confirmAction').onclick=null; document.getElementById('confirmCancel').onclick=null; resolve(res); };
                    document.getElementById('confirmAction').onclick=()=>cleanup(true); document.getElementById('confirmCancel').onclick=()=>cleanup(false);
                    d.classList.remove('hidden'); requestAnimationFrame(()=>{d.classList.remove('opacity-0'); box.classList.add('scale-100');});
                });
            }
        };

        const DefaultCategories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' }, 
            { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
            { id: 'Ocio', icon: 'ph-popcorn', color: 'text-purple-400' }, 
            { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' }, 
            { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Super', icon: 'ph-basket', color: 'text-emerald-400' },
            { id: 'Deuda', icon: 'ph-receipt', color: 'text-indigo-400' }, 
            { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
        ];

        // --- APP LOGIC ---
        const app = window.app = {
            user: null, 
            data: { income: 0, fixed: [], loans: [], goals: [], cycle: 'biweekly', startDay: 1 }, 
            logs: [], 
            currentPeriod: null, 
            privacyMode: false,
            searchQuery: '',
            charts: {},
            printCharts: {},

            async init() {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        this.user = u; this.updateUserUI();
                        document.getElementById('authModal').classList.remove('active');
                        this.setupListeners();
                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if(token) await signInWithCustomToken(auth, token); else document.getElementById('authModal').classList.add('active');
                    }
                });
            },

            redirectToAuth() { window.location.href = '/'; },
            logout() { if(confirm("¿Salir?")) signOut(auth).then(() => window.location.reload()); },
            
            updateUserUI() {
                document.getElementById('userName').textContent = this.user.displayName || 'Usuario';
                document.getElementById('userStatusText').textContent = 'Sincronizado'; document.getElementById('userStatusText').className = 'text-[10px] text-emerald-500 font-bold';
                document.getElementById('syncStatus').classList.add('bg-emerald-500');
            },

            setupListeners() {
                const uid = this.user.uid;
                const userRef = doc(db, 'artifacts', APP_ID, 'users', uid, 'data', 'financials');
                const logsRef = collection(db, 'artifacts', APP_ID, 'users', uid, 'transactions');
                
                onSnapshot(userRef, (snap) => {
                    if(snap.exists()) {
                        this.data = { income: 0, fixed: [], loans: [], goals: [], cycle: 'biweekly', startDay: 1, ...snap.data() };
                        document.getElementById('inpIncome').value = this.data.income || '';
                        this.renderFixed(); this.renderLoans(); this.renderGoals();
                        this.calcPeriod(); 
                    } else setDoc(userRef, { income: 0, fixed: [], loans: [] });
                });

                const q = query(logsRef, orderBy('date', 'desc'), limit(400));
                onSnapshot(q, (snap) => {
                    this.logs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                    this.renderTransactions(); this.calcBalance(); this.renderCharts(); this.renderAnalysisMetrics();
                });
            },

            // --- DATE & PERIOD LOGIC ---
            calcPeriod() {
                const now = new Date(); const d = now.getDate(); const m = now.getMonth(); const y = now.getFullYear();
                let start, end;
                const startDay = this.data.startDay || 1; 

                if (this.data.cycle === 'monthly') {
                    if (d >= startDay) { start = new Date(y, m, startDay); end = new Date(y, m + 1, startDay - 1); }
                    else { start = new Date(y, m - 1, startDay); end = new Date(y, m, startDay - 1); }
                } else {
                    const midDay = startDay + 15;
                    if (d >= startDay && d < midDay) {
                        start = new Date(y, m, startDay); end = new Date(y, m, midDay - 1);
                    } else {
                        if (d >= midDay) { start = new Date(y, m, midDay); end = new Date(y, m + 1, startDay - 1); }
                        else { start = new Date(y, m - 1, midDay); end = new Date(y, m, startDay - 1); }
                    }
                }
                
                start.setHours(0,0,0,0); end.setHours(23,59,59,999);
                const totalMs = end - start; const elapsed = now - start;
                const progress = Math.min(100, Math.max(0, (elapsed / totalMs) * 100));
                const daysLeft = Math.ceil((end - now) / (86400000));
                
                this.currentPeriod = { start, end, daysLeft: Math.max(0, daysLeft), progress };
                
                document.getElementById('periodDates').innerHTML = `<span class="text-zinc-400 text-sm font-normal">${start.getDate()} ${start.toLocaleString('es',{month:'short'})}</span> <i class="ph-bold ph-arrow-right text-zinc-600 text-xs"></i> <span class="text-white text-sm">${end.getDate()} ${end.toLocaleString('es',{month:'short'})}</span>`;
                document.getElementById('daysLeftBadge').textContent = `${this.currentPeriod.daysLeft} días restantes`;
                document.getElementById('periodProgress').style.width = `${progress}%`;
                
                this.calcBalance();
            },

            // --- CORE FINANCIAL MATH ---
            calcBalance() {
                if(!this.currentPeriod) return;
                
                // 1. Filtramos logs que pertenezcan matemáticamente al periodo
                const pStart = this.currentPeriod.start;
                const pEnd = this.currentPeriod.end;
                const periodLogs = this.logs.filter(l => {
                    const d = new Date(l.date);
                    return d >= pStart && d <= pEnd;
                });

                // 2. Calcular Gastos Variables e Ingresos Extra
                let spent = 0; 
                let extraInc = 0;
                
                periodLogs.forEach(l => {
                    if(l.type === 'income') extraInc += l.amount; 
                    else spent += l.amount;
                });

                // 3. Calcular "Smart Reserve" para Gastos Fijos
                let fixedReserve = 0;
                
                (this.data.fixed || []).forEach(f => {
                    const day = parseInt(f.day);
                    
                    // Verificar si el día de pago cae en este periodo
                    let triggers = false;
                    const dateInMonth = new Date(pStart.getFullYear(), pStart.getMonth(), day);
                    const dateNextMonth = new Date(pStart.getFullYear(), pStart.getMonth() + 1, day);
                    const datePrevMonth = new Date(pStart.getFullYear(), pStart.getMonth() - 1, day);

                    if (dateInMonth >= pStart && dateInMonth <= pEnd) triggers = true;
                    if (dateNextMonth >= pStart && dateNextMonth <= pEnd) triggers = true;
                    if (datePrevMonth >= pStart && datePrevMonth <= pEnd) triggers = true;

                    if (triggers) {
                        const isPaid = periodLogs.some(l => 
                            l.type === 'expense' && 
                            (l.desc || '').toLowerCase().includes(f.name.toLowerCase()) &&
                            l.amount > 0 
                        );

                        if (!isPaid) {
                            fixedReserve += (parseFloat(f.amount) || 0);
                        }
                    }
                });

                const baseInc = parseFloat(this.data.income) || 0;
                const liquidIncome = (baseInc + extraInc);
                const remainingTotal = liquidIncome - fixedReserve - spent;
                const daily = remainingTotal / Math.max(1, this.currentPeriod.daysLeft);

                const dailyEl = document.getElementById('dailyFree');
                dailyEl.textContent = UI.fmtMoney(daily);
                dailyEl.className = daily < 0 ? 'text-red-500' : 'text-white';
                
                document.getElementById('totalFree').textContent = UI.fmtMoney(remainingTotal);
                document.getElementById('totalFree').className = remainingTotal < 0 ? 'text-lg font-bold text-red-500' : 'text-lg font-bold text-zinc-200';
                
                const todayStr = new Date().toDateString();
                const todaySpent = this.logs.filter(l => l.type === 'expense' && new Date(l.date).toDateString() === todayStr).reduce((a,b)=>a+b.amount,0);
                document.getElementById('todayTotal').textContent = `-${UI.fmtMoney(todaySpent)}`;
                
                document.getElementById('summaryFixed').textContent = UI.fmtMoney(fixedReserve);
                const loanSum = (this.data.loans||[]).reduce((a,b)=>a+(b.amount||0),0);
                document.getElementById('summaryShortLoans').textContent = UI.fmtMoney(loanSum);
            },
            
            togglePrivacy() {
                this.privacyMode = !this.privacyMode;
                const blur = document.getElementById('dailyFreeBlur');
                const icon = document.getElementById('eyeIcon');
                if(this.privacyMode) { blur.classList.remove('hidden'); icon.className = 'ph-fill ph-eye-slash text-lg'; }
                else { blur.classList.add('hidden'); icon.className = 'ph ph-eye text-lg'; }
            },

            // --- RENDERING ---
            renderTransactions() {
                const list = document.getElementById('transactionsList');
                list.innerHTML = '';
                
                let visibleLogs = this.logs;
                
                if(this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    visibleLogs = visibleLogs.filter(l => (l.desc||'').toLowerCase().includes(q) || (l.category||'').toLowerCase().includes(q) || l.amount.toString().includes(q));
                }
                
                if(!visibleLogs.length) { list.innerHTML = `<div class="text-center py-6 text-zinc-600 text-xs italic">No hay movimientos.</div>`; return; }
                
                const cats = DefaultCategories;

                visibleLogs.slice(0,50).forEach(l => {
                    const isInc = l.type === 'income';
                    const cat = cats.find(c=>c.id === l.category) || {icon:'ph-question',color:'text-gray-500'};
                    const icon = isInc ? 'ph-arrow-down-left' : cat.icon;
                    const color = isInc ? 'text-emerald-500' : cat.color;
                    list.innerHTML += `
                    <div onclick="app.openModal('${isInc?'extra':'expense'}','${l.id}')" class="flex justify-between items-center p-3 rounded-2xl hover:bg-zinc-900/50 transition-colors cursor-pointer border border-transparent hover:border-zinc-800 group active:scale-[0.99] active:bg-zinc-900 md:bg-zinc-900/20 md:mb-2">
                        <div class="flex items-center gap-4 overflow-hidden">
                            <div class="w-12 h-12 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform md:bg-black">
                                <i class="ph-fill ${icon} ${color} text-xl"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-zinc-300 text-sm truncate">${l.desc || l.category || 'Movimiento'}</h4>
                                <p class="text-xs text-zinc-500">${new Date(l.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <span class="font-bold text-base ${isInc?'text-emerald-500':'text-zinc-300'} whitespace-nowrap">${isInc?'+':'-'}${UI.fmtMoney(l.amount)}</span>
                    </div>`;
                });
            },

            renderFixed() {
                const el = document.getElementById('fixedExpensesList'); el.innerHTML='';
                (this.data.fixed || []).sort((a,b)=>a.day-b.day).forEach((f,i) => {
                    el.innerHTML += `
                    <div class="flex items-center justify-between p-3.5 bg-zinc-900/50 border border-zinc-800 rounded-2xl mb-2 active:scale-[0.99] transition-transform">
                        <div class="flex items-center gap-3 cursor-pointer flex-1" onclick="app.openModal('fixed', ${i})">
                            <div class="w-9 h-9 rounded-lg bg-zinc-800 flex items-center justify-center font-bold text-xs text-zinc-400">${f.day}</div>
                            <div class="min-w-0"><div class="font-bold text-sm text-zinc-200 truncate">${f.name}</div><div class="text-xs text-zinc-500">${UI.fmtMoney(f.amount)}</div></div>
                        </div>
                        <button onclick="app.payFixed(${i})" class="bg-zinc-800 hover:bg-red-600 hover:text-white text-zinc-400 text-[10px] font-bold px-3 py-2 rounded-lg transition-colors ml-2" title="Registrar Pago Hoy">PAGAR</button>
                    </div>`;
                });
            },
            
            renderLoans() {
                const el = document.getElementById('loansList'); el.innerHTML='';
                if(!this.data.loans?.length) el.innerHTML = '<div class="text-zinc-700 text-xs text-center py-2 col-span-2">Sin deudas activas</div>';
                (this.data.loans || []).forEach((l,i) => {
                    el.innerHTML += `
                    <div onclick="app.openModal('loan', ${i})" class="p-4 bg-zinc-900 border border-zinc-800 rounded-2xl cursor-pointer hover:border-zinc-700 transition-all flex justify-between items-center mb-2 active:scale-[0.99]">
                        <div><div class="font-bold text-sm text-white">${l.name}</div><div class="text-xs text-red-400">Vence: ${l.dueDate||'Sin fecha'}</div></div>
                        <div class="text-right font-bold text-base text-zinc-300">${UI.fmtMoney(l.amount)}</div>
                    </div>`;
                });
            },
            
            renderGoals() {
                const el = document.getElementById('goalsList'); el.innerHTML='';
                (this.data.goals || []).forEach((g,i) => {
                    const pct = Math.min(100, Math.round((g.saved / g.target) * 100));
                    el.innerHTML += `
                    <div onclick="app.openModal('goal', ${i})" class="p-3 bg-zinc-900 border border-zinc-800 rounded-2xl cursor-pointer hover:border-pink-500/30 transition-colors mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-white">${g.name}</span>
                            <span class="text-[10px] text-pink-400 font-bold">${UI.fmtMoney(g.saved)} / ${UI.fmtMoney(g.target)}</span>
                        </div>
                        <div class="w-full h-2 bg-zinc-800 rounded-full overflow-hidden">
                            <div class="h-full bg-pink-500 transition-all" style="width: ${pct}%"></div>
                        </div>
                    </div>`;
                });
            },
            
            // --- CHARTS & METRICS ---
            renderCharts() {
                if(!this.logs.length) { document.getElementById('chartSection').classList.add('hidden'); return; }
                document.getElementById('chartSection').classList.remove('hidden');
                
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const periodLogs = this.logs.filter(l => l.type === 'expense' && new Date(l.date).getTime() >= pStart.getTime() && new Date(l.date).getTime() <= pEnd.getTime());
                
                // 1. Donut Chart (Categorías)
                const cats = {};
                periodLogs.forEach(l => { cats[l.category] = (cats[l.category]||0) + l.amount; });
                
                if(this.charts.donut) this.charts.donut.destroy();
                this.charts.donut = new Chart(document.getElementById('expenseChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats),
                        datasets: [{ data: Object.values(cats), backgroundColor: ['#fb923c','#60a5fa','#c084fc','#facc15','#ec4899','#f87171','#34d399','#818cf8','#9ca3af'], borderWidth:0 }]
                    },
                    options: { responsive:true, maintainAspectRatio:false, cutout:'75%', plugins:{ legend:{position:'right',labels:{color:'#71717a',font:{size:10,family:'Plus Jakarta Sans'},boxWidth:8,usePointStyle:true}} } }
                });

                // 2. Trend Line Chart (Burn-down)
                const days = [];
                const dailySpending = {};
                const currentDay = new Date(pStart);
                while (currentDay <= pEnd) {
                    const key = currentDay.getDate() + '/' + (currentDay.getMonth()+1);
                    days.push(key);
                    dailySpending[key] = 0;
                    currentDay.setDate(currentDay.getDate() + 1);
                }

                periodLogs.forEach(l => {
                    const d = new Date(l.date);
                    const key = d.getDate() + '/' + (d.getMonth()+1);
                    if(dailySpending[key] !== undefined) dailySpending[key] += l.amount;
                });

                const dataPoints = [];
                let accum = 0;
                days.forEach(d => {
                    accum += dailySpending[d];
                    dataPoints.push(accum);
                });
                
                const totalBudget = (this.data.income || 0) - (this.data.fixed||[]).reduce((a,b)=>a+b.amount,0); 
                const idealPoints = days.map((_, i) => (totalBudget / days.length) * (i + 1));

                if(this.charts.line) this.charts.line.destroy();
                this.charts.line = new Chart(document.getElementById('trendChart'), {
                    type: 'line',
                    data: {
                        labels: days.filter((_,i) => i % 2 === 0),
                        datasets: [
                            { label: 'Gasto Acumulado', data: dataPoints, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                            { label: 'Límite Ideal', data: idealPoints, borderColor: '#3f3f46', borderDash: [5, 5], borderWidth: 1, pointRadius: 0, tension: 0.1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { display: false, grid: { display: false } }, x: { grid: { display: false }, ticks: { color: '#52525b', font: { size: 9 } } } }
                    }
                });
            },

            renderAnalysisMetrics() {
                if(!this.logs.length || !this.currentPeriod) return;
                const pStart = this.currentPeriod.start; const pEnd = this.currentPeriod.end;
                const periodLogs = this.logs.filter(l => l.type === 'expense' && new Date(l.date).getTime() >= pStart.getTime() && new Date(l.date).getTime() <= pEnd.getTime());
                
                const totalSpent = periodLogs.reduce((a,b)=>a+b.amount,0);
                const dayDiff = Math.max(1, Math.ceil((new Date() - pStart) / (1000 * 60 * 60 * 24)));
                const avg = totalSpent / dayDiff;
                document.getElementById('statDailyAvg').textContent = UI.fmtMoney(avg);

                const cats = {};
                periodLogs.forEach(l => { cats[l.category] = (cats[l.category]||0) + l.amount; });
                const maxCat = Object.keys(cats).reduce((a, b) => cats[a] > cats[b] ? a : b, '---');
                document.getElementById('statMaxCat').textContent = maxCat;
                
                const income = this.logs.filter(l => l.type === 'income' && new Date(l.date).getTime() >= pStart.getTime() && new Date(l.date).getTime() <= pEnd.getTime());
                const totalInc = income.reduce((a,b)=>a+b.amount,0) + (this.data.income || 0);
                document.getElementById('statTotalInc').textContent = UI.fmtMoney(totalInc);
                document.getElementById('statTotalExp').textContent = UI.fmtMoney(totalSpent);
            },

            // --- ACTIONS ---
            openModal(type, id=null) {
                this.modalType = type; this.editId = id;
                document.querySelectorAll('#modalSheet > div[id^="form"]').forEach(d => d.classList.add('hidden'));
                document.getElementById('modalOverlay').classList.add('is-open');
                const title = document.getElementById('modalTitle');
                
                if(type === 'expense' || type === 'extra') {
                    document.getElementById('formTransaction').classList.remove('hidden');
                    title.textContent = type === 'expense' ? 'Registrar Gasto' : 'Ingreso Extra';
                    const chips = document.getElementById('categoryChips');
                    chips.innerHTML = DefaultCategories.map(c => `
                        <div onclick="app.selCat(this)" class="chip bg-zinc-900 px-5 py-3 rounded-full text-xs font-bold text-zinc-400 cursor-pointer border border-zinc-800 hover:border-zinc-600 flex items-center gap-2 transition-all">
                            <i class="ph-fill ${c.icon} ${c.color} text-lg"></i>
                            <span>${c.id}</span>
                        </div>
                    `).join('');
                    const log = id ? this.logs.find(l=>l.id===id) : null;
                    document.getElementById('txAmount').value = log ? log.amount : '';
                    document.getElementById('txDesc').value = log ? log.desc : '';
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('txDate').value = log ? new Date(log.date).toISOString().split('T')[0] : today;
                    document.getElementById('btnDeleteTx').classList.toggle('hidden', !log);
                    
                    if(log) { 
                        setTimeout(()=> { 
                            Array.from(chips.children).find(c => {
                                const span = c.querySelector('span');
                                return span && span.textContent.trim() === log.category;
                            })?.classList.add('active');
                        }, 50); 
                    } else if (type === 'expense') {
                         setTimeout(()=> { chips.children[0]?.classList.add('active') }, 50);
                    }
                } 
                else if (type === 'fixed') {
                    document.getElementById('formFixed').classList.remove('hidden'); title.textContent = 'Gasto Fijo';
                    const f = id !== null ? this.data.fixed[id] : {};
                    document.getElementById('fixName').value = f.name||''; document.getElementById('fixAmount').value=f.amount||''; document.getElementById('fixDay').value=f.day||'';
                    document.getElementById('btnDeleteFix').classList.toggle('hidden', id===null);
                }
                else if (type === 'loan') {
                    document.getElementById('formLoan').classList.remove('hidden'); title.textContent = 'Deuda';
                    const l = id !== null ? this.data.loans[id] : {};
                    document.getElementById('loanName').value = l.name||''; document.getElementById('loanAmount').value=l.amount||''; document.getElementById('loanDueDate').value=l.dueDate||'';
                    document.getElementById('btnDeleteLoan').classList.toggle('hidden', id===null);
                }
                else if (type === 'goal') {
                    document.getElementById('formGoal').classList.remove('hidden'); title.textContent = 'Meta de Ahorro';
                    const g = id !== null ? this.data.goals[id] : {};
                    document.getElementById('goalName').value=g.name||''; document.getElementById('goalTarget').value=g.target||''; document.getElementById('goalSaved').value=g.saved||'';
                    document.getElementById('btnDeleteGoal').classList.toggle('hidden', id===null);
                }
                else if (type === 'config') {
                    document.getElementById('formConfig').classList.remove('hidden'); title.textContent = 'Configuración Ciclo';
                    const currentMode = this.data.cycle || 'biweekly';
                    this.setCycleMode(currentMode);
                    document.getElementById('configStartDay').value = this.data.startDay || 1;
                }
            },
            
            closeModal() {
                document.getElementById('modalOverlay').classList.remove('is-open');
            },
            
            selCat(el) { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); },
            
            async saveTransaction() {
                const amt = parseFloat(document.getElementById('txAmount').value);
                const desc = document.getElementById('txDesc').value;
                const catEl = document.querySelector('.chip.active');
                const cat = catEl ? catEl.innerText.trim() : 'Otro';
                const dateVal = document.getElementById('txDate').value;
                
                if(!amt) return UI.toast('Ingresa un monto','error');
                if(!dateVal) return UI.toast('Fecha requerida','error');

                const [y, m, d] = dateVal.split('-').map(Number);
                const finalDate = new Date(y, m-1, d, new Date().getHours(), new Date().getMinutes());

                const payload = { 
                    amount: amt, 
                    desc, 
                    category: cat, 
                    type: this.modalType === 'extra'?'income':'expense', 
                    date: finalDate.toISOString() 
                };
                
                const ref = collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'transactions');
                
                if(this.editId) await updateDoc(doc(ref, this.editId), payload);
                else await addDoc(ref, payload);
                
                UI.toast('Guardado','success'); this.closeModal();
            },
            
            async saveFixed() {
                const arr = [...(this.data.fixed||[])];
                const item = { name: document.getElementById('fixName').value, amount: parseFloat(document.getElementById('fixAmount').value), day: parseInt(document.getElementById('fixDay').value) };
                if(this.editId!==null) arr[this.editId]=item; else arr.push(item);
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{fixed:arr});
                this.closeModal(); UI.toast('Fijo guardado','success');
            },
            
            async payFixed(idx) {
                const f = this.data.fixed[idx];
                if(await UI.confirm('Pagar Fijo', `¿Registrar pago de ${f.name} por ${UI.fmtMoney(f.amount)}?`)) {
                    await addDoc(collection(db,'artifacts',APP_ID,'users',this.user.uid,'transactions'), {
                        amount: parseFloat(f.amount), desc: `Pago Fijo: ${f.name}`, category: 'Servicios', type: 'expense', date: new Date().toISOString()
                    });
                    UI.toast('Pago registrado','success');
                }
            },
            
            async saveLoan() {
                const arr = [...(this.data.loans||[])];
                const item = { name: document.getElementById('loanName').value, amount: parseFloat(document.getElementById('loanAmount').value), dueDate: document.getElementById('loanDueDate').value };
                if(this.editId!==null) arr[this.editId]=item; else arr.push(item);
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{loans:arr});
                this.closeModal();
            },
            
            async saveGoal() {
                const arr = [...(this.data.goals||[])];
                const item = { name: document.getElementById('goalName').value, target: parseFloat(document.getElementById('goalTarget').value), saved: parseFloat(document.getElementById('goalSaved').value) };
                if(this.editId!==null) arr[this.editId]=item; else arr.push(item);
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{goals:arr});
                this.closeModal();
            },
            
            async saveConfig() {
                const inc = parseFloat(document.getElementById('inpIncome').value);
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{income:inc});
                UI.toast('Ingreso actualizado','success');
            },
            
            setCycleMode(mode) {
                this.tempCycle = mode;
                document.getElementById('btnCycleBi').className = `border p-4 rounded-2xl text-center transition-colors w-full h-32 flex flex-col items-center justify-center active:scale-95 ${mode==='biweekly' ? 'border-emerald-500 bg-emerald-500/10' : 'border-zinc-700'}`;
                document.getElementById('btnCycleMo').className = `border p-4 rounded-2xl text-center transition-colors w-full h-32 flex flex-col items-center justify-center active:scale-95 ${mode==='monthly' ? 'border-blue-500 bg-blue-500/10' : 'border-zinc-700'}`;
                
                const div = document.getElementById('customStartDayDiv');
                div.classList.remove('hidden');
                
                const lbl = document.getElementById('lblStartDay');
                if(mode === 'biweekly') {
                    lbl.textContent = 'Día Inicio 1er Periodo';
                    div.querySelector('p').textContent = 'El segundo periodo iniciará 15 días después.';
                } else {
                    lbl.textContent = 'Día de Corte / Inicio Mes';
                    div.querySelector('p').textContent = 'Tu mes financiero iniciará en este día.';
                }
            },
            
            async saveCycleConfig() {
                const mode = this.tempCycle || this.data.cycle || 'biweekly';
                const startDay = parseInt(document.getElementById('configStartDay').value) || 1;
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{cycle: mode, startDay: startDay});
                UI.toast('Ciclo actualizado','success'); this.closeModal();
            },

            // --- DELETIONS ---
            async deleteTxConfirm() { if(await UI.confirm('Borrar','¿Eliminar esta transacción?')) { await deleteDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'transactions',this.editId)); this.closeModal(); } },
            async deleteFixedConfirm() { if(await UI.confirm('Borrar','¿Eliminar gasto fijo?')) { const arr=this.data.fixed.filter((_,i)=>i!==this.editId); await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{fixed:arr}); this.closeModal(); } },
            async deleteLoanConfirm() { if(await UI.confirm('Liquidar','¿Marcar como pagado y borrar?')) { const arr=this.data.loans.filter((_,i)=>i!==this.editId); await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{loans:arr}); this.closeModal(); } },
            async deleteGoalConfirm() { if(await UI.confirm('Borrar','¿Eliminar meta?')) { const arr=this.data.goals.filter((_,i)=>i!==this.editId); await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'data','financials'),{goals:arr}); this.closeModal(); } },
            
            async resetData() {
                 if(await UI.confirm('RESETEO TOTAL','¿Estás seguro? Se borrará TODO.')) {
                      const uid = this.user.uid; const batch = writeBatch(db);
                      batch.set(doc(db,'artifacts',APP_ID,'users',uid,'data','financials'), {income:0,fixed:[],loans:[],goals:[], categories:[]});
                      const q = await getDocs(collection(db,'artifacts',APP_ID,'users',uid,'transactions'));
                      q.forEach(d => batch.delete(d.ref));
                      await batch.commit(); window.location.reload();
                 }
            },
            
            // --- UI HELPERS ---
            switchView(v) {
                document.getElementById('view-balance').classList.add('hidden'); 
                document.getElementById('view-analysis').classList.add('hidden');
                document.getElementById('view-plan').classList.add('hidden');
                
                document.getElementById('view-'+v).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                
                if(event && event.currentTarget) event.currentTarget.classList.add('active');
                
                document.querySelectorAll('.nav-link-desk').forEach(b => {
                    b.classList.toggle('active', b.dataset.view === v);
                });
                
                document.getElementById('fabContainer').classList.toggle('scale-0', v !== 'balance');
                
                if(v === 'analysis' && this.charts.donut) {
                    setTimeout(() => {
                        this.charts.donut.resize();
                        this.charts.line.resize();
                    }, 100);
                }
            },
            scrollToChart() { document.getElementById('chartSection').classList.remove('hidden'); document.getElementById('chartSection').scrollIntoView({behavior:'smooth'}); },
            filterTransactions() { this.searchQuery = document.getElementById('searchTx').value; this.renderTransactions(); },
            
            // --- NUEVO REPORTE Y CSV IMPORT/EXPORT ---
            generateReport() {
                if(!this.currentPeriod) return UI.toast('Espera un momento...','error');
                
                // Filtrar datos
                const logs = this.logs.filter(l => { const t = new Date(l.date).getTime(); return t >= this.currentPeriod.start.getTime() && t <= this.currentPeriod.end.getTime(); });
                const inc = logs.filter(l=>l.type==='income').reduce((a,b)=>a+b.amount,0);
                const exp = logs.filter(l=>l.type==='expense').reduce((a,b)=>a+b.amount,0);
                const totalIncome = this.data.income + inc;
                const balance = totalIncome - exp;
                const savingsRate = totalIncome > 0 ? Math.round((balance / totalIncome) * 100) : 0;
                
                // Construir HTML del Reporte (PREMIUM DARK MODE - RED EDITION)
                const printArea = document.getElementById('print-area');
                
                // 1. Desbloquear el scroll del body temporalmente para multipágina
                document.body.style.overflow = 'visible';
                document.body.style.height = 'auto';

                // 2. Usar position: absolute para fluir con el scroll
                printArea.style.display = 'block';
                printArea.style.position = 'absolute'; 
                printArea.style.top = '0';
                printArea.style.left = '0';
                printArea.style.width = '100%';
                printArea.style.minHeight = '100vh';
                printArea.style.height = 'auto';
                printArea.style.zIndex = '9999';
                printArea.style.backgroundColor = '#000000';
                printArea.style.overflowY = 'visible';

                printArea.innerHTML = `
                <div class="print-header">
                    <div class="print-logo">
                        GOD'S <span class="logo-accent">PLAN</span>
                    </div>
                    <div class="print-meta">
                        <p>REPORTE FINANCIERO MENSUAL</p>
                        <p>ID: #GP-${new Date().getFullYear()}-${Math.floor(Math.random() * 9000 + 1000)}</p>
                        <p>FECHA: ${new Date().toLocaleDateString('es-MX', {day: '2-digit', month:'short', year:'numeric'}).toUpperCase()}</p>
                    </div>
                </div>

                <div class="print-grid">
                    <div class="print-card">
                        <div class="print-label">Ingresos Totales</div>
                        <div class="print-val">${UI.fmtMoney(totalIncome)}</div>
                    </div>
                    <div class="print-card">
                        <div class="print-label">Gastos Totales</div>
                        <div class="print-val text-red-500">${UI.fmtMoney(exp)}</div>
                    </div>
                    <div class="print-card">
                        <div class="print-label">Utilidad Neta</div>
                        <div class="print-val">${UI.fmtMoney(balance)}</div>
                    </div>
                    <div class="print-card">
                        <div class="print-label">Tasa de Ahorro</div>
                        <div class="print-val text-green-500">${savingsRate > 0 ? '+' : ''}${savingsRate}%</div>
                    </div>
                </div>

                <div class="print-charts-row">
                    <div class="print-chart-box">
                         <div style="position:absolute;top:10px;left:10px;font-size:10px;color:#ef4444;font-weight:bold;">TENDENCIA DE FLUJO</div>
                         <div style="height:100%;width:100%" id="containerTrend"><canvas id="printTrendChart"></canvas></div>
                    </div>
                    <div class="print-chart-box">
                        <div style="position:absolute;top:10px;left:10px;font-size:10px;color:#ef4444;font-weight:bold;">DISTRIBUCIÓN</div>
                        <div style="height:100%;width:100%" id="containerCat"><canvas id="printCatChart"></canvas></div>
                    </div>
                </div>

                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>Categoría</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th style="text-align: right;">Monto</th>
                        </tr>
                    </thead>
                    <tbody>${logs.slice(0, 40).map(l=>`
                        <tr>
                            <td>${l.desc||'Sin descripción'}</td>
                            <td>${l.category}</td>
                            <td>${l.type==='income'?'INGRESO':'GASTO'}</td>
                            <td>${new Date(l.date).toLocaleDateString()}</td>
                            <td style="text-align:right;color:${l.type==='income'?'#34d399':'#ef4444'}">${l.type==='income'?'+':'-'} ${UI.fmtMoney(l.amount)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>

                <div class="print-footer">
                    <p>CONFIDENCIAL - GENERADO POR SISTEMA GOD'S PLAN</p>
                    <p>Página 1 de 1</p>
                </div>
                
                <button onclick="app.closePrintPreview()" style="position:fixed;bottom:20px;right:20px;background:#ef4444;color:white;padding:12px 24px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:10000;" class="no-print hover:bg-red-600 transition-colors">CERRAR VISTA PREVIA</button>
                <style>@media print { .no-print { display: none !important; } }</style>
                `;

                this.renderPrintCharts(logs).then(() => {
                    setTimeout(() => window.print(), 800);
                });
            },

            closePrintPreview() {
                const printArea = document.getElementById('print-area');
                printArea.style.display = 'none';
                // Restaurar estilos del body para la App SPA
                document.body.style.overflow = '';
                document.body.style.height = '';
            },

            renderPrintCharts(logs) {
                 return new Promise((resolveAll) => {
                     // Datos Tendencia
                     const days = []; const dailySpending = {};
                     let current = new Date(this.currentPeriod.start);
                     while(current <= this.currentPeriod.end) {
                         const k = current.getDate()+'/'+(current.getMonth()+1);
                         days.push(k); dailySpending[k] = 0;
                         current.setDate(current.getDate()+1);
                     }
                     logs.filter(l=>l.type==='expense').forEach(l=>{
                         const d=new Date(l.date); const k=d.getDate()+'/'+(d.getMonth()+1);
                         if(dailySpending[k]!==undefined) dailySpending[k]+=l.amount;
                     });
                     const dataPoints = []; let accum=0;
                     days.forEach(d=>{ accum+=dailySpending[d]; dataPoints.push(accum); });

                     // Promesas individuales para cada gráfico con colores ROJO/NEGRO
                     const p1 = new Promise(resolve => {
                         new Chart(document.getElementById('printTrendChart'), {
                             type: 'line',
                             data: {
                                 labels: days.filter((_,i)=>i%3===0),
                                 datasets: [{ label: 'Gasto', data: dataPoints, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, pointRadius: 2, borderWidth: 2 }]
                             },
                             options: { 
                                 responsive:true, 
                                 maintainAspectRatio:false, 
                                 plugins:{legend:{display:false}}, 
                                 scales:{x:{ticks:{color:'#7f1d1d'}, grid:{color:'#220505'}}, y:{display:false}},
                                 animation: {
                                     onComplete: function() {
                                         const img = this.toBase64Image();
                                         const container = document.getElementById('containerTrend');
                                         if(container) container.innerHTML = `<img src="${img}" style="width:100%;height:100%;object-fit:contain;">`;
                                         resolve();
                                     }
                                 }
                             }
                         });
                     });

                     // Datos Categorías
                     const cats = {};
                     logs.filter(l=>l.type==='expense').forEach(l=>{ cats[l.category]=(cats[l.category]||0)+l.amount; });
                     
                     const p2 = new Promise(resolve => {
                         new Chart(document.getElementById('printCatChart'), {
                             type: 'doughnut',
                             data: {
                                labels: Object.keys(cats),
                                datasets: [{ 
                                    data: Object.values(cats), 
                                    backgroundColor: ['#ef4444','#b91c1c','#991b1b','#7f1d1d','#450a0a','#f87171','#fca5a5','#fecaca', '#ffffff'], 
                                    borderWidth:1,
                                    borderColor: '#000000'
                                }]
                             },
                             options: { 
                                 responsive:true, 
                                 maintainAspectRatio:false, 
                                 cutout:'60%', 
                                 plugins:{ legend:{position:'right',labels:{color:'#a1a1aa',font:{size:9},boxWidth:8}} },
                                 animation: {
                                     onComplete: function() {
                                         const img = this.toBase64Image();
                                         const container = document.getElementById('containerCat');
                                         if(container) container.innerHTML = `<img src="${img}" style="width:100%;height:100%;object-fit:contain;">`;
                                         resolve();
                                     }
                                 }
                             }
                         });
                     });

                     Promise.all([p1, p2]).then(resolveAll);
                 });
            },

            exportCSV() {
                if(!this.logs.length) return UI.toast('Sin datos para exportar', 'error');
                let csv = 'Fecha,Tipo,Categoria,Descripcion,Monto\n';
                this.logs.forEach(l => {
                    // Usar ISO string para fecha para asegurar compatibilidad al importar
                    const dateStr = new Date(l.date).toISOString().split('T')[0]; 
                    csv += `${dateStr},${l.type},${l.category},"${l.desc||''}",${l.amount}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "gods_plan_export.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            importCSV() {
                document.getElementById('csvInput').click();
            },
            
            async processCSV(input) {
                const file = input.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n');
                    const batch = writeBatch(db);
                    let count = 0;
                    
                    // Saltar cabecera (index 1)
                    for(let i=1; i<rows.length; i++) {
                        const row = rows[i].trim();
                        if(!row) continue;
                        
                        // Parse simple CSV (asume formato del export: Date,Type,Cat,Desc,Amount)
                        // Maneja comillas simples en descripción si existen
                        const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || row.split(',');
                        
                        if(cols.length >= 5) {
                            let dateStr = cols[0].replace(/"/g, '');
                            const type = cols[1].replace(/"/g, '');
                            const category = cols[2].replace(/"/g, '');
                            const desc = cols[3].replace(/"/g, '');
                            const amount = parseFloat(cols[4]);
                            
                            if(amount && type) {
                                // Intentar parsear fecha
                                let finalDate = new Date();
                                if(dateStr.includes('-')) {
                                    // Formato ISO YYYY-MM-DD
                                    const [y,m,d] = dateStr.split('-').map(Number);
                                    finalDate = new Date(y, m-1, d, 12, 0, 0);
                                } else if (dateStr.includes('/')) {
                                    // Formato Locale DD/MM/YYYY
                                    const [d,m,y] = dateStr.split('/').map(Number);
                                    finalDate = new Date(y, m-1, d, 12, 0, 0);
                                }

                                const ref = doc(collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'transactions'));
                                batch.set(ref, {
                                    amount: Math.abs(amount),
                                    desc: desc,
                                    category: category || 'Importado',
                                    type: type.toLowerCase().includes('income') || type.toLowerCase().includes('ingreso') ? 'income' : 'expense',
                                    date: finalDate.toISOString()
                                });
                                count++;
                            }
                        }
                    }
                    
                    if(count > 0) {
                        await batch.commit();
                        UI.toast(`${count} registros importados`, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        UI.toast('No se pudieron leer registros', 'error');
                    }
                    input.value = ''; // Reset input
                };
                reader.readAsText(file);
            }
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
