<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>God's Plan | Lite</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Firebase Imports (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc
        };
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { dark: { 900: '#050505', card: '#18181b' } },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; height: 100dvh; }
        input, select, textarea { font-size: 16px !important; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-highlight { background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.08); }
        .glass-nav { background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); padding-bottom: var(--sab); }
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { font-size: 10px; font-weight: 800; letter-spacing: 0.05em; color: #71717a; transition: color 0.2s; text-decoration: none; white-space: nowrap; }
        .g-link:hover, .g-link.active { color: white; }
        .input-modern { background: #09090b; border: 1px solid #27272a; color: white; border-radius: 16px; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); font-size: 16px !important; }
        .input-modern:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); outline: none; background: #18181b; }
        .chip { transition: all 0.2s; user-select: none; white-space: nowrap; }
        .chip.active { background: #ef4444; color: white; transform: scale(1.02); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border-color: #ef4444; }
        #toast-container { position: fixed; top: calc(20px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; animation: fadeIn 0.3s forwards; pointer-events: auto; }
        #global-nav { position: sticky; top: 0; z-index: 1000; }
        .g-logo { color: #fff; font-weight: 800; text-decoration: none; font-size: 1.1rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; position: relative; z-index: 1001; cursor: pointer; white-space: nowrap; }
        #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; align-items: flex-end; justify-content: center; }
        #modalOverlay.is-open { opacity: 1; pointer-events: auto; }
        #modalSheet { background: #121212; width: 100%; max-height: 85dvh; border-top-left-radius: 32px; border-top-right-radius: 32px; border-top: 1px solid #27272a; padding: 20px 24px; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: calc(40px + var(--sab)); }
        #modalOverlay.is-open #modalSheet { transform: translateY(0); }
        @media (min-width: 768px) {
            #modalOverlay { align-items: center; padding: 20px; }
            #modalSheet { width: 100%; max-width: 380px; border-radius: 20px; transform: scale(0.95); opacity: 0; transition: all 0.2s ease-out; }
            #modalOverlay.is-open #modalSheet { transform: scale(1); opacity: 1; }
        }
        .nav-link-desk { color: #71717a; padding: 6px 16px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; transition: all 0.2s; }
        .nav-link-desk:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-link-desk.active { color: white; background: #27272a; }
        .modal-auth { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-auth.active { display: flex; }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm sm:text-base bg-[#050505] text-[#e5e5e5]">
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="#" class="g-logo"><i class="ph-bold ph-fire text-lg text-red-600"></i> God's Plan <span class="text-[10px] bg-red-600/20 px-1.5 py-0.5 rounded text-red-500 ml-1 font-bold">LITE</span></a>
        <div class="g-links no-scrollbar">
            <a href="#" class="g-link active">BILLETERA</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-zinc-800 ml-1 flex-shrink-0 transition-all duration-500" title="Estado"></div>
        </div>
    </nav>
    <main id="app-content" class="flex-1 overflow-y-auto pb-36 relative scroll-smooth overflow-x-hidden md:px-6">
        <div class="w-full max-w-lg md:max-w-4xl mx-auto h-full pt-4 md:pt-8">
            
            <div class="hidden md:flex justify-center mb-8 fade-in">
                <div class="bg-zinc-900/80 border border-white/10 p-1.5 rounded-full flex items-center gap-1 shadow-lg backdrop-blur-sm">
                    <button onclick="app.switchView('balance')" class="nav-link-desk active px-5" data-view="balance">Balance</button>
                    <button onclick="app.switchView('plan')" class="nav-link-desk px-5" data-view="plan">Fijos</button>
                </div>
            </div>

            <!-- VISTA: BALANCE -->
            <section id="view-balance" class="p-4 sm:p-0 fade-in">
                <div class="flex justify-between items-end mb-4 px-1">
                    <div onclick="app.openModal('nextpay')" class="cursor-pointer group">
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em] mb-1 group-hover:text-red-500 transition-colors">
                            PRÓXIMO PAGO <i class="ph-bold ph-pencil-simple ml-1"></i>
                        </p>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2" id="nextPayDateDisplay">Definir fecha</h2>
                    </div>
                    <div id="daysLeftBadge" class="hidden text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-full font-mono font-bold whitespace-nowrap shadow-[0_0_10px_rgba(239,68,68,0.1)]">
                        -- Días
                    </div>
                </div>

                <!-- ALERTA DE PAGOS FIJOS HOY -->
                <div id="fixedAlertContainer" class="hidden mb-4"></div>

                <div id="mainCard" class="glass rounded-[2rem] p-6 relative overflow-hidden group mb-6 transition-all shadow-2xl shadow-black/50">
                    <div id="mainCardBg" class="absolute -top-10 -right-10 w-32 h-32 bg-red-600/10 rounded-full blur-3xl transition-colors duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest" id="mainCardLabel">Disponible Hoy</span>
                            <button onclick="app.openModal('adjustment')" class="text-zinc-500 hover:text-white transition-colors" title="Ajustar Saldo">
                                <i class="ph-bold ph-scales"></i>
                            </button>
                        </div>
                        <div class="text-5xl xs:text-6xl font-black text-white tracking-tighter mb-6 break-all relative leading-none" id="mainAmountDisplay">
                            ---
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                            <div>
                                <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1 flex items-center gap-1">Saldo Real Total</span>
                                <span class="text-lg font-bold text-zinc-300" id="realBalanceDisplay">---</span>
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] text-zinc-500 uppercase font-bold mb-1 flex items-center justify-end gap-1">Fijos a Retener</span>
                                <span class="text-lg font-bold text-orange-400" id="reservedFixedDisplay">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-1 gap-3 mb-6">
                    <button onclick="app.openModal('extra')" class="glass-highlight h-14 rounded-2xl text-red-500 font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-95 md:hover:scale-105 hover:bg-red-500/10 border-transparent hover:border-red-500/30">
                        <i class="ph-bold ph-arrow-down-left text-lg"></i> INGRESO
                    </button>
                    <button onclick="app.openModal('expense')" class="glass-highlight h-14 rounded-2xl text-white font-bold text-xs flex items-center justify-center gap-2 transition-all hover:scale-105 hover:bg-zinc-800 hover:border-zinc-700 bg-zinc-900 border-zinc-800">
                        <i class="ph-bold ph-minus text-lg"></i> GASTO
                    </button>
                </div>

                <div class="mt-2 md:mt-0">
                    <div class="mb-4 px-1 md:p-3 md:rounded-xl flex items-center justify-between">
                        <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Movimientos</h3>
                        <div class="relative w-40">
                            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 text-xs"></i>
                            <input type="text" id="searchTx" placeholder="Buscar..." onkeyup="app.filterTransactions()" class="w-full bg-zinc-900 border border-zinc-800 rounded-lg py-1.5 pl-8 pr-2 text-xs text-white focus:outline-none focus:border-red-900 transition-colors">
                        </div>
                    </div>
                    
                    <div id="dateFilterDisplay" class="hidden mx-1 md:mx-0 p-3 mb-4 bg-red-900/10 border border-red-900/30 rounded-xl text-xs font-bold text-red-300 justify-between items-center animate-fade-in">
                        <span id="dateFilterLabel"></span>
                        <button onclick="app.clearDateFilter()" class="text-red-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
                    </div>

                    <div id="transactionsList" class="space-y-3 min-h-[100px] pb-24 md:pb-0">
                        <div class="text-center py-10 text-zinc-600 animate-pulse">Cargando...</div>
                    </div>
                </div>
            </section>

            <!-- VISTA: PLAN (SOLO FIJOS) -->
            <section id="view-plan" class="p-4 sm:p-0 hidden fade-in max-w-4xl mx-auto pb-24">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-white mb-2">Gastos Fijos</h2>
                    <p class="text-zinc-500 text-sm">Configura tus pagos recurrentes (Netflix, Renta, Internet). Se activarán avisos el día correspondiente.</p>
                </div>
                
                <div class="glass p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-500"><i class="ph-bold ph-calendar-check text-xl"></i></div>
                            <div><h3 class="text-lg font-bold text-white">Recurrentes</h3></div>
                        </div>
                        <button onclick="app.openModal('fixed')" class="w-10 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-white flex items-center justify-center transition-colors active:scale-90"><i class="ph-bold ph-plus"></i></button>
                    </div>
                    <div id="fixedExpensesList" class="space-y-3"></div>
                </div>

                <div class="mt-8 p-6 rounded-3xl bg-zinc-900/30 border border-zinc-800/50">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400"><i class="ph-fill ph-user text-2xl"></i></div>
                            <div>
                                <div id="userName" class="font-bold text-white">Usuario</div>
                                <div id="userStatusText" class="text-xs text-zinc-500">Estado</div>
                            </div>
                        </div>
                        <button id="btnLogout" onclick="app.logout()" class="text-zinc-500 hover:text-white transition-colors"><i class="ph-bold ph-sign-out text-xl"></i></button>
                    </div>
                    <button onclick="app.resetData()" class="w-full py-3 rounded-xl border border-red-900/30 text-red-500 text-xs font-bold hover:bg-red-900/10 transition-colors flex items-center justify-center gap-2">
                        <i class="ph-bold ph-trash"></i> BORRAR TODO
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- FAB (MÓVIL) -->
    <div id="fabContainer" class="md:hidden fixed bottom-[calc(90px+var(--sab))] left-1/2 -translate-x-1/2 z-40">
        <button onclick="app.openModal('expense')" class="w-16 h-16 bg-gradient-to-b from-red-600 to-red-800 rounded-full flex items-center justify-center text-white shadow-[0_8px_30px_rgba(220,38,38,0.4)] border-[6px] border-[#050505] active:scale-90 transition-transform duration-200 group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <i class="ph-bold ph-plus text-3xl group-hover:rotate-90 transition-transform duration-300 relative z-10"></i>
        </button>
    </div>

    <!-- NAV INFERIOR - MÓVIL -->
    <div class="md:hidden glass-nav fixed bottom-0 w-full h-[80px] grid grid-cols-2 z-50 pb-2">
        <button class="nav-btn active group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('balance', this)">
            <div class="relative p-1"><i class="ph-fill ph-wallet text-xl group-[.active]:text-white transition-colors duration-300"></i></div>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">Balance</span>
        </button>
        <button class="nav-btn group flex flex-col items-center justify-center gap-1 text-zinc-600 active:scale-95 transition-transform" onclick="app.switchView('plan', this)">
            <div class="relative p-1"><i class="ph-fill ph-calendar-check text-xl group-[.active]:text-white transition-colors duration-300"></i></div>
            <span class="text-[10px] font-bold group-[.active]:text-white transition-colors">Fijos</span>
        </button>
    </div>

    <!-- MODALES -->
    <div id="modalOverlay" onclick="if(event.target === this) app.closeModal()">
        <div id="modalSheet">
            <div class="md:hidden w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6 shrink-0"></div>
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#121212] z-10 pb-2 border-b border-transparent">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo</h3>
                <button onclick="app.closeModal()" class="w-10 h-10 rounded-full bg-zinc-900 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 transition-colors active:scale-90"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <!-- FORM NEXT PAY -->
            <div id="formNextPay" class="hidden pb-4">
                <p class="text-zinc-400 text-xs mb-4">Define cuándo recibes tu próximo ingreso para calcular tu límite diario disponible hasta esa fecha.</p>
                <div class="mb-4">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Fecha Próximo Pago</label>
                    <input type="date" id="nextPayDateInput" class="input-modern w-full p-4 text-center h-14 font-bold cursor-pointer">
                </div>
                <div class="mb-4">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Monto Esperado (Opcional)</label>
                    <input type="number" id="nextPayAmountInput" class="input-modern w-full p-4 text-center h-14" placeholder="$0.00">
                    <p class="text-[10px] text-zinc-600 mt-2 text-center">Solo informativo, no afecta tu saldo actual.</p>
                </div>
                <button onclick="app.saveNextPayData()" class="w-full bg-white text-black py-4 rounded-2xl font-black mt-4 h-16 hover:bg-zinc-200">GUARDAR FECHA</button>
                <button onclick="app.clearNextPayData()" class="w-full text-red-500 py-3 font-bold text-xs mt-2">ELIMINAR FECHA (MODO LIBRE)</button>
            </div>

            <!-- FORM TRANSACCION -->
            <div id="formTransaction" class="hidden pb-4">
                <div class="relative mb-8 md:mb-2">
                    <span class="absolute left-1/2 -translate-x-[calc(50%+60px)] top-1/2 -translate-y-1/2 text-2xl text-zinc-600 font-light pointer-events-none">$</span>
                    <input type="number" id="txAmount" inputmode="decimal" class="bg-transparent text-center text-5xl md:text-3xl font-black text-white w-full border-none outline-none focus:ring-0 p-0 placeholder-zinc-800 h-16 md:h-10" placeholder="0">
                </div>
                <div class="mb-6 md:mb-1" id="categorySelectionContainer">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-2 md:mb-1 block">Categoría</label>
                    <div id="categoryChips" class="flex flex-wrap gap-2.5 md:gap-1.5 no-scrollbar overflow-x-auto pb-2"></div>
                </div>
                <div class="mb-4 md:mb-2">
                    <label class="text-[10px] text-zinc-500 font-bold uppercase ml-1 mb-1 block">Fecha</label>
                    <input type="date" id="txDate" class="input-modern w-full p-4 text-center h-14 md:h-9 md:text-sm font-bold cursor-pointer">
                </div>
                <input type="text" id="txDesc" class="input-modern w-full p-4 mb-6 md:mb-3 text-center placeholder-zinc-600 h-14 md:h-9 md:text-sm" placeholder="Nota opcional...">
                <button id="btnSaveTx" onclick="app.saveTransaction()" class="w-full bg-white text-black py-4 md:py-0 rounded-2xl font-black text-lg hover:bg-zinc-200 transition-colors active:scale-95 shadow-lg shadow-white/10 h-16 md:h-10 md:text-sm">GUARDAR</button>
                <button id="btnDeleteTx" onclick="app.deleteTxConfirm()" class="w-full mt-4 text-red-500 py-3 font-bold text-xs hidden opacity-70 hover:opacity-100">ELIMINAR TRANSACCIÓN</button>
            </div>

            <!-- FORM FIJO -->
            <div id="formFixed" class="hidden space-y-4 md:space-y-2 pb-4">
                <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Nombre</label><input type="text" id="fixName" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm" placeholder="Ej: Netflix"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Monto</label><input type="number" id="fixAmount" inputmode="decimal" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm" placeholder="$0.00"></div>
                    <div><label class="text-[10px] text-zinc-500 font-bold uppercase ml-2 mb-1 block">Día Pago (Mes)</label><input type="number" id="fixDay" inputmode="numeric" class="input-modern w-full p-4 h-14 md:h-9 md:text-sm text-center" placeholder="Ej: 5"></div>
                </div>
                <button onclick="app.saveFixed()" class="w-full bg-white text-black py-4 md:py-0 rounded-2xl font-black mt-4 h-16 md:h-10 md:text-sm hover:bg-zinc-200">GUARDAR FIJO</button>
                <button id="btnDeleteFix" onclick="app.deleteFixedConfirm()" class="w-full text-red-500 py-3 font-bold text-xs hidden">ELIMINAR</button>
            </div>
        </div>
    </div>

    <!-- AUTH & CONFIRM -->
    <div class="modal-auth" id="authModal">
        <div class="rounded-2xl p-8 text-center bg-[#121212] border border-zinc-800 max-w-xs w-full">
            <div class="w-16 h-16 bg-red-600/10 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph-fill ph-lock-key text-red-500 text-2xl"></i></div>
            <h2 class="text-xl font-bold text-white mb-2">Autenticación</h2>
            <p class="text-xs text-zinc-500 mb-6 leading-relaxed">Inicia sesión para proteger y sincronizar tus datos.</p>
            <button class="w-full bg-white text-black py-4 rounded-xl font-bold hover:bg-zinc-200 transition-colors h-14" onclick="window.app.redirectToAuth()">Entrar</button>
        </div>
    </div>
    
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[2200] hidden flex items-center justify-center opacity-0 transition-opacity p-5">
        <div class="rounded-3xl p-6 bg-[#121212] border border-zinc-800 transform scale-95 transition-transform duration-200 w-full max-w-xs" id="confirmBox">
            <h4 id="confirmTitle" class="text-lg font-bold text-white mb-2">Confirmar</h4>
            <p id="confirmMessage" class="text-zinc-400 text-sm mb-8 leading-relaxed">¿Estás seguro?</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="text-zinc-400 text-xs font-bold px-4 py-3 rounded-xl hover:bg-zinc-800 transition-colors uppercase tracking-wider flex-1 bg-zinc-900">Cancelar</button>
                <button id="confirmAction" class="bg-red-600 text-white text-xs font-bold px-4 py-3 rounded-xl hover:bg-red-700 transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20 flex-1">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc, addDoc, deleteDoc, getDocs, writeBatch, getDoc } = window.firebaseImports;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-lite-v1';
        
        // --- CUSTOM CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
          authDomain: "godsplan-blqa.firebaseapp.com",
          projectId: "godsplan-blqa",
          storageBucket: "godsplan-blqa.firebasestorage.app",
          messagingSenderId: "1008783768310",
          appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7",
          measurementId: "G-924H3FVC6Z"
        };
        
        let fbApp, auth, db;
        try { fbApp = initializeApp(firebaseConfig); auth = getAuth(fbApp); db = getFirestore(fbApp); } catch(e) { console.error("Error init:", e); }

        const UI = {
            toast(msg, type='info') {
                const con = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = 'toast';
                const icons = { success: 'ph-check-circle text-red-500', error: 'ph-warning-circle text-orange-400', info: 'ph-info text-blue-400' };
                el.innerHTML = `<i class="ph-fill ${icons[type]||icons.info} text-xl"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                con.appendChild(el); setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 3000);
            },
            fmtMoney(n) { return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n||0); },
            confirm(title, msg) {
                return new Promise(resolve => {
                    const d = document.getElementById('confirmDialog'); const box = document.getElementById('confirmBox');
                    document.getElementById('confirmTitle').textContent=title; document.getElementById('confirmMessage').textContent=msg;
                    const cleanup = (res) => { d.classList.add('opacity-0'); box.classList.remove('scale-100'); setTimeout(()=>{d.classList.add('hidden');},200); document.getElementById('confirmAction').onclick=null; document.getElementById('confirmCancel').onclick=null; resolve(res); };
                    document.getElementById('confirmAction').onclick=()=>cleanup(true); document.getElementById('confirmCancel').onclick=()=>cleanup(false);
                    d.classList.remove('hidden'); requestAnimationFrame(()=>{d.classList.remove('opacity-0'); box.classList.add('scale-100');});
                });
            }
        };

        const DefaultCategories = [
            { id: 'Comida', icon: 'ph-hamburger', color: 'text-orange-400' },
            { id: 'Transporte', icon: 'ph-car', color: 'text-blue-400' },
            { id: 'Casa', icon: 'ph-house', color: 'text-purple-400' },
            { id: 'Servicios', icon: 'ph-lightning', color: 'text-yellow-400' },
            { id: 'Compras', icon: 'ph-shopping-bag', color: 'text-pink-400' },
            { id: 'Salud', icon: 'ph-heartbeat', color: 'text-red-400' },
            { id: 'Super', icon: 'ph-basket', color: 'text-green-400' },
            { id: 'Ajuste', icon: 'ph-scales', color: 'text-zinc-300' },
            { id: 'Otro', icon: 'ph-dots-three-circle', color: 'text-gray-400' }
        ];

        window.app = {
            user: null,
            data: { fixed: [], nextPayDate: null, nextPayAmount: 0 },
            logs: [],
            searchQuery: '',
            filterDate: null,
            currentBalance: 0,
            
            async init() {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        this.user = u; 
                        document.getElementById('userName').textContent = u.displayName || 'Usuario';
                        document.getElementById('userStatusText').textContent = 'Sincronizado'; document.getElementById('userStatusText').className = 'text-[10px] text-red-500 font-bold';
                        document.getElementById('syncStatus').classList.add('bg-red-600');
                        document.getElementById('authModal').classList.remove('active');
                        this.setupListeners();
                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if(token) await signInWithCustomToken(auth, token); else document.getElementById('authModal').classList.add('active');
                    }
                });
            },
            redirectToAuth() { signInAnonymously(auth); },
            logout() { if(confirm("¿Salir?")) signOut(auth).then(() => window.location.reload()); },
            
            setupListeners() {
                const uid = this.user.uid;
                
                // MAPPED PATHS as requested (Safe structure)
                // Maps to: users/{uid}/finance/data (for user settings)
                // Maps to: users/{uid}/finance/data/transactions (for logs)
                
                const userRef = doc(db, 'artifacts', APP_ID, 'users', uid, 'finance', 'data');
                const logsRef = collection(db, 'artifacts', APP_ID, 'users', uid, 'finance', 'data', 'transactions');
                
                onSnapshot(userRef, (snap) => {
                    if(snap.exists()) {
                        this.data = { fixed: [], nextPayDate: null, nextPayAmount: 0, ...snap.data() };
                        this.renderFixed();
                        this.calcBalance();
                    } else setDoc(userRef, { fixed: [] });
                });

                const q = query(logsRef, orderBy('date', 'desc'), limit(1500));
                onSnapshot(q, (snap) => {
                    this.logs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date));
                    this.calcBalance();
                    this.renderTransactions();
                });
            },

            calcBalance() {
                let total = 0;
                let mIncome = 0;
                let mExpense = 0;
                
                const now = new Date();
                const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const mStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const mEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

                this.logs.forEach(l => {
                    if(l.type === 'income') total += l.amount; else total -= l.amount;
                    // Monthly stats
                    const d = new Date(l.date);
                    if (d >= mStart && d <= mEnd) {
                        if(l.type === 'income' && l.category !== 'Ajuste') mIncome += l.amount;
                        else if (l.type === 'expense' && l.category !== 'Ajuste') mExpense += l.amount;
                    }
                });

                this.currentBalance = total;
                document.getElementById('realBalanceDisplay').textContent = UI.fmtMoney(total);
                
                // --- DAILY LIMIT LOGIC ---
                let reserved = 0;
                let dailyAvailable = 0;
                let labelText = "Disponible Hoy";
                
                if (this.data.nextPayDate) {
                    const payDate = new Date(this.data.nextPayDate + 'T00:00:00');
                    const diffTime = payDate - todayMidnight;
                    const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    document.getElementById('nextPayDateDisplay').innerHTML = `${payDate.toLocaleDateString('es-MX', {day:'numeric', month:'short'})} <span class="text-xs text-zinc-500 font-normal">(${daysLeft} días)</span>`;
                    document.getElementById('daysLeftBadge').classList.remove('hidden');
                    document.getElementById('daysLeftBadge').textContent = daysLeft <= 0 ? '¡Es Hoy!' : `${daysLeft} Días`;
                    
                    if (daysLeft > 0) {
                        const checkDate = new Date(todayMidnight);
                        while (checkDate <= payDate) {
                            const dayNum = checkDate.getDate();
                            const monthNum = checkDate.getMonth();
                            const yearNum = checkDate.getFullYear();
                            (this.data.fixed || []).forEach(f => {
                                if (parseInt(f.day) === dayNum) {
                                    const isPaid = this.logs.some(l => {
                                        const ld = new Date(l.date);
                                        return ld.getDate() === dayNum && ld.getMonth() === monthNum && ld.getFullYear() === yearNum && 
                                               (l.meta_related_fixed === f.name || (l.desc && l.desc.includes(f.name)));
                                    });
                                    if (!isPaid) reserved += parseFloat(f.amount);
                                }
                            });
                            checkDate.setDate(checkDate.getDate() + 1);
                        }
                        const virtualBalance = total - reserved;
                        dailyAvailable = virtualBalance / daysLeft;
                    } else {
                        dailyAvailable = total;
                        labelText = "Saldo Total (Llegó el día)";
                    }
                } else {
                    document.getElementById('nextPayDateDisplay').textContent = "Definir Fecha";
                    document.getElementById('daysLeftBadge').classList.add('hidden');
                    dailyAvailable = total;
                    labelText = "Saldo Total";
                }

                document.getElementById('mainCardLabel').textContent = labelText;
                document.getElementById('mainAmountDisplay').textContent = UI.fmtMoney(dailyAvailable);
                document.getElementById('reservedFixedDisplay').textContent = reserved > 0 ? `-${UI.fmtMoney(reserved)}` : '$0.00';
                
                const mainDisplay = document.getElementById('mainAmountDisplay');
                if (dailyAvailable < 0) mainDisplay.className = 'text-5xl xs:text-6xl font-black text-red-500 tracking-tighter mb-6 break-all relative leading-none animate-pulse';
                else mainDisplay.className = 'text-5xl xs:text-6xl font-black text-white tracking-tighter mb-6 break-all relative leading-none';

                this.checkFixedAlerts(mStart, mEnd);
            },

            checkFixedAlerts(mStart, mEnd) {
                const today = new Date().getDate();
                const container = document.getElementById('fixedAlertContainer');
                container.innerHTML = '';
                container.classList.add('hidden');

                const pendingToday = [];
                (this.data.fixed || []).forEach(f => {
                    if (parseInt(f.day) === today) {
                        const isPaid = this.logs.some(l => {
                            const d = new Date(l.date);
                            return d >= mStart && d <= mEnd && (l.meta_related_fixed === f.name || (l.desc && l.desc.includes(f.name)));
                        });
                        if (!isPaid) pendingToday.push(f);
                    }
                });

                if (pendingToday.length > 0) {
                    container.classList.remove('hidden');
                    container.innerHTML = pendingToday.map(f => `
                        <div class="bg-red-600/20 border border-red-500/50 p-4 rounded-2xl flex items-center justify-between mb-2 animate-pulse-slow">
                            <div class="flex items-center gap-3">
                                <i class="ph-fill ph-bell-ringing text-red-400 text-xl"></i>
                                <div>
                                    <div class="text-xs text-red-300 font-bold uppercase">HOY TOCA PAGAR</div>
                                    <div class="text-sm font-bold text-white">${f.name}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white">${UI.fmtMoney(f.amount)}</div>
                                <button onclick="app.payFixedByName('${f.name}')" class="text-[10px] bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded mt-1 font-bold">PAGAR YA</button>
                            </div>
                        </div>
                    `).join('');
                }
            },

            payFixedByName(name) {
                const f = this.data.fixed.find(i => i.name === name);
                if(f) {
                     setTimeout(() => {
                         if(confirm(`¿Registrar pago de ${f.name} por ${UI.fmtMoney(f.amount)}?`)) {
                             // Use specific requested path structure
                             addDoc(collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'finance', 'data', 'transactions'), {
                                amount: parseFloat(f.amount),
                                desc: `Pago Fijo: ${f.name}`,
                                category: 'Servicios',
                                type: 'expense',
                                date: new Date().toISOString(),
                                meta_related_fixed: f.name
                            });
                            UI.toast('Pago registrado', 'success');
                         }
                     }, 100);
                }
            },

            renderTransactions() {
                const list = document.getElementById('transactionsList'); list.innerHTML = '';
                let visibleLogs = this.logs;
                
                if(this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    visibleLogs = visibleLogs.filter(l => (l.desc||'').toLowerCase().includes(q) || (l.category||'').toLowerCase().includes(q) || l.amount.toString().includes(q));
                }
                if(this.filterDate) {
                    visibleLogs = visibleLogs.filter(l => {
                        const txDate = new Date(l.date); const [y, m, d] = this.filterDate.split('-').map(Number);
                        return txDate.getFullYear() === y && txDate.getMonth() === m-1 && txDate.getDate() === d;
                    });
                }
                if(!visibleLogs.length) {
                    list.innerHTML = `<div class="text-center py-6 text-zinc-600 text-xs italic">No hay movimientos${this.filterDate || this.searchQuery ? ' para estos filtros.' : '.'}</div>`; return;
                }

                const groups = {};
                visibleLogs.forEach(log => {
                    const date = new Date(log.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    if (!groups[key]) groups[key] = { txs: [], income: 0, expense: 0, date: date };
                    groups[key].txs.push(log);
                    if (log.type === 'income') groups[key].income += log.amount; else groups[key].expense += log.amount;
                });

                Object.keys(groups).sort((a, b) => b.localeCompare(a)).forEach(dateKey => {
                    const g = groups[dateKey];
                    const dayName = g.date.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month:'short' });
                    list.innerHTML += `
                        <div class="flex justify-between items-center px-2 mt-6 mb-2 border-b border-white/5 pb-1">
                            <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest">${dayName}</h3>
                            <div class="flex gap-2 text-[10px] font-mono font-bold">
                                ${g.income>0 ? `<span class="text-red-500">+${UI.fmtMoney(g.income)}</span>` : ''}
                                ${g.expense>0 ? `<span class="text-zinc-500">-${UI.fmtMoney(g.expense)}</span>` : ''}
                            </div>
                        </div>
                        <div class="space-y-1">
                            ${g.txs.map(l => {
                                const isInc = l.type === 'income';
                                const cat = DefaultCategories.find(c=>c.id === l.category) || {icon:'ph-question',color:'text-gray-500'};
                                const icon = isInc ? 'ph-arrow-down-left' : cat.icon;
                                const color = isInc ? 'text-red-500' : cat.color;
                                return `
                                <div onclick="app.openModal('${isInc?'extra':'expense'}','${l.id}')" class="flex justify-between items-center p-3 rounded-xl hover:bg-zinc-900/50 transition-colors cursor-pointer border border-transparent hover:border-zinc-800 group active:scale-[0.99] md:bg-zinc-900/20">
                                    <div class="flex items-center gap-3 overflow-hidden">
                                        <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0"><i class="ph-fill ${icon} ${color} text-xl"></i></div>
                                        <div class="min-w-0">
                                            <h4 class="font-bold text-zinc-300 text-sm truncate">${l.desc || l.category}</h4>
                                            <p class="text-[10px] text-zinc-500">${new Date(l.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p>
                                        </div>
                                    </div>
                                    <span class="font-bold text-base ${isInc?'text-red-500':'text-zinc-300'}">${isInc?'+':'-'}${UI.fmtMoney(l.amount)}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                });
            },

            renderFixed() {
                const el = document.getElementById('fixedExpensesList'); el.innerHTML='';
                const sorted = (this.data.fixed || []).sort((a,b)=>a.day-b.day);
                if(sorted.length === 0) { el.innerHTML = '<div class="text-center py-8 text-zinc-600 italic text-xs">Sin gastos fijos configurados</div>'; return; }
                
                const today = new Date().getDate();

                sorted.forEach((f,i) => {
                    const isToday = parseInt(f.day) === today;
                    el.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-zinc-900/50 border ${isToday ? 'border-red-500/50 bg-red-900/10' : 'border-zinc-800'} rounded-2xl mb-2 active:scale-[0.99] transition-transform" onclick="app.openModal('fixed', ${i})">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center font-bold text-sm text-zinc-400 border border-zinc-700">
                                ${f.day}
                            </div>
                            <div>
                                <div class="font-bold text-sm text-zinc-200">${f.name}</div>
                                <div class="text-xs text-zinc-500">${UI.fmtMoney(f.amount)}</div>
                            </div>
                        </div>
                        ${isToday ? '<span class="text-[10px] font-bold text-red-400 uppercase tracking-widest bg-red-900/30 px-2 py-1 rounded">Hoy</span>' : ''}
                    </div>`;
                });
            },

            openModal(type, id=null) {
                this.modalType = type; this.editId = id;
                document.querySelectorAll('#modalSheet > div[id^="form"]').forEach(d => d.classList.add('hidden'));
                document.getElementById('modalOverlay').classList.add('is-open');
                const title = document.getElementById('modalTitle');
                
                document.getElementById('categorySelectionContainer').classList.remove('hidden');

                if(type === 'expense' || type === 'extra' || type === 'adjustment') {
                    document.getElementById('formTransaction').classList.remove('hidden');
                    if (type === 'expense') title.textContent = 'Gasto';
                    else if (type === 'extra') title.textContent = 'Ingreso';
                    else if (type === 'adjustment') { title.textContent = 'Ajustar Saldo'; document.getElementById('categorySelectionContainer').classList.add('hidden'); }
                    
                    const chips = document.getElementById('categoryChips');
                    chips.innerHTML = DefaultCategories.map(c => `
                        <div onclick="app.selCat(this)" class="chip bg-zinc-900 px-4 py-2 rounded-full text-xs font-bold text-zinc-400 cursor-pointer border border-zinc-800 hover:border-zinc-600 flex items-center gap-2">
                            <i class="ph-fill ${c.icon} ${c.color}"></i> <span>${c.id}</span>
                        </div>
                    `).join('');

                    const log = id ? this.logs.find(l=>l.id===id) : null;
                    document.getElementById('txAmount').value = log ? log.amount : '';
                    document.getElementById('txDesc').value = log ? log.desc : '';
                    
                    let dateVal = new Date().toISOString().split('T')[0];
                    if (log) { const d = new Date(log.date); dateVal = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
                    document.getElementById('txDate').value = dateVal;
                    
                    document.getElementById('btnDeleteTx').classList.toggle('hidden', !log);
                    
                    if (type === 'adjustment') {
                        document.getElementById('txAmount').placeholder = "Saldo Real";
                        document.getElementById('txDesc').placeholder = "Motivo (Opcional)";
                    } else {
                        document.getElementById('txAmount').placeholder = "0";
                        document.getElementById('txDesc').placeholder = "Nota...";
                    }

                    if(log) { setTimeout(()=> { Array.from(chips.children).find(c => c.querySelector('span')?.textContent.trim() === log.category)?.classList.add('active'); }, 50); }
                    else if (type === 'expense') { setTimeout(()=> { chips.children[0]?.classList.add('active') }, 50); }
                } 
                else if (type === 'fixed') {
                    document.getElementById('formFixed').classList.remove('hidden'); title.textContent = 'Gasto Fijo';
                    const rawFixed = this.data.fixed || [];
                    const sortedFixed = [...rawFixed].sort((a,b)=>a.day-b.day);
                    const selected = id !== null ? sortedFixed[id] : {};
                    this.realEditIndex = id !== null ? rawFixed.indexOf(selected) : null;

                    document.getElementById('fixName').value = selected.name||''; 
                    document.getElementById('fixAmount').value=selected.amount||''; 
                    document.getElementById('fixDay').value=selected.day||'';
                    document.getElementById('btnDeleteFix').classList.toggle('hidden', id===null);
                }
                else if (type === 'nextpay') {
                    document.getElementById('formNextPay').classList.remove('hidden');
                    title.textContent = 'Configurar Fecha';
                    document.getElementById('categorySelectionContainer').classList.add('hidden');
                    document.getElementById('nextPayDateInput').value = this.data.nextPayDate || '';
                    document.getElementById('nextPayAmountInput').value = this.data.nextPayAmount || '';
                }
            },

            closeModal() { document.getElementById('modalOverlay').classList.remove('is-open'); },
            selCat(el) { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); },
            
            async saveTransaction() {
                const amtVal = parseFloat(document.getElementById('txAmount').value);
                const desc = document.getElementById('txDesc').value;
                const catEl = document.querySelector('.chip.active');
                let cat = catEl ? catEl.innerText.trim() : 'Otro';
                const dateVal = document.getElementById('txDate').value;
                
                if(isNaN(amtVal)) return UI.toast('Monto inválido','error');
                if(!dateVal) return UI.toast('Fecha requerida','error');

                const [y, m, d] = dateVal.split('-').map(Number);
                const now = new Date();
                const finalDate = new Date(y, m-1, d, now.getHours(), now.getMinutes());
                const payload = { desc, date: finalDate.toISOString() };

                if (this.modalType === 'adjustment') {
                    const diff = amtVal - this.currentBalance;
                    if (Math.abs(diff) < 0.01) return UI.toast('El saldo ya es correcto', 'info');
                    payload.amount = Math.abs(diff);
                    payload.type = diff > 0 ? 'income' : 'expense';
                    payload.category = 'Ajuste';
                    payload.desc = desc || 'Ajuste Manual';
                } else {
                    payload.amount = amtVal;
                    payload.category = cat;
                    payload.type = this.modalType === 'extra' ? 'income' : 'expense';
                }

                // --- SAVE TO NEW NESTED PATH ---
                const ref = collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'finance', 'data', 'transactions');
                if(this.editId) await updateDoc(doc(ref, this.editId), payload);
                else await addDoc(ref, payload);
                
                UI.toast(this.modalType === 'adjustment' ? 'Saldo Ajustado' : 'Guardado', 'success');
                this.closeModal();
            },

            async saveFixed() {
                const arr = [...(this.data.fixed||[])];
                const item = { 
                    name: document.getElementById('fixName').value, 
                    amount: parseFloat(document.getElementById('fixAmount').value), 
                    day: parseInt(document.getElementById('fixDay').value) 
                };
                if (!item.name || isNaN(item.amount) || isNaN(item.day)) return UI.toast('Datos incompletos', 'error');

                if(this.realEditIndex !== null && this.realEditIndex !== -1) arr[this.realEditIndex] = item; 
                else arr.push(item);
                
                // --- SAVE TO NEW NESTED PATH ---
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'finance','data'),{fixed:arr});
                this.closeModal(); UI.toast('Fijo guardado','success');
            },
            
            async saveNextPayData() {
                const date = document.getElementById('nextPayDateInput').value;
                const amount = parseFloat(document.getElementById('nextPayAmountInput').value) || 0;
                if (!date) return UI.toast('Fecha requerida', 'error');
                // --- SAVE TO NEW NESTED PATH ---
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'finance','data'),{ nextPayDate: date, nextPayAmount: amount });
                this.closeModal(); UI.toast('Fecha configurada', 'success');
            },
            
            async clearNextPayData() {
                // --- SAVE TO NEW NESTED PATH ---
                await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'finance','data'),{ nextPayDate: null, nextPayAmount: 0 });
                this.closeModal(); UI.toast('Modo libre activado', 'info');
            },

            async deleteFixedConfirm() { 
                if(await UI.confirm('Borrar','¿Eliminar gasto fijo?')) { 
                    const arr = (this.data.fixed||[]).filter((_,i)=>i!==this.realEditIndex); 
                    // --- SAVE TO NEW NESTED PATH ---
                    await updateDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'finance','data'),{fixed:arr}); 
                    this.closeModal(); 
                } 
            },
            async deleteTxConfirm() { 
                if(await UI.confirm('Borrar','¿Eliminar esta transacción?')) { 
                    // --- DELETE FROM NEW NESTED PATH ---
                    await deleteDoc(doc(db,'artifacts',APP_ID,'users',this.user.uid,'finance','data','transactions',this.editId)); 
                    this.closeModal(); 
                } 
            },
            async resetData() {
                 if(await UI.confirm('RESET TOTAL','Se borrarán TODOS los datos.')) {
                     const uid = this.user.uid; const batch = writeBatch(db);
                     // --- RESET NEW NESTED PATHS ---
                     batch.set(doc(db,'artifacts',APP_ID,'users',uid,'finance','data'), {fixed:[]});
                     const q = await getDocs(collection(db,'artifacts',APP_ID,'users',uid,'finance','data','transactions'));
                     q.forEach(d => batch.delete(d.ref));
                     await batch.commit(); window.location.reload();
                 }
            },
            switchView(v, btnRef) {
                document.querySelectorAll('section[id^="view-"]').forEach(s => s.classList.add('hidden'));
                document.getElementById('view-'+v).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                if(btnRef) btnRef.classList.add('active');
                document.querySelectorAll('.nav-link-desk').forEach(b => b.classList.toggle('active', b.dataset.view === v));
                document.getElementById('fabContainer').classList.toggle('scale-0', v !== 'balance');
            },
            filterTransactions() { this.searchQuery = document.getElementById('searchTx').value; this.renderTransactions(); },
            setFilterDate(d) { this.filterDate = d; document.getElementById('dateFilterDisplay').classList.remove('hidden'); document.getElementById('dateFilterDisplay').classList.add('flex'); document.getElementById('dateFilterLabel').textContent = "Filtro: " + d; this.renderTransactions(); },
            clearDateFilter() { this.filterDate = null; document.getElementById('dateFilterDisplay').classList.add('hidden'); document.getElementById('dateFilterDisplay').classList.remove('flex'); this.renderTransactions(); }
        };
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
