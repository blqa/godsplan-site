<!DOCTYPE html>
<html lang="es" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Ticket System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: {
                        brand: '#E70000',
                        status: {
                            unassigned: '#ef4444', // Rojo
                            pending: '#eab308',    // Amarillo
                            resolved: '#22c55e'    // Verde
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }
        
        .glass-nav { backdrop-filter: blur(12px); border-bottom: 1px solid; }
        .dark .glass-nav { background: rgba(9, 9, 11, 0.85); border-color: rgba(255,255,255,0.05); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); border-color: rgba(0,0,0,0.05); }

        .action-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn:active { transform: scale(0.95); }
        
        /* Animaciones de estado */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .badge-pulse { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Estilos para pestañas del modal */
        .tab-active { border-bottom-color: #E70000; color: #E70000; background-color: rgba(231, 0, 0, 0.05); }
        .tab-inactive { border-bottom-color: transparent; color: #9ca3af; }
        .dark .tab-inactive { color: #52525b; }
        .tab-inactive:hover { color: #374151; }
        .dark .tab-inactive:hover { color: #d4d4d8; }
    </style>
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden bg-gray-50 text-gray-900 dark:bg-[#09090b] dark:text-gray-200">

    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- HEADER -->
    <header class="h-16 glass-nav sticky top-0 z-50 flex items-center justify-between px-4 lg:px-8 shadow-sm dark:shadow-none transition-colors">
        <div class="flex items-center gap-6">
            <a href="/" class="flex items-center gap-3 font-black tracking-tighter text-lg group">
                <div class="w-8 h-8 bg-brand rounded flex items-center justify-center shadow-lg shadow-brand/20 group-hover:scale-105 transition-transform">
                    <i class="ph-bold ph-strategy text-white"></i>
                </div>
                <span class="dark:text-white text-gray-900 tracking-tight">WAR ROOM</span>
            </a>
            <!-- Estadísticas rápidas -->
            <div class="hidden lg:flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider text-gray-500">
                <div class="px-2 py-1 rounded bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400">
                    <span id="stat-unassigned">0</span> Libres
                </div>
                <div class="px-2 py-1 rounded bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400">
                    <span id="stat-pending">0</span> En Proceso
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="window.app.toggleTheme()" class="w-9 h-9 rounded-full bg-gray-200 dark:bg-zinc-800 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors">
                <i id="theme-icon" class="ph-bold ph-moon"></i>
            </button>
            <button onclick="window.app.toggleImportModal()" class="action-btn bg-gray-900 dark:bg-white text-white dark:text-black hover:bg-brand dark:hover:bg-brand hover:text-white dark:hover:text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center gap-2 shadow-lg">
                <i class="ph-bold ph-plus"></i> <span class="hidden sm:inline">Nuevo Caso</span>
            </button>
            <div id="user-pill" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-gray-200 dark:bg-zinc-900 rounded-lg border border-gray-300 dark:border-zinc-800">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span id="username-display" class="text-xs font-bold text-gray-700 dark:text-zinc-300">...</span>
            </div>
        </div>
    </header>

    <!-- CONTROLS & FILTERS -->
    <div class="sticky top-16 z-40 bg-white/80 dark:bg-[#09090b]/95 backdrop-blur-sm border-b border-gray-200 dark:border-zinc-800 py-3 px-4 lg:px-8 shadow-sm">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            
            <!-- Main State Filters -->
            <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto no-scrollbar pb-1 md:pb-0">
                <button id="filter-unassigned" onclick="window.app.setFilter('unassigned')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500"></div> Sin Asignar
                </button>
                <button id="filter-mine" onclick="window.app.setFilter('mine')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div> Mis Pendientes
                </button>
                <button id="filter-resolved" onclick="window.app.setFilter('resolved')" class="action-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase border flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div> Resueltos
                </button>
                <div class="h-4 w-px bg-gray-300 dark:bg-zinc-700 mx-1"></div>
                <button id="filter-all" onclick="window.app.setFilter('all')" class="action-btn px-3 py-1.5 rounded-full text-xs font-bold uppercase border text-gray-500">Todos</button>
            </div>

            <!-- Search -->
            <div class="relative w-full md:w-80 group">
                <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand transition-colors"></i>
                <input type="text" id="search-input" onkeyup="window.app.handleSearch(this.value)" class="block w-full pl-9 pr-3 py-2 bg-gray-100 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand transition-all" placeholder="Buscar cliente, teléfono...">
            </div>
        </div>
    </div>

    <!-- MAIN GRID -->
    <main class="flex-grow p-4 lg:p-6 w-full max-w-7xl mx-auto">
        <div id="cases-grid" class="grid grid-cols-1 gap-4">
            <!-- Loader -->
            <div class="col-span-1 flex flex-col items-center justify-center h-64 text-gray-400 dark:text-zinc-600">
                <i class="ph-duotone ph-spinner-gap text-4xl animate-spin mb-3 text-brand"></i>
                <span class="text-xs font-mono uppercase tracking-widest">Sincronizando War Room...</span>
            </div>
        </div>
    </main>

    <!-- NEW HYBRID MODAL -->
    <div id="import-modal" class="fixed inset-0 z-[100] bg-black/50 dark:bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-all duration-200 opacity-0">
        <div class="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 w-full max-w-xl rounded-2xl shadow-2xl transform scale-95 transition-all duration-200 flex flex-col overflow-hidden" id="import-modal-content">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 dark:border-zinc-800 flex justify-between items-center bg-gray-50 dark:bg-zinc-950">
                <h3 class="font-black text-lg text-gray-900 dark:text-white flex items-center gap-2"><i class="ph-fill ph-plus-circle text-brand"></i> NUEVO CASO</h3>
                <button onclick="window.app.toggleImportModal()" class="text-gray-400 hover:text-red-500 p-2 rounded-lg transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-100 dark:border-zinc-800">
                <button onclick="window.app.setTab('auto')" id="tab-auto" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active">Automático (Pegar)</button>
                <button onclick="window.app.setTab('manual')" id="tab-manual" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive">Manual</button>
            </div>

            <div class="p-6 relative">
                <!-- VISTA AUTOMÁTICA -->
                <div id="view-auto" class="transition-all duration-300">
                    <div class="mb-4 text-xs text-gray-500 dark:text-zinc-400 flex items-start gap-2">
                        <i class="ph-bold ph-magic-wand text-brand mt-0.5"></i>
                        Pega el texto crudo (ej: WhatsApp, Email). El sistema extraerá teléfonos y nombres.
                    </div>
                    <textarea id="raw-input" class="w-full h-40 bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-700 rounded-xl p-4 text-sm font-mono text-gray-900 dark:text-zinc-300 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand/50 resize-none mb-6 placeholder:text-gray-400 dark:placeholder:text-zinc-700" placeholder="Ej: Cliente Juan Perez 5512345678 problema con pantalla..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.app.processInput('smartwatch')" class="p-3 rounded-xl border border-gray-200 dark:border-zinc-800 hover:border-sky-500 bg-white dark:bg-zinc-950 hover:bg-sky-50 dark:hover:bg-sky-900/10 transition-all text-left group">
                            <span class="text-sky-500 font-black text-xs flex items-center gap-2 mb-1"><i class="ph-fill ph-watch"></i> SMARTWATCH</span>
                            <span class="text-[10px] text-gray-400">Procesar como soporte SW</span>
                        </button>
                        <button onclick="window.app.processInput('general')" class="p-3 rounded-xl border border-gray-200 dark:border-zinc-800 hover:border-yellow-500 bg-white dark:bg-zinc-950 hover:bg-yellow-50 dark:hover:bg-yellow-900/10 transition-all text-left group">
                            <span class="text-yellow-500 font-black text-xs flex items-center gap-2 mb-1"><i class="ph-fill ph-globe"></i> GENERAL</span>
                            <span class="text-[10px] text-gray-400">Procesar como ventas/dudas</span>
                        </button>
                    </div>
                </div>

                <!-- VISTA MANUAL -->
                <div id="view-manual" class="hidden transition-all duration-300 flex flex-col gap-4">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-zinc-500 mb-1 block">Nombre del Cliente</label>
                        <input type="text" id="man-name" class="w-full bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-800 rounded-lg p-2.5 text-sm font-bold text-gray-900 dark:text-white focus:outline-none focus:border-brand uppercase" placeholder="Ej: JUAN PEREZ">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-zinc-500 mb-1 block">Tel. Contacto</label>
                            <input type="text" id="man-contact" class="w-full bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-800 rounded-lg p-2.5 text-sm font-mono text-gray-900 dark:text-white focus:outline-none focus:border-brand" placeholder="Llamar a...">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-zinc-500 mb-1 block">Tel. Afectado (Opcional)</label>
                            <input type="text" id="man-affected" class="w-full bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-800 rounded-lg p-2.5 text-sm font-mono text-gray-900 dark:text-white focus:outline-none focus:border-brand" placeholder="Línea con falla...">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-zinc-500 mb-1 block">Tipo de Caso</label>
                        <select id="man-type" class="w-full bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-800 rounded-lg p-2.5 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-brand">
                            <option value="smartwatch">Smartwatch (Soporte)</option>
                            <option value="general">General (Ventas)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-zinc-500 mb-1 block">Descripción del Problema</label>
                        <textarea id="man-desc" rows="3" class="w-full bg-gray-50 dark:bg-black border border-gray-300 dark:border-zinc-800 rounded-lg p-2.5 text-sm text-gray-900 dark:text-zinc-300 focus:outline-none focus:border-brand resize-none" placeholder="Detalles del caso..."></textarea>
                    </div>

                    <button onclick="window.app.saveManual()" class="w-full py-3 bg-brand hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-brand/20 transition-all uppercase text-sm mt-2">
                        Crear Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            signInAnonymously,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE ENTORNO UNIFICADA ---
        const fallbackConfig = { 
            apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", 
            authDomain: "god-s-plan-d737b.firebaseapp.com", 
            projectId: "god-s-plan-d737b", 
            storageBucket: "god-s-plan-d737b.firebasestorage.app", 
            messagingSenderId: "458198314028", 
            appId: "1:458198314028:web:d62b24cee2d19ee5b47589" 
        };
        
        let firebaseConfig = fallbackConfig;
        
        try { 
            if (typeof __firebase_config !== 'undefined' && __firebase_config) { 
                const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; 
                if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; 
            } 
        } catch(e) { console.error("Error cargando config:", e); }
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // ** SOLUCIÓN CLAVE SSO: Persistencia Local **
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-default';

        let currentUser = null;
        let casesData = [];
        let currentFilter = 'unassigned';
        let searchTerm = '';

        // --- UI UTILS ---
        const toast = (msg, type = 'success') => {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-500 text-white' : (type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white');
            el.className = `${colors} px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 text-sm font-bold animate-toastIn pointer-events-auto`;
            el.innerHTML = `<i class="ph-bold ${type === 'success' ? 'ph-check' : (type === 'error' ? 'ph-warning' : 'ph-info')}"></i> ${msg}`;
            c.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300) }, 3000);
        };

        const timeAgo = (date) => {
            if (!date) return 'Hace un momento';
            const seconds = Math.floor((new Date() - date.toDate()) / 1000);
            if (seconds < 60) return 'Hace unos seg';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} h`;
            return `${Math.floor(hours / 24)} d`;
        };

        const formatTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // --- AUTH & DATA ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('username-display').textContent = (user.displayName || 'AGENTE').toUpperCase();
                initRealtime();
            }
        });

        function initRealtime() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'tickets');
            onSnapshot(q, (snap) => {
                casesData = [];
                snap.forEach(d => casesData.push({ id: d.id, ...d.data() }));
                
                // Actualizar contadores
                const unassignedCount = casesData.filter(c => c.status === 'unassigned').length;
                const pendingCount = casesData.filter(c => c.status === 'pending').length;
                document.getElementById('stat-unassigned').textContent = unassignedCount;
                document.getElementById('stat-pending').textContent = pendingCount;
                
                // Ordenar: Pendientes urgentes primero
                casesData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            }, (error) => {
                console.error("Error fetching tickets:", error);
            });
        }

        // --- APP LOGIC ---
        window.app = {
            toggleTheme: () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
                document.getElementById('theme-icon').className = isDark ? 'ph-bold ph-sun' : 'ph-bold ph-moon';
            },

            toggleImportModal: () => {
                const m = document.getElementById('import-modal');
                const c = document.getElementById('import-modal-content');
                if (m.classList.contains('hidden')) {
                    m.classList.remove('hidden');
                    setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); }, 10);
                    // Reset to Auto Tab by default
                    window.app.setTab('auto');
                } else {
                    m.classList.add('opacity-0'); c.classList.add('scale-95');
                    setTimeout(() => m.classList.add('hidden'), 200);
                }
            },

            setTab: (tabName) => {
                const btnAuto = document.getElementById('tab-auto');
                const btnMan = document.getElementById('tab-manual');
                const viewAuto = document.getElementById('view-auto');
                const viewMan = document.getElementById('view-manual');

                if (tabName === 'auto') {
                    btnAuto.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active";
                    btnMan.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive";
                    viewAuto.classList.remove('hidden');
                    viewMan.classList.add('hidden');
                    document.getElementById('raw-input').focus();
                } else {
                    btnAuto.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-inactive";
                    btnMan.className = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 transition-all tab-active";
                    viewAuto.classList.add('hidden');
                    viewMan.classList.remove('hidden');
                    document.getElementById('man-name').focus();
                }
            },

            setFilter: (f) => {
                currentFilter = f;
                render();
            },

            handleSearch: (val) => {
                searchTerm = val.toLowerCase();
                render();
            },

            // AUTOMATIC IMPORT
            processInput: async (type) => {
                const text = document.getElementById('raw-input').value;
                if(!text.trim()) return toast('El campo está vacío', 'error');
                
                const chunks = text.split(/(?:plis|\n{2,})/i).map(c => c.trim()).filter(c => c.length > 5);
                let added = 0;
                
                for (const chunk of chunks) {
                    const phones = chunk.match(/\b\d{10}\b/g) || [];
                    let name = chunk.split(phones[0] || '')[0].replace(/[:.-]/g, ' ').trim().substring(0, 30);
                    if(!name || name.length < 3) name = "Cliente Desconocido";

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tickets'), {
                        type,
                        rawText: chunk,
                        clientName: name.toUpperCase(),
                        contactPhone: phones[0] || '',
                        phones,
                        description: chunk,
                        status: 'unassigned',
                        assignedTo: null,
                        comments: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    added++;
                }
                
                toast(`${added} Tickets Creados`);
                document.getElementById('raw-input').value = '';
                window.app.toggleImportModal();
            },

            // MANUAL IMPORT
            saveManual: async () => {
                const name = document.getElementById('man-name').value.trim();
                const contact = document.getElementById('man-contact').value.trim();
                const affected = document.getElementById('man-affected').value.trim();
                const type = document.getElementById('man-type').value;
                const desc = document.getElementById('man-desc').value.trim();

                if (!name) return toast('El nombre es obligatorio', 'error');
                if (!contact && !affected) return toast('Ingresa al menos un teléfono', 'error');
                if (!desc) return toast('La descripción es obligatoria', 'error');

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tickets'), {
                        type,
                        rawText: 'Creado manualmente',
                        clientName: name.toUpperCase(),
                        contactPhone: contact,
                        affectedPhone: affected,
                        phones: [contact, affected].filter(p => p),
                        description: desc,
                        status: 'unassigned',
                        assignedTo: null,
                        comments: [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    
                    toast('Ticket creado con éxito');
                    
                    // Clear fields
                    document.getElementById('man-name').value = '';
                    document.getElementById('man-contact').value = '';
                    document.getElementById('man-affected').value = '';
                    document.getElementById('man-desc').value = '';
                    
                    window.app.toggleImportModal();
                } catch (e) {
                    console.error(e);
                    toast('Error al guardar', 'error');
                }
            },

            // CASE ACTIONS
            claim: async (id) => {
                if(!currentUser) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                        status: 'pending',
                        assignedTo: { uid: currentUser.uid, name: currentUser.displayName || 'Agente' },
                        updatedAt: serverTimestamp(),
                        comments: arrayUnion({ type: 'system', text: 'tomó el caso', author: currentUser.displayName || 'Agente', time: Date.now() })
                    });
                    toast('Caso asignado a ti');
                } catch(e) { toast('Error al asignar', 'error'); }
            },

            release: async (id) => {
                if(!confirm("¿Soltar este caso?")) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                    status: 'unassigned',
                    assignedTo: null,
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: 'liberó el caso', author: currentUser.displayName, time: Date.now() })
                });
                toast('Caso liberado');
            },

            resolve: async (id) => {
                if(!confirm("¿Marcar como resuelto?")) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                    status: 'resolved',
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: 'marcó como resuelto', author: currentUser.displayName, time: Date.now() })
                });
                toast('Caso Resuelto', 'success');
            },

            reopen: async (id) => {
                if(!confirm("¿Reabrir caso?")) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                    status: 'pending',
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion({ type: 'system', text: 'reabrió el caso', author: currentUser.displayName, time: Date.now() })
                });
                toast('Caso Reabierto');
            },

            addComment: async (id, inputId) => {
                const input = document.getElementById(inputId);
                const txt = input.value.trim();
                if(!txt) return;
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                    comments: arrayUnion({ type: 'user', text: txt, author: currentUser.displayName?.split(' ')[0] || 'Yo', time: Date.now() })
                });
                input.value = '';
            },

            // --- INTERACTION LOGS ---
            toggleSuccessInput: (id) => {
                const el = document.getElementById(`success-input-${id}`);
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) document.getElementById(`comment-success-${id}`).focus();
            },

            logInteraction: async (id, type) => {
                let commentText = '';
                
                if (type === 'success') {
                    const input = document.getElementById(`comment-success-${id}`);
                    commentText = input.value.trim();
                    if (!commentText) return toast('Debes agregar un comentario para registro exitoso', 'error');
                    // Hide input again
                    document.getElementById(`success-input-${id}`).classList.add('hidden');
                    input.value = '';
                }

                const logData = {
                    type: 'interaction',
                    subtype: type,
                    text: commentText, // Empty for attempt/failed usually
                    author: currentUser.displayName || 'Agente',
                    time: Date.now()
                };

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id), {
                    updatedAt: serverTimestamp(),
                    comments: arrayUnion(logData)
                });
                
                toast('Interacción registrada');
            },

            delete: async (id) => {
                if(!confirm("¿Eliminar permanentemente?")) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id));
                toast('Eliminado');
            }
        };

        // --- RENDER ---
        function render() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '';

            // Update Filter Buttons Style
            const filters = ['unassigned', 'mine', 'resolved', 'all'];
            filters.forEach(f => {
                const btn = document.getElementById(`filter-${f}`);
                if (btn) {
                    if (currentFilter === f) {
                        btn.classList.add('bg-gray-900', 'dark:bg-white', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.remove('bg-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('bg-gray-900', 'dark:bg-white', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.add('bg-transparent', 'text-gray-500', 'hover:text-gray-900', 'dark:hover:text-white');
                    }
                }
            });

            // Filter Data logic
            let list = casesData;

            if (currentFilter === 'unassigned') {
                list = list.filter(c => c.status === 'unassigned');
            } else if (currentFilter === 'mine') {
                list = list.filter(c => c.status === 'pending' && c.assignedTo?.uid === currentUser?.uid);
            } else if (currentFilter === 'resolved') {
                list = list.filter(c => c.status === 'resolved');
            }

            if (searchTerm) {
                list = list.filter(c => JSON.stringify(c).toLowerCase().includes(searchTerm));
            }

            if (list.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-1 flex flex-col items-center justify-center h-64 opacity-50">
                        <i class="ph-duotone ph-magnifying-glass text-4xl mb-2"></i>
                        <span class="text-sm font-bold uppercase">No hay tickets en esta vista</span>
                    </div>`;
                return;
            }

            list.forEach(c => {
                const isMine = c.assignedTo?.uid === currentUser?.uid;
                
                // Color mapping based on Status
                let statusColor = 'gray';
                let statusLabel = 'DESCONOCIDO';
                let borderColor = 'border-gray-200 dark:border-zinc-800';
                
                if (c.status === 'unassigned') {
                    statusColor = 'red'; statusLabel = 'SIN ASIGNAR';
                    borderColor = 'border-red-200 dark:border-red-900/30 bg-red-50/50 dark:bg-red-950/5';
                } else if (c.status === 'pending') {
                    statusColor = 'yellow'; statusLabel = isMine ? 'MIS PENDIENTES' : `PENDIENTE (${c.assignedTo?.name})`;
                    borderColor = isMine ? 'border-yellow-200 dark:border-yellow-900/30 bg-yellow-50/50 dark:bg-yellow-950/5 ring-1 ring-yellow-400/20' : 'border-gray-200 dark:border-zinc-800 opacity-90';
                } else if (c.status === 'resolved') {
                    statusColor = 'green'; statusLabel = 'RESUELTO';
                    borderColor = 'border-green-200 dark:border-green-900/30 bg-green-50/50 dark:bg-green-950/5 opacity-75';
                }

                const card = document.createElement('div');
                card.className = `group relative rounded-2xl border ${borderColor} p-5 flex flex-col md:flex-row gap-6 transition-all hover:shadow-lg dark:hover:shadow-none bg-white dark:bg-[#0f0f11]`;

                // Badge Logic
                const typeIcon = c.type === 'smartwatch' ? 'ph-watch' : 'ph-globe';
                const typeColor = c.type === 'smartwatch' ? 'text-sky-500' : 'text-orange-500';

                // Phones Display
                let phonesDisplay = c.contactPhone || 'Sin teléfono';
                if (c.affectedPhone && c.affectedPhone !== c.contactPhone) {
                    phonesDisplay += ` <span class="opacity-50 mx-1">|</span> <i class="ph-bold ph-warning-circle text-orange-500"></i> ${c.affectedPhone}`;
                }

                // Comments Logic (System vs User vs Interaction)
                const recentComments = c.comments?.slice().reverse().slice(0, 5).map(co => {
                    const time = formatTime(co.time);
                    
                    if (co.type === 'system') {
                        return `<div class="text-[10px] text-gray-400 italic mb-1 pl-1 border-l-2 border-gray-200 dark:border-zinc-800">
                            <span class="font-bold">${co.author}</span> ${co.text} <span class="opacity-50 text-[9px]">${time}</span>
                        </div>`;
                    }
                    
                    if (co.type === 'interaction') {
                        let icon = 'ph-info';
                        let color = 'text-gray-500';
                        let text = 'Interacción';
                        
                        if (co.subtype === 'attempt') { icon = 'ph-phone-outgoing'; color = 'text-blue-500'; text = 'Intento de Contacto'; }
                        else if (co.subtype === 'failed') { icon = 'ph-x-circle'; color = 'text-red-500'; text = 'No Exitoso'; }
                        else if (co.subtype === 'success') { icon = 'ph-check-circle'; color = 'text-green-500'; text = 'Contacto Exitoso'; }

                        return `<div class="text-[11px] mb-2 bg-gray-50 dark:bg-zinc-900 p-2 rounded border border-dashed border-gray-200 dark:border-zinc-800">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ph-fill ${icon} ${color}"></i>
                                <span class="font-bold text-gray-700 dark:text-zinc-300 uppercase text-[10px]">${text}</span>
                                <span class="ml-auto text-[9px] font-mono text-gray-400">${time}</span>
                            </div>
                            ${co.text ? `<div class="text-gray-600 dark:text-zinc-400 pl-6 border-l-2 border-green-500/20">${co.text}</div>` : ''}
                        </div>`;
                    }

                    // Default User Comment
                    return `<div class="text-[11px] text-gray-600 dark:text-zinc-300 mb-1 bg-gray-100 dark:bg-zinc-800/50 p-2 rounded-lg border border-gray-200 dark:border-zinc-700/50">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="font-bold text-gray-800 dark:text-zinc-200">${co.author}</span>
                            <span class="text-[9px] text-gray-400 font-mono">${time}</span>
                        </div>
                        ${co.text}
                    </div>`;
                }).join('') || '<div class="text-[10px] text-gray-300 italic">Sin actividad reciente</div>';

                // Actions Logic
                let mainAction = '';
                if (c.status === 'unassigned') {
                    mainAction = `<button onclick="window.app.claim('${c.id}')" class="w-full py-2 bg-gray-900 dark:bg-white text-white dark:text-black font-bold text-xs uppercase rounded-lg hover:bg-brand dark:hover:bg-brand hover:text-white dark:hover:text-white transition-colors shadow-lg shadow-black/5">TOMAR CASO</button>`;
                } else if (c.status === 'pending') {
                    if (isMine) {
                        mainAction = `
                            <!-- Interaction Controls for Owner -->
                            <div class="mb-3 p-2 bg-gray-50 dark:bg-zinc-900 rounded-lg border border-dashed border-gray-200 dark:border-zinc-700">
                                <p class="text-[9px] font-bold text-gray-400 uppercase mb-2 tracking-wider">Registrar Interacción</p>
                                <div class="flex gap-1 mb-2">
                                    <button onclick="window.app.logInteraction('${c.id}', 'attempt')" class="flex-1 py-1.5 bg-white dark:bg-black border border-gray-200 dark:border-zinc-800 rounded text-[10px] font-bold text-blue-500 hover:border-blue-500 transition-colors" title="Intento de llamada"><i class="ph-bold ph-phone-outgoing"></i> INTENTO</button>
                                    <button onclick="window.app.logInteraction('${c.id}', 'failed')" class="flex-1 py-1.5 bg-white dark:bg-black border border-gray-200 dark:border-zinc-800 rounded text-[10px] font-bold text-red-500 hover:border-red-500 transition-colors" title="No contestó/Falló"><i class="ph-bold ph-x"></i> FALLIDO</button>
                                    <button onclick="window.app.toggleSuccessInput('${c.id}')" class="flex-1 py-1.5 bg-white dark:bg-black border border-gray-200 dark:border-zinc-800 rounded text-[10px] font-bold text-green-500 hover:border-green-500 transition-colors" title="Contacto Exitoso"><i class="ph-bold ph-check"></i> EXITOSO</button>
                                </div>
                                <div id="success-input-${c.id}" class="hidden animate-fadeIn">
                                    <input type="text" id="comment-success-${c.id}" placeholder="¿Qué acordaron?" class="w-full text-xs bg-white dark:bg-black border border-green-500/30 rounded px-2 py-1 mb-2 focus:outline-none focus:border-green-500">
                                    <button onclick="window.app.logInteraction('${c.id}', 'success')" class="w-full py-1 bg-green-500 text-white text-[10px] font-bold rounded uppercase hover:bg-green-600">Guardar Éxito</button>
                                </div>
                            </div>

                            <div class="flex gap-2">
                                <button onclick="window.app.resolve('${c.id}')" class="flex-1 py-2 bg-green-500 text-white font-bold text-xs uppercase rounded-lg hover:bg-green-600 shadow-lg shadow-green-500/20">RESOLVER</button>
                                <button onclick="window.app.release('${c.id}')" class="px-3 py-2 border border-gray-200 dark:border-zinc-700 text-gray-400 hover:text-red-500 rounded-lg" title="Soltar caso"><i class="ph-bold ph-hand-palm"></i></button>
                            </div>
                        `;
                    } else {
                        // Allow stealing
                        mainAction = `<button onclick="window.app.claim('${c.id}')" class="w-full py-2 border border-brand/50 text-brand font-bold text-xs uppercase rounded-lg hover:bg-brand hover:text-white transition-colors">TOMAR CASO (DE ${c.assignedTo?.name?.split(' ')[0]})</button>`;
                    }
                } else if (c.status === 'resolved') {
                    mainAction = `<button onclick="window.app.reopen('${c.id}')" class="w-full py-2 border border-gray-200 dark:border-zinc-700 text-gray-500 dark:text-zinc-400 font-bold text-xs uppercase rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800">REABRIR CASO</button>`;
                }

                card.innerHTML = `
                    <!-- Left: Info -->
                    <div class="flex-grow min-w-0 flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-${statusColor}-500 bg-${statusColor}-100 dark:bg-${statusColor}-900/20 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider ${c.status === 'unassigned' ? 'badge-pulse' : ''}">${statusLabel}</span>
                                <span class="text-[10px] font-mono text-gray-400">${timeAgo(c.updatedAt || c.createdAt)}</span>
                            </div>
                            <i class="${typeIcon} ${typeColor} text-lg opacity-50"></i>
                        </div>
                        
                        <div>
                            <h3 class="font-black text-xl text-gray-900 dark:text-white leading-tight truncate tracking-tight mb-1">${c.clientName}</h3>
                            <p class="text-xs font-mono text-gray-500 dark:text-zinc-500 select-all">${phonesDisplay}</p>
                        </div>

                        <div class="text-sm text-gray-600 dark:text-zinc-400 leading-relaxed line-clamp-3 hover:line-clamp-none transition-all cursor-help bg-white dark:bg-black/20 p-3 rounded-lg border border-gray-100 dark:border-zinc-800/50">
                            ${c.description}
                        </div>
                    </div>

                    <!-- Right: Chat & Actions -->
                    <div class="flex-grow md:max-w-xs min-w-0 md:border-l border-gray-100 dark:border-zinc-800 md:pl-6 flex flex-col gap-3 justify-between">
                        
                        <!-- Mini Chat History -->
                        <div class="flex-grow flex flex-col gap-1 overflow-hidden">
                            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Actividad Reciente</div>
                            ${recentComments}
                        </div>

                        <!-- Inputs area -->
                        <div class="space-y-3 pt-3 border-t border-gray-100 dark:border-zinc-800">
                            ${c.status !== 'resolved' ? `
                            <div class="relative">
                                <input type="text" id="input-${c.id}" placeholder="Nota rápida..." 
                                    class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-xs text-gray-900 dark:text-white focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all"
                                    onkeypress="if(event.key==='Enter') window.app.addComment('${c.id}', 'input-${c.id}')">
                                <button onclick="window.app.addComment('${c.id}', 'input-${c.id}')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand"><i class="ph-bold ph-paper-plane-right"></i></button>
                            </div>
                            ` : ''}
                            
                            ${mainAction}
                            
                            <div class="flex justify-end pt-1">
                                <button onclick="window.app.delete('${c.id}')" class="text-[10px] text-gray-300 hover:text-red-500 uppercase font-bold flex items-center gap-1 transition-colors"><i class="ph-bold ph-trash"></i> Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        const savedTheme = localStorage.theme;
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').className = 'ph-bold ph-sun';
        }
    </script>
</body>
</html>
