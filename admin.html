<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God's Plan | Panel de Administraci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: {
                        brand: '#E70000',
                        dark: '#050505',
                        panel: '#0A0A0A',
                        surface: '#121212'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e4e4e7; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        /* Animaci√≥n de carga */
        .loader { border: 2px solid rgba(231,0,0,0.1); border-left-color: #E70000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- LOGIN AISLADO (Overlay Bloqueante) -->
    <div id="admin-login-overlay" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-[#0A0A0A] border border-white/10 rounded-2xl p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand to-transparent"></div>
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-brand/5 border border-brand/20 mb-6 shadow-[0_0_30px_rgba(231,0,0,0.1)]">
                    <i class="ph-fill ph-lock-key text-3xl text-brand"></i>
                </div>
                <h1 class="text-2xl font-black text-white tracking-tight">AREA RESTRINGIDA</h1>
                <p class="text-zinc-500 text-sm mt-3 leading-relaxed">
                    Panel de Control Maestro.<br>
                    Acceso exclusivo para <span class="text-white font-mono bg-white/10 px-1 rounded">tizorplayer@gmail.com</span>
                </p>
            </div>
            <div class="space-y-4">
                <div id="login-error" class="text-red-400 text-xs font-bold text-center hidden bg-red-950/30 p-3 rounded-xl border border-red-500/20 flex items-center justify-center gap-2">
                    <i class="ph-bold ph-warning-circle text-lg"></i>
                    <span id="login-error-text">Error de autenticaci√≥n.</span>
                </div>
                <button onclick="adminAuth.login()" id="login-btn" class="w-full bg-white hover:bg-zinc-200 text-black font-bold py-4 rounded-xl transition transform active:scale-95 flex items-center justify-center gap-3 shadow-lg group">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 group-hover:scale-110 transition-transform" alt="Google">
                    <span>ACCEDER CON GOOGLE</span>
                </button>
            </div>
            <div class="mt-8 text-center border-t border-white/5 pt-6">
                <a href="/" class="text-xs text-zinc-600 hover:text-white transition flex items-center justify-center gap-1.5 group">
                    <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Volver al Portal P√∫blico
                </a>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <header class="h-16 border-b border-white/10 bg-black/50 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <a href="/" class="text-white hover:text-brand transition"><i class="ph-bold ph-arrow-left text-xl"></i></a>
            <div class="h-6 w-px bg-white/10"></div>
            <div class="flex items-center gap-2">
                <i class="ph-fill ph-shield-check text-brand text-xl"></i>
                <span class="font-bold tracking-tight text-lg">GOD'S PLAN <span class="text-brand">ADMIN</span></span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-brand/10 border border-brand/20 rounded-full">
                <div class="w-2 h-2 rounded-full bg-brand animate-pulse"></div>
                <span class="text-xs font-mono text-brand font-bold">tizorplayer@gmail.com</span>
            </div>
            <button onclick="adminAuth.logout()" class="p-2 hover:bg-white/5 rounded-lg text-zinc-400 hover:text-white transition" title="Cerrar Sesi√≥n Segura">
                <i class="ph-bold ph-sign-out text-lg"></i>
            </button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-72 bg-panel border-r border-white/5 flex flex-col z-30 shadow-xl">
            <div class="p-5 border-b border-white/5">
                <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3 block">Explorador de Datos</label>
                <select id="collection-selector" class="w-full bg-surface border border-white/10 rounded-xl p-3 text-sm text-white focus:border-brand focus:outline-none transition shadow-inner">
                    <option value="" disabled selected>Seleccionar Colecci√≥n...</option>
                    <optgroup label="üß¨ Rutas Profundas (System)">
                        <option value="DEEP:users">üë§ Usuarios (Perfiles Sistema)</option>
                        <option value="DEEP:public_data">üóÇÔ∏è Public Data (artifacts/...)</option>
                        <option value="DEEP:chat_corpo">üí¨ Chat Corpo (Interno)</option>
                    </optgroup>
                    <optgroup label="üìÇ Ra√≠z de Base de Datos">
                        <option value="ROOT:artifacts">üì¶ artifacts (Root)</option>
                        <option value="ROOT:godsPlanData">üóÑÔ∏è godsPlanData</option>
                    </optgroup>
                    <optgroup label="üì± Datos de Aplicaci√≥n (Alias)">
                        <option value="anuncios">üì¢ Anuncios</option>
                        <option value="finanzas_global">üí∞ Finanzas Globales</option>
                        <option value="usuarios_registrados">üë• Lista Usuarios (Public)</option>
                    </optgroup>
                    <option value="custom">‚ö° Ruta Manual (Avanzado)</option>
                </select>
            </div>

            <!-- Entrada manual de ruta -->
            <div id="custom-path-container" class="px-5 pb-5 hidden">
                <div class="bg-blue-500/10 border border-blue-500/20 p-3 rounded-lg mb-3">
                    <p class="text-[10px] text-blue-200 leading-tight"><i class="ph-bold ph-info text-blue-400 mr-1"></i> <b>Navegaci√≥n Profunda:</b> Usa <code>/</code> para entrar en subcarpetas.</p>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="custom-path-input" placeholder="Ruta (ej: users)" class="w-full bg-surface border border-white/10 rounded-lg p-2 text-xs text-white font-mono focus:border-brand focus:outline-none">
                    <button id="load-custom-btn" class="bg-white/10 hover:bg-brand hover:text-white text-zinc-300 rounded-lg px-3 transition"><i class="ph-bold ph-arrow-right"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5">
                <div class="text-[10px] text-zinc-600 mb-3 font-bold tracking-widest uppercase">Info. Contextual</div>
                <div id="stats-panel" class="space-y-3">
                    <div class="glass p-4 rounded-xl border-l-2 border-brand">
                        <span class="block text-zinc-500 text-[10px] uppercase mb-1">Ruta Actual</span>
                        <span id="current-path-display" class="text-xs font-mono text-white break-all leading-tight block">...</span>
                    </div>
                    <div class="flex justify-between items-center glass p-3 rounded-xl">
                        <span class="text-zinc-500 text-[10px] uppercase">Documentos</span>
                        <span id="doc-count" class="text-lg font-mono font-bold text-white">-</span>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-white/5 bg-panel">
                <button onclick="adminApp.openEditor()" class="w-full bg-white hover:bg-zinc-200 text-black font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition shadow-lg transform active:scale-95">
                    <i class="ph-bold ph-plus-circle text-lg"></i> Nuevo Documento
                </button>
            </div>
        </aside>

        <!-- AREA PRINCIPAL -->
        <main class="flex-1 bg-dark flex flex-col relative overflow-hidden">
            <!-- Barra de Herramientas -->
            <div class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-surface/30 backdrop-blur-sm relative z-20">
                <div class="flex items-center gap-3 text-sm text-zinc-300">
                    <div class="p-1.5 bg-white/5 rounded-md"><i class="ph-bold ph-database"></i></div>
                    <span id="view-title" class="font-medium">Panel Listo</span>
                </div>
                
                <!-- Toolbar Derecha -->
                <div class="flex items-center gap-3">
                    <!-- BOT√ìN ZONA PELIGROSA (NUEVO) -->
                    <button onclick="adminApp.openBulkDelete()" class="flex items-center gap-2 px-3 py-2 bg-red-500/10 hover:bg-red-500 border border-red-500/20 hover:border-red-500 rounded-lg text-xs font-bold text-red-500 hover:text-white transition group" title="Borrar M√∫ltiples">
                        <i class="ph-bold ph-skull group-hover:animate-bounce"></i> Limpieza
                    </button>

                    <!-- Toggle Filtros -->
                    <button onclick="adminApp.toggleFilters()" id="filter-toggle-btn" class="flex items-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-lg text-xs font-bold text-zinc-400 transition">
                        <i class="ph-bold ph-faders"></i> Filtros
                    </button>

                    <!-- Buscador -->
                    <div class="relative group">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="text" id="search-filter" placeholder="Buscar ID..." class="bg-black/40 border border-white/10 rounded-xl pl-10 pr-4 py-2 text-xs text-white focus:border-brand w-48 focus:outline-none focus:w-64 transition-all">
                    </div>
                </div>

                <!-- Panel Filtros Avanzados -->
                <div id="advanced-filters-panel" class="absolute top-16 right-6 bg-[#151515] border border-white/10 rounded-xl p-4 shadow-2xl w-72 hidden transform origin-top-right transition-all">
                    <h4 class="text-xs font-bold text-zinc-500 uppercase mb-3 border-b border-white/5 pb-2">Opciones de Filtrado</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-zinc-400 mb-1 block">Buscar en:</label>
                            <div class="flex bg-black/50 rounded-lg p-1 border border-white/5">
                                <button onclick="adminApp.setSearchMode('id')" id="btn-mode-id" class="flex-1 py-1.5 text-xs rounded text-white bg-brand font-bold transition">ID</button>
                                <button onclick="adminApp.setSearchMode('content')" id="btn-mode-content" class="flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition">Contenido</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-400 mb-1 block">Ordenar:</label>
                            <div class="flex bg-black/50 rounded-lg p-1 border border-white/5">
                                <button onclick="adminApp.setSortOrder('asc')" id="btn-sort-asc" class="flex-1 py-1.5 text-xs rounded text-white bg-white/10 font-bold transition">A-Z</button>
                                <button onclick="adminApp.setSortOrder('desc')" id="btn-sort-desc" class="flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition">Z-A</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Datos -->
            <div class="flex-1 overflow-auto p-8 relative" id="data-container">
                <div class="flex flex-col items-center justify-center h-full text-zinc-700 select-none">
                    <div class="w-24 h-24 rounded-full bg-white/5 flex items-center justify-center mb-6">
                        <i class="ph-duotone ph-circles-three-plus text-5xl opacity-50"></i>
                    </div>
                    <h3 class="text-zinc-500 font-bold text-lg">Esperando comandos</h3>
                    <p class="text-zinc-600 text-sm mt-2 max-w-xs text-center">Selecciona una colecci√≥n del men√∫ lateral para cargar y administrar datos.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDITOR (Create/Edit) -->
    <div id="editor-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-[#0f0f0f] border border-white/10 rounded-2xl w-full max-w-3xl shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between p-5 border-b border-white/10 bg-surface">
                <h3 id="modal-title" class="text-lg font-bold text-white flex items-center gap-3">
                    <span class="p-1.5 bg-brand/20 rounded text-brand"><i class="ph-bold ph-pencil-simple"></i></span>
                    Editar Documento
                </h3>
                <button onclick="adminApp.closeEditor()" class="text-zinc-500 hover:text-white transition p-2 hover:bg-white/10 rounded-lg"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="p-8 flex-1 overflow-y-auto">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-zinc-500 uppercase mb-2 tracking-wider">Identificador del Documento (ID)</label>
                    <div class="flex gap-3">
                        <input type="text" id="doc-id-input" placeholder="(Auto-generado si se deja vac√≠o)" class="flex-1 bg-black border border-white/10 rounded-xl p-4 text-sm font-mono text-white focus:border-brand focus:outline-none transition-colors placeholder:text-zinc-700">
                        <button id="regen-id-btn" class="px-4 bg-white/5 hover:bg-white/10 rounded-xl border border-white/5 text-zinc-400 hover:text-white transition" title="Limpiar ID"><i class="ph-bold ph-eraser text-lg"></i></button>
                    </div>
                </div>
                <div class="mb-2 flex justify-between items-end">
                    <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wider">Estructura JSON</label>
                    <button onclick="adminApp.formatJson()" class="text-[10px] text-brand hover:text-red-400 font-mono cursor-pointer flex items-center gap-1 bg-brand/10 px-2 py-1 rounded"><i class="ph-bold ph-code"></i> Prettify</button>
                </div>
                <div class="relative">
                    <textarea id="json-editor" class="w-full h-96 bg-black border border-white/10 rounded-xl p-5 text-sm font-mono text-green-400 focus:border-brand focus:outline-none resize-none leading-relaxed" spellcheck="false"></textarea>
                    <div id="json-error" class="absolute bottom-4 right-4 bg-red-900/90 text-red-200 text-xs px-3 py-2 rounded-lg border border-red-500/50 hidden backdrop-blur"><i class="ph-bold ph-warning-circle"></i> Error de sintaxis</div>
                </div>
            </div>
            <div class="p-5 border-t border-white/10 bg-surface rounded-b-2xl flex justify-end gap-3">
                <button onclick="adminApp.closeEditor()" class="px-6 py-2.5 text-sm font-bold text-zinc-400 hover:text-white hover:bg-white/5 rounded-xl transition">Cancelar</button>
                <button onclick="adminApp.saveDocument()" class="bg-brand hover:bg-red-600 text-white px-8 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-brand/20 transition flex items-center gap-2 transform active:scale-95"><i class="ph-bold ph-floppy-disk"></i> Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- MODAL LIMPIEZA MASIVA (NUEVO) -->
    <div id="bulk-delete-modal" class="fixed inset-0 z-[60] bg-red-950/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-[#1a0505] border border-red-500/30 rounded-2xl w-full max-w-lg shadow-2xl p-6 relative overflow-hidden">
            <div class="flex items-center gap-4 mb-6">
                <div class="p-3 bg-red-500/20 rounded-full text-red-500"><i class="ph-fill ph-warning-octagon text-3xl"></i></div>
                <div>
                    <h3 class="text-xl font-bold text-white">Zona de Peligro: Limpieza Masiva</h3>
                    <p class="text-red-300 text-xs">Esta acci√≥n eliminar√° documentos permanentemente.</p>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-zinc-400 uppercase mb-2">IDs para CONSERVAR (Separados por coma)</label>
                <textarea id="bulk-keep-ids" class="w-full h-32 bg-black/50 border border-red-900 rounded-xl p-4 text-sm font-mono text-green-400 focus:border-red-500 focus:outline-none resize-none" placeholder="Ej: UID_1, UID_2, UID_3..."></textarea>
                <p class="text-[10px] text-zinc-500 mt-2">Todo documento cuyo ID <b>NO</b> est√© en esta lista ser√° eliminado de la vista actual.</p>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('bulk-delete-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-bold text-zinc-400 hover:text-white transition">Cancelar</button>
                <button onclick="adminApp.executeBulkDelete()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2">
                    <i class="ph-bold ph-trash"></i> EJECUTAR LIMPIEZA
                </button>
            </div>
        </div>
    </div>

    <!-- LOGICA FIREBASE & APP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACI√ìN
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) { console.error(e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const AUTH_EMAIL = "tizorplayer@gmail.com";
        const loginOverlay = document.getElementById('admin-login-overlay');
        
        window.adminAuth = {
            init: async function() {
                const user = auth.currentUser;
                if (user) { if (user.email === AUTH_EMAIL) this.showDashboard(); else { await signOut(auth); this.showLogin(); } } else { this.showLogin(); }
            },
            login: async function() {
                const btn = document.getElementById('login-btn'); const err = document.getElementById('login-error'); const errText = document.getElementById('login-error-text');
                const originalContent = btn.innerHTML; btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin text-xl"></i> Verificando...'; btn.disabled = true; err.classList.add('hidden');
                try {
                    const provider = new GoogleAuthProvider(); const result = await signInWithPopup(auth, provider);
                    if (result.user.email === AUTH_EMAIL) this.showDashboard();
                    else { await signOut(auth); throw new Error(`El correo ${result.user.email} no tiene permisos.`); }
                } catch (error) {
                    errText.textContent = error.message; err.classList.remove('hidden'); btn.innerHTML = originalContent; btn.disabled = false;
                }
            },
            logout: async function() { await signOut(auth); window.location.reload(); },
            showDashboard: function() { loginOverlay.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => loginOverlay.style.display = 'none', 500); },
            showLogin: function() { loginOverlay.style.display = 'flex'; loginOverlay.classList.remove('opacity-0', 'pointer-events-none'); }
        };
        setTimeout(() => adminAuth.init(), 1000);

        let currentCollectionPath = "";
        let currentDocs = [];
        let filterState = { searchMode: 'id', sortOrder: 'asc' };

        window.adminApp = {
            toggleFilters: function() {
                document.getElementById('advanced-filters-panel').classList.toggle('hidden');
                document.getElementById('filter-toggle-btn').classList.toggle('bg-brand');
                document.getElementById('filter-toggle-btn').classList.toggle('text-white');
            },
            setSearchMode: function(mode) {
                filterState.searchMode = mode;
                document.getElementById('btn-mode-id').className = mode === 'id' ? 'flex-1 py-1.5 text-xs rounded text-white bg-brand font-bold transition' : 'flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition';
                document.getElementById('btn-mode-content').className = mode === 'content' ? 'flex-1 py-1.5 text-xs rounded text-white bg-brand font-bold transition' : 'flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition';
                document.getElementById('search-filter').placeholder = mode === 'id' ? 'Buscar por ID...' : 'Buscar texto en JSON...';
                this.renderTable();
            },
            setSortOrder: function(order) {
                filterState.sortOrder = order;
                document.getElementById('btn-sort-asc').className = order === 'asc' ? 'flex-1 py-1.5 text-xs rounded text-white bg-white/10 font-bold transition' : 'flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition';
                document.getElementById('btn-sort-desc').className = order === 'desc' ? 'flex-1 py-1.5 text-xs rounded text-white bg-white/10 font-bold transition' : 'flex-1 py-1.5 text-xs rounded text-zinc-500 hover:text-white transition';
                this.renderTable();
            },
            loadCollection: async function(pathOrType) {
                const dataContainer = document.getElementById('data-container'); dataContainer.innerHTML = '<div class="flex justify-center mt-32"><div class="loader"></div></div>';
                let fullPath = "";
                if (pathOrType === undefined && document.getElementById('collection-selector').value === 'custom') {
                    const customInput = document.getElementById('custom-path-input').value.trim();
                    if(!customInput) { dataContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-zinc-500"><i class="ph-bold ph-warning text-4xl mb-2 text-yellow-500"></i><p>Escribe una ruta v√°lida</p></div>'; return; }
                    fullPath = customInput;
                } else {
                    const selectedValue = pathOrType || document.getElementById('collection-selector').value;
                    if (selectedValue === 'custom') { dataContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-zinc-600"><i class="ph-bold ph-keyboard text-4xl mb-4 opacity-50"></i><p>Usa el campo "Ruta" en la barra lateral.</p></div>'; return; }
                    if (selectedValue.startsWith('DEEP:')) {
                        const type = selectedValue.split(':')[1];
                        if (type === 'public_data') fullPath = `artifacts/${appId}/public/data`;
                        else if (type === 'chat_corpo') fullPath = `artifacts/${appId}/public/data/chat_corpo`;
                        else if (type === 'users') fullPath = `artifacts/${appId}/users`;
                    } else if (selectedValue.startsWith('ROOT:')) fullPath = selectedValue.replace('ROOT:', '');
                    else fullPath = `artifacts/${appId}/public/data/${selectedValue}`;
                }
                currentCollectionPath = fullPath;
                document.getElementById('current-path-display').textContent = fullPath;
                document.getElementById('view-title').textContent = `Explorando: ${fullPath}`;
                try {
                    const querySnapshot = await getDocs(collection(db, fullPath));
                    currentDocs = []; querySnapshot.forEach((doc) => { currentDocs.push({ id: doc.id, ...doc.data() }); });
                    document.getElementById('doc-count').textContent = currentDocs.length;
                    this.renderTable();
                } catch (error) {
                    console.error(error); dataContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full max-w-lg mx-auto text-center"><div class="bg-red-500/10 p-4 rounded-full mb-4 border border-red-500/20"><i class="ph-bold ph-warning-octagon text-3xl text-red-500"></i></div><h3 class="text-white font-bold text-lg mb-2">Error de Carga</h3><p class="text-zinc-500 text-sm font-mono bg-black p-2 rounded mb-4">${error.message}</p></div>`;
                }
            },
            createMyAdminProfile: async function() {
                const user = auth.currentUser; if (!user) return alert("Error: No hay usuario.");
                const profileData = { email: user.email, displayName: user.displayName || "Admin", photoURL: user.photoURL, role: "admin", createdAt: new Date().toISOString() };
                try { await setDoc(doc(db, currentCollectionPath, user.uid), profileData); alert("¬°Perfil creado!"); this.loadCollection(); } catch (e) { alert("Error: " + e.message); }
            },
            
            // --- NUEVO: FUNCIONES DE LIMPIEZA ---
            openBulkDelete: function() {
                if(!currentCollectionPath || currentDocs.length === 0) return alert("No hay datos cargados para limpiar.");
                document.getElementById('bulk-delete-modal').classList.remove('hidden');
            },
            executeBulkDelete: async function() {
                const keepInput = document.getElementById('bulk-keep-ids').value;
                const keepIds = keepInput.split(',').map(id => id.trim()).filter(id => id); // Array limpio de IDs
                
                if(!confirm(`‚ö†Ô∏è ATENCI√ìN:\nSe borrar√°n TODOS los documentos EXCEPTO: ${keepIds.length > 0 ? keepIds.join(', ') : '(Ninguno)'}.\n\n¬øEst√°s completamente seguro?`)) return;

                const btn = document.querySelector('#bulk-delete-modal button.bg-red-600');
                const originalText = btn.innerHTML;
                btn.innerHTML = "BORRANDO..."; btn.disabled = true;

                let deletedCount = 0;
                let errors = 0;

                for (const d of currentDocs) {
                    if (!keepIds.includes(d.id)) {
                        try {
                            await deleteDoc(doc(db, currentCollectionPath, d.id));
                            deletedCount++;
                        } catch (e) {
                            console.error(e); errors++;
                        }
                    }
                }

                btn.innerHTML = originalText; btn.disabled = false;
                document.getElementById('bulk-delete-modal').classList.add('hidden');
                alert(`Limpieza completada.\nüóëÔ∏è Eliminados: ${deletedCount}\nüõ°Ô∏è Conservados: ${currentDocs.length - deletedCount}\n‚ùå Errores: ${errors}`);
                this.loadCollection(); // Recargar vista
            },

            renderTable: function() {
                const container = document.getElementById('data-container'); const filterText = document.getElementById('search-filter').value.toLowerCase();
                let filteredDocs = currentDocs.filter(d => filterState.searchMode === 'id' ? d.id.toLowerCase().includes(filterText) : JSON.stringify(d).toLowerCase().includes(filterText));
                filteredDocs.sort((a, b) => { const idA = a.id.toLowerCase(); const idB = b.id.toLowerCase(); return filterState.sortOrder === 'asc' ? (idA < idB ? -1 : 1) : (idA > idB ? -1 : 1); });

                if (filteredDocs.length === 0) {
                    if (currentCollectionPath.endsWith('/users')) {
                         container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-zinc-500 px-4 text-center"><div class="bg-brand/10 p-6 rounded-full mb-6 animate-pulse"><i class="ph-duotone ph-users-three text-5xl text-brand"></i></div><h3 class="text-xl font-bold text-white mb-2">Carpeta de Usuarios Vac√≠a</h3><p class="text-sm text-zinc-400 max-w-md leading-relaxed mb-8">Los usuarios registrados en "Authentication" no crean autom√°ticamente un perfil aqu√≠.<br><br>Para ver usuarios aqu√≠, debes crear sus documentos.</p><button onclick="adminApp.createMyAdminProfile()" class="bg-white hover:bg-zinc-200 text-black font-bold py-3 px-8 rounded-full shadow-xl transition transform hover:scale-105 flex items-center gap-2"><i class="ph-bold ph-magic-wand"></i> Crear Mi Perfil de Admin</button><p class="text-[10px] text-zinc-600 mt-4">Esto crear√° un documento con TU ID actual (${auth.currentUser?.uid?.slice(0,5)}...).</p></div>`;
                        return;
                    }
                    let emptyHtml = `<div class="flex flex-col items-center justify-center h-full text-zinc-500"><i class="ph-bold ph-folder-dashed text-5xl mb-4 opacity-30"></i><h3 class="text-lg font-bold text-zinc-400">Sin Resultados Visibles</h3><p class="text-sm max-w-md text-center mt-2 leading-relaxed">No se encontraron documentos en <code>${currentCollectionPath}</code> con los filtros actuales.</p>`;
                    if (currentCollectionPath === 'artifacts') emptyHtml += `<div class="mt-6 bg-blue-500/10 border border-blue-500/20 p-4 rounded-xl max-w-md text-left"><h4 class="text-blue-400 font-bold text-xs uppercase mb-2 flex items-center gap-2"><i class="ph-bold ph-lightbulb"></i> Tip Pro</h4><p class="text-xs text-blue-200 mb-2">Firestore oculta carpetas intermedias. Intenta usar las <b>Rutas Profundas</b> del men√∫.</p></div>`;
                    emptyHtml += `</div>`; container.innerHTML = emptyHtml; return;
                }

                let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20">${filteredDocs.map(doc => {
                    const jsonPreview = JSON.stringify(doc, null, 2).slice(0, 150) + '...';
                    return `<div class="glass rounded-2xl p-5 flex flex-col group hover:border-brand/50 hover:bg-white/5 transition duration-300 relative overflow-hidden"><div class="flex justify-between items-start mb-4 relative z-10"><div class="flex items-center gap-3 overflow-hidden"><div class="p-2 bg-brand/10 rounded-lg text-brand"><i class="ph-bold ph-file-text"></i></div><div class="flex flex-col"><span class="font-mono text-xs font-bold text-white truncate w-32" title="${doc.id}">${doc.id}</span><span class="text-[10px] text-zinc-500">Documento</span></div></div></div><div class="flex-1 bg-black/40 rounded-xl p-3 mb-4 overflow-hidden border border-white/5 relative group-hover:border-white/10 transition"><pre class="text-[10px] text-zinc-500 font-mono leading-relaxed h-24 overflow-hidden">${jsonPreview}</pre><div class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-black to-transparent"></div></div><div class="flex items-center justify-between mt-auto pt-3 border-t border-white/5"><span class="text-[10px] text-zinc-600 font-mono">JSON</span><div class="flex gap-2"><button onclick="adminApp.openEditor('${doc.id}')" class="p-2 bg-white/5 hover:bg-white text-zinc-400 hover:text-black rounded-lg transition" title="Editar"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="adminApp.deleteDocument('${doc.id}')" class="p-2 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-lg transition" title="Eliminar"><i class="ph-bold ph-trash"></i></button></div></div></div>`;
                }).join('')}</div>`; container.innerHTML = html;
            },
            deleteDocument: async function(id) { if (!confirm(`‚ö†Ô∏è ¬øEliminar "${id}"?`)) return; try { await deleteDoc(doc(db, currentCollectionPath, id)); currentDocs = currentDocs.filter(d => d.id !== id); this.renderTable(); document.getElementById('doc-count').textContent = currentDocs.length; } catch (e) { alert("Error: " + e.message); } },
            openEditor: function(id = null) {
                const modal = document.getElementById('editor-modal'); const title = document.getElementById('modal-title'); const idInput = document.getElementById('doc-id-input'); const jsonEditor = document.getElementById('json-editor'); modal.classList.remove('hidden');
                if (id) { title.innerHTML = `<span class="p-1.5 bg-brand/20 rounded text-brand"><i class="ph-bold ph-pencil-simple"></i></span> Editando: <span class="font-mono ml-2 text-sm opacity-70">${id}</span>`; idInput.value = id; idInput.disabled = true; idInput.classList.add('opacity-50', 'cursor-not-allowed'); const docData = currentDocs.find(d => d.id === id); const { id: _, ...cleanData } = docData; jsonEditor.value = JSON.stringify(cleanData, null, 4); } 
                else { title.innerHTML = `<span class="p-1.5 bg-green-500/20 rounded text-green-500"><i class="ph-bold ph-plus"></i></span> Nuevo Documento`; idInput.value = ""; idInput.disabled = false; idInput.classList.remove('opacity-50', 'cursor-not-allowed'); jsonEditor.value = "{\n    \"campo\": \"valor\"\n}"; }
            },
            closeEditor: function() { document.getElementById('editor-modal').classList.add('hidden'); document.getElementById('json-error').classList.add('hidden'); },
            formatJson: function() { const editor = document.getElementById('json-editor'); const err = document.getElementById('json-error'); try { const val = JSON.parse(editor.value); editor.value = JSON.stringify(val, null, 4); err.classList.add('hidden'); } catch (e) { err.classList.remove('hidden'); setTimeout(() => err.classList.add('hidden'), 3000); } },
            saveDocument: async function() {
                const idInput = document.getElementById('doc-id-input'); const jsonEditor = document.getElementById('json-editor');
                if (!currentCollectionPath) { alert("Selecciona una colecci√≥n primero."); return; }
                try { const data = JSON.parse(jsonEditor.value); let docId = idInput.value.trim(); const docRef = docId ? doc(db, currentCollectionPath, docId) : doc(collection(db, currentCollectionPath)); await setDoc(docRef, data, { merge: true }); this.closeEditor(); const querySnapshot = await getDocs(collection(db, currentCollectionPath)); currentDocs = []; querySnapshot.forEach((doc) => currentDocs.push({ id: doc.id, ...doc.data() })); this.renderTable(); document.getElementById('doc-count').textContent = currentDocs.length; } catch (e) { alert("Error al guardar: " + e.message); }
            }
        };

        document.getElementById('collection-selector').addEventListener('change', (e) => { const val = e.target.value; if (val === 'custom') { document.getElementById('custom-path-container').classList.remove('hidden'); } else { document.getElementById('custom-path-container').classList.add('hidden'); adminApp.loadCollection(val); } });
        document.getElementById('load-custom-btn').addEventListener('click', () => { adminApp.loadCollection('custom'); });
        document.getElementById('regen-id-btn').addEventListener('click', () => { const inp = document.getElementById('doc-id-input'); if(!inp.disabled) inp.value = ""; });
        document.getElementById('search-filter').addEventListener('input', () => { adminApp.renderTable(); });
    </script>
</body>
</html>
