<!DOCTYPE html>
<html lang="es" style="background-color: #050505;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Notas</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked para procesar Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS GLOBALES */
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Scrollbar Oculto/Custom */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism */
        .glass-nav { background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); }
        .glass-card { background: rgba(24, 24, 27, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }

        /* Inputs Limpios */
        .input-clean {
            background: transparent; border: none; color: white; width: 100%; outline: none;
        }
        .input-search {
            background: #121212; border: 1px solid #333; color: white; border-radius: 12px;
            transition: all 0.2s; font-size: 16px !important;
        }
        .input-search:focus { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1); }

        /* Transiciones Masonry (Simuladas) */
        .note-card { transition: transform 0.2s, box-shadow 0.2s; break-inside: avoid; margin-bottom: 1rem; }
        .note-card:active { transform: scale(0.98); }

        /* Modal Editor Full Screen en Móvil */
        .editor-modal {
            position: fixed; inset: 0; background: #050505; z-index: 2000;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            transform: translateY(100%);
        }
        .editor-modal.active { transform: translateY(0); }

        /* TextArea Auto-resize */
        textarea { resize: none; field-sizing: content; min-height: 50vh; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm sm:text-base bg-[#050505] text-[#e5e5e5]">

    <!-- NAV SUPERIOR (Global) -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="text-white font-black text-base tracking-wide flex items-center gap-2 decoration-none">
            <i class="ph-bold ph-circles-three-plus text-lg"></i> God's Plan
        </a>
        <div class="flex items-center gap-5 overflow-x-auto no-scrollbar pl-2">
            <a href="/adherencia.html" class="text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">ADHERENCIA</a>
            <a href="/finanzas.html" class="text-zinc-500 text-[10px] font-bold uppercase tracking-wider whitespace-nowrap">FINANZAS</a>
            <a href="#" class="text-white text-[10px] font-bold uppercase tracking-wider whitespace-nowrap border-b-2 border-white pb-0.5">NOTAS</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-zinc-800 ml-1 flex-shrink-0" title="Estado"></div>
        </div>
    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="app-content" class="flex-1 overflow-y-auto relative scroll-smooth px-4 pt-4 pb-32">
        
        <!-- BARRA DE BÚSQUEDA Y SALUDO -->
        <div class="max-w-2xl mx-auto mb-6 fade-in">
            <h1 class="text-2xl font-black text-white mb-1">Mis Notas</h1>
            <p class="text-xs text-zinc-500 mb-4" id="notesCount">Cargando...</p>
            
            <div class="relative">
                <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                <input type="text" id="searchInput" placeholder="Buscar en notas..." class="input-search w-full py-3 pl-10 pr-4 placeholder-zinc-600" oninput="app.filterNotes()">
            </div>
        </div>

        <!-- GRID DE NOTAS -->
        <div id="notesGrid" class="columns-2 gap-4 max-w-2xl mx-auto pb-10 space-y-4">
            <!-- Las notas se inyectan aquí -->
            <div class="text-center text-zinc-600 col-span-full py-10 text-xs mt-10">Conectando...</div>
        </div>

    </main>

    <!-- FAB (NUEVA NOTA) -->
    <div class="fixed bottom-8 right-6 z-40">
        <button onclick="app.openEditor()" class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-black shadow-[0_0_20px_rgba(255,255,255,0.3)] active:scale-95 transition-transform group">
            <i class="ph-bold ph-plus text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- EDITOR MODAL (FULL SCREEN) -->
    <div id="editorModal" class="editor-modal">
        <!-- Toolbar Superior -->
        <div class="h-14 flex items-center justify-between px-4 border-b border-zinc-900 bg-black/50 backdrop-blur-md sticky top-0 z-50">
            <button onclick="app.closeEditor()" class="w-8 h-8 flex items-center justify-center text-zinc-400 hover:text-white bg-zinc-900 rounded-full">
                <i class="ph-bold ph-arrow-left"></i>
            </button>
            <div class="flex items-center gap-2">
                <!-- Botón Pin -->
                <button id="btnPin" onclick="app.togglePin()" class="w-8 h-8 flex items-center justify-center text-zinc-400 hover:bg-zinc-800 rounded-full transition-all">
                    <i id="iconPin" class="ph-bold ph-push-pin text-lg"></i>
                </button>
                
                <button id="btnDeleteNote" onclick="app.deleteNote()" class="w-8 h-8 flex items-center justify-center text-red-500 hover:bg-red-500/10 rounded-full hidden">
                    <i class="ph-bold ph-trash"></i>
                </button>
                
                <button onclick="app.saveNote()" class="text-xs bg-white text-black px-4 py-2 rounded-full font-bold hover:bg-zinc-200 transition-colors ml-2">
                    GUARDAR
                </button>
            </div>
        </div>

        <!-- Área de Edición -->
        <div class="flex-1 overflow-y-auto p-5 max-w-2xl mx-auto w-full">
            <input type="text" id="noteTitle" placeholder="Título" class="input-clean text-3xl font-black mb-4 placeholder-zinc-700">
            <textarea id="noteBody" placeholder="Escribe algo brillante..." class="input-clean text-base text-zinc-300 leading-relaxed placeholder-zinc-800 w-full h-full bg-transparent font-sans"></textarea>
            <!-- Estado de guardado -->
            <div class="text-[10px] text-zinc-600 mt-10 font-mono flex items-center gap-2" id="lastEdited"></div>
        </div>
    </div>

    <!-- DIALOGO DE CONFIRMACIÓN -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[3000] hidden flex items-center justify-center opacity-0 transition-opacity">
        <div class="bg-[#121212] border border-[#333] rounded-2xl p-6 max-w-xs w-[90%] shadow-2xl">
            <h4 class="text-lg font-bold text-white mb-2">¿Eliminar nota?</h4>
            <p class="text-zinc-400 text-sm mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="text-zinc-400 text-sm font-bold px-4 py-2 rounded-lg hover:bg-zinc-800">Cancelar</button>
                <button id="confirmAction" class="bg-red-600 text-white text-sm font-bold px-4 py-2 rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[3000] pointer-events-none w-full max-w-xs flex flex-col items-center gap-2"></div>

    <!-- AUTH BLOCKER -->
    <div id="authModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[4000] hidden flex items-center justify-center p-6">
        <div class="bg-[#121212] border border-zinc-800 p-8 rounded-3xl max-w-sm w-full text-center">
            <i class="ph-fill ph-lock-key text-4xl text-zinc-600 mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Acceso Privado</h2>
            <p class="text-xs text-zinc-500 mb-6">Tus notas están encriptadas y requieren inicio de sesión.</p>
            <button onclick="window.location.href='/'" class="w-full bg-white text-black py-3 rounded-xl font-bold text-sm hover:scale-[1.02] transition-transform">
                IR AL INICIO
            </button>
        </div>
    </div>

    <script type="module">
        // IMPORTACIONES DE FIREBASE
        const {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, onSnapshot, collection, query, orderBy, limit, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp
        } = window.firebaseImports;

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const HOME_URL = "/";

        // CONFIGURACIÓN (Fallback)
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) { console.error(e); }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // INICIALIZACIÓN
        let appInstance, auth, db;
        try {
            appInstance = initializeApp(firebaseConfig);
            auth = getAuth(appInstance);
            db = getFirestore(appInstance);
        } catch(e) { console.error("Firebase Error:", e); }

        // --- LÓGICA DE LA APP ---
        const app = window.app = {
            user: null,
            notes: [],
            currentNoteId: null,
            currentNoteIsPinned: false,
            saveTimeout: null, // Timer para el auto-save

            async init() {
                if (!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u && !u.isAnonymous) {
                        this.user = u;
                        document.getElementById('authModal').classList.add('hidden');
                        this.setupListeners();
                    } else {
                        if (!u && initialAuthToken) {
                            try { await signInWithCustomToken(auth, initialAuthToken); return; } catch(e){}
                        }
                        if (!u) await signInAnonymously(auth);
                        document.getElementById('authModal').classList.remove('hidden');
                    }
                });
            },

            setupListeners() {
                if (!this.user) return;
                const notesRef = collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'notes');
                // Traemos por fecha, ordenaremos en cliente por Pin + Fecha
                const q = query(notesRef, orderBy('updatedAt', 'desc'), limit(100));

                onSnapshot(q, (snapshot) => {
                    document.getElementById('syncStatus').classList.remove('bg-zinc-800', 'bg-red-500');
                    document.getElementById('syncStatus').classList.add('bg-emerald-500', 'animate-pulse-slow');
                    
                    this.notes = snapshot.docs.map(d => ({
                        id: d.id,
                        ...d.data(),
                        updatedAt: d.data().updatedAt ? d.data().updatedAt.toDate() : new Date(),
                        isPinned: d.data().isPinned || false // Default false
                    }));

                    // Ordenamiento Cliente: Pinned primero, luego fecha
                    this.notes.sort((a, b) => {
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        return b.updatedAt - a.updatedAt;
                    });

                    this.renderNotes();
                }, (error) => {
                    console.error("Error fetching notes:", error);
                    document.getElementById('syncStatus').classList.add('bg-red-500');
                });
            },

            renderNotes(filterText = '') {
                const container = document.getElementById('notesGrid');
                const countEl = document.getElementById('notesCount');
                
                let filtered = this.notes;
                if (filterText) {
                    const term = filterText.toLowerCase();
                    filtered = this.notes.filter(n => 
                        (n.title && n.title.toLowerCase().includes(term)) || 
                        (n.body && n.body.toLowerCase().includes(term))
                    );
                }

                countEl.textContent = `${filtered.length} nota${filtered.length !== 1 ? 's' : ''}`;
                container.innerHTML = '';

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-20 opacity-50">
                            <i class="ph-bold ph-pencil-simple-slash text-4xl mb-3"></i>
                            <p class="text-xs">No hay notas aquí.</p>
                        </div>
                    `;
                    return;
                }

                filtered.forEach(note => {
                    // Lógica de Markdown limpia para Preview
                    let preview = 'Sin contenido';
                    if (note.body) {
                        try {
                            const rawHtml = marked.parse(note.body);
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = rawHtml;
                            const plainText = tempDiv.textContent || tempDiv.innerText || '';
                            preview = plainText.length > 100 ? plainText.substring(0, 100) + '...' : plainText;
                        } catch (e) {
                            preview = note.body;
                        }
                    }
                    
                    const dateStr = note.updatedAt.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    const pinnedIcon = note.isPinned ? `<i class="ph-fill ph-push-pin text-yellow-500 text-xs absolute top-5 right-5"></i>` : '';
                    
                    const el = document.createElement('div');
                    el.className = 'note-card glass-card rounded-2xl p-5 cursor-pointer hover:bg-zinc-800/50 relative group';
                    el.onclick = () => this.openEditor(note.id);
                    el.innerHTML = `
                        ${pinnedIcon}
                        <h3 class="font-bold text-white text-base mb-2 leading-tight pr-4">${note.title || 'Sin Título'}</h3>
                        <p class="text-zinc-400 text-xs leading-relaxed mb-3 font-light">${preview}</p>
                        <div class="text-[10px] text-zinc-600 font-bold uppercase tracking-wider">${dateStr}</div>
                    `;
                    container.appendChild(el);
                });
            },

            filterNotes() {
                const val = document.getElementById('searchInput').value;
                this.renderNotes(val);
            },

            openEditor(id = null) {
                this.currentNoteId = id;
                const modal = document.getElementById('editorModal');
                const btnDelete = document.getElementById('btnDeleteNote');
                const titleInput = document.getElementById('noteTitle');
                const bodyInput = document.getElementById('noteBody');
                const lastEdited = document.getElementById('lastEdited');

                // Bind auto-save listeners
                titleInput.oninput = () => this.autoSaveTrigger();
                bodyInput.oninput = () => this.autoSaveTrigger();

                if (id) {
                    const note = this.notes.find(n => n.id === id);
                    if (note) {
                        titleInput.value = note.title || '';
                        bodyInput.value = note.body || '';
                        this.currentNoteIsPinned = note.isPinned;
                        lastEdited.textContent = `Editado el ${note.updatedAt.toLocaleString()}`;
                        btnDelete.classList.remove('hidden');
                    }
                } else {
                    titleInput.value = '';
                    bodyInput.value = '';
                    this.currentNoteIsPinned = false;
                    lastEdited.textContent = 'Nueva Nota';
                    btnDelete.classList.add('hidden');
                }
                
                this.updatePinUI();
                modal.classList.add('active');
            },

            closeEditor() {
                if(this.saveTimeout) clearTimeout(this.saveTimeout);
                document.getElementById('editorModal').classList.remove('active');
                setTimeout(() => {
                    this.currentNoteId = null;
                }, 300);
            },

            // --- AUTO SAVE LOGIC ---
            autoSaveTrigger() {
                const statusEl = document.getElementById('lastEdited');
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse inline-block"></span> Guardando...`;
                
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                
                this.saveTimeout = setTimeout(() => {
                    this.saveNote(true); // Silent save
                }, 1500);
            },

            async saveNote(silent = false) {
                const title = document.getElementById('noteTitle').value.trim();
                const body = document.getElementById('noteBody').value.trim();

                if (!title && !body && !this.currentNoteId) {
                    if (!silent) this.closeEditor();
                    return;
                }

                const payload = {
                    title,
                    body,
                    isPinned: this.currentNoteIsPinned,
                    updatedAt: serverTimestamp()
                };

                try {
                    const notesRef = collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'notes');
                    
                    if (this.currentNoteId) {
                        await updateDoc(doc(notesRef, this.currentNoteId), payload);
                        if(!silent) this.showToast('Nota actualizada', 'success');
                    } else {
                        // Para nuevas notas, obtenemos la referencia para el ID
                        const docRef = await addDoc(notesRef, { ...payload, createdAt: serverTimestamp() });
                        this.currentNoteId = docRef.id; // Set ID so subsequent autosaves update this doc
                        if(!silent) this.showToast('Nota creada', 'success');
                        
                        // Show delete button now that it exists
                        document.getElementById('btnDeleteNote').classList.remove('hidden');
                    }

                    if (silent) {
                        const statusEl = document.getElementById('lastEdited');
                        statusEl.innerHTML = `<span class="text-emerald-500">Guardado</span>`;
                    } else {
                        this.closeEditor();
                    }
                } catch (e) {
                    console.error(e);
                    if(!silent) this.showToast('Error al guardar', 'error');
                }
            },

            togglePin() {
                this.currentNoteIsPinned = !this.currentNoteIsPinned;
                this.updatePinUI();
                this.saveNote(true); // Save state immediately silently
            },

            updatePinUI() {
                const icon = document.getElementById('iconPin');
                const btn = document.getElementById('btnPin');
                
                if (this.currentNoteIsPinned) {
                    icon.classList.remove('ph-bold');
                    icon.classList.add('ph-fill', 'text-yellow-400');
                    btn.classList.add('bg-zinc-800');
                } else {
                    icon.classList.add('ph-bold');
                    icon.classList.remove('ph-fill', 'text-yellow-400');
                    btn.classList.remove('bg-zinc-800');
                }
            },

            async deleteNote() {
                if (!this.currentNoteId) return;
                
                const confirmed = await this.confirmDialog('¿Eliminar esta nota?', 'Desaparecerá para siempre.');
                if (confirmed) {
                    try {
                        const notesRef = collection(db, 'artifacts', APP_ID, 'users', this.user.uid, 'notes');
                        await deleteDoc(doc(notesRef, this.currentNoteId));
                        this.showToast('Nota eliminada', 'info');
                        this.closeEditor();
                    } catch (e) {
                        this.showToast('Error al eliminar', 'error');
                    }
                }
            },

            // Utilidades UI
            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'success' ? 'bg-emerald-900/80 text-emerald-200 border-emerald-800' : 
                               type === 'error' ? 'bg-red-900/80 text-red-200 border-red-800' : 
                               'bg-zinc-800 text-white border-zinc-700';
                
                el.className = `px-4 py-2 rounded-full text-xs font-bold border backdrop-blur-md shadow-lg animate-fade-in ${colors}`;
                el.innerHTML = msg;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transition = 'opacity 0.3s';
                    setTimeout(() => el.remove(), 300);
                }, 2000);
            },

            confirmDialog(title, msg) {
                return new Promise(resolve => {
                    const dialog = document.getElementById('confirmDialog');
                    const btnYes = document.getElementById('confirmAction');
                    const btnNo = document.getElementById('confirmCancel');
                    
                    const close = (res) => {
                        dialog.classList.add('opacity-0');
                        setTimeout(() => {
                            dialog.classList.add('hidden');
                            resolve(res);
                        }, 200);
                    };

                    btnYes.onclick = () => close(true);
                    btnNo.onclick = () => close(false);

                    dialog.classList.remove('hidden');
                    void dialog.offsetWidth;
                    dialog.classList.remove('opacity-0');
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
