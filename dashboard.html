<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <title>God's Plan | Master View</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE (Standardized Imports) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc };
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', card: '#121212' },
                        brand: { 500: '#ef4444', 600: '#dc2626' } // Red Core
                    }
                }
            }
        }
    </script>

    <style>
        :root { --nav-height: 65px; }
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; }
        
        /* Glassmorphism Red Core */
        .glass { background: rgba(18, 18, 18, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card { background: linear-gradient(180deg, rgba(24, 24, 27, 0.6) 0%, rgba(18, 18, 18, 0.9) 100%); border: 1px solid rgba(255,255,255,0.05); }
        .glass-red { background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, rgba(127, 29, 29, 0.05) 100%); border: 1px solid rgba(220, 38, 38, 0.2); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Nav Global */
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { font-size: 10px; font-weight: 800; letter-spacing: 0.05em; color: #71717a; transition: color 0.2s; text-decoration: none; white-space: nowrap; }
        .g-link:hover, .g-link.active { color: white; }
        
        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #ef4444; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Inputs invisibles */
        .bare-input { background: transparent; border: none; outline: none; text-align: right; width: 100%; font-weight: bold; color: inherit; border-bottom: 1px dashed rgba(255,255,255,0.2); transition: border-color 0.2s; }
        .bare-input:focus { border-bottom-color: #ef4444; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- NAV SUPERIOR -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="flex items-center gap-2 text-white font-black text-lg tracking-tight decoration-none">
            <i class="ph-bold ph-circles-three-plus text-red-600"></i> God's Plan
        </a>
        <div class="g-links no-scrollbar">
            <a href="/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/chat.html" class="g-link">CHAT</a>
            <a href="/finanzas.html" class="g-link">FINANZAS</a>
            <a href="#" class="g-link active text-red-500">MASTER VIEW</a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
        <div class="max-w-6xl mx-auto">
            
            <!-- HEADER -->
            <div class="flex justify-between items-end mb-8 border-b border-white/5 pb-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight mb-1">EXEC DASHBOARD</h1>
                    <p class="text-zinc-500 text-xs md:text-sm font-medium flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span>
                        TIEMPO REAL · <span id="currentDateDisplay">--</span>
                    </p>
                </div>
                <div class="text-right">
                    <div id="authStatus" class="text-xs font-bold text-zinc-600 uppercase tracking-widest">Conectando...</div>
                </div>
            </div>

            <!-- KPI GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                
                <!-- CARD 1: VALOR HORA REAL (Métrica Reina) -->
                <div class="glass-red rounded-2xl p-5 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-600/20 rounded-full blur-2xl group-hover:bg-red-600/30 transition-colors"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="text-[10px] font-black text-red-400 uppercase tracking-widest">Valor Hora Real</span>
                        <i class="ph-fill ph-crown text-red-500 text-lg"></i>
                    </div>
                    <div class="text-4xl font-black text-white tracking-tighter mb-1 relative z-10" id="kpiRealRate">--</div>
                    <div class="text-xs text-red-200/50 font-mono relative z-10">Ingreso Neto / Horas Vida</div>
                </div>

                <!-- CARD 2: TIEMPO VENDIDO -->
                <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Tiempo Vendido</span>
                        <i class="ph-fill ph-clock-user text-zinc-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiHours">--</div>
                    <div class="w-full bg-zinc-800 h-1.5 rounded-full mt-3 overflow-hidden">
                        <div id="barHours" class="h-full bg-white w-0 transition-all duration-1000"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-[9px] text-zinc-500 font-bold uppercase">
                        <span>Mes Actual</span>
                        <span id="kpiHoursTarget">Meta: 160h</span>
                    </div>
                </div>

                <!-- CARD 3: COSTO DE VIDA (Burn Rate) -->
                <div class="glass-card rounded-2xl p-5 relative group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Costo por Hora</span>
                        <i class="ph-fill ph-fire text-orange-500/50 group-hover:text-orange-500 transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiLifeCost">--</div>
                    <div class="text-xs text-zinc-600">Lo que te cuesta existir (720h)</div>
                </div>

                <!-- CARD 4: CASHFLOW NETO -->
                <div class="glass-card rounded-2xl p-5 relative group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Cashflow Neto</span>
                        <i class="ph-fill ph-trend-up text-emerald-500/50 group-hover:text-emerald-500 transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiNet">--</div>
                    <div class="text-xs text-zinc-600" id="kpiMargin">Margen: 0%</div>
                </div>
            </div>

            <!-- MAIN SPLIT -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- COLUMNA IZQUIERDA: GRÁFICO DE RENDIMIENTO -->
                <div class="lg:col-span-2 glass-card rounded-2xl p-6 border border-zinc-800">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Eficiencia Financiera</h3>
                        <div class="flex gap-2">
                            <span class="text-[10px] text-zinc-500 font-bold px-2 py-1 rounded bg-zinc-900 border border-zinc-800">INGRESOS vs GASTOS</span>
                        </div>
                    </div>
                    <div class="relative w-full h-64">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: AJUSTES RÁPIDOS & RUNWAY -->
                <div class="space-y-4">
                    
                    <!-- RUNWAY WIDGET -->
                    <div class="glass-card rounded-2xl p-5 border border-zinc-800">
                        <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3">Runway (Supervivencia)</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-4xl font-black text-white" id="runwayMonths">0.0</span>
                            <span class="text-sm font-bold text-zinc-500 mb-1">Meses</span>
                        </div>
                        <p class="text-xs text-zinc-600 mb-4 leading-relaxed">Tiempo antes de la quiebra si los ingresos se detienen hoy.</p>
                        
                        <!-- Input Manual para Ahorros Líquidos (Sincronizado) -->
                        <div class="bg-black/50 p-3 rounded-xl border border-zinc-800">
                            <label class="text-[9px] text-red-500 font-bold uppercase block mb-1">Ahorro Líquido Total</label>
                            <div class="flex items-center gap-2">
                                <span class="text-zinc-600 text-lg font-light">$</span>
                                <input type="number" id="inpLiquidAssets" class="bg-transparent w-full text-white font-bold outline-none text-right placeholder-zinc-700" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>
                    </div>

                    <!-- RESUMEN MENSUAL (EDITABLE/LIVE) -->
                    <div class="glass-card rounded-2xl p-5 border border-zinc-800 space-y-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Configuración Base</h3>
                            <i class="ph-bold ph-sliders text-zinc-600 text-xs"></i>
                        </div>
                        
                        <!-- Ingresos (Base Salary) -->
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Ingreso Base (Conf)</span>
                            <div class="flex items-center gap-1 w-28">
                                <span class="text-emerald-500 font-bold text-xs">$</span>
                                <input type="number" id="inpIncome" class="bare-input text-emerald-500" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>

                        <!-- Gastos (Budget Limit) -->
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Límite Gasto (Conf)</span>
                            <div class="flex items-center gap-1 w-28">
                                <span class="text-red-500 font-bold text-xs">$</span>
                                <input type="number" id="inpExpenses" class="bare-input text-red-500" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>

                        <div class="border-t border-white/5 my-2"></div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Horas Trabajadas</span>
                            <span class="text-white font-bold" id="summaryHours">0h</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <!-- JS LOGIC -->
    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc } = window.firebaseImports;

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-ultimate-v3';
        
        // Configuración Fallback
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) {}

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Utility formatting
        const fmtMoney = (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(n || 0);
        const fmtNum = (n) => new Intl.NumberFormat('es-MX', { maximumFractionDigits: 1 }).format(n || 0);

        window.dash = {
            data: {
                workLogs: [],
                financeLogs: [],
                financeConfig: { income: 0, liquidAssets: 0, monthlyBudget: 0 }, // Changed estimatedExpenses to monthlyBudget to match Finance app logic
                adherenceConfig: {}
            },
            userId: null,
            chart: null,

            init() {
                const now = new Date();
                const months = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
                document.getElementById('currentDateDisplay').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        this.userId = u.uid;
                        document.getElementById('authStatus').textContent = "SINCRONIZADO";
                        document.getElementById('authStatus').className = "text-xs font-bold text-emerald-600 uppercase tracking-widest";
                        this.startListeners();
                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if(token) {
                             await signInWithCustomToken(auth, token);
                        } else {
                             await signInAnonymously(auth);
                             document.getElementById('authStatus').textContent = "ANÓNIMO";
                        }
                    }
                });
            },

            startListeners() {
                // 1. Escuchar WORK DATA (godsPlanData/{uid}) -> Logica de Adherencia
                const workRef = doc(db, 'godsPlanData', this.userId);
                onSnapshot(workRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        this.data.workLogs = d.logs || [];
                        this.data.adherenceConfig = d.config || {};
                        this.calcMetrics();
                    }
                });

                // 2. Escuchar FINANCE CONFIG (artifacts/.../financials)
                const finConfigRef = doc(db, 'artifacts', APP_ID, 'users', this.userId, 'data', 'financials');
                onSnapshot(finConfigRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        // Mapping Finance fields
                        this.data.financeConfig.income = d.income || 0; // Base Income
                        this.data.financeConfig.liquidAssets = d.liquidAssets || 0; // Assets for runway
                        this.data.financeConfig.monthlyBudget = d.monthlyBudget || 0; // Planned Limit
                        
                        // Populate inputs if not focused
                        if(document.activeElement.id !== 'inpLiquidAssets') document.getElementById('inpLiquidAssets').value = this.data.financeConfig.liquidAssets;
                        if(document.activeElement.id !== 'inpIncome') document.getElementById('inpIncome').value = this.data.financeConfig.income;
                        if(document.activeElement.id !== 'inpExpenses') document.getElementById('inpExpenses').value = this.data.financeConfig.monthlyBudget;
                        
                        this.calcMetrics();
                    } else {
                        // Create if missing
                        setDoc(finConfigRef, { income: 0, liquidAssets: 0, monthlyBudget: 0 }, { merge: true });
                    }
                });

                // 3. Escuchar FINANCE LOGS (artifacts/.../transactions)
                const txRef = collection(db, 'artifacts', APP_ID, 'users', this.userId, 'transactions');
                onSnapshot(query(txRef), (snap) => {
                    this.data.financeLogs = snap.docs.map(d => d.data());
                    this.calcMetrics();
                });
            },

            calcMetrics() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // --- 1. WORK METRICS (Calculated from Adherencia) ---
                const mWorkLogs = this.data.workLogs.filter(l => {
                    const d = new Date(l.date + 'T00:00'); 
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                let totalMins = 0;
                mWorkLogs.forEach(l => {
                    if (l.type === 'Laboral' || l.type === 'Descanso') {
                        const gross = l.hours || 0;
                        const disc = l.disconnection || 0;
                        totalMins += Math.max(0, gross - disc);
                    }
                });
                const totalHours = totalMins / 60;

                // --- 2. FINANCE METRICS (Calculated from Finanzas) ---
                const mFinLogs = this.data.financeLogs.filter(l => {
                    const d = new Date(l.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                // Calculate Totals from Logs
                const extraIncome = mFinLogs.filter(l => l.type === 'income').reduce((a, b) => a + (b.amount || 0), 0);
                const actualExpenses = mFinLogs.filter(l => l.type === 'expense').reduce((a, b) => a + (b.amount || 0), 0);
                
                // Income Logic: Base (Config) + Extras (Logs)
                const baseIncome = parseFloat(this.data.financeConfig.income) || 0;
                const totalRealIncome = baseIncome + extraIncome; 

                // Expenses Logic: Only Real Logs used for stats, but Budget used for comparison
                const totalRealExpenses = actualExpenses;

                const netCashflow = totalRealIncome - totalRealExpenses;

                // --- 3. DERIVED KPIs ---
                
                // Real Hourly Rate = (Real Monthly Income / Real Monthly Hours)
                // This is the "God Metric"
                const realRate = totalHours > 0 ? (totalRealIncome / totalHours) : 0;

                // Life Cost Per Hour = (Real Expenses / 720h hours in month)
                // This shows how much money you burn just by existing per hour
                const lifeCostRate = totalRealExpenses / (30 * 24);

                // Runway
                const liquid = parseFloat(this.data.financeConfig.liquidAssets) || 0;
                // Use a 3-month moving average estimate or just current budget if expenses are 0
                const burnBasis = totalRealExpenses > 0 ? totalRealExpenses : (this.data.financeConfig.monthlyBudget || 1);
                const runway = burnBasis > 0 ? (liquid / burnBasis) : 99;

                // --- 4. UPDATE UI ---
                
                // KPI 1: Real Rate
                document.getElementById('kpiRealRate').textContent = fmtMoney(realRate);
                document.getElementById('kpiRealRate').className = `text-4xl font-black tracking-tighter mb-1 relative z-10 ${realRate > lifeCostRate ? 'text-white' : 'text-red-500'}`;

                // KPI 2: Time Sold
                document.getElementById('kpiHours').textContent = fmtNum(totalHours) + 'h';
                const pct = Math.min(100, (totalHours / 160) * 100);
                document.getElementById('barHours').style.width = `${pct}%`;
                
                // KPI 3: Burn Rate
                document.getElementById('kpiLifeCost').textContent = fmtMoney(lifeCostRate);

                // KPI 4: Net Cashflow
                document.getElementById('kpiNet').textContent = (netCashflow > 0 ? '+' : '') + fmtMoney(netCashflow);
                document.getElementById('kpiNet').className = `text-3xl font-bold mb-1 ${netCashflow >= 0 ? 'text-emerald-500' : 'text-red-500'}`;
                
                const margin = totalRealIncome > 0 ? ((netCashflow / totalRealIncome) * 100) : 0;
                document.getElementById('kpiMargin').textContent = `Margen: ${margin.toFixed(0)}%`;

                document.getElementById('summaryHours').textContent = fmtNum(totalHours) + 'h';

                const rwEl = document.getElementById('runwayMonths');
                rwEl.textContent = runway > 50 ? '>50' : fmtNum(runway);
                rwEl.className = `text-4xl font-black ${runway < 1 ? 'text-red-600 animate-pulse' : (runway < 3 ? 'text-orange-500' : 'text-emerald-500')}`;

                this.renderChart(totalRealIncome, totalRealExpenses);
            },

            saveConfig() {
                const liq = parseFloat(document.getElementById('inpLiquidAssets').value) || 0;
                const inc = parseFloat(document.getElementById('inpIncome').value) || 0;
                const budget = parseFloat(document.getElementById('inpExpenses').value) || 0;
                
                const ref = doc(db, 'artifacts', APP_ID, 'users', this.userId, 'data', 'financials');
                updateDoc(ref, { liquidAssets: liq, income: inc, monthlyBudget: budget }).catch(err => console.error("Error saving config", err));
            },

            renderChart(inc, exp) {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;

                if (this.chart) this.chart.destroy();

                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Balance Actual'],
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: [inc],
                                backgroundColor: '#10b981',
                                borderRadius: 8,
                                barThickness: 40
                            },
                            {
                                label: 'Gastos',
                                data: [exp],
                                backgroundColor: '#ef4444',
                                borderRadius: 8,
                                barThickness: 40
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                grid: { color: '#27272a' }, 
                                ticks: { color: '#71717a', font: { family: 'Plus Jakarta Sans' }, callback: (v) => '$' + v } 
                            },
                            x: { 
                                grid: { display: false }, 
                                ticks: { display: false } 
                            }
                        }
                    }
                });
            }
        };

        window.onload = () => window.dash.init();
    </script>
</body>
</html>
