<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <title>God's Plan | Master View</title>
    
    <!-- LIBRERIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE (Actualizado para coincidir con Portal) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc };
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', card: '#121212' },
                        brand: { 500: '#ef4444', 600: '#dc2626' } // Red Core
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --nav-height: 65px; }
        body { background-color: #050505; color: #e5e5e5; -webkit-tap-highlight-color: transparent; }
        
        /* Glassmorphism Red Core */
        .glass { background: rgba(18, 18, 18, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card { background: linear-gradient(180deg, rgba(24, 24, 27, 0.6) 0%, rgba(18, 18, 18, 0.9) 100%); border: 1px solid rgba(255,255,255,0.05); }
        .glass-red { background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, rgba(127, 29, 29, 0.05) 100%); border: 1px solid rgba(220, 38, 38, 0.2); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Nav Global */
        .g-links { display: flex; align-items: center; gap: 20px; overflow-x: auto; }
        .g-link { font-size: 10px; font-weight: 800; letter-spacing: 0.05em; color: #71717a; transition: color 0.2s; text-decoration: none; white-space: nowrap; }
        .g-link:hover, .g-link.active { color: white; }
        
        /* Inputs invisibles */
        .bare-input { background: transparent; border: none; outline: none; text-align: right; width: 100%; font-weight: bold; color: inherit; border-bottom: 1px dashed rgba(255,255,255,0.2); transition: border-color 0.2s; }
        .bare-input:focus { border-bottom-color: #ef4444; }

        /* Debug Panel */
        #debugPanel { transition: transform 0.3s ease-in-out; }
        #debugPanel.hidden-panel { transform: translateY(100%); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden relative">

    <!-- NAV SUPERIOR -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="/" class="flex items-center gap-2 text-white font-black text-lg tracking-tight decoration-none">
            <i class="ph-bold ph-circles-three-plus text-red-600"></i> God's Plan
        </a>
        <div class="g-links no-scrollbar">
            <a href="/adherencia.html" class="g-link">ADHERENCIA</a>
            <a href="/chat.html" class="g-link">CHAT</a>
            <a href="/finanzas.html" class="g-link">FINANZAS</a>
            <a href="#" class="g-link active text-red-500">MASTER VIEW</a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-32">
        <div class="max-w-6xl mx-auto">
            
            <!-- HEADER -->
            <div class="flex justify-between items-end mb-8 border-b border-white/5 pb-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight mb-1">EXEC DASHBOARD</h1>
                    <p class="text-zinc-500 text-xs md:text-sm font-medium flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span>
                        TIEMPO REAL · <span id="currentDateDisplay">--</span>
                    </p>
                </div>
                <div class="text-right">
                    <button onclick="dash.toggleDebug()" class="text-[10px] font-bold text-zinc-600 uppercase tracking-widest hover:text-white transition-colors border border-zinc-800 rounded px-2 py-1 flex items-center gap-2">
                        <i class="ph-bold ph-plugs-connected"></i> <span id="connectionStatus">Conectando...</span>
                    </button>
                </div>
            </div>

            <!-- ALERT: NO DATA (Inteligente) -->
            <div id="noDataAlert" class="hidden mb-6 bg-red-500/10 border border-red-500/20 p-4 rounded-xl flex items-start gap-3 animate-pulse-slow">
                <i class="ph-fill ph-warning-octagon text-red-500 text-2xl mt-0.5"></i>
                <div class="flex-1">
                    <h3 class="text-sm font-bold text-white">Datos no sincronizados</h3>
                    <p class="text-xs text-zinc-400 mt-1 leading-relaxed">
                        No encuentro registros de Adherencia o Finanzas para el usuario actual (<span id="alertUid" class="font-mono text-red-300">...</span>).
                        <br>Posible causa: Iniciaste sesión con cuentas diferentes en el Portal y aquí.
                    </p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="window.location.href='/'" class="text-xs bg-zinc-800 text-white px-3 py-1.5 rounded font-bold hover:bg-zinc-700 border border-zinc-700">Ir al Portal (Login)</button>
                        <button onclick="dash.forceReload()" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded font-bold hover:bg-red-500">Reintentar</button>
                    </div>
                </div>
            </div>

            <!-- KPI GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                
                <!-- CARD 1: VALOR HORA REAL -->
                <div class="glass-red rounded-2xl p-5 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-600/20 rounded-full blur-2xl group-hover:bg-red-600/30 transition-colors"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="text-[10px] font-black text-red-400 uppercase tracking-widest">Valor Hora Real</span>
                        <i class="ph-fill ph-crown text-red-500 text-lg"></i>
                    </div>
                    <div class="text-4xl font-black text-white tracking-tighter mb-1 relative z-10" id="kpiRealRate">--</div>
                    <div class="text-xs text-red-200/50 font-mono relative z-10">Ingreso Neto / Horas Vida</div>
                </div>

                <!-- CARD 2: TIEMPO VENDIDO -->
                <div class="glass-card rounded-2xl p-5 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Tiempo Vendido</span>
                        <i class="ph-fill ph-clock-user text-zinc-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiHours">--</div>
                    <div class="w-full bg-zinc-800 h-1.5 rounded-full mt-3 overflow-hidden">
                        <div id="barHours" class="h-full bg-white w-0 transition-all duration-1000"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-[9px] text-zinc-500 font-bold uppercase">
                        <span>Mes Actual</span>
                        <span id="kpiHoursTarget">Meta: 160h</span>
                    </div>
                </div>

                <!-- CARD 3: COSTO DE VIDA -->
                <div class="glass-card rounded-2xl p-5 relative group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Costo por Hora</span>
                        <i class="ph-fill ph-fire text-orange-500/50 group-hover:text-orange-500 transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiLifeCost">--</div>
                    <div class="text-xs text-zinc-600">Lo que te cuesta existir (720h)</div>
                </div>

                <!-- CARD 4: CASHFLOW NETO -->
                <div class="glass-card rounded-2xl p-5 relative group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Cashflow Neto</span>
                        <i class="ph-fill ph-trend-up text-emerald-500/50 group-hover:text-emerald-500 transition-colors"></i>
                    </div>
                    <div class="text-3xl font-bold text-white mb-1" id="kpiNet">--</div>
                    <div class="text-xs text-zinc-600" id="kpiMargin">Margen: 0%</div>
                </div>
            </div>

            <!-- MAIN SPLIT -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- COLUMNA IZQUIERDA: GRÁFICO DE RENDIMIENTO -->
                <div class="lg:col-span-2 glass-card rounded-2xl p-6 border border-zinc-800">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Eficiencia Financiera</h3>
                        <div class="flex gap-2">
                            <span class="text-[10px] text-zinc-500 font-bold px-2 py-1 rounded bg-zinc-900 border border-zinc-800">INGRESOS vs GASTOS</span>
                        </div>
                    </div>
                    <div class="relative w-full h-64">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: AJUSTES RÁPIDOS & RUNWAY -->
                <div class="space-y-4">
                    
                    <!-- RUNWAY WIDGET -->
                    <div class="glass-card rounded-2xl p-5 border border-zinc-800">
                        <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3">Runway (Supervivencia)</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-4xl font-black text-white" id="runwayMonths">0.0</span>
                            <span class="text-sm font-bold text-zinc-500 mb-1">Meses</span>
                        </div>
                        <p class="text-xs text-zinc-600 mb-4 leading-relaxed">Tiempo antes de la quiebra si los ingresos se detienen hoy.</p>
                        
                        <!-- Input Manual para Ahorros Líquidos -->
                        <div class="bg-black/50 p-3 rounded-xl border border-zinc-800">
                            <label class="text-[9px] text-red-500 font-bold uppercase block mb-1">Ahorro Líquido Total</label>
                            <div class="flex items-center gap-2">
                                <span class="text-zinc-600 text-lg font-light">$</span>
                                <input type="number" id="inpLiquidAssets" class="bg-transparent w-full text-white font-bold outline-none text-right placeholder-zinc-700" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>
                    </div>

                    <!-- RESUMEN MENSUAL (EDITABLE) -->
                    <div class="glass-card rounded-2xl p-5 border border-zinc-800 space-y-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Resumen Mes (Config)</h3>
                            <i class="ph-bold ph-pencil-simple text-zinc-600 text-xs"></i>
                        </div>
                        
                        <!-- Ingresos -->
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Ingreso Base</span>
                            <div class="flex items-center gap-1 w-24">
                                <span class="text-emerald-500 font-bold text-xs">$</span>
                                <input type="number" id="inpIncome" class="bare-input text-emerald-500" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>

                        <!-- Gastos -->
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Presupuesto Mensual</span>
                            <div class="flex items-center gap-1 w-24">
                                <span class="text-red-500 font-bold text-xs">$</span>
                                <input type="number" id="inpExpenses" class="bare-input text-red-500" placeholder="0" onblur="dash.saveConfig()">
                            </div>
                        </div>

                        <div class="border-t border-white/5 my-2"></div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-zinc-400">Horas Trabajadas</span>
                            <span class="text-white font-bold" id="summaryHours">0h</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <!-- DEBUG PANEL (SLIDE UP) -->
    <div id="debugPanel" class="fixed bottom-0 left-0 w-full bg-zinc-900 border-t border-zinc-700 p-4 z-[100] transform translate-y-full transition-transform duration-300 shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                <i class="ph-bold ph-wrench text-zinc-500"></i> DIAGNÓSTICO DE CONEXIÓN
            </h3>
            <button onclick="dash.toggleDebug()" class="text-zinc-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="grid grid-cols-2 gap-4 text-xs font-mono text-zinc-400">
            <div class="bg-black p-3 rounded border border-zinc-800">
                <div class="text-zinc-600 uppercase text-[10px] font-bold mb-1">User ID (Actual)</div>
                <div id="debugUid" class="text-emerald-500 truncate font-bold">...</div>
            </div>
            <div class="bg-black p-3 rounded border border-zinc-800">
                <div class="text-zinc-600 uppercase text-[10px] font-bold mb-1">Registros Detectados</div>
                <div class="flex justify-between border-b border-zinc-800 pb-1 mb-1">
                    <span>Adherencia:</span> <span id="debugWorkCount" class="text-white font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Finanzas:</span> <span id="debugFinCount" class="text-white font-bold">0</span>
                </div>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button onclick="dash.forceReload()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded font-bold text-xs border border-zinc-700">RECARGAR DATOS</button>
            <button onclick="window.location.href='/'" class="flex-1 bg-white hover:bg-zinc-200 text-black py-2 rounded font-bold text-xs">IR AL LOGIN</button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script type="module">
        // Importamos setPersistence y browserLocalPersistence para coincidir con el Portal
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, getFirestore, doc, onSnapshot, collection, query, where, getDocs, updateDoc, setDoc, getDoc } = window.firebaseImports;

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'gods-plan-ultimate-v3';
        
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) {}

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Utility formatting
        const fmtMoney = (n) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(n || 0);
        const fmtNum = (n) => new Intl.NumberFormat('es-MX', { maximumFractionDigits: 1 }).format(n || 0);

        window.dash = {
            data: {
                workLogs: [],
                financeLogs: [],
                financeConfig: { income: 0, liquidAssets: 0, monthlyBudget: 0 },
                adherenceConfig: {}
            },
            userId: null,
            chart: null,

            async init() {
                // Configurar persistencia IGUAL que en el Portal para compartir sesión
                try {
                    await setPersistence(auth, browserLocalPersistence);
                } catch(e) { console.error("Error persistencia:", e); }

                const now = new Date();
                const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                document.getElementById('currentDateDisplay').textContent = `${months[now.getMonth()].toUpperCase()} ${now.getFullYear()}`;

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        this.userId = u.uid;
                        this.updateAuthUI(u);
                        this.startListeners();
                    } else {
                        // Intentar token inicial del entorno (Canvas)
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if(token) await signInWithCustomToken(auth, token);
                        else {
                            // Si no hay token, intentar anónimo pero avisar
                            await signInAnonymously(auth);
                            this.updateAuthUI(auth.currentUser);
                        }
                    }
                });
            },

            updateAuthUI(u) {
                const status = u.isAnonymous ? "ANÓNIMO" : "CONECTADO";
                const color = u.isAnonymous ? "text-orange-500" : "text-emerald-500";
                document.getElementById('connectionStatus').textContent = status;
                document.getElementById('connectionStatus').className = color;
                
                document.getElementById('debugUid').textContent = u.uid;
                document.getElementById('alertUid').textContent = u.uid.substring(0, 8) + "...";
                
                if(u.isAnonymous) {
                    console.warn("Modo anónimo: Los datos no se comparten con el Portal.");
                }
            },

            toggleDebug() {
                const p = document.getElementById('debugPanel');
                if(p.classList.contains('translate-y-full')) p.classList.remove('translate-y-full');
                else p.classList.add('translate-y-full');
            },

            forceReload() {
                window.location.reload();
            },

            startListeners() {
                // 1. ADHERENCIA: Escuchar god's Plan Data
                const workRef = doc(db, 'godsPlanData', this.userId);
                onSnapshot(workRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        this.data.workLogs = d.logs || [];
                        this.data.adherenceConfig = d.config || {};
                        document.getElementById('debugWorkCount').textContent = this.data.workLogs.length;
                        document.getElementById('debugWorkCount').className = "text-emerald-400 font-bold";
                        this.calcMetrics();
                    } else {
                        document.getElementById('debugWorkCount').textContent = "0 (No existe)";
                        document.getElementById('debugWorkCount').className = "text-red-500 font-bold";
                        this.checkEmptyState();
                    }
                });

                // 2. FINANZAS: Configuración
                const finConfigRef = doc(db, 'artifacts', APP_ID, 'users', this.userId, 'data', 'financials');
                onSnapshot(finConfigRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        this.data.financeConfig.income = d.income || 0;
                        this.data.financeConfig.liquidAssets = d.liquidAssets || 0;
                        this.data.financeConfig.monthlyBudget = d.monthlyBudget || 0;
                        
                        // Sync inputs (Evitar sobrescribir si el usuario está editando)
                        if(document.activeElement.id !== 'inpLiquidAssets') document.getElementById('inpLiquidAssets').value = this.data.financeConfig.liquidAssets;
                        if(document.activeElement.id !== 'inpIncome') document.getElementById('inpIncome').value = this.data.financeConfig.income;
                        if(document.activeElement.id !== 'inpExpenses') document.getElementById('inpExpenses').value = this.data.financeConfig.monthlyBudget;
                        
                        this.calcMetrics();
                    }
                });

                // 3. FINANZAS: Registros (Logs)
                const txRef = collection(db, 'artifacts', APP_ID, 'users', this.userId, 'transactions');
                onSnapshot(query(txRef), (snap) => {
                    this.data.financeLogs = snap.docs.map(d => d.data());
                    const count = this.data.financeLogs.length;
                    document.getElementById('debugFinCount').textContent = count;
                    document.getElementById('debugFinCount').className = count > 0 ? "text-emerald-400 font-bold" : "text-zinc-500 font-bold";
                    
                    this.calcMetrics();
                    this.checkEmptyState();
                });
            },

            checkEmptyState() {
                const isEmpty = this.data.workLogs.length === 0 && this.data.financeLogs.length === 0;
                document.getElementById('noDataAlert').style.display = isEmpty ? 'flex' : 'none';
            },

            // PARSEADOR DE FECHAS ROBUSTO (Para arreglar el "no lo toma")
            parseDate(dateStr) {
                if(!dateStr) return new Date();
                // Si es formato YYYY-MM-DD (ISO simple), tratarlo como local para evitar desfase de zona horaria
                if(typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y, m, d] = dateStr.split('-').map(Number);
                    return new Date(y, m - 1, d, 12, 0, 0); // Mediodía para asegurar el día correcto
                }
                return new Date(dateStr);
            },

            calcMetrics() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // --- 1. WORK METRICS ---
                const mWorkLogs = this.data.workLogs.filter(l => {
                    const d = this.parseDate(l.date); 
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                let totalMins = 0;
                mWorkLogs.forEach(l => {
                    if (l.type === 'Laboral' || l.type === 'Descanso') {
                        const gross = l.hours || 0;
                        const disc = l.disconnection || 0;
                        totalMins += Math.max(0, gross - disc);
                    }
                });
                const totalHours = totalMins / 60;

                // --- 2. FINANCE METRICS ---
                const mFinLogs = this.data.financeLogs.filter(l => {
                    const d = this.parseDate(l.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const extraIncome = mFinLogs.filter(l => l.type === 'income').reduce((a, b) => a + (b.amount || 0), 0);
                const actualExpenses = mFinLogs.filter(l => l.type === 'expense').reduce((a, b) => a + (b.amount || 0), 0);
                
                // Income Logic
                const baseIncome = parseFloat(this.data.financeConfig.income) || 0;
                const totalRealIncome = baseIncome + extraIncome; 

                // Expenses Logic
                const totalRealExpenses = actualExpenses;
                const netCashflow = totalRealIncome - totalRealExpenses;

                // --- 3. DERIVED KPIs ---
                const realRate = totalHours > 0 ? (totalRealIncome / totalHours) : 0;
                const lifeCostRate = totalRealExpenses / (30 * 24); // 720h month

                // Runway Logic
                const liquid = parseFloat(this.data.financeConfig.liquidAssets) || 0;
                const burnBasis = totalRealExpenses > 0 ? totalRealExpenses : (this.data.financeConfig.monthlyBudget || 1); 
                const runway = burnBasis > 0 ? (liquid / burnBasis) : 99;

                // --- 4. UPDATE UI ---
                document.getElementById('kpiRealRate').textContent = fmtMoney(realRate);
                document.getElementById('kpiRealRate').className = `text-4xl font-black tracking-tighter mb-1 relative z-10 ${realRate > lifeCostRate ? 'text-white' : 'text-red-500'}`;

                document.getElementById('kpiHours').textContent = fmtNum(totalHours) + 'h';
                const pct = Math.min(100, (totalHours / 160) * 100);
                document.getElementById('barHours').style.width = `${pct}%`;
                
                document.getElementById('kpiLifeCost').textContent = fmtMoney(lifeCostRate);

                document.getElementById('kpiNet').textContent = (netCashflow > 0 ? '+' : '') + fmtMoney(netCashflow);
                document.getElementById('kpiNet').className = `text-3xl font-bold mb-1 ${netCashflow >= 0 ? 'text-emerald-500' : 'text-red-500'}`;
                
                const margin = totalRealIncome > 0 ? ((netCashflow / totalRealIncome) * 100) : 0;
                document.getElementById('kpiMargin').textContent = `Margen: ${margin.toFixed(0)}%`;

                document.getElementById('summaryHours').textContent = fmtNum(totalHours) + 'h';

                const rwEl = document.getElementById('runwayMonths');
                rwEl.textContent = runway > 50 ? '>50' : fmtNum(runway);
                rwEl.className = `text-4xl font-black ${runway < 1 ? 'text-red-600 animate-pulse' : (runway < 3 ? 'text-orange-500' : 'text-emerald-500')}`;

                this.renderChart(totalRealIncome, totalRealExpenses);
            },

            saveConfig() {
                const liq = parseFloat(document.getElementById('inpLiquidAssets').value) || 0;
                const inc = parseFloat(document.getElementById('inpIncome').value) || 0;
                const budget = parseFloat(document.getElementById('inpExpenses').value) || 0;
                
                const ref = doc(db, 'artifacts', APP_ID, 'users', this.userId, 'data', 'financials');
                setDoc(ref, { liquidAssets: liq, income: inc, monthlyBudget: budget }, { merge: true });
            },

            renderChart(inc, exp) {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;

                if (this.chart) this.chart.destroy();

                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Balance Actual'],
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: [inc],
                                backgroundColor: '#10b981',
                                borderRadius: 8,
                                barThickness: 40
                            },
                            {
                                label: 'Gastos',
                                data: [exp],
                                backgroundColor: '#ef4444',
                                borderRadius: 8,
                                barThickness: 40
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                grid: { color: '#27272a' }, 
                                ticks: { color: '#71717a', font: { family: 'Plus Jakarta Sans' }, callback: (v) => '$' + v } 
                            },
                            x: { 
                                grid: { display: false }, 
                                ticks: { display: false } 
                            }
                        }
                    }
                });
            }
        };

        window.onload = () => window.dash.init();
    </script>
</body>
</html>
