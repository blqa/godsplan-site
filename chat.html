<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Chat Pro Corpodatos</title>
    
    <!-- LIBRERIAS & FUENTES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- FIREBASE MODULAR (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, updateDoc
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#050505', 800: '#0a0a0a', 700: '#121212', card: '#18181b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1'
                    }
                }
            }
        }
    </script>

    <style>
        /* Definici√≥n de variables de tema */
        :root {
            --bg: #050505; --card: #121212; --text: #e5e5e5; --text-mute: #737373;
            --brand: #ef4444; --brand-glow: rgba(239, 68, 68, 0.3); --border: #27272a; --input-bg: #18181b;
            --own-msg: #ef4444; --other-msg: #27272a;
            --pkg-color: #f59e0b;
        }

        /* Tema Light */
        [data-theme="light"] {
            --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --text-mute: #6b7280;
            --brand: #dc2626; --brand-glow: rgba(220, 38, 38, 0.2); --border: #e5e7eb; --input-bg: #ffffff;
            --own-msg: #dc2626; --other-msg: #f3f4f6;
        }

        /* Tema Red Core */
        [data-theme="red"] {
            --bg: #000000; --card: #111111; --text: #e5e5e5; --text-mute: #737373;
            --brand: #b91c1c; --brand-glow: rgba(185, 28, 28, 0.4); --border: #330505; --input-bg: #220505;
            --own-msg: #7f1d1d; --other-msg: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* HEADER APP */
        header { 
            height: 60px; background: var(--card); border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; z-index: 40;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .app-logo { font-size: 1rem; font-weight: 800; color: var(--text); display: flex; gap: 8px; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-actions button { background: none; border: 1px solid var(--border); border-radius: 8px; color: var(--text-mute); font-size: 1.1rem; cursor: pointer; padding: 8px; margin-left: 8px; transition: all 0.2s; }
        .header-actions button:hover { background: var(--bg); color: var(--text); border-color: var(--brand); }

        /* TABS */
        .sections-bar {
            background: var(--bg); border-bottom: 1px solid var(--border);
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            padding: 8px; gap: 8px; flex-shrink: 0;
        }
        .section-tab {
            background: transparent; border: 1px solid transparent; border-radius: 12px;
            color: var(--text-mute); padding: 12px; font-size: 0.75rem; font-weight: 800;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden;
        }
        .section-tab i { font-size: 1.3rem; }
        .section-tab:hover { background: var(--card); }
        .section-tab.active { background: var(--card); border-color: var(--border); color: var(--brand); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section-tab[data-tab="paquetes"].active { color: var(--pkg-color); }

        /* CHAT AREA */
        #messages {
            flex-grow: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 6px;
            scroll-behavior: smooth;
            background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.02) 0%, transparent 100%);
        }
        
        /* SCROLLBAR */
        #messages::-webkit-scrollbar { width: 5px; }
        #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        #messages::-webkit-scrollbar-track { background: transparent; }

        .message-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        
        .message-row { display: flex; flex-direction: column; max-width: 85%; position: relative; animation: slideUp 0.25s ease-out; margin-bottom: 2px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-row.mine { align-self: flex-end; align-items: flex-end; }
        .message-row.theirs { align-self: flex-start; align-items: flex-start; }
        
        .sender-name { font-size: 0.65rem; color: var(--text-mute); margin-bottom: 2px; margin-left: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; }
        .message-row.mine .sender-name { display: none; } 

        .bubble-container { display: flex; align-items: flex-end; gap: 8px; }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: var(--text-mute); flex-shrink: 0; }
        .message-row.mine .avatar { display: none; }

        .bubble {
            padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; font-weight: 500;
            position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.1s; cursor: pointer; user-select: none;
        }
        .bubble:active { transform: scale(0.98); }
        
        .message-row.theirs .bubble { background: var(--other-msg); color: var(--text); border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .message-row.mine .bubble { background: var(--own-msg); color: white; border-bottom-right-radius: 4px; }
        
        /* Links in bubbles */
        .bubble a { text-decoration: underline; color: inherit; font-weight: 700; opacity: 0.9; }
        
        .msg-meta { font-size: 0.6rem; margin-top: 2px; opacity: 0.6; text-align: right; font-weight: 700; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }

        /* REPLIES */
        .reply-preview {
            background: rgba(0,0,0,0.1); padding: 6px 10px; border-radius: 8px; margin-bottom: 4px;
            border-left: 3px solid rgba(255,255,255,0.3); font-size: 0.75rem; cursor: pointer;
        }
        .message-row.theirs .reply-preview { background: rgba(0,0,0,0.05); border-left-color: var(--brand); }
        .reply-name { font-weight: 800; font-size: 0.65rem; margin-bottom: 2px; opacity: 0.8; }
        .reply-text { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; opacity: 0.9; }

        /* REACTIONS */
        .reaction-badge {
            position: absolute; bottom: -8px; right: 0; background: var(--card); border: 1px solid var(--border);
            border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10;
        }
        .message-row.theirs .reaction-badge { right: auto; left: 0; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* PAQUETES STYLE */
        .bubble.package-request {
            background: rgba(245, 158, 11, 0.1) !important; 
            border: 1px solid var(--pkg-color); color: var(--text);
            border-radius: 16px !important; width: 100%;
        }
        .pkg-header { display: flex; align-items: center; gap: 6px; color: var(--pkg-color); font-weight: 800; font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

        /* FOOTER & INPUT */
        footer {
            background: var(--card); padding: 12px 15px; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 0; flex-shrink: 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom)); 
        }
        
        /* Reply Banner in Footer */
        #replyBanner {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--bg); border-radius: 12px 12px 0 0;
            margin: 0 10px -10px 10px; border: 1px solid var(--border); border-bottom: none;
            font-size: 0.8rem; color: var(--text-mute); transform: translateY(100%); transition: transform 0.2s; position: relative; z-index: 1; opacity: 0; pointer-events: none;
        }
        #replyBanner.active { transform: translateY(-5px); opacity: 1; pointer-events: auto; }
        
        .input-container { display: flex; align-items: center; gap: 10px; position: relative; z-index: 2; background: var(--card); width: 100%; }
        
        .chat-input-wrapper { flex-grow: 1; position: relative; display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border); border-radius: 20px; transition: border-color 0.2s; height: 44px; }
        .chat-input-wrapper:focus-within { border-color: var(--brand); box-shadow: 0 0 0 2px var(--brand-glow); }
        
        #messageInput {
            width: 100%; background: transparent; border: none;
            color: var(--text); padding: 0 16px; font-size: 0.95rem; resize: none; height: 100%; line-height: 44px;
        }

        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%; border: 1px solid transparent; font-size: 1.4rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; background: transparent; color: var(--text-mute);
        }
        .icon-btn:hover { color: var(--brand); background: var(--bg); border-color: var(--border); }
        
        #sendButton { 
            background: var(--brand); color: white; width: 44px; height: 44px; border-radius: 12px; border: none;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; flex-shrink: 0;
            transition: all 0.2s;
        }
        #sendButton:disabled { opacity: 0.4; cursor: not-allowed; background: var(--border); color: var(--text-mute); }
        #sendButton:not(:disabled):hover { transform: scale(1.05); box-shadow: 0 4px 12px var(--brand-glow); }

        /* BIG BUTTON FOR PACKAGES */
        #pkgButton { 
            background: var(--pkg-color); color: white; border: none; border-radius: 12px; width: 100%; height: 50px;
            font-weight: 800; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; display: none;
            align-items: center; justify-content: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
            transition: all 0.2s;
        }
        #pkgButton:hover { filter: brightness(1.1); transform: translateY(-1px); }
        #pkgButton:active { transform: translateY(1px); }

        /* EMOJI PICKER */
        #emojiPicker {
            position: absolute; bottom: 80px; left: 15px; width: 320px; height: 300px;
            background: var(--card); border: 1px solid var(--border); border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; flex-direction: column; overflow: hidden; z-index: 100;
        }
        #emojiPicker.active { display: flex; animation: fadeUp 0.2s; }
        @keyframes fadeUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        .emoji-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 8px; overflow-y: auto; gap: 4px; }
        .emoji-item { font-size: 1.3rem; cursor: pointer; text-align: center; padding: 6px; border-radius: 6px; transition: background 0.1s; user-select: none; }
        .emoji-item:hover { background: var(--bg); transform: scale(1.2); }
        
        /* CONTEXT MENU (Message Options) */
        .context-menu {
            position: absolute; background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000;
            display: none; flex-direction: column; min-width: 150px; overflow: hidden;
            animation: scaleIn 0.15s ease-out;
        }
        .context-menu.active { display: flex; }
        @keyframes scaleIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }
        .ctx-item { padding: 12px 16px; color: var(--text); font-size: 0.9rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .ctx-item:last-child { border-bottom: none; }
        .ctx-item:hover { background: var(--bg); }
        .ctx-item.delete { color: #ef4444; }
        .ctx-item i { font-size: 1.1rem; opacity: 0.7; }

        /* MODALS (Iguales al original pero refinados) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; display: flex; }
        .modal-card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .full-input { width: 100%; padding: 16px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; font-size: 1rem; }
        .full-btn { width: 100%; padding: 16px; background: var(--brand); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 12px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
        .full-btn:active { transform: scale(0.98); }
        .full-btn:disabled { opacity: 0.6; cursor: wait; }
        .sec-btn { background: transparent; border: 1px solid var(--border); color: var(--text-mute); font-size: 0.8rem; width: 100%; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 700; }
        
        /* THEME MENU */
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .theme-btn { padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .theme-btn.active { border-color: var(--brand); color: var(--brand); background: var(--card); box-shadow: 0 0 0 1px var(--brand); }
    </style>
</head>
<body>

    <!-- NAV SUPERIOR (Global Header) -->
    <nav id="global-nav" class="h-14 bg-black border-b border-white/5 flex items-center justify-between px-5 shrink-0 z-50">
        <a href="https://godsplan.site/" class="flex items-center gap-2 font-black tracking-wider text-white group decoration-0">
            <i class="ph-bold ph-circles-three-plus text-lg text-white group-hover:text-red-500 transition-colors"></i> God's Plan
        </a>
        <div class="flex gap-4 items-center">
            <a href="#" class="text-[10px] font-bold text-white border-b border-white pb-0.5 tracking-wider no-underline">CHAT</a>
            <div id="syncStatus" class="w-1.5 h-1.5 rounded-full bg-emerald-500 ml-1 shadow-[0_0_8px_rgba(16,185,129,0.5)] animate-pulse" title="Online"></div>
        </div>
    </nav>

    <!-- HEADER DE LA APLICACI√ìN DE CHAT -->
    <header>
        <div class="header-left">
            <div class="app-logo"><i class="ph-fill ph-buildings text-brand-500"></i> Corpodatos</div>
        </div>
        <div class="header-actions">
            <button onclick="window.app.openThemeModal()"><i class="ph-bold ph-paint-brush"></i></button>
            <button onclick="window.app.logout()" title="Cerrar"><i class="ph-bold ph-sign-out"></i></button>
        </div>
    </header>

    <!-- BARRA DE CANALES (TABS) -->
    <div class="sections-bar">
        <button class="section-tab active" onclick="window.app.switchChannel('blints')">
            <i class="ph-bold ph-lightning"></i> Blints (IA)
        </button>
        <button class="section-tab" onclick="window.app.switchChannel('chat')">
            <i class="ph-bold ph-chat-circle-text"></i> Chat (General)
        </button>
        <button class="section-tab" data-tab="paquetes" onclick="window.app.switchChannel('paquetes')">
            <i class="ph-bold ph-package"></i> Paquetes (Log√≠stica)
        </button>
    </div>

    <!-- √ÅREA DE MENSAJES -->
    <main id="messages"></main>

    <!-- MENU CONTEXTUAL PARA MENSAJES -->
    <div id="msgContext" class="context-menu">
        <div class="ctx-item" onclick="window.app.handleReply()"><i class="ph-bold ph-arrow-u-up-left"></i> Responder</div>
        <div class="ctx-item" onclick="window.app.handleCopy()"><i class="ph-bold ph-copy"></i> Copiar Texto</div>
        <div class="ctx-item" onclick="window.app.handleReaction()"><i class="ph-fill ph-heart text-red-500"></i> Me encanta</div>
        <div id="btnDeleteMsg" class="ctx-item delete" style="display:none;" onclick="window.app.handleDelete()"><i class="ph-bold ph-trash"></i> Eliminar</div>
    </div>

    <!-- FOOTER Y CAJA DE MENSAJES -->
    <footer>
        <div id="replyBanner">
            <div class="flex flex-col overflow-hidden">
                <span class="text-[10px] font-bold text-brand-500">Respondiendo a:</span>
                <span id="replyTargetText" class="truncate font-medium text-xs">...</span>
            </div>
            <button onclick="window.app.cancelReply()" class="p-2 text-lg"><i class="ph-bold ph-x"></i></button>
        </div>

        <div class="input-container">
            <!-- EMOJI TOGGLE -->
            <button class="icon-btn" id="btnEmoji" onclick="window.app.toggleEmojiPicker()">
                <i class="ph-bold ph-smiley"></i>
            </button>
            
            <div class="chat-input-wrapper">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje..." autocomplete="off">
            </div>
            
            <button id="sendButton" disabled><i class="ph-fill ph-paper-plane-right"></i></button>
            <button id="pkgButton" onclick="window.app.openPkgModal()"><i class="ph-bold ph-package"></i> SOLICITAR APOYO</button>
        </div>
    </footer>

    <!-- EMOJI PICKER OVERLAY -->
    <div id="emojiPicker">
        <div class="p-2 border-b border-zinc-800 text-xs font-bold text-center text-zinc-500 bg-zinc-900/50">EMOJIS</div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Emojis injected via JS -->
        </div>
    </div>

    <!-- MODALES -->
    <!-- Modal de Autenticaci√≥n (Solo se usa si no hay sesi√≥n activa) -->
    <div class="modal" id="authModal">
        <div class="modal-card">
            <div class="mb-6 flex justify-center text-red-500 text-4xl"><i class="ph-fill ph-lock-key"></i></div>
            <h2 class="text-xl font-bold text-white mb-2">Acceso Corpodatos</h2>
            <p class="text-xs text-gray-500 mb-6">Introduce tus credenciales empresariales o inicia sesi√≥n en la p√°gina principal.</p>
            
            <input type="password" id="companyPin" class="full-input" placeholder="üîí PIN Empresa">
            <div id="loginForm">
                <input type="text" id="loginId" class="full-input" placeholder="ID de Empleado o Correo">
                <input type="password" id="loginPass" class="full-input" placeholder="Contrase√±a">
                <button class="full-btn" id="btnLoginAction" onclick="window.app.login()">Entrar</button>
                <button class="full-btn google-btn" style="background:#4285F4;" id="btnGoogleAction" onclick="window.app.loginGoogle()"><i class="ph-bold ph-google-logo mr-2"></i> Google</button>
                <button class="sec-btn" onclick="window.app.toggleAuthMode()">Crear Cuenta Nueva</button>
            </div>
            <div id="registerForm" style="display:none;">
                <input type="text" id="regName" class="full-input" placeholder="Nombre Completo">
                <input type="text" id="regId" class="full-input" placeholder="ID de Empleado o Correo">
                <input type="password" id="regPass" class="full-input" placeholder="Crear Contrase√±a">
                <button class="full-btn" id="btnRegAction" onclick="window.app.register()">Registrarme</button>
                <button class="sec-btn" onclick="window.app.toggleAuthMode()">Volver al Login</button>
            </div>
        </div>
    </div>

    <!-- Modal de Solicitud de Paquetes -->
    <div class="modal" id="pkgModal">
        <div class="modal-card">
            <h3 style="color:var(--pkg-color); margin-bottom:5px; font-weight:800; font-size:1.2rem;">SOLICITAR APOYO</h3>
            <p class="text-xs text-gray-500 mb-6">Paqueter√≠a o asistencia de personal.</p>
            
            <label class="form-label" style="display:block; text-align:left; color:var(--text-mute); font-size:0.75rem; font-weight:700; margin-bottom:8px; text-transform:uppercase;">Fecha Requerida</label>
            <input type="date" id="pkgDate" class="full-input">
            
            <label class="form-label" style="display:block; text-align:left; color:var(--text-mute); font-size:0.75rem; font-weight:700; margin-bottom:8px; text-transform:uppercase;">Motivo / Detalles</label>
            <input type="text" id="pkgReason" class="full-input" placeholder="Ej. Material pesado, Baja...">
            
            <button class="full-btn" style="background:var(--pkg-color);" onclick="window.app.sendPkgRequest()">Enviar Solicitud</button>
            <button class="sec-btn" onclick="document.getElementById('pkgModal').classList.remove('active')">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Tema -->
    <div class="modal" id="themeModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px; color:var(--text); font-weight:800;">PERSONALIZAR</h3>
            <div class="theme-grid">
                <button class="theme-btn" onclick="window.app.setTheme('light')"><i class="ph-bold ph-sun"></i> Claro</button>
                <button class="theme-btn" onclick="window.app.setTheme('dark')"><i class="ph-bold ph-moon"></i> Oscuro</button>
                <button class="theme-btn" onclick="window.app.setTheme('red')"><i class="ph-bold ph-fire"></i> Red Core</button>
            </div>
            <button class="sec-btn" onclick="document.getElementById('themeModal').classList.remove('active')">Cerrar</button>
        </div>
    </div>

    <!-- Modal de Mensajes -->
    <div class="modal" id="msgModal">
        <div class="modal-card">
            <i id="msgIcon" style="font-size:3rem; margin-bottom:15px;" class="ph-fill ph-warning-circle text-alert"></i>
            <p id="msgText" style="font-weight:700; margin-bottom:25px; color:var(--text); font-size:1.1rem;"></p>
            <button class="full-btn" onclick="window.app.closeMessageModal()">ENTENDIDO</button>
        </div>
    </div>

    <script type="module">
        // Se importan todos los m√≥dulos de Firebase definidos arriba
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, updateDoc 
        } = window.firebaseImports;

        const PIN = "corpodatos"; 
        // Colecci√≥n p√∫blica para chat colaborativo
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const COLLECTION_NAME = `/artifacts/${APP_ID}/public/data/chat_corpo`; 
        
        // Configuraci√≥n de Firebase
        const fallbackConfig = { apiKey: "AIzaSyCrHBz94UtgiaYntHCYhC5jNa6auUI63vQ", authDomain: "god-s-plan-d737b.firebaseapp.com", projectId: "god-s-plan-d737b", storageBucket: "god-s-plan-d737b.firebasestorage.app", messagingSenderId: "458198314028", appId: "1:458198314028:web:d62b24cee2d19ee5b47589" };
        let firebaseConfig = fallbackConfig;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) { const envConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config; if (envConfig && envConfig.apiKey) firebaseConfig = envConfig; } } catch(e) { console.error(e); }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db;
        try { 
            const fbApp = initializeApp(firebaseConfig); 
            auth = getAuth(fbApp); 
            db = getFirestore(fbApp); 
        } catch(e) { console.error(e); }

        window.app = {
            user: null, currentChannel: 'blints', isLoading: false, unsub: null,
            replyTo: null, selectedMsg: null,

            // EMOJI LIST
            emojis: [
                "üëç","üëé","‚ù§Ô∏è","üòÇ","üî•","üòÆ","üéâ","ü´°","üëÄ","‚úÖ","‚ùå","üöÄ","üíº","üíÄ","ü§°","ü§ù","‚ö†Ô∏è","üí°","üìâ","üìà","üíØ","üëã","üôè","ü§´","üôÑ",
                "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","ü§£","üòä","üòá","üôÇ","üôÉ","üòâ","üòå","üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòù","üòú","ü§™","ü§®",
                "üßê","ü§ì","üòé","ü•∏","ü§©","ü•≥","üòè","üòí","üòû","üòî","üòü","üòï","üôÅ","‚òπÔ∏è","üò£","üòñ","üò´","üò©","ü•∫","üò¢","üò≠","üò§","üò†","üò°","ü§¨",
                "ü§Ø","üò≥","ü•µ","ü•∂","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü§î","ü§≠","ü§´","ü§•","üò∂","üòê","üòë","üò¨","üôÑ","üòØ","üò¶","üòß","üòÆ","üò≤","ü•±",
                "üò¥","ü§§","üò™","üòµ","ü§ê","ü•¥","ü§¢","ü§Æ","ü§ß","üò∑","ü§í","ü§ï","ü§ë","ü§†","üòà","üëø","üëπ","üë∫","üí©","üëª","üíÄ","‚ò†Ô∏è","üëΩ","üëæ","ü§ñ",
                "üéÉ","üò∫","üò∏","üòπ","üòª","üòº","üòΩ","üôÄ","üòø","üòæ","üëã","ü§ö","‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äãüñê","‚úã","üññ","üëå","ü§è","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëà","üëâ",
                "üëÜ","üñï","üëá","‚òùÔ∏è","üëç","üëé","‚úä","üëä","ü§õ","ü§ú","üëè","üôå","üëê","ü§≤","ü§ù","üôè","‚úçÔ∏è","üíÖ","ü§≥","üí™","ü¶µ","ü¶∂","üëÇ","ü¶ª","üëÉ",
                "üß†","ü´Ä","ü´Å","ü¶∑","ü¶¥","üëÄ","üëÅ","üëÖ","üëÑ","üíã","ü©∏"
            ],

            init() {
                const savedTheme = localStorage.getItem('gp_theme') || 'dark';
                this.setTheme(savedTheme);
                this.renderEmojis();

                onAuthStateChanged(auth, async u => {
                    this.user = u; 
                    
                    // 1. Si NO hay usuario, intentar autenticaci√≥n inicial (solo ocurre si la sesi√≥n no persisti√≥)
                    if (!u) {
                        if (initialAuthToken) {
                            try { await signInWithCustomToken(auth, initialAuthToken); return; } catch(e){
                                // Si el token falla, intentamos an√≥nimo, pero solo si no hay sesi√≥n
                                await signInAnonymously(auth); 
                            }
                        } else {
                            await signInAnonymously(auth); 
                        }
                    }

                    // 2. Si el usuario est√°, pero no ha verificado el PIN (ya sea reci√©n autenticado o sesi√≥n persistente)
                    if (this.user && localStorage.getItem('gp_pin_verified') !== 'true') {
                         // Evitar mostrar el modal de Auth si la sesi√≥n es an√≥nima y no es obligatorio el PIN (asumimos que la autenticaci√≥n an√≥nima ya pas√≥)
                         if (this.user.isAnonymous && !localStorage.getItem('gp_pin_required')) {
                            this.startChat();
                         } else {
                            document.getElementById('authModal').classList.add('active');
                         }
                    } else if (this.user && localStorage.getItem('gp_pin_verified') === 'true') {
                        // Usuario y PIN verificados
                        this.startChat(); 
                    }
                });

                // Listeners Input
                const input = document.getElementById('messageInput');
                input.addEventListener('input', e => {
                    document.getElementById('sendButton').disabled = !e.target.value.trim();
                });
                input.addEventListener('keydown', e => { 
                    if(e.key==='Enter') this.sendMessage(); 
                });
                
                document.getElementById('sendButton').addEventListener('click', () => this.sendMessage());
                document.getElementById('pkgDate').valueAsDate = new Date();

                // Close Context Menu on click elsewhere
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu') && !e.target.closest('.bubble')) {
                        document.getElementById('msgContext').classList.remove('active');
                    }
                    if (!e.target.closest('#emojiPicker') && !e.target.closest('#btnEmoji')) {
                        document.getElementById('emojiPicker').classList.remove('active');
                    }
                });
            },

            renderEmojis() {
                const grid = document.getElementById('emojiGrid');
                grid.innerHTML = this.emojis.map(e => 
                    `<div class="emoji-item" onclick="window.app.insertEmoji('${e}')">${e}</div>`
                ).join('');
            },

            toggleEmojiPicker() {
                const p = document.getElementById('emojiPicker');
                p.classList.toggle('active');
            },

            insertEmoji(char) {
                const input = document.getElementById('messageInput');
                input.value += char;
                input.focus();
                document.getElementById('sendButton').disabled = false;
            },

            // MESSAGING LOGIC
            showMessage(m) {
                document.getElementById('msgText').textContent = m;
                document.getElementById('msgIcon').style.color = 'var(--brand)'; 
                document.getElementById('msgModal').classList.add('active');
            },
            closeMessageModal() { document.getElementById('msgModal').classList.remove('active'); },
            
            setLoading(loading) {
                this.isLoading = loading;
                const btns = ['btnLoginAction', 'btnGoogleAction', 'btnRegAction'];
                btns.forEach(id => {
                    const btn = document.getElementById(id);
                    if(btn) {
                        btn.disabled = loading;
                        btn.textContent = loading ? "Procesando..." : (id === 'btnLoginAction' ? "Entrar" : (id === 'btnRegAction' ? "Registrarme" : "Google"));
                    }
                });
            },

            // THEME
            openThemeModal() { document.getElementById('themeModal').classList.add('active'); },
            setTheme(t) {
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('gp_theme', t);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                if(t==='light') document.querySelector('.theme-btn:nth-child(1)').classList.add('active');
                if(t==='dark') document.querySelector('.theme-btn:nth-child(2)').classList.add('active');
                if(t==='red') document.querySelector('.theme-btn:nth-child(3)').classList.add('active');
            },

            // AUTH
            checkPin() { 
                const pinVal = document.getElementById('companyPin').value.trim().toLowerCase();
                // Si ya est√° verificado por sesi√≥n (desde godsplan.site), no pedimos el PIN
                if (localStorage.getItem('gp_pin_verified') === 'true') return true; 
                if(pinVal !== PIN) { 
                    this.showMessage("üö´ PIN de Empresa Incorrecto."); 
                    return false; 
                } 
                localStorage.setItem('gp_pin_verified','true'); 
                return true; 
            },
            
            async login() { 
                if(this.isLoading || !this.checkPin()) return; 
                const id = document.getElementById('loginId').value.trim();
                const pass = document.getElementById('loginPass').value.trim();
                if(!id || !pass) return this.showMessage("Completa todos los campos.");
                let email = id.includes('@') ? id : `${id}@godsplan.site`;
                this.setLoading(true);
                try{ await signInWithEmailAndPassword(auth, email, pass); } catch(e) { this.showMessage(e.message); this.setLoading(false); } 
            },
            
            async loginGoogle() { 
                if(this.isLoading || !this.checkPin()) return; 
                this.setLoading(true);
                try{ await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { this.showMessage(e.message); this.setLoading(false); } 
            },
            
            async register() { 
                if(this.isLoading || !this.checkPin()) return; 
                const name = document.getElementById('regName').value.trim();
                const id = document.getElementById('regId').value.trim();
                const pass = document.getElementById('regPass').value.trim();
                if(!name || !id || !pass) return this.showMessage("Completa todos los campos.");
                let email = id.includes('@') ? id : `${id}@godsplan.site`;
                this.setLoading(true);
                try{ 
                    const r = await createUserWithEmailAndPassword(auth, email, pass); 
                    await updateProfile(r.user, {displayName: name}); 
                } catch(e) { this.showMessage(e.message); this.setLoading(false); } 
            },
            
            toggleAuthMode() { 
                const l=document.getElementById('loginForm'), r=document.getElementById('registerForm'); 
                l.style.display=l.style.display==='none'?'block':'none'; 
                r.style.display=r.style.display==='none'?'block':'none'; 
            },
            
            logout() { 
                if(confirm("¬øCerrar sesi√≥n de Corpodatos?")) {
                    signOut(auth); 
                    localStorage.removeItem('gp_pin_verified'); 
                    // Redirigir a la p√°gina principal para que inicie el ciclo de autenticaci√≥n
                    // Usamos la URL absoluta seg√∫n tu requerimiento, que es la correcta para producci√≥n.
                    window.location.href = "https://godsplan.site/"; 
                }
            },

            startChat() { 
                document.getElementById('authModal').classList.remove('active'); 
                this.setLoading(false);
                this.loadMessages(); 
            },

            switchChannel(c) {
                this.currentChannel = c;
                this.cancelReply(); 
                document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
                
                const buttons = document.querySelectorAll('.section-tab');
                if(c==='blints') buttons[0].classList.add('active');
                if(c==='chat') buttons[1].classList.add('active');
                if(c==='paquetes') buttons[2].classList.add('active');

                const isPkg = c === 'paquetes';
                
                // Muestra/Oculta elementos de entrada seg√∫n el canal
                const inputWrap = document.querySelector('.chat-input-wrapper');
                const btnEmoji = document.getElementById('btnEmoji');
                const sendBtn = document.getElementById('sendButton');
                const pkgBtn = document.getElementById('pkgButton');

                if(isPkg) {
                    inputWrap.style.display = 'none';
                    btnEmoji.style.display = 'none';
                    sendBtn.style.display = 'none';
                    pkgBtn.style.display = 'flex';
                } else {
                    inputWrap.style.display = 'flex';
                    btnEmoji.style.display = 'flex';
                    sendBtn.style.display = 'flex';
                    pkgBtn.style.display = 'none';
                }
                
                this.loadMessages();
            },

            // --- ADVANCED CHAT RENDERING ---
            loadMessages() {
                if(this.unsub) this.unsub();
                const box = document.getElementById('messages');
                
                // Asegurar que el usuario no es an√≥nimo antes de intentar leer la DB (o que se fuerce el PIN)
                if (this.user.isAnonymous && localStorage.getItem('gp_pin_verified') !== 'true') {
                    box.innerHTML = '<div class="text-center p-10 text-zinc-700 text-xs uppercase tracking-widest">Inicia sesi√≥n con tu cuenta corporativa para acceder al chat.</div>';
                    return;
                }

                box.innerHTML = '<div class="text-center p-10 text-zinc-600 text-xs uppercase font-bold tracking-widest animate-pulse">Sincronizando...</div>';
                
                const q = query(
                    collection(db, COLLECTION_NAME),
                    where('channel', '==', this.currentChannel),
                    orderBy('at', 'asc'),
                    limit(60)
                );

                this.unsub = onSnapshot(q, (s) => {
                    const wasAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
                    box.innerHTML = '';
                    
                    if(s.empty) box.innerHTML = '<div class="text-center p-10 text-zinc-700 text-xs uppercase tracking-widest">Canal vac√≠o</div>';
                    
                    s.forEach(d => {
                        const m = d.data();
                        const id = d.id;
                        box.appendChild(this.createMessageElement(m, id));
                    });

                    // Auto scroll only if user was near bottom
                    if(wasAtBottom) box.scrollTop = box.scrollHeight;
                });
            },

            formatText(text) {
                if(!text) return "";
                // Escape HTML
                let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                // Bold *text*
                safe = safe.replace(/\*(.*?)\*/g, '<b>$1</b>');
                // Italic _text_
                safe = safe.replace(/_(.*?)_/g, '<i>$1</i>');
                // Linkify
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return safe.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
            },

            getInitials(name) {
                if(!name) return "?";
                const parts = name.split(' ');
                if(parts.length === 1) return parts[0].substring(0,2).toUpperCase();
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            },

            createMessageElement(m, id) {
                const mine = this.user && m.uid === this.user.uid;
                const time = m.at ? new Date(m.at.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                let name = m.name || "Anon";
                if (name.includes('@godsplan.site')) name = "ID " + name.split('@')[0];

                const div = document.createElement('div');
                div.className = `message-row ${mine?'mine':'theirs'}`;
                
                // --- CONTEXT MENU CLICK ---
                const openMenu = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.selectedMsg = { id, text: m.text, uid: m.uid, type: m.type };
                    const menu = document.getElementById('msgContext');
                    
                    // Position menu
                    const rect = e.target.closest('.bubble').getBoundingClientRect();
                    menu.style.top = (rect.bottom + 5) + 'px';
                    // Ajuste de posici√≥n en horizontal para que el men√∫ aparezca junto al mensaje
                    const menuWidth = 150; 
                    const leftPosition = mine ? (rect.right - menuWidth) : rect.left;
                    menu.style.left = leftPosition + 'px';
                    
                    document.getElementById('btnDeleteMsg').style.display = mine ? 'flex' : 'none';
                    menu.classList.add('active');
                };

                // --- DOUBLE TAP REACTION ---
                const toggleReaction = () => {
                   if(mine) return; 
                   this.addReaction(id, '‚ù§Ô∏è');
                };

                // HTML CONTENT
                let content = '';

                // Header info
                content += `<div class="sender-name">${name}</div>`;
                
                content += `<div class="bubble-container">`;
                
                // Avatar (only theirs)
                if(!mine) {
                    content += `<div class="avatar">${this.getInitials(name)}</div>`;
                }

                // Bubble Start
                const bubbleClass = m.type === 'package_request' ? 'bubble package-request' : 'bubble';
                const bubble = document.createElement('div'); // Creamos el elemento aqu√≠ para el atributo data-msg-id
                bubble.className = bubbleClass;
                bubble.id = `bubble-${id}`;

                // Reply Preview
                if(m.replyTo) {
                    content += `
                    <div class="reply-preview">
                        <div class="reply-name"><i class="ph-bold ph-arrow-bend-up-left"></i> ${m.replyTo.name}</div>
                        <div class="reply-text">${m.replyTo.text}</div>
                    </div>`;
                }

                // Main Content
                if (m.type === 'package_request') {
                    content += `
                        <div class="pkg-header"><i class="ph-bold ph-hand-waving"></i> APOYO REQUERIDO</div>
                        <div class="pkg-body font-bold mb-2">Por favor, bajen mis paquetes.</div>
                        <div class="pkg-date text-xs text-zinc-500 flex items-center gap-1"><i class="ph-bold ph-calendar"></i> Fecha: <strong>${m.targetDate}</strong></div>
                        ${m.reason ? `<div class="text-xs text-zinc-500 mt-1 flex items-center gap-1"><i class="ph-bold ph-info"></i> Nota: ${m.reason}</div>` : ''}
                    `;
                } else {
                    content += this.formatText(m.text);
                }

                // Meta & Time
                content += `<div class="msg-meta">${time} ${mine ? '<i class="ph-bold ph-check"></i>' : ''}</div>`;

                // Reaction Badge
                if(m.reactions && Object.keys(m.reactions).length > 0) {
                     const count = Object.keys(m.reactions).length;
                     content += `<div class="reaction-badge">‚ù§Ô∏è ${count > 1 ? count : ''}</div>`;
                }

                bubble.innerHTML = content; // Establecemos el contenido HTML del bubble

                div.querySelector('.bubble-container').appendChild(bubble); // Lo a√±adimos al container
                
                // Attach Events
                bubble.addEventListener('click', openMenu);
                bubble.addEventListener('dblclick', toggleReaction);

                return div;
            },

            // ACTIONS
            handleReply() {
                if(!this.selectedMsg) return;
                this.replyTo = this.selectedMsg;
                document.getElementById('replyBanner').classList.add('active');
                document.getElementById('replyTargetText').textContent = this.selectedMsg.text || "Solicitud de paquete";
                document.getElementById('msgContext').classList.remove('active');
                document.getElementById('messageInput').focus();
            },
            cancelReply() {
                this.replyTo = null;
                document.getElementById('replyBanner').classList.remove('active');
            },
            handleCopy() {
                if(this.selectedMsg) {
                    // Aseguramos que se copia solo el texto
                    document.execCommand('copy', false, this.selectedMsg.text); 
                }
                document.getElementById('msgContext').classList.remove('active');
            },
            handleDelete() {
                if(this.selectedMsg && confirm("¬øEliminar mensaje permanentemente?")) {
                    deleteDoc(doc(db, COLLECTION_NAME, this.selectedMsg.id));
                }
                document.getElementById('msgContext').classList.remove('active');
            },
            handleReaction() {
                if(this.selectedMsg) this.addReaction(this.selectedMsg.id, '‚ù§Ô∏è');
                document.getElementById('msgContext').classList.remove('active');
            },

            async addReaction(msgId, emoji) {
                if(!this.user || this.user.isAnonymous) return this.showMessage("Debes iniciar sesi√≥n para reaccionar.");
                const msgRef = doc(db, COLLECTION_NAME, msgId);
                
                try {
                    const snap = await getDoc(msgRef);
                    if(snap.exists()) {
                        const data = snap.data();
                        const reacts = data.reactions || {};
                        
                        // Toggle reaction
                        if(reacts[this.user.uid] === emoji) {
                            delete reacts[this.user.uid]; 
                        } else {
                            // If user reacted with something else, or nothing, set new reaction
                            reacts[this.user.uid] = emoji;
                        }
                        await updateDoc(msgRef, { reactions: reacts });
                    }
                } catch(e) { console.log(e); }
            },

            sendMessage() {
                const input = document.getElementById('messageInput');
                const txt = input.value.trim();
                if(!txt) return;

                // Verificaci√≥n final de autenticaci√≥n para mensajes
                if(!this.user || this.user.isAnonymous || localStorage.getItem('gp_pin_verified') !== 'true') {
                    this.showMessage("Inicia sesi√≥n con tu cuenta corporativa para enviar mensajes.");
                    input.value = '';
                    document.getElementById('authModal').classList.add('active');
                    return;
                }

                const payload = {
                    text: txt, type: 'text',
                    at: serverTimestamp(),
                    uid: this.user.uid,
                    name: this.user.displayName || this.user.email || "Anon",
                    channel: this.currentChannel
                };

                // Add Reply Metadata
                if(this.replyTo) {
                    payload.replyTo = {
                        id: this.replyTo.id,
                        text: this.replyTo.text.substring(0, 50) + (this.replyTo.text.length>50?'...':''),
                        name: (this.replyTo.uid === this.user.uid) ? "Yo" : "Usuario"
                    };
                    this.cancelReply();
                }

                addDoc(collection(db, COLLECTION_NAME), payload);
                input.value = '';
                input.focus();
                document.getElementById('sendButton').disabled = true;
                document.getElementById('emojiPicker').classList.remove('active');
            },

            openPkgModal() { document.getElementById('pkgModal').classList.add('active'); },
            
            sendPkgRequest() {
                const dateVal = document.getElementById('pkgDate').value;
                const reason = document.getElementById('pkgReason').value.trim();
                if(!dateVal) return this.showMessage("Selecciona una fecha");
                
                if(!this.user || this.user.isAnonymous || localStorage.getItem('gp_pin_verified') !== 'true') {
                    this.showMessage("Inicia sesi√≥n con tu cuenta corporativa para enviar solicitudes.");
                    document.getElementById('pkgModal').classList.remove('active');
                    document.getElementById('authModal').classList.add('active');
                    return;
                }
                
                const dateObj = new Date(dateVal + 'T00:00:00');
                const dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                
                addDoc(collection(db, COLLECTION_NAME), {
                    type: 'package_request', targetDate: dateStr, reason: reason,
                    at: serverTimestamp(),
                    uid: this.user.uid, name: this.user.displayName || this.user.email || "Anon", channel: 'paquetes'
                });
                document.getElementById('pkgModal').classList.remove('active');
                this.showMessage("Solicitud de Apoyo enviada con √©xito.");
            }
        };
        document.addEventListener('DOMContentLoaded', ()=>window.app.init());
    </script>
</body>
</html>
