<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gods Plan | Chat General</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">

    <!-- FUENTE: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        card: '#111111',
                        border: '#262626',
                        input: '#0a0a0a',
                        text: '#e5e5e5',
                        'text-mute': '#737373',
                        brand: '#dc2626', // Rojo Principal
                        'brand-dark': '#991b1b',
                        'msg-me': '#dc2626',
                        'msg-other': '#1f1f1f',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0, transform: 'translateY(-10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg); overflow: hidden; } /* Prevent body scroll, handle in chat container */
        
        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                        radial-gradient(circle at 90% 10%, rgba(220, 38, 38, 0.1) 0%, transparent 40%);
            filter: blur(80px); pointer-events: none;
        }

        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        /* Scrollbar personalizada para el chat */
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

        .input-gp {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: white;
            transition: all 0.3s; width: 100%; padding: 12px 16px; border-radius: 14px;
        }
        .input-gp:focus { border-color: #dc2626; background: rgba(220, 38, 38, 0.05); }

        .glass-panel {
            background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .msg-bubble {
            position: relative; max-width: 85%; padding: 10px 14px; border-radius: 18px;
            font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .msg-me {
            background: linear-gradient(135deg, #dc2626, #b91c1c); color: white;
            border-bottom-right-radius: 4px; margin-left: auto;
        }
        .msg-other {
            background: #1f1f1f; color: #e5e5e5; border: 1px solid #333;
            border-bottom-left-radius: 4px; margin-right: auto;
        }
        
        /* Auth Styles (Reused) */
        .auth-switch { display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .auth-switch button { flex: 1; padding: 8px; font-size: 0.8rem; font-weight: 700; z-index: 1; color: #666; transition: 0.3s; }
        .auth-switch button.active { color: white; }
        .btn-glow { position: relative; overflow: hidden; background: #dc2626; color: white; transition: all 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 20px rgba(220, 38, 38, 0.4); transform: translateY(-1px); }
    </style>
</head>

<body class="text-text font-sans h-screen flex flex-col md:items-center md:justify-center">

    <div class="aurora-bg"></div>
    <div class="grid-bg"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black md:bg-black/80 md:backdrop-blur-sm">
        <div class="w-full max-w-sm animate-fade-in">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/5 mb-4 border border-white/10">
                    <i class="ph-fill ph-chats-circle text-3xl text-brand"></i>
                </div>
                <h1 class="text-3xl font-black tracking-tight mb-1 text-white">SALA GENERAL</h1>
                <p class="text-text-mute text-xs font-mono tracking-widest uppercase">Canal Seguro Encriptado</p>
            </div>
            
            <div class="glass-panel rounded-3xl p-6 relative overflow-hidden">
                <div class="auth-switch">
                    <button onclick="window.app.toggleAuth('login')" id="tab-login" class="active">INGRESAR</button>
                    <button onclick="window.app.toggleAuth('register')" id="tab-register">REGISTRARSE</button>
                </div>
                
                <form onsubmit="event.preventDefault(); window.app.handleAuthSubmit();" class="flex flex-col gap-4">
                    <div id="field-name" class="hidden">
                        <input type="text" id="input-name" class="input-gp" placeholder="Tu Nombre P√∫blico">
                    </div>
                    <input type="text" id="input-email" class="input-gp" placeholder="Email o ID" required>
                    <input type="password" id="input-pass" class="input-gp" placeholder="Contrase√±a" required>
                    
                    <div id="auth-error" class="hidden text-red-400 text-xs font-bold text-center bg-red-900/10 p-2 rounded">Error</div>
                    
                    <button type="submit" id="btn-submit" class="btn-glow w-full py-3.5 rounded-xl font-bold uppercase tracking-widest text-xs mt-2">
                        ENTRAR AL CHAT
                    </button>
                </form>
                
                <div class="relative my-5 text-center">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                    <span class="relative bg-[#111] px-2 text-[10px] text-zinc-500 font-bold uppercase">Opcional</span>
                </div>
                <button onclick="window.app.loginGoogle()" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white text-xs font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all">
                    <i class="ph-bold ph-google-logo text-lg"></i> Acceder con Google
                </button>
            </div>
        </div>
    </div>

    <!-- CHAT INTERFACE (Adaptado para PC y M√≥vil) -->
    <div id="chat-view" class="hidden flex-col w-full h-full bg-black relative shadow-2xl md:max-w-6xl md:h-[90vh] md:rounded-2xl md:border md:border-border md:overflow-hidden">
        
        <!-- HEADER -->
        <header class="h-[60px] glass-panel border-b border-border flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-brand flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-brand/20">
                    <i class="ph-fill ph-users-three"></i>
                </div>
                <div>
                    <h2 class="font-bold text-sm text-white leading-tight">SALA GENERAL</h2>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-[10px] text-text-mute font-mono uppercase tracking-wide">EN L√çNEA</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <div class="hidden md:flex flex-col items-end mr-2">
                    <span class="text-[10px] text-text-mute uppercase font-bold tracking-widest">Conectado como</span>
                    <span id="user-display-name" class="text-xs font-bold text-white">--</span>
                </div>
                <button onclick="window.app.logout()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 text-text-mute hover:text-white transition-colors" title="Cerrar Sesi√≥n">
                    <i class="ph-bold ph-sign-out text-lg"></i>
                </button>
            </div>
        </header>

        <!-- MESSAGES AREA -->
        <div id="messages-list" class="flex-1 overflow-y-auto p-4 space-y-3 chat-scroll relative bg-black/50">
            <!-- Loading State -->
            <div id="chat-loader" class="absolute inset-0 flex items-center justify-center bg-black z-10">
                <div class="animate-spin w-6 h-6 border-2 border-brand border-t-transparent rounded-full"></div>
            </div>
            <!-- Messages will be injected here -->
        </div>

        <!-- INPUT AREA -->
        <div class="p-3 pb-5 md:p-4 glass-panel border-t border-border shrink-0">
            <form onsubmit="event.preventDefault(); window.app.sendMessage();" class="flex items-end gap-2 relative max-w-4xl mx-auto w-full">
                <input type="text" id="msg-input" autocomplete="off" 
                    class="w-full bg-[#0a0a0a] border border-[#333] text-white rounded-2xl py-3 pl-4 pr-12 focus:border-brand focus:outline-none transition-colors placeholder-zinc-600 shadow-inner"
                    placeholder="Escribe un mensaje...">
                
                <button type="submit" class="absolute right-1.5 bottom-1.5 w-9 h-9 bg-brand text-white rounded-xl flex items-center justify-center hover:bg-red-600 hover:scale-105 transition-all shadow-lg shadow-brand/20">
                    <i class="ph-fill ph-paper-plane-right text-lg translate-x-px translate-y-px"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyD0lX3XmVPQHNNxpsZS82YzDMzM6MLhq3g",
  authDomain: "godsplan-blqa.firebaseapp.com",
  projectId: "godsplan-blqa",
  storageBucket: "godsplan-blqa.firebasestorage.app",
  messagingSenderId: "1008783768310",
  appId: "1:1008783768310:web:c09fe541a2f4d23e5b8ad7",
  measurementId: "G-924H3FVC6Z"
};

        let auth, db;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Error", e); }

        // APP LOGIC
        window.app = {
            user: null,
            isRegistering: false,
            unsubscribe: null,
            // CR√çTICO: Usar el ID din√°mico de la app o fallback
            appId: typeof __app_id !== 'undefined' ? __app_id : 'godsplan-chat', 

            init() {
                // CR√çTICO: Autenticaci√≥n inicial con el token del entorno para evitar errores de permisos
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Error autenticaci√≥n inicial:", e);
                        }
                    }
                };
                initAuth();

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        this.user = u;
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('chat-view').classList.remove('hidden');
                        document.getElementById('chat-view').classList.add('flex');
                        
                        const dn = document.getElementById('user-display-name');
                        if(dn) dn.textContent = u.displayName || u.email.split('@')[0];

                        this.loadMessages();
                    } else {
                        this.user = null;
                        if (this.unsubscribe) this.unsubscribe();
                        document.getElementById('chat-view').classList.add('hidden');
                        document.getElementById('chat-view').classList.remove('flex');
                        document.getElementById('login-view').classList.remove('hidden');
                    }
                });
            },

            // AUTH
            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                document.getElementById('tab-login').classList.toggle('active', !this.isRegistering);
                document.getElementById('tab-register').classList.toggle('active', this.isRegistering);
                document.getElementById('btn-submit').textContent = this.isRegistering ? 'CREAR CUENTA' : 'ENTRAR AL CHAT';
                document.getElementById('field-name').classList.toggle('hidden', !this.isRegistering);
                document.getElementById('auth-error').classList.add('hidden');
            },

            async handleAuthSubmit() {
                const email = document.getElementById('input-email').value.trim();
                const pass = document.getElementById('input-pass').value;
                const name = document.getElementById('input-name').value.trim();
                const btn = document.getElementById('btn-submit');
                const errEl = document.getElementById('auth-error');

                if (!email || !pass) return;
                const finalEmail = email.includes('@') ? email : `${email}@godsplan.site`;

                btn.disabled = true;
                btn.textContent = '...';
                errEl.classList.add('hidden');

                try {
                    if (this.isRegistering) {
                        if(!name) throw new Error("Nombre requerido");
                        const cred = await createUserWithEmailAndPassword(auth, finalEmail, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalEmail, pass);
                    }
                } catch (e) {
                    errEl.textContent = e.message;
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = this.isRegistering ? 'CREAR CUENTA' : 'ENTRAR AL CHAT';
                }
            },

            async loginGoogle() {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { console.error(e); }
            },

            logout() { signOut(auth); },

            // CHAT CORE
            loadMessages() {
                const list = document.getElementById('messages-list');
                const loader = document.getElementById('chat-loader');
                
                // CR√çTICO: Usar this.appId din√°mico para cumplir con las reglas de seguridad
                const q = query(
                    collection(db, 'artifacts', this.appId, 'public', 'data', 'messages'),
                    orderBy('timestamp', 'asc'),
                    limit(100)
                );

                this.unsubscribe = onSnapshot(q, (snapshot) => {
                    loader.classList.add('hidden');
                    list.innerHTML = ''; 
                    
                    snapshot.forEach(doc => {
                        this.renderMessage(doc.data());
                    });
                    
                    this.scrollToBottom();
                }, (error) => {
                    console.error("Firestore Error:", error);
                    // Si falla por permisos incluso despu√©s de auth, podr√≠a ser un problema de cach√© o reglas.
                });
            },

            renderMessage(msg) {
                const list = document.getElementById('messages-list');
                const isMe = msg.uid === this.user.uid;
                
                const div = document.createElement('div');
                div.className = `flex flex-col mb-1 ${isMe ? 'items-end' : 'items-start'}`;
                
                const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                
                div.innerHTML = `
                    <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'} animate-slide-up">
                        ${!isMe ? `<div class="text-[0.65rem] font-bold opacity-70 mb-0.5 text-brand">${msg.displayName || 'Usuario'}</div>` : ''}
                        <div class="text-white">${this.escapeHtml(msg.text)}</div>
                        <div class="text-[0.6rem] text-right mt-1 opacity-50 font-mono">${time}</div>
                    </div>
                `;
                list.appendChild(div);
            },

            async sendMessage() {
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                if (!text) return;

                input.value = ''; // Optimistic clear
                this.scrollToBottom();

                try {
                    // CR√çTICO: Usar this.appId din√°mico
                    await addDoc(collection(db, 'artifacts', this.appId, 'public', 'data', 'messages'), {
                        text: text,
                        uid: this.user.uid,
                        displayName: this.user.displayName || this.user.email.split('@')[0],
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error enviando", e);
                    input.value = text; // Restore if fail
                }
            },

            scrollToBottom() {
                const list = document.getElementById('messages-list');
                setTimeout(() => list.scrollTop = list.scrollHeight, 50);
            },

            escapeHtml(text) {
                if (!text) return text;
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
