<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Clean Monaco & Console</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        brand: { DEFAULT: '#007ACC', hover: '#005fa3' }, 
                        bg: '#1e1e1e',
                        panel: '#252526',
                        border: '#333333',
                        console: '#242424'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #1e1e1e; color: #cccccc; overflow: hidden; margin: 0; padding: 0; }

        /* Scrollbar estilo VS Code/Chrome Dark */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
        ::-webkit-scrollbar-corner { background: #1e1e1e; }

        .resizer-v {
            width: 4px; background: #2b2b2b; cursor: col-resize; z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .resizer-v:hover, .resizer-v.active { background: #007ACC; }

        .myLineDecoration {
            background: rgba(0, 122, 204, 0.3) !important;
            border-left: 2px solid #007ACC;
            width: 100% !important;
        }
        
        .animate-inspect { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(0, 122, 204, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(0, 122, 204, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 122, 204, 0); }
        }

        /* Consola Styles */
        .console-log { color: #cccccc; border-bottom: 1px solid #333; padding: 4px 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; display: flex; gap: 8px; }
        .console-warn { background: rgba(255, 200, 0, 0.1); color: #fce97f; border-left: 3px solid #fce97f; }
        .console-error { background: rgba(255, 0, 0, 0.1); color: #ff8080; border-left: 3px solid #ff8080; }
        .console-input:focus { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ESTADO INICIAL VOLÁTIL (Se reinicia al refrescar)
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God's Plan</title>
    <style>
        body { background: #000; color: #8B0000; display: grid; place-items: center; height: 100vh; font-family: monospace; margin: 0; font-size: 14px; }
    </style>
</head>
<body>
    godsplan by blqa
</body>
</html>`;

        // Script que intercepta la consola dentro del iframe
        const CONSOLE_INTERCEPTOR = `
            <script>
                (function() {
                    const sendToParent = (type, args) => {
                        const payload = args.map(arg => {
                            try {
                                if (typeof arg === 'object' && arg !== null) return JSON.stringify(arg);
                                return String(arg);
                            } catch (e) {
                                return '[Circular/Unserializable]';
                            }
                        });
                        window.parent.postMessage({ type: 'CONSOLE_MSG', level: type, payload: payload }, '*');
                    };

                    const originalLog = console.log;
                    const originalWarn = console.warn;
                    const originalError = console.error;

                    console.log = function(...args) { originalLog.apply(console, args); sendToParent('log', args); };
                    console.warn = function(...args) { originalWarn.apply(console, args); sendToParent('warn', args); };
                    console.error = function(...args) { originalError.apply(console, args); sendToParent('error', args); };

                    window.onerror = function(msg, url, line, col, error) {
                        sendToParent('error', [\`Uncaught Error: \${msg} (Line \${line})\`]);
                        return false;
                    };

                    window.addEventListener('message', (e) => {
                        if (e.data.type === 'EVAL_CODE') {
                            try {
                                const result = eval(e.data.code);
                                console.log('<Result>', result);
                            } catch (err) {
                                console.error(err.toString());
                            }
                        }
                    });
                })();
            <\/script>
        `;

        // Script del inspector visual (Highlight)
        const INSPECTOR_SCRIPT = `
            <script>
                (function() {
                    let isInspecting = false;
                    let overlay = document.createElement('div');
                    overlay.style.cssText = 'position: fixed; pointer-events: none; z-index: 99999; border: 2px solid #007ACC; background: rgba(0, 122, 204, 0.1); display: none;';
                    document.body.appendChild(overlay);

                    window.addEventListener('message', (e) => {
                        if (e.data.type === 'TOGGLE_INSPECT') {
                            isInspecting = e.data.value;
                            overlay.style.display = 'none';
                            document.body.style.cursor = isInspecting ? 'crosshair' : 'default';
                        }
                        if (e.data.type === 'HIGHLIGHT_ELEMENT') {
                            const target = document.querySelector(\`[data-src-line="\${e.data.line}"]\`);
                            if(target) {
                                const rect = target.getBoundingClientRect();
                                overlay.style.display = 'block';
                                overlay.style.top = rect.top + 'px';
                                overlay.style.left = rect.left + 'px';
                                overlay.style.width = rect.width + 'px';
                                overlay.style.height = rect.height + 'px';
                                setTimeout(() => overlay.style.display = 'none', 1500);
                            }
                        }
                    });

                    document.addEventListener('mouseover', (e) => {
                        if (!isInspecting || e.target === document.body || e.target === overlay) return;
                        e.stopPropagation();
                        const rect = e.target.getBoundingClientRect();
                        overlay.style.display = 'block';
                        overlay.style.top = rect.top + 'px';
                        overlay.style.left = rect.left + 'px';
                        overlay.style.width = rect.width + 'px';
                        overlay.style.height = rect.height + 'px';
                    });

                    document.addEventListener('click', (e) => {
                        if (!isInspecting) return;
                        e.preventDefault();
                        e.stopPropagation();
                        let target = e.target;
                        let srcLine = target.getAttribute('data-src-line');
                        if (srcLine) {
                            window.parent.postMessage({ type: 'ELEMENT_CLICKED', line: parseInt(srcLine) }, '*');
                        }
                    });
                })();
            <\/script>
        `;

        const ConsolePanel = ({ logs, onClear, onExecute }) => {
            const [input, setInput] = useState('');
            const endRef = useRef(null);

            useEffect(() => {
                endRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                onExecute(input);
                setInput('');
            };

            return (
                <div className="flex flex-col h-full w-full bg-[#1e1e1e] text-gray-300 font-mono text-xs">
                    {/* Console Toolbar */}
                    <div className="h-9 bg-[#252526] border-b border-[#111] flex items-center px-2 gap-2 justify-between shrink-0">
                        <div className="flex items-center gap-2">
                             <button 
                                onClick={onClear}
                                className="flex items-center gap-1 px-2 py-1 bg-[#333] hover:bg-[#444] text-white rounded border border-[#444] transition-colors"
                                title="Limpiar Consola"
                            >
                                <i className="ph-bold ph-prohibit text-gray-300"></i>
                                <span className="text-[10px] font-bold">CLEAR</span>
                            </button>
                            <div className="h-4 w-[1px] bg-gray-500 mx-1"></div>
                            <input type="text" placeholder="Filter..." className="bg-[#1e1e1e] border border-[#444] px-2 h-6 rounded text-gray-300 w-32 focus:outline-none focus:border-blue-500 text-[10px]"/>
                        </div>
                        <span className="text-[10px] text-gray-500">JS Console</span>
                    </div>

                    {/* Logs Area */}
                    <div className="flex-1 overflow-y-auto p-1 bg-[#1e1e1e]">
                        {logs.length === 0 && <div className="text-gray-500 italic p-4 text-center mt-10 opacity-50">Console is empty</div>}
                        {logs.map((log, i) => (
                            <div key={i} className={`console-log ${log.level === 'error' ? 'console-error' : log.level === 'warn' ? 'console-warn' : ''} border-b border-[#2b2b2b]`}>
                                {log.level === 'error' ? <i className="ph-fill ph-x-circle text-red-500 mt-0.5 shrink-0"></i> : 
                                 log.level === 'warn' ? <i className="ph-fill ph-warning text-yellow-500 mt-0.5 shrink-0"></i> : 
                                 log.level === 'command' ? <i className="ph-bold ph-caret-right text-gray-500 mt-0.5 shrink-0"></i> :
                                 <i className="ph-bold ph-info text-blue-400 mt-0.5 shrink-0"></i>}
                                <div className="break-all whitespace-pre-wrap flex-1">
                                    {log.payload.join(' ')}
                                </div>
                            </div>
                        ))}
                        <div ref={endRef}></div>
                    </div>

                    {/* Input Line */}
                    <form onSubmit={handleSubmit} className="h-8 border-t border-[#333] flex items-center px-2 bg-[#252526] shrink-0">
                        <i className="ph-bold ph-caret-right text-blue-500 mr-2"></i>
                        <input 
                            type="text" 
                            className="flex-1 bg-transparent border-none outline-none text-white console-input font-mono"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Ejecutar JavaScript..."
                            autoComplete="off"
                        />
                    </form>
                </div>
            );
        };

        const App = () => {
            const [code, setCode] = useState(DEFAULT_CODE);
            const [logs, setLogs] = useState([]);
            
            // Layout State
            const [previewWidth, setPreviewWidth] = useState(50); // El % es para la izquierda (preview)
            const [activeTab, setActiveTab] = useState('code'); // 'code' | 'console'
            const [isInspectorActive, setIsInspectorActive] = useState(false);
            
            // Refs
            const iframeRef = useRef(null);
            const editorContainerRef = useRef(null);
            const monacoRef = useRef(null);
            const decorationsRef = useRef([]);

            // Resizing State
            const [isDraggingH, setIsDraggingH] = useState(false);

            // 1. Monaco Setup
            useEffect(() => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
                require(['vs/editor/editor.main'], function () {
                    if (!editorContainerRef.current) return;
                    const editor = monaco.editor.create(editorContainerRef.current, {
                        value: code,
                        language: 'html',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 13,
                        fontFamily: "'JetBrains Mono', 'Courier New', monospace", // Fallback añadido
                        fontLigatures: true,
                        padding: { top: 16 },
                        scrollBeyondLastLine: false,
                    });

                    // FIX: Esperar a que la fuente cargue y recalcular medidas para evitar desajuste visual
                    document.fonts.ready.then(() => {
                        monaco.editor.remeasureFonts();
                    });

                    editor.onDidChangeModelContent(() => {
                        setCode(editor.getValue());
                    });

                    editor.onDidChangeCursorPosition((e) => {
                        if (iframeRef.current?.contentWindow) {
                            iframeRef.current.contentWindow.postMessage({ type: 'HIGHLIGHT_ELEMENT', line: e.position.lineNumber }, '*');
                        }
                    });

                    monacoRef.current = editor;
                });
            }, []);

            // Handle Tab Switch Layout Update
            useEffect(() => {
                if (activeTab === 'code' && monacoRef.current) {
                    // Small delay to allow container to be visible
                    setTimeout(() => monacoRef.current.layout(), 50);
                }
            }, [activeTab, previewWidth]);

            // 2. Code Injection & Preview
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (iframeRef.current) {
                        const lines = code.split('\n');
                        const processedCode = lines.map((line, index) => {
                            const lineNum = index + 1;
                            if (line.includes('<script') || line.includes('<style')) return line;
                            return line.replace(/<([a-zA-Z0-9-]+)([^>]*?)>/, (match, tag, attrs) => `<${tag} data-src-line="${lineNum}"${attrs}>`);
                        }).join('\n');

                        const finalSrc = processedCode.replace('</body>', `${CONSOLE_INTERCEPTOR}${INSPECTOR_SCRIPT}</body>`);
                        iframeRef.current.srcdoc = finalSrc;
                        
                        setLogs([]); 
                        setLogs(prev => [...prev, { level: 'info', payload: ['System: Ready.'] }]);
                    }
                }, 800);
                return () => clearTimeout(timer);
            }, [code]);

            // 3. Message Handling
            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data.type === 'CONSOLE_MSG') {
                        setLogs(prev => [...prev, { level: e.data.level, payload: e.data.payload }]);
                    }
                    if (e.data.type === 'ELEMENT_CLICKED' && monacoRef.current) {
                        // Switch to code tab if clicked
                        setActiveTab('code');
                        
                        const lineNum = e.data.line;
                        monacoRef.current.revealLineInCenter(lineNum);
                        monacoRef.current.setPosition({ lineNumber: lineNum, column: 1 });
                        monacoRef.current.focus();
                        setIsInspectorActive(false);
                        
                        const newDecorations = [{
                            range: new monaco.Range(lineNum, 1, lineNum, 1),
                            options: { isWholeLine: true, className: 'myLineDecoration' }
                        }];
                        decorationsRef.current = monacoRef.current.deltaDecorations(decorationsRef.current, newDecorations);
                        setTimeout(() => decorationsRef.current = monacoRef.current.deltaDecorations(decorationsRef.current, []), 1000);
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            useEffect(() => {
                if (iframeRef.current?.contentWindow) {
                    iframeRef.current.contentWindow.postMessage({ type: 'TOGGLE_INSPECT', value: isInspectorActive }, '*');
                }
            }, [isInspectorActive]);

            const handleMouseMove = useCallback((e) => {
                if (isDraggingH) {
                    const newWidth = (e.clientX / window.innerWidth) * 100;
                    if (newWidth > 20 && newWidth < 80) setPreviewWidth(newWidth);
                }
            }, [isDraggingH]);

            const handleMouseUp = useCallback(() => setIsDraggingH(false), []);

            useEffect(() => {
                if (isDraggingH) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                }
            }, [isDraggingH]);

            const executeConsoleCommand = (cmd) => {
                setLogs(prev => [...prev, { level: 'command', payload: [`> ${cmd}`] }]);
                if (iframeRef.current?.contentWindow) {
                    iframeRef.current.contentWindow.postMessage({ type: 'EVAL_CODE', code: cmd }, '*');
                }
            };

            return (
                <div className="flex flex-col h-screen w-full bg-bg text-[#cccccc] font-sans select-none overflow-hidden">
                    
                    {/* Header */}
                    <header className="h-10 bg-[#1e1e1e] border-b border-[#333] flex items-center justify-between px-4 shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <span className="text-xs font-bold text-gray-300 tracking-wide">GOD'S PLAN <span className="opacity-50">| F12 EDITION</span></span>
                        </div>
                        <div className="flex items-center gap-2">
                             <button onClick={() => setIsInspectorActive(!isInspectorActive)}
                                className={`flex items-center gap-2 px-3 py-1 text-xs font-medium rounded transition-all border ${isInspectorActive ? 'bg-blue-900/30 text-blue-400 border-blue-500/50 animate-inspect' : 'bg-[#2d2d2d] border-transparent text-gray-400'}`}>
                                <i className={`ph-bold ${isInspectorActive ? 'ph-crosshair' : 'ph-cursor-click'}`}></i>
                                {isInspectorActive ? 'DETECTANDO...' : 'INSPECCIONAR'}
                            </button>
                        </div>
                    </header>

                    {/* Main Content Area (Inverted Layout: Preview Left, Editor Right) */}
                    <div className="flex-1 flex overflow-hidden relative w-full h-full">
                        
                        {/* LEFT PANE: Preview */}
                        <div className="flex flex-col h-full bg-white relative" style={{ width: `${previewWidth}%` }}>
                            <iframe ref={iframeRef} className="w-full h-full border-none" sandbox="allow-scripts allow-modals allow-forms allow-same-origin" title="Preview"></iframe>
                            {isDraggingH && <div className="absolute inset-0 z-50 bg-transparent"></div>}
                        </div>

                        {/* RESIZER */}
                        <div className={`resizer-v ${isDraggingH ? 'active' : ''}`} onMouseDown={() => setIsDraggingH(true)}></div>

                        {/* RIGHT PANE: Editor & Console Tabs */}
                        <div className="flex flex-col h-full bg-[#1e1e1e]" style={{ width: `${100 - previewWidth}%` }}>
                            
                            {/* Tabs Header */}
                            <div className="flex bg-[#252526] border-b border-[#111]">
                                <button 
                                    onClick={() => setActiveTab('code')}
                                    className={`px-4 py-2 text-xs flex items-center gap-2 border-t-2 ${activeTab === 'code' ? 'bg-[#1e1e1e] border-blue-500 text-white' : 'bg-[#2d2d2d] border-transparent text-gray-400 hover:bg-[#333]'}`}
                                >
                                    <i className="ph-fill ph-file-html text-orange-500"></i> index.html
                                </button>
                                <button 
                                    onClick={() => setActiveTab('console')}
                                    className={`px-4 py-2 text-xs flex items-center gap-2 border-t-2 ${activeTab === 'console' ? 'bg-[#1e1e1e] border-blue-500 text-white' : 'bg-[#2d2d2d] border-transparent text-gray-400 hover:bg-[#333]'}`}
                                >
                                    <i className="ph-bold ph-terminal-window text-gray-400"></i> Consola
                                    {logs.length > 1 && <span className="bg-blue-600 text-[9px] px-1 rounded-full text-white">{logs.length}</span>}
                                </button>
                            </div>

                            {/* Tab Content Area */}
                            <div className="flex-1 relative w-full h-full overflow-hidden">
                                
                                {/* 1. Monaco Editor Container */}
                                <div 
                                    className="absolute inset-0 w-full h-full" 
                                    style={{ visibility: activeTab === 'code' ? 'visible' : 'hidden', zIndex: activeTab === 'code' ? 10 : 0 }}
                                >
                                    <div ref={editorContainerRef} className="absolute inset-0"></div>
                                </div>

                                {/* 2. Console Container */}
                                {activeTab === 'console' && (
                                    <div className="absolute inset-0 w-full h-full z-20 bg-[#1e1e1e]">
                                        <ConsolePanel 
                                            logs={logs} 
                                            onClear={() => setLogs([])}
                                            onExecute={executeConsoleCommand}
                                        />
                                    </div>
                                )}
                            </div>

                        </div>
                    </div>

                    {/* Global Overlays */}
                    {isDraggingH && <div className="fixed inset-0 z-[100] cursor-col-resize"></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
