<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Code Editor</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes y Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    },
                    colors: {
                        brand: { DEFAULT: '#E70000', hover: '#cc0000', glow: 'rgba(231,0,0,0.5)' }, 
                        dark: '#030000',
                        glass: 'rgba(20, 20, 20, 0.7)'
                    },
                    animation: {
                        'nebula': 'nebula 20s infinite alternate',
                    },
                    keyframes: {
                        nebula: {
                            '0%': { transform: 'scale(1)', opacity: '0.3' },
                            '100%': { transform: 'scale(1.2)', opacity: '0.6' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #030000; color: white; overflow: hidden; }

        /* FONDO DINÁMICO (AURORA) */
        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(231, 0, 0, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(100, 0, 0, 0.2) 0%, transparent 40%);
            filter: blur(80px);
            animation: nebula 15s infinite alternate ease-in-out;
        }

        /* RED (GRID) */
        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        .editor-textarea {
            font-family: 'Fira Code', monospace;
            tab-size: 2;
            line-height: 1.5;
            background: rgba(0,0,0,0.3);
            caret-color: #E70000;
        }
        
        .editor-textarea:focus { outline: none; }

        /* Highlight de línea seleccionada (simulado) */
        .highlight-line {
            background-color: rgba(231, 0, 0, 0.2);
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #E70000; }

        .glass-panel {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Código por defecto: Hola Mundo Simple
        const INITIAL_CODE = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola Mundo</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-slate-900 flex items-center justify-center h-screen text-white">
    
    <div class="text-center p-10 border border-white/10 rounded-2xl bg-white/5 backdrop-blur-md shadow-xl">
        <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
            ¡Hola Mundo!
        </h1>
        <p class="text-gray-400 text-lg">
            Selecciona el icono de <span class="text-yellow-400 font-bold">mira ⌖</span> arriba
            y haz click en este texto para ver su código.
        </p>
        <button class="mt-6 px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-full transition-colors font-medium">
            Botón de Ejemplo
        </button>
    </div>

</body>
</html>`;

        // Script inyectado para manejar la inspección dentro del iframe
        const INSPECTOR_SCRIPT = `
            <script>
                (function() {
                    let isInspecting = false;
                    let lastHighlighted = null;

                    window.addEventListener('message', (e) => {
                        if (e.data.type === 'TOGGLE_INSPECT') {
                            isInspecting = e.data.value;
                            document.body.style.cursor = isInspecting ? 'crosshair' : 'default';
                            if(!isInspecting && lastHighlighted) {
                                lastHighlighted.style.outline = '';
                                lastHighlighted = null;
                            }
                        }
                    });

                    document.addEventListener('mouseover', (e) => {
                        if (!isInspecting) return;
                        e.stopPropagation();
                        
                        if (lastHighlighted) lastHighlighted.style.outline = '';
                        
                        e.target.style.outline = '2px dashed #E70000';
                        e.target.style.cursor = 'crosshair';
                        lastHighlighted = e.target;
                    });

                    document.addEventListener('mouseout', (e) => {
                        if (!isInspecting) return;
                        e.target.style.outline = '';
                    });

                    document.addEventListener('click', (e) => {
                        if (!isInspecting) return;
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Enviar la etiqueta de apertura para buscarla
                        // Tomamos los primeros 50 caracteres para asegurar una búsqueda más única pero no gigante
                        let tagSnippet = e.target.outerHTML.split('>')[0] + '>';
                        
                        window.parent.postMessage({ 
                            type: 'ELEMENT_CLICKED', 
                            snippet: tagSnippet,
                            tagName: e.target.tagName.toLowerCase()
                        }, '*');
                        
                        // Desactivar highlight visual al hacer click
                        if (lastHighlighted) lastHighlighted.style.outline = '';
                        isInspecting = false;
                        document.body.style.cursor = 'default';
                    });
                })();
            <\/script>
        `;

        const App = () => {
            const [code, setCode] = useState(INITIAL_CODE);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [srcDoc, setSrcDoc] = useState('');
            const [isInspectorActive, setIsInspectorActive] = useState(false);
            
            const iframeRef = useRef(null);
            const textareaRef = useRef(null);

            // Actualizar el iframe con el código + script de inspección
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    // Inyectamos el script de inspección justo antes de cerrar el body
                    const codeWithInspector = code.replace('</body>', `${INSPECTOR_SCRIPT}</body>`);
                    setSrcDoc(codeWithInspector);
                }, 400); 
                return () => clearTimeout(timeoutId);
            }, [code]);

            // Comunicar estado del inspector al iframe
            useEffect(() => {
                if (iframeRef.current && iframeRef.current.contentWindow) {
                    iframeRef.current.contentWindow.postMessage({
                        type: 'TOGGLE_INSPECT',
                        value: isInspectorActive
                    }, '*');
                }
            }, [isInspectorActive, srcDoc]);

            // Escuchar mensajes del iframe (Click en inspector)
            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data.type === 'ELEMENT_CLICKED') {
                        setIsInspectorActive(false); // Apagar inspector
                        findAndScrollToLine(e.data.snippet);
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [code]);

            const findAndScrollToLine = (snippet) => {
                if (!textareaRef.current) return;

                // Intento simple de búsqueda: buscar el string exacto
                // Nota: Esto es una aproximación. Si hay elementos idénticos, irá al primero.
                // Limpiamos un poco el snippet para mejorar el match (quitamos clases inyectadas si las hubiera)
                const searchStr = snippet.replace(/ style=".*?"/g, ''); 
                
                // Buscar índice en el código
                // Usamos una búsqueda flexible: solo la etiqueta de apertura sin atributos si falla la exacta
                let index = code.indexOf(searchStr);
                
                // Si no encuentra match exacto, intentamos buscar solo la etiqueta base (ej: <h1)
                if (index === -1) {
                    const basicTag = snippet.split(' ')[0]; 
                    index = code.indexOf(basicTag);
                }

                if (index !== -1) {
                    // Calcular número de línea
                    const lines = code.substring(0, index).split('\n');
                    const lineNumber = lines.length;
                    
                    // Mover scroll del textarea
                    const lineHeight = 24; // Aproximado basado en font-size/line-height css
                    textareaRef.current.scrollTop = (lineNumber - 5) * lineHeight; // -5 para centrar un poco
                    
                    // Enfocar y seleccionar (opcional, seleccionamos la línea)
                    textareaRef.current.focus();
                    textareaRef.current.setSelectionRange(index, index + searchStr.length);
                    
                    // Efecto visual momentáneo en textarea (opcional)
                    alert(`Elemento encontrado en línea: ${lineNumber}`);
                } else {
                    alert("No pude localizar la línea exacta en el código crudo.");
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    const value = e.target.value;
                    setCode(value.substring(0, start) + '  ' + value.substring(end));
                    setTimeout(() => {
                        e.target.selectionStart = e.target.selectionEnd = start + 2;
                    }, 0);
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(code);
                const btn = document.getElementById('btn-copy');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-check"></i> COPIADO';
                setTimeout(() => btn.innerHTML = originalText, 2000);
            };

            return (
                <div className="flex flex-col h-screen w-full relative">
                    <div className="aurora-bg"></div>
                    <div className="grid-bg"></div>

                    {/* Header */}
                    <header className="h-16 border-b border-white/5 bg-black/40 backdrop-blur-md flex items-center justify-between px-6 shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="relative w-8 h-8 flex items-center justify-center">
                                <div className="absolute inset-0 bg-brand rounded-full blur opacity-40"></div>
                                <i className="ph-fill ph-code text-2xl text-brand relative z-10"></i>
                            </div>
                            <div>
                                <h1 className="font-bold tracking-widest text-sm text-white">GOD'S PLAN</h1>
                                <span className="text-[10px] text-zinc-500 font-mono uppercase tracking-[0.2em]">Code Canvas</span>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <button 
                                id="btn-inspector"
                                onClick={() => setIsInspectorActive(!isInspectorActive)}
                                className={`flex items-center gap-2 px-4 py-2 text-xs font-bold tracking-wider border rounded-lg transition-all ${isInspectorActive ? 'bg-brand text-white border-brand shadow-[0_0_15px_rgba(231,0,0,0.5)]' : 'bg-white/5 border-white/10 text-zinc-400 hover:text-white'}`}
                                title="Inspector de Elementos (Selecciona y encuentra código)"
                            >
                                <i className="ph-bold ph-crosshair"></i>
                                {isInspectorActive ? 'SELECCIONA ELEMENTO...' : 'INSPECTOR'}
                            </button>

                            <button 
                                id="btn-copy"
                                onClick={copyToClipboard}
                                className="flex items-center gap-2 px-4 py-2 text-xs font-bold tracking-wider bg-white/5 border border-white/10 hover:bg-white/10 hover:border-brand/50 hover:text-white text-zinc-400 rounded-lg transition-all"
                            >
                                <i className="ph-bold ph-copy"></i>
                                EXPORTAR
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 flex overflow-hidden relative z-10">
                        
                        {/* 1. Panel Izquierdo: Previsualización (Ahora a la izquierda) */}
                        <div className={`${isSidebarOpen ? 'w-full md:w-1/2' : 'w-full'} bg-black relative flex flex-col transition-all duration-500 order-1`}>
                            
                            {/* Toolbar Preview */}
                            <div className="h-10 bg-black border-b border-white/5 flex items-center justify-between px-4">
                                <div className="flex items-center gap-2 w-full max-w-xs">
                                    <div className="px-3 py-1 bg-white/5 rounded text-[10px] text-zinc-500 border border-white/5 flex items-center gap-2 w-full">
                                        <i className="ph-fill ph-globe text-brand"></i> 
                                        <span className="truncate">Vista Previa</span>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="text-zinc-500 hover:text-white md:block hidden transition-colors"
                                    title={isSidebarOpen ? "Pantalla completa" : "Dividir pantalla"}
                                >
                                    <i className={`ph-bold ${isSidebarOpen ? "ph-arrows-out-simple" : "ph-arrows-in-simple"} text-lg`}></i>
                                </button>
                            </div>

                            {/* Iframe */}
                            <div className="flex-1 w-full h-full bg-white relative">
                                <iframe
                                    ref={iframeRef}
                                    srcDoc={srcDoc}
                                    title="preview"
                                    sandbox="allow-scripts allow-modals allow-forms allow-same-origin allow-popups"
                                    className="w-full h-full border-none"
                                ></iframe>
                                
                                {/* Overlay indicador de modo inspector */}
                                {isInspectorActive && (
                                    <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-brand text-white px-4 py-1 rounded-full text-xs font-bold shadow-lg pointer-events-none animate-bounce">
                                        Modo Inspector Activo: Haz click en un elemento
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 2. Panel Derecho: Editor (Ahora a la derecha) */}
                        <div className={`${isSidebarOpen ? 'w-full md:w-1/2' : 'w-0 hidden'} transition-all duration-500 flex flex-col border-l border-white/5 glass-panel relative group order-2`}>
                            
                            <div className="h-10 flex items-center justify-between px-4 border-b border-white/5 bg-black/20">
                                <div className="flex items-center gap-2">
                                    <i className="ph-fill ph-file-html text-orange-500"></i>
                                    <span className="text-xs font-mono text-zinc-400">index.html (Editable)</span>
                                </div>
                                <div className="text-[10px] text-zinc-600 font-mono">UTF-8</div>
                            </div>

                            <textarea
                                ref={textareaRef}
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                onKeyDown={handleKeyDown}
                                className="editor-textarea w-full h-full text-zinc-300 p-6 resize-none text-sm"
                                spellCheck="false"
                                placeholder="<!-- Pega tu código aquí -->"
                            ></textarea>
                        </div>

                        {/* Botón Toggle Mobile */}
                        <button 
                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                            className="absolute bottom-6 left-1/2 -translate-x-1/2 z-50 md:hidden bg-brand text-white px-4 py-2 rounded-full text-xs font-bold shadow-[0_0_20px_rgba(231,0,0,0.4)]"
                        >
                            {isSidebarOpen ? 'VER PANTALLA COMPLETA' : 'DIVIDIR PANTALLA'}
                        </button>

                    </main>
                    
                    {/* Status Bar */}
                    <footer className="h-6 border-t border-white/5 bg-black/80 text-[10px] text-zinc-500 flex items-center justify-between px-4 shrink-0 z-20">
                        <div className="flex gap-4">
                            <span className="flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-brand animate-pulse"></div> SYSTEM READY</span>
                        </div>
                        <div className="font-mono opacity-50">GOD'S PLAN v2.0</div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
