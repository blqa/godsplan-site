<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Dev Environment</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeFlask & Prism (Editor & Syntax Highlighting) -->
    <script src="https://unpkg.com/codeflask/build/codeflask.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/prism.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-markup.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <link href="https://unpkg.com/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <!-- Fuentes y Iconos -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    },
                    colors: {
                        brand: { DEFAULT: '#E70000', hover: '#cc0000', glow: 'rgba(231,0,0,0.5)' }, 
                        dark: '#030000',
                        glass: 'rgba(20, 20, 20, 0.7)'
                    },
                    animation: {
                        'nebula': 'nebula 20s infinite alternate',
                    },
                    keyframes: {
                        nebula: {
                            '0%': { transform: 'scale(1)', opacity: '0.3' },
                            '100%': { transform: 'scale(1.2)', opacity: '0.6' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #030000; color: white; overflow: hidden; }

        /* FONDO DINÁMICO (AURORA) */
        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(231, 0, 0, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(100, 0, 0, 0.2) 0%, transparent 40%);
            filter: blur(80px);
            animation: nebula 15s infinite alternate ease-in-out;
        }

        /* RED (GRID) */
        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        /* FIX CODEFLASK */
        .codeflask {
            position: absolute !important;
            top: 0; left: 0; right: 0; bottom: 0;
            background: transparent !important;
            width: 100% !important;
            height: 100% !important;
        }
        .codeflask textarea {
            background: transparent !important;
            color: transparent !important;
            caret-color: #E70000 !important;
            font-family: 'Fira Code', monospace !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            z-index: 10 !important;
        }
        .codeflask pre {
            font-family: 'Fira Code', monospace !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            z-index: 5 !important;
        }
        /* Colores del tema Tomorrow Night */
        .codeflask .token.tag { color: #ef4444 !important; }
        .codeflask .token.attr-name { color: #f59e0b !important; }
        .codeflask .token.attr-value { color: #84cc16 !important; }
        .codeflask .token.comment { font-style: italic; opacity: 0.5; }
        .codeflask .codeflask__flatten { padding: 20px !important; } 
        .codeflask textarea { padding: 20px !important; }

        .glass-panel {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(12px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Resizer Handle */
        .resizer {
            width: 8px;
            background: #050505;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            cursor: col-resize;
            transition: all 0.2s;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resizer:hover, .resizer.active {
            background: #E70000;
            border-color: #E70000;
            box-shadow: 0 0 10px rgba(231,0,0,0.5);
        }
        .resizer-icon {
            width: 2px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 1px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const STORAGE_KEY = 'godsPlan_code_v4';
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola Mundo</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-slate-900 flex flex-col items-center justify-center h-screen text-white">
    
    <div class="text-center p-10 border border-white/10 rounded-2xl bg-white/5 backdrop-blur-md shadow-xl">
        <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
            ¡Hola Mundo!
        </h1>
        <p class="text-gray-400 text-lg mb-6">
            Bienvenido a God's Plan Editor
        </p>
        
        <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-full transition-colors font-medium">
            Botón de Ejemplo
        </button>
    </div>

</body>
</html>`;

        // Script inyectado SOLO para el Inspector
        const INJECTED_TOOLS = `
            <script>
                (function() {
                    // --- INSPECTOR SOLAMENTE ---
                    let isInspecting = false;
                    let lastHighlighted = null;

                    window.addEventListener('message', (e) => {
                        if (e.data.type === 'TOGGLE_INSPECT') {
                            isInspecting = e.data.value;
                            document.body.style.cursor = isInspecting ? 'crosshair' : 'default';
                            if(!isInspecting && lastHighlighted) {
                                lastHighlighted.style.outline = '';
                            }
                        }
                    });

                    document.addEventListener('mouseover', (e) => {
                        if (!isInspecting) return;
                        e.stopPropagation();
                        if (lastHighlighted) lastHighlighted.style.outline = '';
                        e.target.style.outline = '2px dashed #E70000';
                        lastHighlighted = e.target;
                    });

                    document.addEventListener('click', (e) => {
                        if (!isInspecting) return;
                        e.preventDefault();
                        e.stopPropagation();
                        // Snippet para buscar
                        let tagSnippet = e.target.outerHTML.split('>')[0] + '>';
                        window.parent.postMessage({ 
                            type: 'ELEMENT_CLICKED', 
                            snippet: tagSnippet 
                        }, '*');
                        isInspecting = false;
                        if (lastHighlighted) lastHighlighted.style.outline = '';
                        document.body.style.cursor = 'default';
                    });
                })();
            <\/script>
        `;

        const App = () => {
            const [code, setCode] = useState(() => localStorage.getItem(STORAGE_KEY) || DEFAULT_CODE);
            
            // Estado de UI
            const [previewWidth, setPreviewWidth] = useState(50); // % del ancho
            const [isDragging, setIsDragging] = useState(false);
            const [isInspectorActive, setIsInspectorActive] = useState(false);

            const iframeRef = useRef(null);
            const editorDivRef = useRef(null);
            const flaskRef = useRef(null);

            // 1. Inicializar CodeFlask (Editor Pro)
            useEffect(() => {
                if (!flaskRef.current && editorDivRef.current) {
                    const flask = new CodeFlask(editorDivRef.current, {
                        language: 'html',
                        lineNumbers: true,
                        readonly: false
                    });
                    
                    flask.updateCode(code);
                    
                    flask.onUpdate((newCode) => {
                        if (newCode !== code) {
                            setCode(newCode);
                        }
                    });
                    
                    flaskRef.current = flask;
                }
            }, []);

            // Guardar en LocalStorage y Actualizar Iframe
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, code);
                
                const timeoutId = setTimeout(() => {
                    const finalSrc = code.replace('</body>', `${INJECTED_TOOLS}</body>`);
                    if (iframeRef.current) {
                        iframeRef.current.srcdoc = finalSrc;
                    }
                }, 500); 

                return () => clearTimeout(timeoutId);
            }, [code]);

            // Manejar Mensajes del Iframe (Inspector)
            useEffect(() => {
                const handleMessage = (e) => {
                    const { type, snippet } = e.data;
                    if (type === 'ELEMENT_CLICKED') {
                        setIsInspectorActive(false);
                        findAndScroll(snippet);
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, []);

            // Comunicar estado del inspector
            useEffect(() => {
                if (iframeRef.current && iframeRef.current.contentWindow) {
                    iframeRef.current.contentWindow.postMessage({ type: 'TOGGLE_INSPECT', value: isInspectorActive }, '*');
                }
            }, [isInspectorActive]);

            // Lógica del Resizer
            const handleMouseDown = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleMouseMove = useCallback((e) => {
                if (!isDragging) return;
                const newWidth = (e.clientX / window.innerWidth) * 100;
                if (newWidth > 15 && newWidth < 85) {
                    setPreviewWidth(newWidth);
                }
            }, [isDragging]);

            const handleMouseUp = useCallback(() => {
                setIsDragging(false);
            }, []);

            useEffect(() => {
                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                } else {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, handleMouseMove, handleMouseUp]);

            // Buscar código y scrollear
            const findAndScroll = (snippet) => {
                const searchStr = snippet.replace(/ style=".*?"/g, ''); 
                let index = code.indexOf(searchStr);
                if (index === -1) index = code.indexOf(snippet.split(' ')[0]);

                if (index !== -1 && flaskRef.current) {
                    const lines = code.substring(0, index).split('\n');
                    const lineNum = lines.length;
                    
                    // Ajuste de scroll para CodeFlask
                    const container = editorDivRef.current; // CodeFlask crea un div interno a veces, pero scrolleamos el contenedor
                    // Buscamos el textarea para usarlo de referencia si es necesario, 
                    // pero CodeFlask scrollea el contenedor padre si tiene overflow
                    
                    const lineHeight = 21; // aprox 14px * 1.5
                    container.scrollTo({ top: (lineNum - 10) * lineHeight, behavior: 'smooth' });
                    
                    // Efecto visual flash
                    const flash = document.createElement('div');
                    flash.className = 'absolute inset-0 bg-brand/20 z-50 pointer-events-none transition-opacity duration-500';
                    container.appendChild(flash);
                    setTimeout(() => flash.classList.add('opacity-0'), 200);
                    setTimeout(() => flash.remove(), 700);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full relative select-none">
                    <div className="aurora-bg"></div>
                    <div className="grid-bg"></div>

                    {/* Header */}
                    <header className="h-14 border-b border-white/5 bg-black/60 backdrop-blur-md flex items-center justify-between px-6 shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <i className="ph-fill ph-code text-2xl text-brand"></i>
                            <div>
                                <h1 className="font-bold tracking-widest text-sm text-white">GOD'S PLAN</h1>
                                <span className="text-[10px] text-zinc-500 font-mono uppercase tracking-[0.2em]">Dev Environment</span>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setIsInspectorActive(!isInspectorActive)}
                                className={`flex items-center gap-2 px-3 py-1.5 text-xs font-bold tracking-wider border rounded-lg transition-all ${isInspectorActive ? 'bg-brand text-white border-brand animate-pulse' : 'bg-white/5 border-white/10 text-zinc-400 hover:text-white'}`}
                            >
                                <i className="ph-bold ph-crosshair"></i>
                                {isInspectorActive ? 'DETECTANDO...' : 'INSPECTOR'}
                            </button>
                        </div>
                    </header>

                    {/* Main Workspace */}
                    <main className="flex-1 flex overflow-hidden relative z-10">
                        
                        {/* PANEL IZQUIERDO: PREVIEW */}
                        <div className="flex flex-col relative h-full bg-black border-r border-white/5" style={{ width: `${previewWidth}%` }}>
                            
                            {/* Toolbar Preview */}
                            <div className="h-8 bg-black border-b border-white/5 flex items-center px-4 shrink-0">
                                <span className="text-[10px] text-zinc-500 font-mono flex items-center gap-2">
                                    <i className="ph-fill ph-globe text-brand"></i> Vista Previa
                                </span>
                            </div>

                            {/* Iframe */}
                            <div className="flex-1 relative bg-white w-full">
                                <iframe
                                    ref={iframeRef}
                                    className="w-full h-full border-none"
                                    sandbox="allow-scripts allow-modals allow-forms allow-same-origin allow-popups"
                                ></iframe>
                                {isInspectorActive && <div className="absolute inset-0 pointer-events-none border-4 border-brand opacity-50 z-50"></div>}
                            </div>
                        </div>

                        {/* RESIZER HANDLE */}
                        <div 
                            className={`resizer ${isDragging ? 'active' : ''}`}
                            onMouseDown={handleMouseDown}
                        >
                            <div className="resizer-icon"></div>
                        </div>

                        {/* PANEL DERECHO: EDITOR (CodeFlask) */}
                        <div className="flex flex-col h-full bg-[#050505] relative" style={{ width: `${100 - previewWidth}%` }}>
                            
                            <div className="h-8 bg-[#0a0a0a] border-b border-white/5 flex items-center justify-between px-4 shrink-0">
                                <span className="text-[10px] text-zinc-500 font-mono flex items-center gap-2">
                                    <i className="ph-fill ph-file-code text-orange-500"></i> index.html
                                </span>
                                <span className="text-[10px] text-zinc-600">UTF-8 • Auto-save ON</span>
                            </div>

                            {/* Contenedor para CodeFlask */}
                            <div ref={editorDivRef} className="flex-1 relative w-full h-full overflow-hidden"></div>
                        </div>

                    </main>

                    {/* Overlay durante Dragging */}
                    {isDragging && <div className="absolute inset-0 z-[100] cursor-col-resize"></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
