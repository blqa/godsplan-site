<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Ultimate Inspector</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeFlask & Prism -->
    <script src="https://unpkg.com/codeflask/build/codeflask.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/prism.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-markup.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <link href="https://unpkg.com/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        brand: { DEFAULT: '#FF3333', hover: '#cc0000', dim: 'rgba(255, 51, 51, 0.1)' }, 
                        bg: '#050505',
                        panel: '#0a0a0a'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e5e5e5; overflow: hidden; }

        /* Estilo Editor */
        .codeflask { background: transparent !important; }
        .codeflask textarea { color: transparent !important; caret-color: #FF3333 !important; font-family: 'JetBrains Mono', monospace !important; font-size: 13px !important; line-height: 1.6 !important; }
        .codeflask pre { font-family: 'JetBrains Mono', monospace !important; font-size: 13px !important; line-height: 1.6 !important; }
        .codeflask__flatten { padding: 20px !important; } 
        .codeflask textarea { padding: 20px !important; }

        /* Highlight de Selección personalizado */
        ::selection { background: rgba(255, 51, 51, 0.3); color: white; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animaciones */
        @keyframes pulse-border {
            0% { border-color: rgba(255, 51, 51, 0.2); }
            50% { border-color: rgba(255, 51, 51, 0.8); }
            100% { border-color: rgba(255, 51, 51, 0.2); }
        }
        .animate-scan { animation: pulse-border 2s infinite; }

        .resizer {
            width: 4px; background: #1a1a1a; cursor: col-resize; transition: all 0.2s; z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .resizer:hover, .resizer.active { background: #FF3333; width: 4px; box-shadow: 0 0 15px rgba(255,51,51,0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const STORAGE_KEY = 'godsPlan_inspector_v5';
        const DEFAULT_CODE = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Inspector</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-zinc-950 text-white flex flex-col items-center justify-center h-screen overflow-hidden relative">

    <!-- Fondo decorativo -->
    <div class="absolute inset-0 z-0 overflow-hidden">
        <div class="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-purple-600/30 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-blue-600/20 rounded-full blur-[100px]"></div>
    </div>

    <!-- Contenido Principal -->
    <main class="z-10 text-center max-w-2xl px-6">
        <div class="mb-8 inline-block p-1 px-3 rounded-full border border-white/10 bg-white/5 backdrop-blur-sm text-xs font-mono tracking-wider text-purple-300">
            GOD'S PLAN v2.0
        </div>

        <h1 class="text-6xl font-black mb-6 tracking-tight bg-clip-text text-transparent bg-gradient-to-b from-white to-white/50">
            Inspector<br/>Supremo.
        </h1>
        
        <p class="text-lg text-zinc-400 mb-10 leading-relaxed">
            Edita este texto. Luego activa el <span class="text-white font-bold">Inspector</span> arriba y haz clic aquí.
            El editor te llevará <span class="italic text-purple-400">exactamente</span> a la línea correcta.
        </p>

        <div class="flex gap-4 justify-center">
            <button class="px-8 py-3 bg-white text-black font-bold rounded-lg hover:scale-105 transition-transform">
                Comenzar
            </button>
            <button class="px-8 py-3 border border-white/20 hover:bg-white/10 rounded-lg transition-colors font-medium backdrop-blur-md">
                Documentación
            </button>
        </div>
    </main>

</body>
</html>`;

        // Lógica inyectada para el Iframe
        const INJECTED_SCRIPT = `
            <script>
                (function() {
                    let isInspecting = false;
                    let hoveredElement = null;
                    let overlay = null;

                    // Crear Overlay Visual
                    function createOverlay() {
                        if(overlay) return;
                        overlay = document.createElement('div');
                        overlay.style.position = 'fixed';
                        overlay.style.pointerEvents = 'none';
                        overlay.style.zIndex = '9999';
                        overlay.style.border = '2px solid #FF3333';
                        overlay.style.backgroundColor = 'rgba(255, 51, 51, 0.1)';
                        overlay.style.transition = 'all 0.1s ease';
                        overlay.style.display = 'none';
                        overlay.style.borderRadius = '4px';
                        
                        // Etiqueta
                        const tagLabel = document.createElement('span');
                        tagLabel.style.position = 'absolute';
                        tagLabel.style.top = '-24px';
                        tagLabel.style.left = '-2px';
                        tagLabel.style.background = '#FF3333';
                        tagLabel.style.color = 'white';
                        tagLabel.style.fontSize = '10px';
                        tagLabel.style.padding = '2px 6px';
                        tagLabel.style.borderRadius = '3px';
                        tagLabel.style.fontFamily = 'monospace';
                        tagLabel.id = 'inspector-label';
                        
                        overlay.appendChild(tagLabel);
                        document.body.appendChild(overlay);
                    }

                    window.addEventListener('message', (e) => {
                        if (e.data.type === 'TOGGLE_INSPECT') {
                            isInspecting = e.data.value;
                            createOverlay();
                            if (!isInspecting && overlay) overlay.style.display = 'none';
                            document.body.style.cursor = isInspecting ? 'crosshair' : 'default';
                        }
                    });

                    // Mouse Move - Highlight
                    document.addEventListener('mouseover', (e) => {
                        if (!isInspecting) return;
                        e.stopPropagation();
                        
                        const target = e.target;
                        if (target === document.body || target === document.documentElement) return;

                        const rect = target.getBoundingClientRect();
                        
                        overlay.style.display = 'block';
                        overlay.style.top = rect.top + 'px';
                        overlay.style.left = rect.left + 'px';
                        overlay.style.width = rect.width + 'px';
                        overlay.style.height = rect.height + 'px';
                        
                        // Encontrar etiqueta y línea
                        const tagName = target.tagName.toLowerCase();
                        let srcLine = target.getAttribute('data-src-line');
                        
                        // Buscar línea en padres si el elemento actual no tiene (ej: texto dentro de div)
                        let walker = target;
                        while (!srcLine && walker.parentElement) {
                            walker = walker.parentElement;
                            srcLine = walker.getAttribute('data-src-line');
                        }

                        overlay.querySelector('#inspector-label').textContent = \`<\${tagName}> \${srcLine ? 'L:' + srcLine : ''}\`;
                        hoveredElement = target;
                    });

                    // Click - Enviar línea exacta
                    document.addEventListener('click', (e) => {
                        if (!isInspecting) return;
                        e.preventDefault();
                        e.stopPropagation();

                        let target = e.target;
                        let srcLine = target.getAttribute('data-src-line');

                        // Subir por el árbol si no tiene línea asignada
                        while (!srcLine && target.parentElement) {
                            target = target.parentElement;
                            srcLine = target.getAttribute('data-src-line');
                        }

                        if (srcLine) {
                            window.parent.postMessage({ 
                                type: 'ELEMENT_CLICKED', 
                                line: parseInt(srcLine) 
                            }, '*');
                            
                            // Visual feedback click
                            overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
                            setTimeout(() => overlay.style.backgroundColor = 'rgba(255, 51, 51, 0.1)', 150);
                        }
                    });
                })();
            <\/script>
        `;

        const App = () => {
            const [code, setCode] = useState(() => localStorage.getItem(STORAGE_KEY) || DEFAULT_CODE);
            const [previewWidth, setPreviewWidth] = useState(50);
            const [isDragging, setIsDragging] = useState(false);
            const [isInspectorActive, setIsInspectorActive] = useState(false);
            
            const iframeRef = useRef(null);
            const editorDivRef = useRef(null);
            const flaskRef = useRef(null);
            
            // Función Mágica: Inyectar marcadores de línea antes de renderizar
            const processCodeForPreview = (sourceCode) => {
                const lines = sourceCode.split('\n');
                return lines.map((line, index) => {
                    const lineNum = index + 1;
                    // Regex cuidadoso para inyectar data-src-line en la primera etiqueta de apertura de la línea
                    // Ignora scripts para evitar romper JS strings
                    if (line.includes('<script') || line.includes('<style')) return line;
                    
                    return line.replace(
                        /<([a-zA-Z0-9-]+)([^>]*?)>/, 
                        (match, tag, attrs) => `<${tag} data-src-line="${lineNum}"${attrs}>`
                    );
                }).join('\n');
            };

            // Inicializar CodeFlask
            useEffect(() => {
                if (!flaskRef.current && editorDivRef.current) {
                    const flask = new CodeFlask(editorDivRef.current, {
                        language: 'html',
                        lineNumbers: true,
                        readonly: false
                    });
                    
                    flask.updateCode(code);
                    
                    flask.onUpdate((newCode) => {
                        if (newCode !== code) setCode(newCode);
                    });
                    
                    flaskRef.current = flask;
                }
            }, []);

            // Actualizar Preview y Storage
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, code);
                
                const timer = setTimeout(() => {
                    if (iframeRef.current) {
                        const codeWithMarkers = processCodeForPreview(code);
                        const finalSrc = codeWithMarkers.replace('</body>', `${INJECTED_SCRIPT}</body>`);
                        iframeRef.current.srcdoc = finalSrc;
                    }
                }, 600); // Debounce para no recargar a cada tecla

                return () => clearTimeout(timer);
            }, [code]);

            // Comunicación con Iframe
            useEffect(() => {
                const handleMessage = (e) => {
                    if (e.data.type === 'ELEMENT_CLICKED' && flaskRef.current) {
                        const lineNum = e.data.line;
                        highlightLine(lineNum);
                        setIsInspectorActive(false); // Auto-desactivar al encontrar
                    }
                };
                window.addEventListener('message', handleMessage);
                return () => window.removeEventListener('message', handleMessage);
            }, [code]);

            // Sync estado inspector
            useEffect(() => {
                if (iframeRef.current && iframeRef.current.contentWindow) {
                    iframeRef.current.contentWindow.postMessage({ type: 'TOGGLE_INSPECT', value: isInspectorActive }, '*');
                }
            }, [isInspectorActive]);

            // Lógica para resaltar y scrollear a la línea exacta
            const highlightLine = (lineNumber) => {
                if (!flaskRef.current) return;
                
                // Calcular índices
                const lines = code.split('\n');
                if (lineNumber > lines.length || lineNumber < 1) return;

                // Encontrar Start y End index para la selección
                let startIndex = 0;
                for (let i = 0; i < lineNumber - 1; i++) {
                    startIndex += lines[i].length + 1; // +1 por el \n
                }
                const endIndex = startIndex + lines[lineNumber - 1].length;

                // Usar API interna de CodeFlask para seleccionar
                const textarea = editorDivRef.current.querySelector('textarea');
                textarea.focus();
                textarea.setSelectionRange(startIndex, endIndex);
                
                // Calcular posición de scroll (altura de línea aprox 21px)
                // Ajustamos para que quede centrado
                const lineHeight = 21; 
                const scrollPos = (lineNumber * lineHeight) - (editorDivRef.current.clientHeight / 2);
                
                editorDivRef.current.scrollTo({
                    top: Math.max(0, scrollPos),
                    behavior: 'smooth'
                });

                // Efecto visual extra en el editor (overlay temporal)
                // Nota: CodeFlask no expone DOM de líneas fácilmente, así que usamos la selección nativa que ya es visible
            };

            // Resizer Logic
            const handleMouseMove = useCallback((e) => {
                if (!isDragging) return;
                const newWidth = (e.clientX / window.innerWidth) * 100;
                if (newWidth > 20 && newWidth < 80) setPreviewWidth(newWidth);
            }, [isDragging]);

            const handleMouseUp = useCallback(() => setIsDragging(false), []);

            useEffect(() => {
                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                }
            }, [isDragging]);

            return (
                <div className="flex flex-col h-screen w-full bg-bg text-white font-sans overflow-hidden">
                    
                    {/* Header Pro */}
                    <header className="h-12 border-b border-white/5 bg-panel flex items-center justify-between px-4 shrink-0 z-20 shadow-md">
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-brand font-bold tracking-tight">
                                <i className="ph-fill ph-infinity text-xl"></i>
                                <span>GOD'S PLAN</span>
                            </div>
                            <div className="h-4 w-[1px] bg-white/10"></div>
                            <div className="flex text-xs gap-1 text-zinc-500">
                                <span className="text-zinc-300">index.html</span>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setIsInspectorActive(!isInspectorActive)}
                                className={`
                                    flex items-center gap-2 px-3 py-1.5 text-xs font-bold rounded-md transition-all border
                                    ${isInspectorActive 
                                        ? 'bg-brand/10 text-brand border-brand animate-scan shadow-[0_0_15px_rgba(255,51,51,0.3)]' 
                                        : 'bg-white/5 border-transparent text-zinc-400 hover:text-white hover:bg-white/10'}
                                `}
                            >
                                <i className={`ph-bold ${isInspectorActive ? 'ph-crosshair' : 'ph-cursor-click'}`}></i>
                                {isInspectorActive ? 'DETECTANDO OBJETIVO' : 'INSPECCIONAR'}
                            </button>
                        </div>
                    </header>

                    {/* Workspace */}
                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* Preview Area */}
                        <div className="flex flex-col h-full relative group" style={{ width: `${previewWidth}%` }}>
                            <div className="absolute top-3 left-3 z-10 opacity-0 group-hover:opacity-100 transition-opacity bg-black/80 text-white text-[10px] px-2 py-1 rounded backdrop-blur">
                                {Math.round(previewWidth)}% Viewport
                            </div>
                            
                            <div className="flex-1 bg-white relative">
                                <iframe 
                                    ref={iframeRef}
                                    className="w-full h-full border-none"
                                    sandbox="allow-scripts allow-modals allow-forms allow-same-origin"
                                    title="Preview"
                                ></iframe>
                                {/* Capa protectora para cuando arrastramos el resizer */}
                                {isDragging && <div className="absolute inset-0 z-50 bg-transparent"></div>}
                            </div>
                        </div>

                        {/* Resizer */}
                        <div 
                            className={`resizer ${isDragging ? 'active' : ''}`}
                            onMouseDown={() => setIsDragging(true)}
                        ></div>

                        {/* Editor Area */}
                        <div className="flex flex-col h-full bg-[#050505] relative" style={{ width: `${100 - previewWidth}%` }}>
                            <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-b from-black/50 to-transparent z-10 pointer-events-none"></div>
                            
                            {/* Editor Container */}
                            <div ref={editorDivRef} className="flex-1 relative w-full h-full">
                                {/* CodeFlask mounts here */}
                            </div>

                            {/* Status Bar */}
                            <div className="h-6 bg-panel border-t border-white/5 flex items-center justify-between px-3 text-[10px] text-zinc-600 font-mono">
                                <span>HTML5 • Tailwind Included</span>
                                <span>UTF-8</span>
                            </div>
                        </div>

                    </div>
                    
                    {/* Full screen dragging overlay */}
                    {isDragging && <div className="fixed inset-0 z-[100] cursor-col-resize"></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
